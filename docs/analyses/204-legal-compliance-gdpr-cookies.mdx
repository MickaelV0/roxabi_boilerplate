---
title: "Legal Compliance, GDPR & Cookies"
description: Analysis of cookie consent, legal pages, and GDPR data rights implementation for French/EU compliance
---

## Context

Roxabi Boilerplate needs legal compliance before any production deployment in France/EU. Issue [#204](https://github.com/roxabi/roxabi_boilerplate/issues/204) covers cookie consent, legal pages (mentions légales, ToS, privacy policy, cookie policy), and GDPR data rights (access, rectification, portability, erasure).

**Compliance target:** GDPR + CNIL (France-specific requirements).

**In scope:** Footer with legal page links (mentions légales, ToS, privacy policy, cookie policy) and a persistent "Cookie settings" link. These are functional legal requirements, not branding.

**Out of scope:** Visual branding (logo, favicon, og:image) — split to a separate issue. Branding is layout work that can proceed independently.

**Inventory date:** Personal data inventory reflects the schema as of February 2026 (issue #204 analysis).

## Questions Explored

1. How should cookie consent be implemented? (Custom vs third-party vs headless)
2. How should legal page content be delivered in a boilerplate context?
3. What personal data does Roxabi currently store, and who processes it?
4. How should GDPR data rights (access, rectification, portability, erasure) be implemented?
5. What are the CNIL-specific requirements beyond standard GDPR?

## Analysis

### 1. Cookie Consent Implementation

The cookie consent UX is a **banner + modal** pattern: a bottom banner with Accept/Reject/Customize, where Customize opens a modal with granular category toggles (necessary, analytics, marketing).

Four implementation approaches were evaluated:

#### Comparison Matrix

| Criterion | Custom Built | Tarteaucitron.js | CookieConsent v3 | Headless |
|---|---|---|---|---|
| Bundle size | ~0 kB extra | ~80–100 kB (no ESM) | ~5 kB gzip | ~1–2 kB or 0 |
| CNIL compliance OOB | None (DIY) | High | Partial | Minimal (DIY) |
| React/SSR compat | Perfect | Poor (no adapter) | Moderate (useEffect guard) | Perfect (hooks) |
| shadcn/ui theming | Perfect | No | CSS variables only | Perfect |
| Server-side consent | Full control | No | Cookie parsing only | Full control |
| Server-side storage | Full control | No | No | Full control |
| Re-consent logic | DIY | Built-in | Via revision param | DIY |
| Time to implement | High | Low | Low-Medium | Medium |

#### Option 1 — Custom Built

Build banner, modal, and consent logic from scratch using shadcn/ui + Tailwind. Zero bundle overhead, perfect design integration, full server-side control. But all CNIL mechanics must be implemented manually — category management, equal-prominence buttons, re-consent logic, consent versioning, proof-of-consent storage.

#### Option 2 — Tarteaucitron.js

French-origin library designed for CNIL compliance. Has a curated service list with per-service blocking. However: ~80–100 kB with no ESM tree-shaking, no React adapter (vanilla JS global requiring `window`), SSR-incompatible, not IAB TCF-certified, and cannot be themed with shadcn/ui. **Deprioritized** for this stack.

#### Option 3 — CookieConsent v3 (orestbida)

MIT-licensed, ~5 kB gzipped, correct CNIL mechanics (categories, equal buttons, revision-based re-consent). Injects its own HTML/CSS into the DOM — cannot use shadcn/ui components inside it. SSR requires client-only guards. No server-side consent storage. **Pragmatic choice if speed is the priority.**

#### Option 4 — Headless (Recommended)

Use a thin consent state hook (or fully custom) and build all UI with shadcn/ui. The `use-cookie-consent` library provides a ~1 kB React hook for consent state management, or an equivalent custom hook can be written with zero external dependency.

**Why headless is the strongest fit:**

- **SSR transparency:** A custom hook is SSR-safe by design. The server reads the consent cookie directly via `getCookie` in TanStack Start loaders — no hydration mismatch.
- **Design system integrity:** Banner and modal use real shadcn/ui `Button`, `Dialog`, and `Sheet` components. No foreign HTML/CSS injection.
- **Server-side consent:** NestJS reads the `consent` cookie on every request. A `POST /api/consent` endpoint (marked `@AllowAnonymous()` — consent must work before login) persists consent to the database for authenticated users (consent follows across devices).
- **Headless/CLI access:** Any headless client can query `GET /api/consent` (authenticated, returns own consent) to check consent state before data processing. Admin access to other users' consent is out of scope.
- **CNIL mechanics are finite:** Category granularity, equal-prominence buttons, 6-month re-consent prompt, refusal recording, and proof-of-consent storage are well-defined — estimated 1–2 days of implementation.
- **Bundle:** ~0 kB extra (reuses existing components).

**Consent record schema** (cookie value and DB record):

```
{
  categories: { necessary: true, analytics: boolean, marketing: boolean },
  consentedAt: ISO timestamp,
  policyVersion: string (e.g., "2026-02-v1"),
  action: "accepted" | "rejected" | "customized"
}
```

The cookie stores this as a JSON string. For authenticated users, the same structure is persisted to a `consent_records` DB table. **DB is authoritative** when both cookie and DB exist (handles cross-device scenarios). The `policyVersion` field triggers re-consent when the privacy policy changes. The `consentedAt` field enables the 6-month re-consent check.

### 2. Legal Page Content Strategy

A SaaS boilerplate must ship legal pages that work out of the box while allowing operators to customize content for their business. Three approaches were evaluated:

| Approach | Pros | Cons |
|---|---|---|
| **Sample templates** | Fastest to get started; realistic content with variable placeholders (company name, address) | Risk of operators shipping unchanged sample text |
| **Empty structure** | Cleanest — no misleading content | Requires more work from operators; pages are blank until filled |
| **MDX files in docs/** | Most flexible; non-dev editors can modify; version-controlled | Adds a rendering pipeline for legal content |

**Recommendation: Sample templates with variable placeholders.**

Ship each legal page pre-filled with realistic French-language sample content. Use a typed configuration file (`legal.config.ts`) for dynamic fields — not environment variables, since these are not secrets and benefit from type safety and IDE autocomplete:

- Company name (dénomination sociale)
- Legal form (SAS, SARL, etc.)
- Registered address (siège social)
- RCS/SIRET number
- VAT number (TVA intracommunautaire)
- Publication director name
- Host company name and address
- Contact email for GDPR rights

Each legal page renders from a React component that reads these variables and injects them into the template. The config file includes a prominent JSDoc comment block explaining each field and what the operator must customize before going live. Legal pages are **French-only** — this is a CNIL/French compliance feature; operators targeting other jurisdictions can add translations later.

**When analytics is added later:** Operators who add analytics (PostHog, GA4, etc.) will need to update the cookie consent categories. Existing users who were never shown a consent banner for analytics should be treated as "no consent" (CNIL default-deny). The consent system must handle this gracefully — a new `policyVersion` triggers re-consent for all users.

### 3. Personal Data Inventory

#### Data Stored in PostgreSQL (Neon)

| Table | Personal Data | Sensitivity |
|---|---|---|
| `users` | name, email, avatar URL, ban_reason | High |
| `accounts` | OAuth tokens (access, refresh, id_token), hashed password, provider account ID | Critical |
| `sessions` | session token, IP address (personal data per GDPR), user-agent | High |
| `verifications` | email address (identifier), verification token | High |
| `members` | user_id → organization link | Medium |
| `invitations` | invitee email, inviter user reference | High |
| `organizations` | organization name, slug, logo (not personal) | Low |
| `roles`, `permissions` | No personal data | N/A |

#### Third-Party Data Processors

| Service | Data Processed | Retention | DPA Required |
|---|---|---|---|
| **Neon** (PostgreSQL) | All database personal data | Persistent | Yes |
| **Upstash** (Redis) | IP addresses and user IDs (rate limiting) | Transient (60s TTL) | Yes |
| **Resend** (email) | Email addresses, email content | Per Resend retention policy | Yes |
| **Vercel** (hosting) | All HTTP traffic, session cookies, runtime logs | Per Vercel retention policy | Yes |
| **Google** (OAuth, optional) | User profile data shared during OAuth flow | Per Google terms | Yes (if enabled) |
| **GitHub** (OAuth, optional) | User profile data shared during OAuth flow | Per GitHub terms | Yes (if enabled) |

#### Cookies Currently Set

| Cookie | Purpose | Category |
|---|---|---|
| `better-auth.session_token` | Session authentication | Strictly necessary |
| `better-auth.session_token.cache` (if enabled) | Session cache to reduce DB lookups (5 min TTL) | Strictly necessary |
| `consent` (proposed) | Cookie consent preferences | Strictly necessary (exempt) |

**No analytics, marketing, or third-party tracking cookies exist today.** The only cookies are auth session cookies, which are strictly necessary and exempt from consent.

### 4. GDPR Data Rights Implementation

#### Right to Access (Data Export)

Endpoint: `GET /api/gdpr/export`

Returns a JSON file containing all personal data for the authenticated user:

- User profile (name, email, avatar, role, creation date)
- Active sessions (IP, user-agent, creation date — anonymize tokens)
- Organization memberships and roles
- Pending invitations sent by or to the user
- Account providers (provider names, OAuth scopes granted — exclude tokens and credentials)

**Format:** JSON download, structured by category. Excludes hashed passwords, OAuth tokens, and session tokens (sensitive internal data). Includes OAuth `scope` and `providerId` as they reveal what the user consented to share.

#### Right to Rectification (Edit Profile)

Already partially implemented via the user profile. Ensure:

- Users can edit name, email, and avatar
- Email change triggers re-verification
- Changes are reflected immediately across all contexts (sessions, org memberships)

#### Right to Portability (Data Download)

Same as Right to Access but in a machine-readable, portable format (JSON). The export endpoint serves both rights.

#### Right to Erasure (Account Deletion)

**Model: Soft delete with 30-day grace period.**

Flow:
1. User requests deletion from account settings
2. Account is marked as `pending_deletion` with a `deletion_scheduled_at` timestamp (now + 30 days)
3. User receives a confirmation email with a cancellation link
4. During the grace period:
   - User can still log in and cancel the deletion
   - Account appears as "scheduled for deletion" in the UI
   - User cannot be invited to new organizations
5. After 30 days, hard deletion is triggered. Two mechanisms (use both for reliability):
   - **Lazy check on auth:** When a user with `deletion_scheduled_at &lt;= now` attempts to log in or any auth-guarded request hits the API, the hard deletion executes immediately. This is serverless-friendly and requires no cron.
   - **Vercel Cron (daily):** A `GET /api/cron/gdpr-cleanup` endpoint scans for expired grace periods and performs batch deletion. Configured via `vercel.json` `crons` field (`"0 3 * * *"`). This catches accounts where the user never logs back in.
   - Hard deletion cascade: delete from `sessions`, `accounts`, `verifications` (DB cascade handles most via `onDelete: 'cascade'`), remove from `members`, reassign or delete owned organizations, delete from `invitations` (both sent and received), delete rate-limit keys from Upstash Redis, request data deletion from Resend via API, finally delete the `users` record.

**Important:** `@nestjs/schedule` `@Cron()` decorators do **not** work on Vercel serverless (process is not kept warm). The Vercel Cron approach uses an HTTP endpoint instead.

**New schema fields needed on `users`:**
- `deletion_requested_at` (timestamptz, nullable)
- `deletion_scheduled_at` (timestamptz, nullable)

These extend the Better Auth-managed `users` table. This is a supported pattern — `banned`, `banReason`, `banExpires`, and `role` already extend it. Fields must be nullable to avoid breaking Better Auth's internal operations.

**Cascade rules:**
- Organizations with a single owner: prompt user to transfer ownership or delete the org
- Organizations with multiple owners: remove the user's membership
- Pending invitations sent by the user: cancel them

#### Right to Object (GDPR Article 21)

The right to object to processing for legitimate interests is addressed through two existing mechanisms — no separate endpoint needed:
- **Cookie consent withdrawal:** Users can revoke analytics/marketing consent at any time via the "Cookie settings" footer link.
- **Account deletion:** Users can request full erasure, which stops all processing.

The privacy policy must inform users of this right and explain how to exercise it.

### 5. CNIL-Specific Requirements

#### Cookie Consent (CNIL Guidelines)

| Requirement | Implementation |
|---|---|
| Accept/Refuse equal prominence | Same button size, weight, and color for both |
| No dark patterns | No manipulative wording or misleading colors |
| Categories | Necessary (exempt), Analytics, Marketing (minimum) |
| Non-essential blocked by default | Scripts only fire after explicit opt-in per category |
| Re-consent prompt | Every 6 months (best practice) or max 13 months |
| Refusal recording | Store both consent AND refusal (avoid re-prompting) |
| Proof of consent | Record: categories accepted, timestamp, policy version shown |
| Revocation | Persistent "Cookie settings" link in footer, always accessible |

#### Mentions Légales (French Legal Notice)

Required by LCEN (June 21, 2004). Mandatory for all professional French websites. Must include:

- Editor identity (company name, legal form, capital, registered address)
- RCS/SIRET number
- TVA intracommunautaire number
- Publication director name
- Host identity (company name, address, phone)
- Contact email for GDPR rights exercise
- GDPR rights notice

**Penalties:** Up to €375,000 for legal entities (Art. L. 121-7 LCEN, as amended).

#### GDPR Rights Notice

The privacy policy must inform users of their rights to:
- Access their personal data
- Rectify inaccurate data
- Request erasure
- Data portability
- Object to processing
- Lodge a complaint with the CNIL

Must include the CNIL contact information and a link to the [CNIL complaints page](https://www.cnil.fr/fr/plaintes).

## Conclusions

1. **Cookie consent: Option 4 — Headless approach** is the recommended implementation. Build UI with shadcn/ui `Button`, `Dialog`, and `Sheet` components; manage state with a custom React hook; persist consent to both a `consent` cookie (JSON with categories, timestamp, policy version) and a `consent_records` DB table. DB is authoritative for cross-device. This gives perfect design integration, SSR compatibility, and server-side consent checking for headless/CLI access.

2. **Legal pages: Sample templates with `legal.config.ts`.** Ship 4 French-language pages (mentions légales, ToS, privacy policy, cookie policy) pre-filled with sample content. A typed config file provides dynamic fields (company name, SIRET, address, etc.). French-only — operators add translations if needed.

3. **GDPR: Full rights implementation.** Access/portability via `GET /api/gdpr/export` (JSON download), rectification via profile editing, erasure via soft delete with 30-day grace period + lazy auth check + Vercel cron. Right to Object is covered by consent withdrawal and account deletion.

4. **No analytics cookies exist today.** The consent system is forward-looking — it provides the infrastructure for when analytics or marketing tools are added later. Currently only strictly necessary auth cookies are set. Adding analytics later triggers re-consent via a new `policyVersion`.

5. **Third-party DPAs needed.** The privacy policy must list Neon, Upstash, Resend, and Vercel as data processors. Each requires a Data Processing Agreement.

6. **Footer legal links are in scope.** The footer includes links to all 4 legal pages plus a persistent "Cookie settings" link for consent revocation (CNIL requirement). Visual branding (logo, favicon) is out of scope.

## Next Steps

- [ ] Create spec from this analysis → `docs/specs/204-legal-compliance-gdpr-cookies.mdx` (covers implementation details, API contracts, component structure)
- [ ] Create a separate GitHub issue for branding (logo, favicon, og:image)
- [ ] Verify DPA status with each third-party processor (Neon, Upstash, Resend, Vercel) — operator responsibility, but the privacy policy template should list them
- [ ] Verify Resend API support for data deletion requests (needed for GDPR erasure cascade)
