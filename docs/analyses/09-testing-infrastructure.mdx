---
title: "Issue #9: Testing Infrastructure Analysis"
description: Technical analysis for Roxabi Boilerplate infrastructure
---

> **Deprecated**: This document is outdated and kept for historical reference only. Please refer to the main documentation sections for current information.


## Executive Summary

This analysis evaluates testing infrastructure options for a Bun/TurboRepo monorepo SaaS boilerplate using TanStack Start (frontend) and NestJS + Fastify (backend). **Vitest with the `projects` configuration (replacing deprecated `workspace`) combined with Playwright for E2E testing represents the current state of the art for 2025-2026**, offering excellent monorepo support, TurboRepo caching integration, and comprehensive coverage reporting. The recommended approach balances development velocity with strict TDD practices through per-package test configurations with shared utilities.

## State of the Art (2025-2026)

### Unit & Integration Testing

**Vitest** has emerged as the dominant testing framework for modern TypeScript/JavaScript projects, replacing Jest in most new projects:

- **Vitest 3.2+** deprecated the `workspace` configuration in favor of `projects` for clearer monorepo semantics
- **V8 coverage with AST-aware remapping** (experimental in 3.2) produces Istanbul-accurate reports with V8 performance
- **Per-package configuration** with shared config packages is the recommended TurboRepo pattern for optimal caching
- **Bun runtime compatibility**: While `bun:test` is faster (11x in synthetic benchmarks), Vitest offers superior test isolation, browser mode, and ecosystem maturity

**Key insight**: Running Vitest with Bun runtime (`bun run --bun vitest`) combines Bun's speed with Vitest's features.

### E2E Testing

**Playwright** dominates E2E testing with:

- **Sharding**: Split tests across CI machines with `--shard=x/y`
- **Fully parallel mode**: Test-level distribution across shards for balanced workloads
- **Blob reporter**: Merge reports from multiple shards
- **Component testing**: Experimental browser-native component tests

### Coverage Enforcement

Modern coverage strategies support strict TDD:

- **Threshold types**: Percentage (min 90%) or absolute (max 10 uncovered lines)
- **Auto-update thresholds**: Automatically raise thresholds when coverage improves
- **Per-file thresholds**: Glob-pattern based enforcement
- **GitHub Actions integration**: Block PRs on coverage regression

### Known Challenges

1. **TanStack Start + Vitest monorepo bug**: The TanStack Start Vite plugin interferes with Vitest in pnpm workspaces; workaround: conditionally disable plugin during tests
2. **NestJS metadata preservation**: Entity decorators require explicit imports (not glob patterns) when using TypeORM with Vitest
3. **Coverage in monorepos**: Must be configured at root level; per-package coverage reports need manual merging with `nyc merge`

---

## Option A: MVP Approach (Fastest to Implement)

### Description

Minimal viable testing setup using Vitest's simple mode with basic Playwright configuration. No shared config packages, inline configurations in each app.

### Configuration

```
roxabi_boilerplate/
├── apps/
│   ├── web/
│   │   ├── vitest.config.ts      # Inline config
│   │   └── playwright.config.ts
│   └── api/
│       └── vitest.config.ts      # Inline config
├── vitest.config.ts              # Root for coverage aggregation
└── package.json
```

**Root `vitest.config.ts`:**
```typescript
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    projects: ['apps/*/vitest.config.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'html', 'lcov'],
      include: ['apps/*/src/**/*.ts', 'apps/*/src/**/*.tsx'],
      exclude: ['**/*.test.ts', '**/*.spec.ts', '**/node_modules/**'],
    },
  },
})
```

**Root `package.json` scripts:**
```json
{
  "scripts": {
    "test": "vitest run",
    "test:unit": "vitest run",
    "test:e2e": "playwright test --project=web",
    "test:coverage": "vitest run --coverage",
    "test:watch": "vitest"
  }
}
```

### Pros

- **Fastest setup**: ~2-4 hours to implement
- **Minimal dependencies**: Only Vitest + Playwright
- **Simple mental model**: Each app owns its config
- **Works immediately**: No shared package complexity

### Cons

- **Code duplication**: Repeated config across apps
- **No TurboRepo caching**: Tests run as single task, no per-package caching
- **Harder to maintain**: Config drift between packages
- **Limited scalability**: Adding packages increases duplication

### Complexity: 1/5

---

## Option B: Gold Standard (Best Quality)

### Description

Full monorepo-optimized setup with shared configuration package, per-package TurboRepo caching, comprehensive Playwright sharding, and strict coverage enforcement with auto-updating thresholds.

### Configuration

```
roxabi_boilerplate/
├── apps/
│   ├── web/
│   │   ├── vitest.config.ts      # Extends @repo/vitest-config
│   │   ├── playwright.config.ts  # Extends @repo/playwright-config
│   │   └── e2e/
│   └── api/
│       └── vitest.config.ts      # Extends @repo/vitest-config
├── packages/
│   ├── vitest-config/            # Shared Vitest configuration
│   │   ├── package.json
│   │   ├── base.ts
│   │   ├── react.ts
│   │   └── node.ts
│   └── playwright-config/        # Shared Playwright configuration
│       ├── package.json
│       └── base.ts
├── tests/
│   └── e2e/                      # Cross-app E2E tests
├── vitest.workspace.ts           # Root workspace (coverage only)
├── turbo.json                    # Per-package test tasks
└── package.json
```

**`packages/vitest-config/base.ts`:**
```typescript
import { defineConfig, mergeConfig } from 'vitest/config'

export const baseConfig = defineConfig({
  test: {
    globals: true,
    passWithNoTests: false,
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'lcov'],
      thresholds: {
        lines: 80,
        functions: 80,
        branches: 80,
        statements: 80,
        autoUpdate: true,
      },
    },
    include: ['src/**/*.{test,spec}.{ts,tsx}'],
    exclude: ['node_modules', 'dist', '.turbo'],
  },
})

export const reactConfig = mergeConfig(baseConfig, {
  test: {
    environment: 'jsdom',
    setupFiles: ['./src/test/setup.ts'],
  },
})

export const nodeConfig = mergeConfig(baseConfig, {
  test: {
    environment: 'node',
  },
})
```

**`apps/web/vitest.config.ts`:**
```typescript
import { mergeConfig } from 'vitest/config'
import { reactConfig } from '@repo/vitest-config'
import react from '@vitejs/plugin-react'

export default mergeConfig(reactConfig, {
  plugins: [
    // Conditionally disable TanStack Start plugin during tests
    process.env.VITEST !== 'true' && tanstackStart(),
    react(),
  ].filter(Boolean),
})
```

**`turbo.json` (enhanced):**
```json
{
  "$schema": "https://turbo.build/schema.json",
  "tasks": {
    "test": {
      "dependsOn": ["^build"],
      "inputs": ["src/**", "test/**", "vitest.config.ts"],
      "outputs": ["coverage/**"],
      "env": ["CI", "VITEST"]
    },
    "test:watch": {
      "cache": false,
      "persistent": true
    },
    "test:e2e": {
      "dependsOn": ["build"],
      "inputs": ["e2e/**", "playwright.config.ts"],
      "outputs": ["playwright-report/**", "test-results/**"],
      "passThroughEnv": [
        "CI",
        "PLAYWRIGHT_*",
        "DEBUG"
      ]
    },
    "test:coverage": {
      "dependsOn": ["test"],
      "outputs": ["coverage/**"]
    }
  }
}
```

**`packages/playwright-config/base.ts`:**
```typescript
import { defineConfig, devices } from '@playwright/test'

export const basePlaywrightConfig = defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 4 : undefined,
  reporter: process.env.CI
    ? [['blob'], ['github']]
    : [['html', { open: 'never' }]],
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
    { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
    { name: 'webkit', use: { ...devices['Desktop Safari'] } },
    { name: 'mobile-chrome', use: { ...devices['Pixel 5'] } },
  ],
  webServer: {
    command: 'bun run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120000,
  },
})
```

**GitHub Actions CI (`.github/workflows/test.yml`):**
```yaml
name: Tests
on: [push, pull_request]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: bun run test:coverage
      - uses: davelosert/vitest-coverage-report-action@v2

  e2e-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard: [1/4, 2/4, 3/4, 4/4]
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: bunx playwright install --with-deps
      - run: bun run test:e2e --shard=${{ matrix.shard }}
      - uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shard }}
          path: blob-report/

  merge-reports:
    needs: e2e-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: blob-report-*
          merge-multiple: true
      - run: bunx playwright merge-reports ./blob-report --reporter=html
```

### Pros

- **Optimal caching**: Per-package TurboRepo caching reduces CI time
- **Consistent configuration**: Single source of truth for test settings
- **Scalable**: Easy to add new packages
- **CI-optimized**: Parallel sharding, coverage gates, report merging
- **TDD-ready**: Auto-updating thresholds, strict coverage enforcement
- **Full browser coverage**: Multi-browser E2E testing

### Cons

- **Higher setup complexity**: ~2-3 days to implement fully
- **More packages to maintain**: Two new config packages
- **Learning curve**: Team must understand workspace patterns
- **Potential TanStack Start issues**: Known Vitest integration bugs

### Complexity: 5/5

---

## Option C: Balanced Approach (Recommended)

### Description

Pragmatic middle ground using root-level shared configuration (no separate package), per-package test execution for TurboRepo caching, and streamlined Playwright setup. Achieves 80% of Option B's benefits with 40% of the effort.

### Configuration

```
roxabi_boilerplate/
├── apps/
│   ├── web/
│   │   ├── vitest.config.ts      # Extends root vitest.shared.ts
│   │   ├── playwright.config.ts
│   │   └── e2e/
│   └── api/
│       └── vitest.config.ts      # Extends root vitest.shared.ts
├── packages/
│   ├── ui/
│   │   └── vitest.config.ts
│   ├── config/
│   └── types/
├── vitest.shared.ts              # Shared config (not a package)
├── vitest.config.ts              # Root config for coverage
├── playwright.config.ts          # Root Playwright config
├── turbo.json
└── package.json
```

**Root `vitest.shared.ts`:**
```typescript
import type { UserConfig } from 'vitest/config'

export const sharedTestConfig: UserConfig['test'] = {
  globals: true,
  passWithNoTests: false,
  include: ['src/**/*.{test,spec}.{ts,tsx}'],
  exclude: ['node_modules', 'dist', '.turbo'],
  coverage: {
    provider: 'v8',
    reporter: ['text', 'json', 'lcov'],
    exclude: [
      'node_modules/**',
      'dist/**',
      '**/*.d.ts',
      '**/*.test.ts',
      '**/*.spec.ts',
      '**/test/**',
    ],
  },
}

export const reactTestConfig: UserConfig['test'] = {
  ...sharedTestConfig,
  environment: 'jsdom',
}

export const nodeTestConfig: UserConfig['test'] = {
  ...sharedTestConfig,
  environment: 'node',
}
```

**Root `vitest.config.ts`:**
```typescript
import { defineConfig } from 'vitest/config'
import { sharedTestConfig } from './vitest.shared'

export default defineConfig({
  test: {
    ...sharedTestConfig,
    projects: [
      'apps/*/vitest.config.ts',
      'packages/*/vitest.config.ts',
    ],
    coverage: {
      ...sharedTestConfig.coverage,
      include: [
        'apps/*/src/**/*.{ts,tsx}',
        'packages/*/src/**/*.{ts,tsx}',
      ],
      thresholds: {
        lines: 70,
        functions: 70,
        branches: 70,
        statements: 70,
      },
    },
  },
})
```

**`apps/web/vitest.config.ts`:**
```typescript
import { defineConfig, mergeConfig } from 'vitest/config'
import react from '@vitejs/plugin-react'
import { reactTestConfig } from '../../vitest.shared'

export default defineConfig({
  plugins: [react()],
  test: {
    ...reactTestConfig,
    name: 'web',
    root: __dirname,
    setupFiles: ['./src/test/setup.ts'],
  },
})
```

**`apps/api/vitest.config.ts`:**
```typescript
import { defineConfig } from 'vitest/config'
import { nodeTestConfig } from '../../vitest.shared'

export default defineConfig({
  test: {
    ...nodeTestConfig,
    name: 'api',
    root: __dirname,
    setupFiles: ['./src/test/setup.ts'],
  },
})
```

**`packages/ui/vitest.config.ts`:**
```typescript
import { defineConfig } from 'vitest/config'
import react from '@vitejs/plugin-react'
import { reactTestConfig } from '../../vitest.shared'

export default defineConfig({
  plugins: [react()],
  test: {
    ...reactTestConfig,
    name: 'ui',
    root: __dirname,
  },
})
```

**Root `playwright.config.ts`:**
```typescript
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './apps/web/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 2 : undefined,
  reporter: [
    ['html', { open: 'never' }],
    ...(process.env.CI ? [['github'] as const] : []),
  ],
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
  ],
  webServer: {
    command: 'bun run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120000,
  },
})
```

**Updated `turbo.json`:**
```json
{
  "$schema": "https://turbo.build/schema.json",
  "tasks": {
    "dev": {
      "cache": false,
      "persistent": true
    },
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**", ".next/**", "build/**"]
    },
    "typecheck": {
      "dependsOn": ["^typecheck"]
    },
    "lint": {
      "dependsOn": ["^lint"]
    },
    "test": {
      "dependsOn": ["^build"],
      "inputs": ["src/**/*.ts", "src/**/*.tsx", "vitest.config.ts"],
      "outputs": ["coverage/**"],
      "env": ["CI", "VITEST"]
    },
    "test:watch": {
      "cache": false,
      "persistent": true
    },
    "clean": {
      "cache": false
    }
  }
}
```

**Root `package.json` scripts:**
```json
{
  "scripts": {
    "dev": "turbo dev",
    "build": "turbo build",
    "lint": "biome check .",
    "lint:fix": "biome check --write .",
    "format": "biome format --write .",
    "typecheck": "turbo typecheck",
    "test": "turbo test",
    "test:unit": "vitest run",
    "test:e2e": "playwright test",
    "test:coverage": "vitest run --coverage",
    "test:watch": "vitest",
    "clean": "turbo clean && rm -rf node_modules"
  },
  "devDependencies": {
    "@biomejs/biome": "^1.9.0",
    "@playwright/test": "^1.50.0",
    "@vitejs/plugin-react": "^4.3.0",
    "@vitest/coverage-v8": "^3.0.0",
    "jsdom": "^25.0.0",
    "turbo": "^2.3.0",
    "typescript": "^5.7.0",
    "vitest": "^3.0.0"
  }
}
```

### Example Test Files

**`apps/api/src/test/setup.ts`:**
```typescript
import { beforeAll, afterAll, afterEach } from 'vitest'

beforeAll(async () => {
  // Setup test database, mocks, etc.
})

afterEach(async () => {
  // Clear mocks, reset state
})

afterAll(async () => {
  // Cleanup
})
```

**`apps/api/src/example.test.ts`:**
```typescript
import { describe, it, expect } from 'vitest'

describe('Example Service', () => {
  it('should pass', () => {
    expect(true).toBe(true)
  })
})
```

**`apps/web/e2e/home.spec.ts`:**
```typescript
import { test, expect } from '@playwright/test'

test.describe('Home Page', () => {
  test('should display welcome message', async ({ page }) => {
    await page.goto('/')
    await expect(page.locator('h1')).toContainText('Welcome')
  })
})
```

### Pros

- **Reasonable setup time**: ~4-8 hours to implement
- **TurboRepo caching**: Per-package test execution
- **Shared configuration**: No code duplication, no extra packages
- **Flexible**: Easy to customize per-package
- **CI-ready**: Works well with GitHub Actions
- **Maintainable**: Single shared file is easy to update

### Cons

- **Relative imports**: Config uses `../../vitest.shared` (slightly fragile)
- **No browser matrix**: Only Chromium + Firefox (not full Option B coverage)
- **Coverage at root only**: Must run from root for merged coverage
- **Less sophisticated CI**: No sharding by default (can be added later)

### Complexity: 3/5

---

## Comparison Table

| Criteria | Option A (MVP) | Option B (Gold) | Option C (Balanced) |
|----------|----------------|-----------------|---------------------|
| **Setup Time** | 2-4 hours | 2-3 days | 4-8 hours |
| **Speed** | Fast | Fastest (cached) | Fast (cached) |
| **Quality** | Basic | Excellent | Good |
| **Complexity** | 1/5 | 5/5 | 3/5 |
| **Maintenance** | High (duplication) | Medium (more packages) | Low (single shared file) |
| **TurboRepo Caching** | No | Full | Yes |
| **Coverage Merging** | Manual | Automated | At root level |
| **E2E Sharding** | No | Yes (4 shards) | No (add later) |
| **Browser Coverage** | Chromium only | 4 browsers + mobile | 2 browsers |
| **Scalability** | Poor | Excellent | Good |
| **TDD Support** | Basic | Full (auto-thresholds) | Good (thresholds) |

---

## Recommendation

**Option C (Balanced Approach)** is recommended for the Roxabi Boilerplate project.

### Justification

1. **Right-sized for current state**: The project is in early setup phase with placeholder apps. Full gold-standard infrastructure would be premature optimization.

2. **TDD-ready without overhead**: Coverage thresholds (70%) and per-package test execution support strict TDD without the complexity of auto-updating thresholds.

3. **Clear upgrade path**: Option C can evolve into Option B by:
   - Extracting `vitest.shared.ts` into `@repo/vitest-config` package
   - Adding Playwright sharding in CI
   - Implementing auto-update thresholds
   - Adding more browser projects

4. **TurboRepo integration**: Per-package test configurations enable caching, which becomes critical as the codebase grows.

5. **Known issues addressed**: The approach accounts for TanStack Start + Vitest compatibility issues with conditional plugin loading.

6. **Bun compatibility**: Using Vitest (not `bun:test`) provides better test isolation and ecosystem support while still benefiting from Bun as the runtime/package manager.

### Migration Effort from Recommended Approach

- To Option A: Simplify by inlining configs (1-2 hours)
- To Option B: Extract shared packages + add CI complexity (1-2 days)

---

## Key Resources

### Official Documentation

- [Vitest Guide](https://vitest.dev/guide/) - Official Vitest documentation
- [Vitest Projects Configuration](https://vitest.dev/guide/projects) - Monorepo setup (replaces deprecated workspace)
- [Vitest Coverage Configuration](https://vitest.dev/config/coverage) - Coverage options and thresholds
- [Playwright Best Practices](https://playwright.dev/docs/best-practices) - Official recommendations
- [Playwright Sharding](https://playwright.dev/docs/test-sharding) - CI parallelization guide
- [TurboRepo + Vitest Guide](https://turborepo.dev/docs/guides/tools/vitest) - Official integration guide
- [TurboRepo + Playwright Guide](https://turborepo.com/docs/guides/tools/playwright) - E2E integration

### Examples & Templates

- [TurboRepo with-vitest Example](https://github.com/vercel/turborepo/blob/main/examples/with-vitest/README.md) - Official starter
- [TrilonIO/nest-vitest](https://github.com/TrilonIO/nest-vitest) - NestJS + Vitest example
- [Vitest Monorepo Setup (2025)](https://www.thecandidstartup.org/2025/09/08/vitest-3-monorepo-setup.html) - Comprehensive Vitest 3 monorepo guide

### GitHub Actions Integration

- [vitest-coverage-report-action](https://github.com/davelosert/vitest-coverage-report-action) - PR coverage comments
- [Vitest Coverage with GitHub Actions](https://medium.com/@alvarado.david/vitest-code-coverage-with-github-actions-report-compare-and-block-prs-on-low-coverage-67fceaa79a47) - Complete CI setup guide

### NestJS-Specific

- [NestJS Testing Documentation](https://docs.nestjs.com/fundamentals/testing) - Official testing guide
- [End-to-End Testing in NestJS with Vitest](https://medium.com/@aymankaddioui/end-to-end-testing-in-nestjs-the-real-way-with-vitest-postgresql-99afd4c25f65) - Real-world E2E patterns
- [@golevelup/ts-vitest](https://www.npmjs.com/package/@golevelup/ts-vitest) - NestJS mocking utilities

### TanStack Start-Specific

- [TanStack Router Testing Setup](https://tanstack.com/router/latest/docs/framework/react/how-to/setup-testing) - Official testing guide
- [Vitest + TanStack Start Workaround](https://github.com/TanStack/router/issues/6246) - Known issue with pnpm workspaces

### Performance Comparisons

- [Bun vs Vitest Performance](https://github.com/gkiely/bun-vs-vitest) - Benchmark repository
- [Jest vs Vitest vs Bun Comparison](https://dev.to/kcsujeet/your-tests-are-slow-you-need-to-migrate-to-bun-9hh) - Real-world migration story

---

## Implementation Checklist

When implementing Option C:

- [ ] Install dependencies: `vitest`, `@vitest/coverage-v8`, `@playwright/test`, `jsdom`
- [ ] Create `vitest.shared.ts` with base configurations
- [ ] Create root `vitest.config.ts` with projects and coverage
- [ ] Create `apps/web/vitest.config.ts` extending shared config
- [ ] Create `apps/api/vitest.config.ts` extending shared config
- [ ] Create `packages/ui/vitest.config.ts` extending shared config
- [ ] Create root `playwright.config.ts`
- [ ] Update `turbo.json` with test task inputs/outputs
- [ ] Add test scripts to root `package.json`
- [ ] Create example unit tests in each package
- [ ] Create example E2E test in `apps/web/e2e/`
- [ ] Verify TurboRepo caching works for test tasks
- [ ] Document testing conventions in CLAUDE.md or CONTRIBUTING.md
