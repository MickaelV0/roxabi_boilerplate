---
title: "Pre-Production Security Hardening"
description: Analysis of 7 medium-severity security items from the project audit, with implementation approach for each.
---

## Context

The project audit of 2026-02-09 identified seven medium-severity security items (M-1 through M-7) that should be addressed before production deployment. These span API configuration, frontend hygiene, dependency cleanup, and email safety. All items are scoped as a **single PR** since each fix is small and self-contained.

**Source:** [Project audit analysis](./project-audit-2026-02-09.mdx) — findings M-1 through M-7 (Security + Infra agents).

**GitHub issue:** [#89](https://github.com/MickaelV0/roxabi_boilerplate/issues/89)

## Questions Explored

1. What is the current security posture of each flagged item?
2. What is the recommended fix for each item?
3. Are there dependencies between items?
4. What is the delivery strategy (single PR vs. split)?

## Analysis

### M-1: CORS Wildcard Validation

**File:** `apps/api/src/index.ts:74-76`

**Current state:** CORS origin is read from `CORS_ORIGIN` env var as a single string, falling back to `http://localhost:3000`. No validation against wildcard `*`.

```typescript
app.enableCors({
  origin: configService.get<string>('CORS_ORIGIN', 'http://localhost:3000'),
})
```

**Risk:** If `CORS_ORIGIN` is set to `*` in production (accidentally or via misconfiguration), the API would accept requests from any origin.

**Fix:** Parse `CORS_ORIGIN` as a comma-separated list to support multiple origins. In production, reject `*` and log a warning. In development, allow `*` for convenience.

**Existing mitigations:** Helmet security headers are already configured. The `CORS_ORIGIN` default is `http://localhost:3000` (not wildcard).

---

### M-2: Demo Route Protection

**Files:** `apps/web/src/routes/demo/start.server-funcs.tsx`, `apps/web/src/routes/demo/api.tq-todos.ts`

**Current state:** Demo server functions and API routes are publicly accessible with no authentication, no authorization, and minimal input validation. They perform file I/O (server-funcs) and in-memory data operations (tq-todos).

**Risk:** Demo routes expose unprotected functionality in production. While they only manipulate demo data, they represent unnecessary attack surface.

**Fix:** Gate all demo routes behind an `ENABLE_DEMO` feature flag (environment variable). The flag will be:
- Active in development (default `true`)
- Active in production (explicitly set to `true` in Vercel env vars)
- When disabled, demo routes return 404 or redirect

This approach preserves demo functionality for showcasing the boilerplate while allowing it to be disabled when deploying a real application. The flag must be added to **Vercel environment variables** for both web deployments.

**Existing mitigations:** Routes live under `/demo/` path prefix, clearly separated from application routes.

---

### M-3: Fastify Body Size Limit

**File:** `apps/api/src/index.ts:10-17`

**Current state:** The `FastifyAdapter` is created with only a logger configuration. No explicit `bodyLimit` is set.

```typescript
new FastifyAdapter({
  logger: {
    level: process.env.LOG_LEVEL || 'debug',
  },
})
```

**Risk:** Fastify's default body limit is 1 MiB. While this is reasonable, an explicit limit documents the intent and prevents surprises if Fastify changes its default. For an API that doesn't handle file uploads, a smaller limit may be appropriate.

**Fix:** Set `bodyLimit: 1048576` (1 MiB) explicitly in the `FastifyAdapter` options. This matches Fastify's current default but makes it explicit and auditable.

**Existing mitigations:** NestJS `ValidationPipe` with `whitelist: true` and `forbidNonWhitelisted: true` already rejects unexpected fields.

---

### M-4: Conditional Devtools

**File:** `apps/web/src/routes/__root.tsx:100-112`

**Current state:** `TanStackDevtools` with Router, Store, and Query plugins is rendered unconditionally in the root document component.

```tsx
<TanStackDevtools
  config={{ position: 'bottom-right' }}
  plugins={[
    { name: 'Tanstack Router', render: <TanStackRouterDevtoolsPanel /> },
    StoreDevtools,
    TanStackQueryDevtools,
  ]}
/>
```

**Risk:** Devtools in production expose internal application state (router history, query cache, store state) and add unnecessary JavaScript to the bundle.

**Fix:** Wrap the `&lt;TanStackDevtools>` block in an `import.meta.env.DEV` check so it's only rendered in development. This also enables tree-shaking to remove devtools code from the production bundle.

**Existing mitigations:** None — devtools are always rendered.

---

### M-5: Move Faker to devDependencies

**File:** `apps/web/package.json`

**Current state:** `@faker-js/faker` (`^10.0.0`) is listed in `dependencies` rather than `devDependencies`. It's approximately 6 MB and is only used for generating demo data.

**Risk:** Faker ships to production, increasing bundle size unnecessarily. It could also be imported accidentally in production code paths.

**Fix:** Move `@faker-js/faker` from `dependencies` to `devDependencies`. Verify that demo data generation only runs at build time or in development. If demo data is needed at runtime, the demo feature flag (M-2) should guard the import.

**Existing mitigations:** None.

---

### M-6: Remove Unused Marked Dependency

**File:** `apps/web/package.json`

**Current state:** `marked` (`^15.0.8`) is listed as a dependency but is **not imported anywhere** in the codebase. Fumadocs uses its own MDX pipeline (remark/rehype) and does not depend on `marked`.

**Risk:** Unused dependency adds attack surface. If `marked` were used in the future without output sanitization, it could enable XSS through malicious markdown.

**Fix:** Remove `marked` from `package.json` entirely. It is unused and not required by any transitive dependency.

**Existing mitigations:** The dependency is not imported, so no current XSS vector exists.

---

### M-7: Email Template Safety

**File:** `apps/api/src/auth/auth.instance.ts:55-89`

**Current state:** Three email templates use template literal interpolation to inject URLs into HTML:

```typescript
html: `<p>Click <a href="${url}">here</a> to reset your password.</p>`
html: `<p>Click <a href="${url}">here</a> to verify your email.</p>`
html: `<p>Click <a href="${url}">here</a> to sign in.</p>`
```

**Risk:** If the `url` parameter contained malicious characters (e.g., `"` or `javascript:`), it could break the HTML structure or inject content into the email.

**Fix:** HTML-escape the `url` before interpolation. Create a minimal `escapeHtml` utility (or use a well-known package) to escape `&`, `<`, `>`, `"`, and `'` characters in the URL string.

**Existing mitigations:** The `url` is generated by better-auth internally and is not user-controlled. The risk is theoretical but defense-in-depth recommends escaping.

## Conclusions

All seven items are straightforward fixes with low implementation risk:

| Item | Severity | Effort | Dependencies |
|------|----------|--------|-------------|
| M-1: CORS validation | Medium | Small | None |
| M-2: Demo feature flag | Medium | Small | Requires Vercel env var setup |
| M-3: Body size limit | Low | Trivial | None |
| M-4: Conditional devtools | Medium | Small | None |
| M-5: Faker to devDeps | Low | Trivial | Verify demo data usage |
| M-6: Remove marked | Low | Trivial | None |
| M-7: Email escaping | Low | Small | None |

**Key decisions made:**
- **Single PR** for all items (small, self-contained changes)
- **M-1**: Reject wildcard in production only, allow in development
- **M-2**: Feature flag (`ENABLE_DEMO`), active in both dev and production (set in Vercel)
- **M-6**: Remove entirely (unused, not needed by Fumadocs)

**No inter-item dependencies** — items can be implemented in any order.

**Note on file references:** The issue references `main.ts` which has since been renamed to `index.ts` (commit `4ef9ad1` — Vercel Fastify entrypoint compatibility).

## Next Steps

- Promote this analysis to a spec for implementation details
- Create implementation plan via `/plan`
- Implement as a single PR in a worktree (Tier L per issue labels)
