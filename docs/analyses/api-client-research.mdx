---
title: API Client Research
description: HTTP client comparison and architecture decisions for frontend-to-backend communication
---

## Context

The frontend (`apps/web`) needs a typed HTTP client to communicate with the NestJS backend (`apps/api`). This is a prerequisite for Auth (#19) and other features connecting frontend to backend.

## HTTP Client Comparison

| Library | Bundle Size | Auto JSON | Error Handling | SSR Support | TypeScript |
|---------|-------------|-----------|----------------|-------------|------------|
| **ofetch** | ~3-4 KB | Yes (`destr`) | `error.data` auto-parsed | Native (Node + browser) | Built-in |
| **ky** | ~3.3 KB | Manual `.json()` | Manual | Node 18+ | Built-in |
| **axios** | ~13 KB | Yes | `error.response.data` | Node + browser | @types |
| **openapi-fetch** | ~2 KB | Yes | Typed from schema | Native fetch | Generated |
| **oRPC** | ~5 KB | Yes | Typed | TanStack Start adapter | Generated |

### Key Considerations

1. **SSR Compatibility**: TanStack Start uses server functions (`createServerFn`) that run on Node.js. The client must work in both Node and browser environments.

2. **Error Body Parsing**: NestJS returns structured error responses. The client should auto-parse these for consistent error handling.

3. **Bundle Size**: Since API calls happen in server functions (not browser), bundle size is less critical than DX.

4. **Type Safety**: Manual types now, auto-generated types later when OpenAPI is adopted.

## Streaming and WebSocket Limitations

### ofetch Issues with SSE

ofetch has known issues with Server-Sent Events (SSE) streaming ([unjs/ofetch#484](https://github.com/unjs/ofetch/issues/484)):
- Response body not properly streamed
- Buffering issues with chunked responses

**Recommendation**: Use native `fetch` for SSE endpoints like `/api/resume-chat`.

### WebSocket Support

OpenAPI specification doesn't support WebSocket definitions. For real-time features:
- Use native `WebSocket` API
- Or socket.io for complex scenarios

## Decision: ofetch for REST

| Communication Type | Solution | Rationale |
|-------------------|----------|-----------|
| REST/JSON | **ofetch** | Auto JSON, error handling, interceptors |
| SSE streaming | Native fetch | ofetch has streaming issues |
| WebSocket | Native/socket.io | OpenAPI doesn't support WS |

### Why Not openapi-fetch Now?

The backend already has Swagger configured (`@nestjs/swagger` v11.2.5), but:
- Only `/health` endpoint exists currently
- DTOs are not yet documented with `@ApiProperty()`
- Benefits are minimal until more endpoints exist

When the API grows, migration to openapi-fetch provides:
- Auto-generated types from OpenAPI spec
- Compile-time validation of API calls
- Single source of truth for API types

## Migration Path to openapi-fetch

### Prerequisites

1. More API endpoints beyond `/health`
2. DTOs documented with `@ApiProperty()` decorators
3. OpenAPI spec exportable (endpoint or build step)

### Migration Steps

```bash
# 1. Install dependencies
cd apps/web
bun add openapi-fetch
bun add -D openapi-typescript

# 2. Generate types from backend spec
bunx openapi-typescript http://localhost:4000/api-json -o src/api/schema.d.ts

# 3. Add to package.json scripts
# "api:types": "openapi-typescript http://localhost:4000/api-json -o src/api/schema.d.ts"
```

```typescript
// 4. Create new client
import createClient from 'openapi-fetch'
import type { paths } from './api/schema'

export const api = createClient<paths>({
  baseURL: process.env.API_URL || 'http://localhost:4000',
})

// 5. Type-safe calls
const { data, error } = await api.GET('/health')
```

### Post-Migration

- Deprecate manual API types in `packages/types`
- Remove ofetch dependency
- Update server functions to use new client

## Related Issues

- **#19**: Auth + Users (Better Auth) - blocked by API client
- **#57**: Public API & API Keys - will use API client
- **#58**: CLI from OpenAPI (AI Agent Interface) - related to openapi-fetch migration

## References

- [ofetch documentation](https://github.com/unjs/ofetch)
- [openapi-fetch documentation](https://openapi-ts.dev/openapi-fetch/)
- [oRPC TanStack Start adapter](https://orpc.dev/docs/adapters/tanstack-start)
- [Type-safe TanStack Query with OpenAPI](https://ruanmartinelli.com/blog/tanstack-query-openapi/)
