---
title: Git Hooks (Pre-commit & Pre-push Quality Gates)
description: Specification for Git hooks configuration with Lefthook - Option C Balanced Approach
status: implemented
---

> **Deprecated**: This document is outdated and kept for historical reference only. Please refer to the main documentation sections for current information.

## Overview

Git hooks configuration using Lefthook following the **Option C: Balanced Approach** from the analysis. This setup provides layered quality gates with fast pre-commit hooks for formatting and comprehensive pre-push validation.

## Goals

- Auto-format staged files on commit (Biome)
- Block pushes if quality gates fail (lint, typecheck, tests)
- Zero configuration for new developers (`bun install` triggers hook setup)
- Leverage TurboRepo caching for fast subsequent runs
- Allow emergency bypass with `--no-verify` (CI is the ultimate enforcement)

## Architecture

### Layered Quality Gates

| Hook | Purpose | Speed Target |
|------|---------|--------------|
| **Pre-commit** | Format staged files with Biome | < 1s |
| **Pre-push** | Full validation (lint, typecheck, test) | < 30s (cached) |

### Tool Choice: Lefthook

**Why Lefthook over Husky:**

1. **Go binary** - No Node.js/Bun PATH issues with version managers
2. **Native parallel execution** - Significantly faster pre-push hooks
3. **Built-in staged file handling** - `{staged_files}` interpolation
4. **`stage_fixed: true`** - Auto-stage formatted files
5. **Single YAML config** - Cleaner than multiple shell scripts

See `docs/analyses/10-git-hooks.mdx` for detailed comparison.

### Test Scope

- **Included:** Unit/integration tests (Vitest)
- **Excluded:** E2E tests (Playwright) - reserved for CI only

Reason: E2E tests are slow (2-5min) and would frustrate developers.

### Bypass Policy

**Allowed with `--no-verify`** for emergencies:
- CI is the ultimate enforcement layer
- Local hooks are a convenience, not a gate
- Developers can bypass when needed (hotfixes, WIP commits)

## Configuration

### 1. Lefthook Setup (`lefthook.yml`)

```yaml
pre-commit:
  parallel: true
  commands:
    biome:
      glob: "*.{js,ts,jsx,tsx,json,jsonc}"
      run: bunx biome check --write --no-errors-on-unmatched --files-ignore-unknown=true {staged_files}
      stage_fixed: true

pre-push:
  parallel: true
  commands:
    lint:
      run: bun run lint
    typecheck:
      run: bun run typecheck
    test:
      run: bun run test
```

### 2. Package.json Scripts

```json
{
  "scripts": {
    "prepare": "lefthook install",
    "typecheck:affected": "turbo run typecheck --filter=...[origin/main]",
    "test:affected": "turbo run test --filter=...[origin/main]"
  }
}
```

The `prepare` script ensures hooks are installed automatically on `bun install`.

### 3. Biome Ignore Update

Add `coverage` folder to `biome.json` ignore list to prevent linting test coverage output.

## Implementation Checklist

- [ ] Install Lefthook (`bun add -D lefthook`)
- [ ] Create `lefthook.yml` at root
- [ ] Add `prepare` script to `package.json`
- [ ] Add `*:affected` scripts for CI alignment
- [ ] Add `coverage` to `biome.json` ignore
- [ ] Test pre-commit with a formatting change
- [ ] Test pre-push with valid code
- [ ] Test pre-push failure (introduce lint error)
- [ ] Test bypass with `--no-verify`
- [ ] Update README with Git Hooks section

## CI Alignment

The same validation runs in CI (GitHub Actions):

```yaml
# .github/workflows/ci.yml
jobs:
  quality:
    steps:
      - run: bun run lint
      - run: bun run typecheck
      - run: bun run test
```

Local hooks and CI execute the same validations, ensuring consistency.

## Edge Cases

### First Push of a Branch

TurboRepo's `--filter=...[origin/main]` handles this gracefully by comparing against the main branch.

### No Changes Detected

TurboRepo skips tasks automatically when cache is valid (no work needed).

### Hook Failure

Clear error output showing which check failed:
```
âŒ Pre-push failed:
   - lint: 2 errors
   - typecheck: passed
   - test: 1 failed

Fix issues and try again.
Use --no-verify to bypass (not recommended).
```

## Success Criteria

- [ ] `bun install` triggers `lefthook install` automatically
- [ ] Pre-commit formats staged files with Biome
- [ ] Pre-commit auto-stages fixed files
- [ ] Pre-push runs lint, typecheck, test in parallel
- [ ] Push blocked if any check fails
- [ ] Validation < 30s for minor changes (with cache)
- [ ] `--no-verify` bypass works for emergencies
- [ ] README documents Git Hooks usage

## Non-Goals

- Complex TurboRepo `--affected` filtering in hooks (kept simple, Option B deferred)
- E2E tests in hooks (CI only)
- Per-developer hook customization
- Commit message linting (not in scope)

## Future Improvements

If pre-push times become problematic, consider upgrading to Option B:
- Add TurboRepo `--affected` flag for incremental validation
- Package-specific `root` configurations in Lefthook

## References

- [Lefthook Documentation](https://github.com/evilmartians/lefthook)
- [Biome Git Hooks Guide](https://biomejs.dev/recipes/git-hooks/)
- [TurboRepo Filtering](https://turbo.build/repo/docs/core-concepts/monorepos/filtering)
- Analysis: `docs/analyses/10-git-hooks.mdx`
- Related: Issue #8 (CI/CD GitHub Actions)
- Related: Issue #18 (Testing Infrastructure)
