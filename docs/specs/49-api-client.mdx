---
title: "API Client (Frontend \u2192 Backend)"
description: Typed HTTP client for frontend-to-backend communication using ofetch
---

> **Deprecated**: This document is outdated and kept for historical reference only. Please refer to the main documentation sections for current information.

## Overview

Setup a typed HTTP client on the frontend (`apps/web`) to communicate with the NestJS backend API (`apps/api`). This is a prerequisite for any feature that connects frontend to backend, starting with Auth (#19).

## Goals

- Provide a configured, typed HTTP client for calling the backend API
- Forward correlation IDs for end-to-end request tracing
- Handle errors in a structured way matching the NestJS error format
- Support SSR via TanStack Start server functions

## Technical Decision

### Library: ofetch

**Why ofetch over alternatives:**

| Criteria | ofetch | ky | native fetch |
|----------|--------|----|--------------|
| SSR support | Native (Node.js + browser) | Node 18+ | Native |
| Auto JSON parsing | Yes (`destr`) | No (manual `.json()`) | No |
| Error body parsing | `error.data` auto-parsed | Manual | Manual |
| Bundle size | ~3-4 KB gzip | ~3.3 KB gzip | 0 KB |
| Interceptors | `onRequest`, `onResponseError` | `beforeRequest`, `afterResponse` | None |

ofetch was chosen for its universal runtime support (critical for TanStack Start SSR), auto JSON parsing (NestJS returns JSON by default), and smart error handling where `error.data` contains the parsed NestJS error body.

### Architecture

```
Browser                     TanStack Start Server           NestJS API
  |                               |                            |
  |-- route loader -------------->|                            |
  |                               |-- createServerFn() ------->|
  |                               |   (uses ofetch instance)   |
  |                               |                            |
  |&lt;-- SSR HTML + data -----------|&lt;-- JSON response ----------|
```

API calls happen inside **server functions** (`createServerFn()`), not directly from the browser. The `API_URL` environment variable is server-side only (no `VITE_` prefix needed).

## Implementation

### Files

| File | Action | Description |
|------|--------|-------------|
| `apps/web/src/lib/api-client.server.ts` | Created | ofetch instance with interceptors |
| `apps/web/src/lib/api-client.test.ts` | Created | Unit tests |
| `packages/types/src/index.ts` | Modified | Added `ApiErrorResponse` type |
| `apps/web/.env.example` | Modified | Added `API_URL` |
| `apps/web/package.json` | Modified | Added `ofetch` dependency |

### API Client (`api-client.server.ts`)

The client exposes:

- **`createApiClient(baseURL)`** &mdash; factory for creating configured ofetch instances
- **`api`** &mdash; default instance using `API_URL` env var (fallback: `http://localhost:3001`)
- **`getApiErrorData(error)`** &mdash; helper to extract typed error data from `FetchError`

Features:
- Automatic `x-correlation-id` header on every request (matches backend interceptor)
- Base URL configurable via `API_URL` environment variable
- Auth header hook ready for future integration (when Auth #19 is implemented)

### Shared Types (`ApiErrorResponse`)

```typescript
type ApiErrorResponse = {
  statusCode: number
  timestamp: string
  path: string
  correlationId: string
  message: string | string[]
}
```

Matches the NestJS `AllExceptionsFilter` error response format exactly.

### Usage Example

```typescript
import { createServerFn } from '@tanstack/react-start'
import { api } from '@/lib/api-client'

const fetchHealth = createServerFn().handler(async () => {
  return api&lt;{ status: string }>('/health')
})
```

## Configuration

| Variable | Location | Default | Description |
|----------|----------|---------|-------------|
| `API_URL` | Server-side env | `http://localhost:3001` | Backend API base URL |

## Dependencies

**Blocks:** #19 (Auth + Users)

## Acceptance Criteria

- [x] HTTP client configured with ofetch
- [x] Base URL configurable via `API_URL` environment variable
- [x] Correlation ID forwarded on every request
- [x] Error responses typed via `ApiErrorResponse`
- [x] Unit tests pass
- [ ] Auth token/cookie automatically included (deferred to #19)
- [x] Works with SSR (server-side via `process.env`)
