---
title: "API Client (Frontend → Backend)"
description: Typed HTTP client for frontend-to-backend communication using ofetch
---

## Overview

Setup a typed HTTP client on the frontend (`apps/web`) to communicate with the NestJS backend API (`apps/api`). This is a prerequisite for any feature that connects frontend to backend, starting with Auth (#19).

## Goals

- Provide a configured, typed HTTP client for calling the backend API
- Forward correlation IDs for end-to-end request tracing
- Handle errors in a structured way matching the NestJS error format
- Support SSR via TanStack Start server functions

## Technical Decision

### Library: ofetch

**Why ofetch over alternatives:**

| Criteria | ofetch | ky | native fetch |
|----------|--------|----|--------------|
| SSR support | Native (Node.js + browser) | Node 18+ | Native |
| Auto JSON parsing | Yes (`destr`) | No (manual `.json()`) | No |
| Error body parsing | `error.data` auto-parsed | Manual | Manual |
| Bundle size | ~3-4 KB gzip | ~3.3 KB gzip | 0 KB |
| Interceptors | `onRequest`, `onResponseError` | `beforeRequest`, `afterResponse` | None |

ofetch was chosen for its universal runtime support (critical for TanStack Start SSR), auto JSON parsing (NestJS returns JSON by default), and smart error handling where `error.data` contains the parsed NestJS error body.

### Scope: REST Only

This API client handles REST endpoints only:

| Communication Type | Solution | Rationale |
|-------------------|----------|-----------|
| REST/JSON | **ofetch** | Auto JSON, error handling, interceptors |
| SSE streaming | Native fetch | ofetch has streaming issues ([#484](https://github.com/unjs/ofetch/issues/484)) |
| WebSocket | Native/socket.io | OpenAPI doesn't support WS |

### Architecture

```
Browser                     TanStack Start Server           NestJS API
  |                               |                            |
  |-- route loader -------------->|                            |
  |                               |-- createServerFn() ------->|
  |                               |   (uses ofetch instance)   |
  |                               |                            |
  |<-- SSR HTML + data -----------|<-- JSON response ----------|
```

API calls happen inside **server functions** (`createServerFn()`), not directly from the browser. The `API_URL` environment variable is server-side only (no `VITE_` prefix needed).

## Implementation

### Files

| File | Action | Description |
|------|--------|-------------|
| `apps/web/src/lib/api-client.server.ts` | Created | ofetch instance with interceptors |
| `apps/web/src/lib/api-client.test.ts` | Created | Unit tests |
| `packages/types/src/index.ts` | Existing | Has `ApiErrorResponse` type |
| `apps/web/package.json` | Modified | Added `ofetch` dependency |

### API Client (`api-client.server.ts`)

The client exposes:

- **`createApiClient(baseURL)`** — factory for creating configured ofetch instances
- **`api`** — default instance using `API_URL` env var (fallback: `http://localhost:4000`)
- **`isFetchError(error)`** — type guard to check if error is a FetchError
- **`getApiErrorData(error)`** — helper to extract typed error data from `FetchError`

Features:
- Automatic `x-correlation-id` header on every request (matches backend interceptor)
- Base URL configurable via `API_URL` environment variable
- Retry logic for transient errors (408, 429, 5xx)
- Auth header hook ready for future integration (when Auth #19 is implemented)

### Shared Types (`ApiErrorResponse`)

```typescript
type ApiErrorResponse = {
  statusCode: number
  timestamp: string
  path: string
  correlationId: string
  message: string | string[]
}
```

Matches the NestJS `AllExceptionsFilter` error response format exactly.

### Usage Example

```typescript
import { createServerFn } from '@tanstack/react-start'
import { api } from '@/lib/api-client.server'

const fetchHealth = createServerFn({ method: 'GET' }).handler(async () => {
  return api<{ status: string }>('/health')
})
```

### Error Handling Example

```typescript
import { createServerFn } from '@tanstack/react-start'
import { api, getApiErrorData, isFetchError } from '@/lib/api-client.server'

const createUser = createServerFn({ method: 'POST' }).handler(async (data) => {
  try {
    return await api('/users', { method: 'POST', body: data })
  } catch (error) {
    const apiError = getApiErrorData(error)
    if (apiError) {
      // Handle structured API error
      console.error(`API Error [${apiError.correlationId}]: ${apiError.message}`)
    }
    throw error
  }
})
```

## Configuration

| Variable | Location | Default | Description |
|----------|----------|---------|-------------|
| `API_URL` | Server-side env | `http://localhost:4000` | Backend API base URL |

## Migration Path to openapi-fetch

When the backend has more endpoints with documented DTOs, migrate to openapi-fetch for auto-generated types:

### Prerequisites

- More API endpoints beyond `/health`
- DTOs documented with `@ApiProperty()` decorators
- OpenAPI spec exportable (endpoint or build step)

### Steps

1. Install dependencies: `bun add openapi-fetch && bun add -D openapi-typescript`
2. Generate types: `bunx openapi-typescript http://localhost:4000/api-json -o src/api/schema.d.ts`
3. Create new client using openapi-fetch
4. Migrate existing API calls
5. Remove ofetch dependency

See [API Client Research](/docs/analyses/api-client-research) for detailed migration guide.

## Dependencies

**Blocks:** #19 (Auth + Users)

## Acceptance Criteria

- [x] HTTP client configured with ofetch
- [x] Base URL configurable via `API_URL` environment variable
- [x] Correlation ID forwarded on every request
- [x] Error responses typed via `ApiErrorResponse`
- [x] Retry logic for transient errors
- [x] Unit tests pass
- [ ] Auth token/cookie automatically included (deferred to #19)
- [x] Works with SSR (server-side via `process.env`)
