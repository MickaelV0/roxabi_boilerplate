---
title: "Pre-Production Security Hardening"
description: Address 7 medium-severity security items from the project audit before production deployment.
---

## Context

The project audit of 2026-02-09 identified seven medium-severity security items (M-1 through M-7) spanning API configuration, frontend hygiene, dependency cleanup, and email safety. These must be addressed before production deployment.

**Promoted from:** [Pre-Production Security Hardening Analysis](../analyses/89-security-hardening.mdx)

**Delivery:** Single PR — all 7 items are small, self-contained fixes with no inter-dependencies.

**Tier:** L (per issue labels — 7 items across multiple packages, though each individual fix is small).

## Goal

Eliminate all medium-severity security findings from the project audit so the application meets baseline production security requirements.

## Users &amp; Use Cases

- **Developers deploying to production** — need confidence that common security misconfigurations are addressed
- **End users** — benefit from defense-in-depth protections (CORS, email safety, no devtools leakage)
- **Boilerplate consumers** — inherit secure defaults when using this as a project template

## Expected Behavior

### Happy path

Each item has a specific, testable outcome:

#### M-1: CORS Wildcard Validation

**File:** `apps/api/src/index.ts`

1. Read `CORS_ORIGIN` env var
2. Split by comma to produce a list of origins (trim whitespace)
3. If `NODE_ENV === 'production'` and any origin is `*`:
   - Log a warning: `"CORS wildcard '*' is not allowed in production. Falling back to no CORS origins."`
   - Reject the wildcard (use an empty origin list or remove `*` from the list)
4. Pass the parsed origin list (string or string[]) to `app.enableCors({ origin })`

**Before:**
```typescript
app.enableCors({
  origin: configService.get<string>('CORS_ORIGIN', 'http://localhost:3000'),
})
```

**After:**
```typescript
const rawOrigins = configService.get<string>('CORS_ORIGIN', 'http://localhost:3000')
const origins = rawOrigins.split(',').map((o) => o.trim()).filter(Boolean)

if (isProduction && origins.includes('*')) {
  logger.warn("CORS wildcard '*' is not allowed in production — ignoring wildcard")
  const safeOrigins = origins.filter((o) => o !== '*')
  app.enableCors({ origin: safeOrigins.length > 0 ? safeOrigins : false })
} else {
  app.enableCors({ origin: origins.length === 1 ? origins[0] : origins })
}
```

#### M-2: Demo Route Protection

**Files:** `apps/web/src/routes/demo/start.server-funcs.tsx`, `apps/web/src/routes/demo/api.tq-todos.ts`, and any other files under `apps/web/src/routes/demo/`

1. Read `VITE_ENABLE_DEMO` environment variable (must use `VITE_` prefix for client-side access in TanStack Start/Vite)
2. If the flag is falsy or not set, demo server functions return 404 responses
3. Demo page components check `import.meta.env.VITE_ENABLE_DEMO` and render nothing (or throw `notFound()`) when disabled

**Implementation approach:**
- Add a shared guard at the top of each demo server function / API handler
- For page routes under `/demo/`, add a `beforeLoad` guard that calls `notFound()` when the flag is disabled
- Default: `VITE_ENABLE_DEMO=true` in `.env` (development) and set explicitly in Vercel env vars for production

#### M-3: Fastify Body Size Limit

**File:** `apps/api/src/index.ts`

Add `bodyLimit` to the `FastifyAdapter` constructor:

```typescript
new FastifyAdapter({
  logger: { level: process.env.LOG_LEVEL || 'debug' },
  bodyLimit: 1_048_576, // 1 MiB — explicit default
})
```

#### M-4: Conditional Devtools

**File:** `apps/web/src/routes/__root.tsx`

Wrap the `&lt;TanStackDevtools>` block in a `DEV` check:

```tsx
{import.meta.env.DEV && (
  <TanStackDevtools
    config={{ position: 'bottom-right' }}
    plugins={[
      { name: 'Tanstack Router', render: <TanStackRouterDevtoolsPanel /> },
      StoreDevtools,
      TanStackQueryDevtools,
    ]}
  />
)}
```

The devtools imports can remain — Vite will tree-shake them out of the production bundle when the condition is statically `false`.

#### M-5: Move Faker to devDependencies

**File:** `apps/web/package.json`

1. Remove `@faker-js/faker` from `dependencies`
2. Add `@faker-js/faker` to `devDependencies`
3. Verify that all faker usage is in demo code gated by `VITE_ENABLE_DEMO` or only used at build time
4. Run `bun install` to update the lockfile

#### M-6: Remove Marked

**File:** `apps/web/package.json`

1. Remove `marked` from `dependencies`
2. Run `bun install` to update the lockfile
3. Verify no import errors (already confirmed: no imports of `marked` in codebase)

#### M-7: Email Template Safety

**File:** `apps/api/src/auth/auth.instance.ts`

1. Add a minimal `escapeHtml` utility (inline in the file or in a shared utils file):

```typescript
function escapeHtml(str: string): string {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
}
```

2. Apply to all three email templates:

```typescript
html: `<p>Click <a href="${escapeHtml(url)}">here</a> to reset your password.</p>`
html: `<p>Click <a href="${escapeHtml(url)}">here</a> to verify your email.</p>`
html: `<p>Click <a href="${escapeHtml(url)}">here</a> to sign in.</p>`
```

### Edge cases

| Scenario | Expected Behavior |
|----------|-------------------|
| `CORS_ORIGIN` is empty string | Fall back to `http://localhost:3000` (default) |
| `CORS_ORIGIN` has trailing commas/spaces | Trim and filter empty entries |
| `CORS_ORIGIN` is `*` in production | Log warning, reject wildcard, use `false` (no CORS) |
| `CORS_ORIGIN` is `*,https://app.com` in prod | Remove `*`, keep `https://app.com` |
| `VITE_ENABLE_DEMO` not set | Demo routes disabled (404) — safe default |
| `VITE_ENABLE_DEMO=true` | Demo routes enabled |
| `VITE_ENABLE_DEMO=false` or `VITE_ENABLE_DEMO=0` | Demo routes disabled (404) |
| Email URL contains `"` or `&lt;` | Escaped by `escapeHtml` before interpolation |
| Email URL is a normal HTTPS URL | No visible change (no characters to escape) |
| Faker imported in production code path | Build error if not in dependencies — demo flag guards this |

## Constraints

- All changes must be backward-compatible with existing `.env` configurations
- `VITE_ENABLE_DEMO` must be added to Vercel env vars for both web projects
- Existing demo functionality must not break when the flag is enabled
- No new runtime dependencies (inline `escapeHtml`, move/remove deps only)

## Non-goals

- Rate limiting or throttling
- WAF or network-level security rules
- Authentication flow changes
- Database security hardening
- New security headers beyond what Helmet already provides
- Comprehensive penetration testing
- OWASP full compliance audit

## Technical Decisions

| Decision | Rationale |
|----------|-----------|
| Single PR for all 7 items | Each fix is small and self-contained; grouping reduces review overhead |
| `VITE_` prefix for demo flag | Required by Vite to expose env vars to client-side code |
| Demo disabled by default | Safer default — must opt-in to demo routes |
| Inline `escapeHtml` | Avoids adding a dependency for 5 lines of code |
| Reject wildcard CORS in prod only | Development convenience vs. production safety |
| Explicit `bodyLimit` matching Fastify default | Documents intent; prevents surprise if Fastify changes defaults |

## Success Criteria

- [ ] M-1: `CORS_ORIGIN=*` in production logs a warning and does not enable wildcard CORS
- [ ] M-1: `CORS_ORIGIN=https://a.com,https://b.com` correctly enables both origins
- [ ] M-2: Demo routes return 404 when `VITE_ENABLE_DEMO` is unset or falsy
- [ ] M-2: Demo routes work normally when `VITE_ENABLE_DEMO=true`
- [ ] M-2: `VITE_ENABLE_DEMO` is set in Vercel env vars
- [ ] M-3: FastifyAdapter has explicit `bodyLimit` configured
- [ ] M-4: TanStack devtools do not render in production builds
- [ ] M-5: `@faker-js/faker` is in `devDependencies` only
- [ ] M-6: `marked` is removed from `package.json`
- [ ] M-7: All email template URLs are HTML-escaped
- [ ] All existing tests pass
- [ ] `bun run typecheck` passes
- [ ] `bun run lint` passes

## Open Questions

- Should `VITE_ENABLE_DEMO` default to `true` in the `.env.example` file, or should it be commented out to encourage explicit configuration?
- For M-5: If faker is used in server-side demo seed scripts that run at deploy time, it needs to remain accessible. Verify all faker usage paths.
