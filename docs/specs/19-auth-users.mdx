---
title: "Auth + Users (Better Auth)"
description: Full-stack authentication and user management with Better Auth, NestJS/Fastify, and TanStack Start
---

# #19 — Auth + Users (Better Auth)

## Context

From the Roxabi vision (Phase 1 MVP): "Auth, billing, multi-tenant: ready out of the box." This spec covers the authentication and user management foundation that all other features depend on.

**Dependency:** #43 Backend Infrastructure (NestJS + Fastify + Drizzle) — **CLOSED**.

**Blocks:** #21 Multi-tenant (RLS), #22 Audit Logs, #23 Notifications, #24 RBAC, #25 Admin Panel.

## Goal

Deliver a complete, production-ready authentication system using Better Auth with:
- Email/password + magic link + OAuth (Google, GitHub)
- Organization (multi-tenant foundation) + admin capabilities
- Session management with cookie caching
- Direct NestJS/Fastify integration (no broken third-party library)
- Reverse proxy for same-origin cookies
- Provider-agnostic email via Resend

## Users & Use Cases

| User | Use Case |
|------|----------|
| New user | Register via email/password, magic link, or OAuth |
| Returning user | Sign in, session persists across visits |
| User with multiple providers | Link Google + GitHub + email to one account |
| User who forgot password | Reset via email link |
| Organization owner | Create org, invite members, manage roles |
| Organization member | Accept invitation, switch between organizations |
| Admin | List/ban/delete users, impersonate, manage sessions |
| API consumer (future) | Authenticated requests to NestJS endpoints |

## Technical Decisions

### 1. Skip `@thallesp/nestjs-better-auth` — Direct Integration

**Problem:** The library is broken on Fastify:
- Issue #53: `req.baseUrl` is Express-only — crashes on every request
- Issue #52: CORS double-registration conflict
- Issue #102: NestJS v11 wildcard routes broken
- Fastify fix PR #65 stalled for months

**Decision:** Build a thin integration layer (~150 lines) directly in NestJS:
- `AuthController` — catch-all forwarding to `auth.handler()`
- `AuthGuard` — global guard using `auth.api.getSession()`
- Decorators: `@Session()`, `@AllowAnonymous()`, `@OptionalAuth()`
- Follows Better Auth's official Fastify integration pattern

### 2. Reverse Proxy for Cookies (Same-Origin)

**Problem:** Frontend (port 3000) and API (port 3001) are different origins. Cross-origin cookies require `SameSite=None` (weakest security).

**Decision:** Proxy `/api/*` from TanStack Start to NestJS:
- **Dev:** Vite/Nitro `routeRules` proxy
- **Prod:** Caddy/Nginx reverse proxy
- Cookies use `SameSite=Lax` (strictest practical setting)
- No CORS complexity for auth

### 3. Resend for Email (with Provider Interface)

**Decision:** Default to Resend (best TypeScript DX, 3K free/month, React Email compatible). Build an `EmailProvider` interface so users can swap to Nodemailer/SES/etc.

### 4. Plural Table Names

**Decision:** `users`, `sessions`, `accounts`, `verifications` — matches SQL conventions and Drizzle patterns. Configured via `usePlural: true` in Drizzle adapter.

### 5. Session Cookie Cache

**Decision:** Enable `cookieCache` with 5-minute TTL and `compact` strategy. Reduces DB queries from every-request to once-per-5-minutes. Signed cookie, `HttpOnly`, `SameSite=Lax`.

**Trade-off:** Session revocation takes up to 5 minutes to propagate.

## Architecture

### System Overview

```
Browser
  │
  ├── GET /login, /register, /reset ──► TanStack Start (SSR pages)
  │
  └── POST /api/auth/* ────────────────► Vite proxy ──► NestJS (port 3001)
                                                          │
                                                    Better Auth handler
                                                          │
                                                    PostgreSQL (Drizzle)
```

### Module Structure (NestJS)

```
AppModule
├── ConfigModule (global)
├── DatabaseModule (global)
├── AuthModule (global)
│   ├── AuthController          # Catch-all /api/auth/*
│   ├── AuthService             # Better Auth instance wrapper
│   ├── AuthGuard               # Global session validation
│   ├── decorators/             # @Session, @AllowAnonymous, @OptionalAuth
│   └── email/
│       ├── email.provider.ts   # EmailProvider interface
│       └── resend.provider.ts  # Resend implementation
├── UserModule
│   ├── UserController          # GET/PATCH /api/users/me
│   └── UserService
└── OrganizationModule          # Handled by Better Auth Organization plugin
```

### Directory Structure (New Files)

```
apps/api/src/
├── auth/
│   ├── auth.module.ts              # AuthModule with Better Auth config
│   ├── auth.controller.ts          # Catch-all /api/auth/* handler
│   ├── auth.service.ts             # Better Auth instance + config
│   ├── auth.guard.ts               # Global AuthGuard
│   ├── auth.instance.ts            # betterAuth() configuration
│   ├── decorators/
│   │   ├── session.decorator.ts    # @Session() param decorator
│   │   ├── allow-anonymous.ts      # @AllowAnonymous() route decorator
│   │   └── optional-auth.ts        # @OptionalAuth() route decorator
│   ├── email/
│   │   ├── email.provider.ts       # EmailProvider interface
│   │   └── resend.provider.ts      # Resend implementation
│   └── auth.*.test.ts              # Tests
├── user/
│   ├── user.module.ts
│   ├── user.controller.ts          # GET/PATCH /api/users/me
│   ├── user.service.ts
│   └── user.*.test.ts
├── database/
│   └── schema/
│       ├── index.ts                # Updated: export auth schema
│       ├── base.ts                 # Existing
│       └── auth.schema.ts          # Generated by Better Auth CLI
```

```
apps/web/
├── src/
│   ├── lib/
│   │   └── auth-client.ts         # Better Auth client instance
│   └── routes/
│       ├── login.tsx               # Minimal login page
│       ├── register.tsx            # Minimal register page
│       └── reset-password.tsx      # Minimal password reset page
```

## Implementation Phases

### Phase 1: Better Auth Core Setup

| Task | Description |
|------|-------------|
| Install packages | `better-auth`, `resend`, `@better-auth/cli` |
| Create `auth.instance.ts` | betterAuth() config with Drizzle adapter, email/password, OAuth, magic link, organization, admin plugins |
| Generate schema | `npx @better-auth/cli generate` → Drizzle schema |
| Run migrations | `bun db:generate && bun db:migrate` |
| Create `AuthService` | Wraps Better Auth instance, injectable |
| Create `AuthModule` | Global module, exports AuthService |

### Phase 2: NestJS Integration Layer

| Task | Description |
|------|-------------|
| Create `AuthController` | `@All('api/auth/*path')` catch-all, builds Fetch Request from Fastify, forwards to `auth.handler()` |
| Disable body parsing for auth routes | Fastify content type parser or raw body handling for auth endpoints |
| Create `AuthGuard` | Global guard, calls `auth.api.getSession()`, sets `request.session` |
| Create decorators | `@Session()`, `@AllowAnonymous()`, `@OptionalAuth()` |
| Register guard globally | In `AuthModule` with `APP_GUARD` |
| Mark health endpoint anonymous | `@AllowAnonymous()` on `AppController.getHealth()` |

### Phase 3: Email Provider

| Task | Description |
|------|-------------|
| Create `EmailProvider` interface | `send(to, subject, html, text?)` |
| Create `ResendProvider` | Implements interface using Resend SDK |
| Wire into Better Auth | `sendVerificationEmail`, `sendResetPassword`, `sendMagicLink` callbacks |
| Add env vars | `RESEND_API_KEY`, `EMAIL_FROM` |

### Phase 4: User Endpoints

| Task | Description |
|------|-------------|
| Create `UserController` | `GET /api/users/me` (session user), `PATCH /api/users/me` (update profile) |
| Create `UserService` | Wraps Better Auth user API |

### Phase 5: Frontend Setup

| Task | Description |
|------|-------------|
| Configure reverse proxy | Vite/Nitro `routeRules` to proxy `/api/*` → `http://localhost:3001` |
| Create `auth-client.ts` | `createAuthClient()` with base URL |
| Create minimal login page | Email/password form + OAuth buttons + magic link |
| Create minimal register page | Name, email, password form + OAuth buttons |
| Create minimal reset password page | Email form → reset link → new password form |

### Phase 6: Tests

| Task | Description |
|------|-------------|
| Unit test `AuthGuard` | Mock session, test public/private/optional routes |
| Unit test `AuthController` | Mock Better Auth handler, verify request/response forwarding |
| Unit test decorators | Verify metadata and param extraction |
| Unit test `ResendProvider` | Mock Resend SDK |
| Unit test `UserController` | GET/PATCH profile |

## Expected Behavior

### Happy Path

1. **Register:** User fills email + password → Better Auth creates user + account + session → cookie set → redirect to app
2. **Login (email/password):** Email + password → session created → cookie set → redirect to app
3. **Login (OAuth):** Click "Sign in with Google" → OAuth redirect → callback → account linked → session → cookie → redirect
4. **Login (magic link):** Enter email → receive link → click → session created → cookie set → redirect to app
5. **Session persistence:** Cookie sent on every request → guard validates → request proceeds
6. **Password reset:** Enter email → receive reset link → click → enter new password → success
7. **Organization:** Create org → invite member by email → member accepts → member sees org
8. **Admin:** Admin lists users → ban user → user session revoked

### Edge Cases

| Scenario | Behavior |
|----------|----------|
| Duplicate email registration | 400 error: "User already exists" |
| OAuth with existing email | Account linked to existing user (if email verified) |
| Invalid session cookie | Guard returns 401, cookie cleared |
| Expired magic link | Error page: "Link expired, request a new one" |
| Rate limit exceeded | 429 with retry-after header |
| Missing RESEND_API_KEY | Console warning in dev, error in production |
| Cookie cache stale after revocation | Max 5-minute delay before session invalidation |
| Organization invite to non-existent user | Invite stored, user creates account then accepts |

## Configuration

### Environment Variables (New)

```bash
# Better Auth
BETTER_AUTH_SECRET=<random-32-char-string>    # Required: signing key
BETTER_AUTH_URL=http://localhost:3001          # API base URL

# OAuth - Google
GOOGLE_CLIENT_ID=                             # Optional: enable Google OAuth
GOOGLE_CLIENT_SECRET=

# OAuth - GitHub
GITHUB_CLIENT_ID=                             # Optional: enable GitHub OAuth
GITHUB_CLIENT_SECRET=

# Email
RESEND_API_KEY=                               # Optional in dev (console fallback)
EMAIL_FROM=noreply@yourdomain.com             # Sender address
```

### Better Auth Configuration

```typescript
import { betterAuth } from 'better-auth';
import { drizzleAdapter } from 'better-auth/adapters/drizzle';
import { organization } from 'better-auth/plugins/organization';
import { admin } from 'better-auth/plugins/admin';
import { magicLink } from 'better-auth/plugins/magic-link';

export const auth = betterAuth({
  basePath: '/api/auth',
  database: drizzleAdapter(db, {
    provider: 'pg',
    usePlural: true,
  }),
  emailAndPassword: {
    enabled: true,
    requireEmailVerification: true,
    sendResetPassword: async ({ user, url }) => { /* email provider */ },
  },
  emailVerification: {
    sendVerificationEmail: async ({ user, url }) => { /* email provider */ },
  },
  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      enabled: !!process.env.GOOGLE_CLIENT_ID,
    },
    github: {
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
      enabled: !!process.env.GITHUB_CLIENT_ID,
    },
  },
  session: {
    expiresIn: 60 * 60 * 24 * 7,  // 7 days
    updateAge: 60 * 60 * 24,       // refresh daily
    cookieCache: {
      enabled: true,
      maxAge: 5 * 60,              // 5 min cache
    },
  },
  plugins: [
    organization(),
    admin(),
    magicLink({
      sendMagicLink: async ({ email, url }) => { /* email provider */ },
    }),
  ],
});
```

### NestJS Auth Controller (Key Pattern)

```typescript
@Controller()
export class AuthController {
  constructor(private readonly authService: AuthService) {}

  @All('api/auth/*path')
  @AllowAnonymous()
  async handleAuth(@Req() req: FastifyRequest, @Res() reply: FastifyReply) {
    const url = new URL(req.url, `http://${req.headers.host}`);
    const headers = new Headers();
    for (const [key, value] of Object.entries(req.headers)) {
      if (value) headers.set(key, String(value));
    }

    const body = req.method !== 'GET' && req.method !== 'HEAD'
      ? JSON.stringify(req.body)
      : undefined;

    const fetchRequest = new Request(url.toString(), {
      method: req.method,
      headers,
      body,
    });

    const response = await this.authService.handler(fetchRequest);

    reply.status(response.status);
    response.headers.forEach((value, key) => reply.header(key, value));
    return reply.send(await response.text());
  }
}
```

### NestJS Auth Guard (Key Pattern)

```typescript
@Injectable()
export class AuthGuard implements CanActivate {
  constructor(private authService: AuthService, private reflector: Reflector) {}

  async canActivate(context: ExecutionContext): Promise&lt;boolean&gt; {
    const isPublic = this.reflector.getAllAndOverride&lt;boolean&gt;('PUBLIC', [
      context.getHandler(), context.getClass(),
    ]);
    if (isPublic) return true;

    const request = context.switchToHttp().getRequest&lt;FastifyRequest&gt;();
    const session = await this.authService.getSession(request);

    request.session = session;
    request.user = session?.user ?? null;

    const isOptional = this.reflector.getAllAndOverride&lt;boolean&gt;('OPTIONAL_AUTH', [
      context.getHandler(), context.getClass(),
    ]);
    if (!session && isOptional) return true;
    if (!session) throw new UnauthorizedException();
    return true;
  }
}
```

### Frontend Proxy Configuration

```typescript
// apps/web/app.config.ts (or vite.config.ts server section)
server: {
  routeRules: {
    '/api/**': { proxy: { to: 'http://localhost:3001/api/**' } }
  }
}
```

## Non-Goals

- Custom auth UI/UX polish (separate issue — headless/minimal pages only)
- Two-factor authentication (2FA/TOTP) — separate issue
- Captcha/bot protection — separate issue
- API keys / bearer tokens — separate issue
- Passkeys (WebAuthn) — separate issue
- SSO (SAML/OIDC enterprise) — separate issue
- Phone/SMS authentication — separate issue

## Database Schema

Generated by `npx @better-auth/cli generate` with organization + admin plugins. Approximate tables:

| Table | Purpose | Key Columns |
|-------|---------|-------------|
| `users` | User accounts | id, name, email, emailVerified, image, role, banned, banReason |
| `sessions` | Active sessions | id, userId, token, expiresAt, ipAddress, userAgent |
| `accounts` | Auth providers | id, userId, accountId, providerId, accessToken, password |
| `verifications` | Email/reset tokens | id, identifier, value, expiresAt |
| `organizations` | Tenants | id, name, slug, logo, metadata |
| `members` | Org membership | id, userId, organizationId, role |
| `invitations` | Pending invites | id, organizationId, email, role, status, expiresAt |

## Success Criteria

- [ ] Users can register with email/password
- [ ] Users can sign in with email/password
- [ ] Users can sign in with magic link
- [ ] OAuth login works (Google, GitHub) when configured
- [ ] Password reset flow sends email and works end-to-end
- [ ] Email verification flow works
- [ ] Sessions persist across page reloads
- [ ] Session cookie cache reduces DB hits (verify via logs)
- [ ] `@AllowAnonymous()` routes are accessible without auth
- [ ] `@Session()` decorator injects session in controllers
- [ ] Global AuthGuard rejects unauthenticated requests with 401
- [ ] `GET /api/users/me` returns authenticated user profile
- [ ] `PATCH /api/users/me` updates user profile
- [ ] Organization CRUD works (create, invite, accept, list members)
- [ ] Admin can list users and ban/unban
- [ ] Better Auth schema migrated to PostgreSQL
- [ ] All new code has unit tests
- [ ] `bun lint && bun typecheck && bun run test` passes
- [ ] Reverse proxy works in development (frontend → API)
- [ ] Minimal login/register/reset pages render and function

## Open Questions

1. **Body parsing for auth routes:** Fastify parses bodies by default. Better Auth expects raw bodies. Need to test whether passing `JSON.stringify(req.body)` works or if we need to disable Fastify body parsing for `/api/auth/*` routes specifically.
2. **Organization plugin + tenant column:** How does the Organization plugin's `organizationId` relate to our existing `tenantId` base column? May need alignment for #21 (RLS).
3. **Magic link + email verification interaction:** If a user signs up via magic link, is their email auto-verified? Need to verify Better Auth's behavior.

## References

- [Better Auth Documentation](https://www.better-auth.com/docs)
- [Better Auth Fastify Integration](https://www.better-auth.com/docs/integrations/fastify)
- [Better Auth Drizzle Adapter](https://www.better-auth.com/docs/adapters/drizzle)
- [Better Auth Organization Plugin](https://www.better-auth.com/docs/plugins/organization)
- [Better Auth Admin Plugin](https://www.better-auth.com/docs/plugins/admin)
- [Better Auth Magic Link Plugin](https://www.better-auth.com/docs/plugins/magic-link)
- [Better Auth Session Management](https://www.better-auth.com/docs/concepts/session-management)
- [Resend Documentation](https://resend.com/docs)
