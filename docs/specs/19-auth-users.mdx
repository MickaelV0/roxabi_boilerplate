---
title: "Auth + Users (Better Auth)"
description: Full-stack authentication and user management with Better Auth, NestJS/Fastify, and TanStack Start
status: implemented
---

## Context

From the Roxabi vision (Phase 1 MVP): "Auth, billing, multi-tenant: ready out of the box." This spec covers the authentication and user management foundation that all other features depend on.

**Dependency:** #43 Backend Infrastructure (NestJS + Fastify + Drizzle) — **CLOSED**.

**Blocks:** #21 Multi-tenant (RLS), #22 Audit Logs, #23 Notifications, #24 RBAC, #25 Admin Panel.

**Analysis:** [docs/analyses/19-auth-users.mdx](../analyses/19-auth-users) — pre-spec research validating technical decisions.

## Goal

Deliver a complete, production-ready authentication system using Better Auth with:
- Email/password + magic link + OAuth (Google, GitHub)
- Organization (multi-tenant foundation) + admin capabilities
- Session management with JWE-encrypted cookie caching
- Direct NestJS/Fastify integration (no broken third-party library)
- Reverse proxy for same-origin cookies
- Provider-agnostic email via Resend
- UUID primary keys on all auth tables
- ESM backend module system

## Users & Use Cases

| User | Use Case |
|------|----------|
| New user | Register via email/password, magic link, or OAuth |
| Returning user | Sign in, session persists across visits |
| User with multiple providers | Link Google + GitHub + email to one account |
| User who forgot password | Reset via email link |
| Organization owner | Create org, invite members, manage roles |
| Organization member | Accept invitation, switch between organizations |
| Admin | List/ban/delete users, impersonate, manage sessions |
| API consumer (future) | Authenticated requests to NestJS endpoints |

## Technical Decisions

### 1. Skip `@thallesp/nestjs-better-auth` — Direct Integration

**Problem:** The library is broken on Fastify:
- Issue #53: `req.baseUrl` is Express-only — crashes on every request
- Issue #52: CORS double-registration conflict
- Issue #102: NestJS v11 wildcard routes broken
- Fastify fix PR #65 stalled for months
- Fastify support marked as "beta" in official docs
- Requires `bodyParser: false` globally — breaks all other routes

**Decision:** Build a thin integration layer (~150 lines) directly in NestJS:
- `AuthController` — catch-all forwarding to `auth.handler()`
- `AuthGuard` — global guard using `auth.api.getSession()`
- Decorators: `@Session()`, `@AllowAnonymous()`, `@OptionalAuth()`, `@Roles()`, `@RequireOrg()`
- Follows Better Auth's official Fastify integration pattern
- Body parsing works with re-serialized JSON (`JSON.stringify(req.body)`) — no need to disable Fastify body parser

### 2. Reverse Proxy + API URL Fix (Same-Origin Cookies)

**Problem:** Frontend (port 3000) and API (port 3001) are different origins. Cross-origin cookies require `SameSite=None` (weakest security). Additionally, the frontend `ofetch` client defaults to `localhost:4000` — mismatched with the backend port.

**Decision:**
- **Reverse proxy:** Proxy `/api/*` from TanStack Start to NestJS
  - **Dev:** Vite/Nitro `routeRules` proxy
  - **Prod:** Caddy/Nginx reverse proxy
- **Fix API_URL default:** Change from `localhost:4000` to `localhost:3001` so server-side `ofetch` calls work without env override
- Cookies use `SameSite=Lax` (strictest practical setting)
- No CORS complexity for auth

### 3. JWE Cookie Cache Strategy

**Decision:** Enable `cookieCache` with 5-minute TTL and `jwe` strategy (encrypted). Session data is encrypted in the cookie — client cannot read session contents.

| Strategy | Size | Security | Readable | Why not |
|----------|------|----------|----------|---------|
| `compact` | Smallest | Signed only | Yes | Session data visible to client |
| `jwt` | Medium | Signed | Yes | No benefit over JWE for our use case |
| **`jwe`** | Largest | **Encrypted** | **No** | **Selected** |

**Trade-off:** Session revocation takes up to 5 minutes to propagate. Slightly larger cookies than compact.

### 4. UUID Primary Keys

**Decision:** All auth tables use UUID primary keys. Better Auth 1.4+ supports this natively.

**Rationale:**
- No sequential ID enumeration (security)
- Globally unique across distributed systems
- Greenfield project — no migration concerns
- Consistent ID strategy for all future tables

### 5. ESM Module System (Phase 0 Migration)

**Problem:** Better Auth 1.4+ is ESM-only. The NestJS backend currently uses CommonJS (`module: CommonJS` in tsconfig).

**Decision:** Migrate the backend to ESM as Phase 0 of this implementation:
- Update `tsconfig.json`: `module: "Node16"` or `"NodeNext"`
- Update `package.json`: `"type": "module"`
- Fix any CommonJS-specific patterns (e.g., `__dirname` → `import.meta.url`)
- Verify NestJS 11 + Fastify 5 work correctly with ESM

### 6. Resend for Email (with Provider Interface)

**Decision:** Default to Resend (best TypeScript DX, 3K free/month, React Email compatible). Build an `EmailProvider` interface so users can swap to Nodemailer/SES/etc.

- **Production:** Resend SDK
- **Development:** Console logging fallback (no API key needed)
- **Tests:** Mocked `EmailProvider` interface — no real API calls in CI

### 7. Plural Table Names

**Decision:** `users`, `sessions`, `accounts`, `verifications` — matches SQL conventions and Drizzle patterns. Configured via `usePlural: true` in Drizzle adapter.

### 8. Five Auth Decorators

| Decorator | Type | Purpose |
|-----------|------|---------|
| `@Session()` | Param | Inject session data into handler parameters |
| `@AllowAnonymous()` | Route | Mark route as public (bypass auth guard) |
| `@OptionalAuth()` | Route | Auth optional — session injected if present, null otherwise |
| `@Roles('admin', 'owner')` | Route | Restrict access to specific roles |
| `@RequireOrg()` | Route | Require active organization context on the request |

## Architecture

### System Overview

```
Browser
  │
  ├── GET /login, /register, /reset ──► TanStack Start (SSR pages)
  │
  └── POST /api/auth/* ────────────────► Vite proxy ──► NestJS (port 3001)
                                                          │
                                                    Better Auth handler
                                                          │
                                                    PostgreSQL (Drizzle)
```

### Module Structure (NestJS)

```
AppModule
├── ConfigModule (global)
├── DatabaseModule (global)
├── AuthModule (global)
│   ├── AuthController          # Catch-all /api/auth/*
│   ├── AuthService             # Better Auth instance wrapper
│   ├── AuthGuard               # Global session validation
│   ├── decorators/             # @Session, @AllowAnonymous, @OptionalAuth, @Roles, @RequireOrg
│   └── email/
│       ├── email.provider.ts   # EmailProvider interface
│       └── resend.provider.ts  # Resend implementation
├── UserModule
│   ├── UserController          # GET/PATCH /api/users/me
│   └── UserService
└── OrganizationModule          # Handled by Better Auth Organization plugin
```

### Directory Structure (New Files)

```
apps/api/src/
├── auth/
│   ├── auth.module.ts              # AuthModule with Better Auth config
│   ├── auth.controller.ts          # Catch-all /api/auth/* handler
│   ├── auth.service.ts             # Better Auth instance + config
│   ├── auth.guard.ts               # Global AuthGuard
│   ├── auth.instance.ts            # betterAuth() configuration
│   ├── decorators/
│   │   ├── session.decorator.ts    # @Session() param decorator
│   │   ├── allow-anonymous.ts      # @AllowAnonymous() route decorator
│   │   ├── optional-auth.ts        # @OptionalAuth() route decorator
│   │   ├── roles.decorator.ts      # @Roles() route decorator
│   │   └── require-org.decorator.ts # @RequireOrg() route decorator
│   ├── email/
│   │   ├── email.provider.ts       # EmailProvider interface
│   │   └── resend.provider.ts      # Resend implementation
│   └── auth.*.test.ts              # Tests
├── user/
│   ├── user.module.ts
│   ├── user.controller.ts          # GET/PATCH /api/users/me
│   ├── user.service.ts
│   └── user.*.test.ts
├── database/
│   └── schema/
│       ├── index.ts                # Updated: export auth schema
│       ├── base.ts                 # Existing
│       └── auth.schema.ts          # Generated by Better Auth CLI
```

```
apps/web/
├── src/
│   ├── lib/
│   │   └── auth-client.ts         # Better Auth client instance
│   └── routes/
│       ├── login.tsx               # Minimal login page
│       ├── register.tsx            # Minimal register page
│       └── reset-password.tsx      # Minimal password reset page
```

## Implementation Phases

### Phase 0: ESM Migration (Backend)

| Task | Description |
|------|-------------|
| Update tsconfig | `module: "Node16"` or `"NodeNext"`, `moduleResolution: "Node16"` |
| Update package.json | Add `"type": "module"` |
| Fix CJS patterns | Replace `__dirname` with `import.meta.url`, fix any `require()` calls |
| Test NestJS + Fastify | Verify all existing functionality works with ESM |
| Run quality checks | `bun lint && bun typecheck && bun run test` |

### Phase 1: Better Auth Core Setup

| Task | Description |
|------|-------------|
| Install packages | `better-auth`, `resend`, `@better-auth/cli` |
| Create `auth.instance.ts` | betterAuth() config with Drizzle adapter, email/password, OAuth, magic link, organization, admin plugins, UUID PKs, JWE cookie cache |
| Generate schema | `npx @better-auth/cli generate` → Drizzle schema (UUID columns) |
| Run migrations | `bun db:generate && bun db:migrate` |
| Create `AuthService` | Wraps Better Auth instance, injectable |
| Create `AuthModule` | Global module, exports AuthService |

### Phase 2: NestJS Integration Layer

| Task | Description |
|------|-------------|
| Create `AuthController` | `@All('api/auth/*path')` catch-all, builds Fetch Request from Fastify, forwards to `auth.handler()` |
| Create `AuthGuard` | Global guard, calls `auth.api.getSession()`, sets `request.session` |
| Create `@Session()` decorator | Param decorator extracting session from request |
| Create `@AllowAnonymous()` | Route decorator setting `PUBLIC` metadata |
| Create `@OptionalAuth()` | Route decorator setting `OPTIONAL_AUTH` metadata |
| Create `@Roles()` | Route decorator for role-based access control |
| Create `@RequireOrg()` | Route decorator requiring active organization context |
| Register guard globally | In `AuthModule` with `APP_GUARD` |
| Mark health endpoint anonymous | `@AllowAnonymous()` on `AppController.getHealth()` |

### Phase 3: Email Provider

| Task | Description |
|------|-------------|
| Create `EmailProvider` interface | `send(to, subject, html, text?)` |
| Create `ResendProvider` | Implements interface using Resend SDK |
| Create `ConsoleEmailProvider` | Development fallback — logs to console |
| Wire into Better Auth | `sendVerificationEmail`, `sendResetPassword`, `sendMagicLink` callbacks |
| Add env vars | `RESEND_API_KEY`, `EMAIL_FROM` |

### Phase 4: User Endpoints

| Task | Description |
|------|-------------|
| Create `UserController` | `GET /api/users/me` (session user), `PATCH /api/users/me` (update profile) |
| Create `UserService` | Wraps Better Auth user API |

### Phase 5: Frontend Setup

| Task | Description |
|------|-------------|
| Configure reverse proxy | Vite/Nitro `routeRules` to proxy `/api/*` → `http://localhost:3001` |
| Fix API_URL default | Update `api-client.server.ts` default from `localhost:4000` to `localhost:3001` |
| Create `auth-client.ts` | `createAuthClient()` with base URL |
| Create auth hooks | `useSession()`, `useSignIn()`, `useSignOut()`, etc. |
| Create minimal login page | Email/password form + OAuth buttons + magic link |
| Create minimal register page | Name, email, password form + OAuth buttons |
| Create minimal reset password page | Email form → reset link → new password form |

> **Note:** Auth UI/UX polish is out of scope — deferred to #68 Auth UI/UX.

### Phase 6: Tests

| Task | Description |
|------|-------------|
| Unit test `AuthGuard` | Mock session, test public/private/optional/roles routes |
| Unit test `AuthController` | Mock Better Auth handler, verify request/response forwarding |
| Unit test decorators | Verify metadata and param extraction for all 5 decorators |
| Unit test `ResendProvider` | Mock Resend SDK |
| Unit test `ConsoleEmailProvider` | Verify console output |
| Unit test `UserController` | GET/PATCH profile |

## Expected Behavior

### Happy Path

1. **Register:** User fills email + password → Better Auth creates user (UUID) + account + session → JWE cookie set → redirect to app
2. **Login (email/password):** Email + password → session created → JWE cookie set → redirect to app
3. **Login (OAuth):** Click "Sign in with Google" → OAuth redirect → callback → account linked → session → cookie → redirect
4. **Login (magic link):** Enter email → receive link → click → session created → JWE cookie set → redirect to app
5. **Session persistence:** Cookie sent on every request → guard validates (JWE cache or DB) → request proceeds
6. **Password reset:** Enter email → receive reset link → click → enter new password → success
7. **Organization:** Create org → invite member by email → member accepts → member sees org
8. **Admin:** Admin lists users → ban user → user session revoked

### Edge Cases

| Scenario | Behavior |
|----------|----------|
| Duplicate email registration | 400 error: "User already exists" |
| OAuth with existing email | Account linked to existing user (if email verified) |
| Invalid session cookie | Guard returns 401, cookie cleared |
| Expired magic link | Error page: "Link expired, request a new one" |
| Rate limit exceeded | 429 with retry-after header (deferred to #53) |
| Missing RESEND_API_KEY | Console fallback in dev, error in production |
| JWE cookie cache stale after revocation | Max 5-minute delay before session invalidation |
| Organization invite to non-existent user | Invite stored, user creates account then accepts |
| `@Roles('admin')` on non-admin user | 403 Forbidden |
| `@RequireOrg()` without active org | 403 Forbidden: "No active organization" |
| Magic link login → emailVerified | DB updated to `true`. Known bug: session response may show `false` ([#6158](https://github.com/better-auth/better-auth/issues/6158)) |

## Configuration

### Environment Variables (New)

```bash
# Better Auth
BETTER_AUTH_SECRET=<random-32-char-string>    # Required: signing + encryption key
BETTER_AUTH_URL=http://localhost:3001          # API base URL

# OAuth - Google
GOOGLE_CLIENT_ID=                             # Optional: enable Google OAuth
GOOGLE_CLIENT_SECRET=

# OAuth - GitHub
GITHUB_CLIENT_ID=                             # Optional: enable GitHub OAuth
GITHUB_CLIENT_SECRET=

# Email
RESEND_API_KEY=                               # Optional in dev (console fallback)
EMAIL_FROM=noreply@yourdomain.com             # Sender address
```

### Better Auth Configuration

```typescript
import { betterAuth } from 'better-auth';
import { drizzleAdapter } from 'better-auth/adapters/drizzle';
import { organization } from 'better-auth/plugins/organization';
import { admin } from 'better-auth/plugins/admin';
import { magicLink } from 'better-auth/plugins/magic-link';

export const auth = betterAuth({
  basePath: '/api/auth',
  database: drizzleAdapter(db, {
    provider: 'pg',
    usePlural: true,
  }),
  advanced: {
    generateId: () => crypto.randomUUID(), // UUID primary keys
  },
  emailAndPassword: {
    enabled: true,
    requireEmailVerification: true,
    sendResetPassword: async ({ user, url }) => { /* email provider */ },
  },
  emailVerification: {
    sendVerificationEmail: async ({ user, url }) => { /* email provider */ },
  },
  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      enabled: !!process.env.GOOGLE_CLIENT_ID,
    },
    github: {
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
      enabled: !!process.env.GITHUB_CLIENT_ID,
    },
  },
  session: {
    expiresIn: 60 * 60 * 24 * 7,  // 7 days
    updateAge: 60 * 60 * 24,       // refresh daily
    cookieCache: {
      enabled: true,
      maxAge: 5 * 60,              // 5 min cache
      strategy: 'jwe',             // encrypted cookie
    },
  },
  plugins: [
    organization(),
    admin(),
    magicLink({
      sendMagicLink: async ({ email, url }) => { /* email provider */ },
    }),
  ],
});
```

### NestJS Auth Controller (Key Pattern)

```typescript
@Controller()
export class AuthController {
  constructor(private readonly authService: AuthService) {}

  @All('api/auth/*path')
  @AllowAnonymous()
  async handleAuth(@Req() req: FastifyRequest, @Res() reply: FastifyReply) {
    const url = new URL(req.url, `http://${req.headers.host}`);
    const headers = new Headers();
    for (const [key, value] of Object.entries(req.headers)) {
      if (value) headers.set(key, String(value));
    }

    const body = req.method !== 'GET' && req.method !== 'HEAD'
      ? JSON.stringify(req.body)
      : undefined;

    const fetchRequest = new Request(url.toString(), {
      method: req.method,
      headers,
      body,
    });

    const response = await this.authService.handler(fetchRequest);

    reply.status(response.status);
    response.headers.forEach((value, key) => reply.header(key, value));
    return reply.send(await response.text());
  }
}
```

### NestJS Auth Guard (Key Pattern)

```typescript
@Injectable()
export class AuthGuard implements CanActivate {
  constructor(private authService: AuthService, private reflector: Reflector) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const isPublic = this.reflector.getAllAndOverride<boolean>('PUBLIC', [
      context.getHandler(), context.getClass(),
    ]);
    if (isPublic) return true;

    const request = context.switchToHttp().getRequest<FastifyRequest>();
    const session = await this.authService.getSession(request);

    request.session = session;
    request.user = session?.user ?? null;

    // Check @OptionalAuth()
    const isOptional = this.reflector.getAllAndOverride<boolean>('OPTIONAL_AUTH', [
      context.getHandler(), context.getClass(),
    ]);
    if (!session && isOptional) return true;
    if (!session) throw new UnauthorizedException();

    // Check @Roles()
    const requiredRoles = this.reflector.getAllAndOverride<string[]>('ROLES', [
      context.getHandler(), context.getClass(),
    ]);
    if (requiredRoles?.length) {
      const userRole = session.user.role ?? 'user';
      if (!requiredRoles.includes(userRole)) throw new ForbiddenException();
    }

    // Check @RequireOrg()
    const requireOrg = this.reflector.getAllAndOverride<boolean>('REQUIRE_ORG', [
      context.getHandler(), context.getClass(),
    ]);
    if (requireOrg && !session.session.activeOrganizationId) {
      throw new ForbiddenException('No active organization');
    }

    return true;
  }
}
```

### Frontend Proxy Configuration

```typescript
// apps/web/app.config.ts (or vite.config.ts server section)
server: {
  routeRules: {
    '/api/**': { proxy: { to: 'http://localhost:3001/api/**' } }
  }
}
```

## Non-Goals

- Auth UI/UX polish — deferred to #68
- Two-factor authentication (2FA/TOTP) — separate issue
- Captcha/bot protection — separate issue
- API keys / bearer tokens — separate issue
- Passkeys (WebAuthn) — separate issue
- SSO (SAML/OIDC enterprise) — separate issue
- Phone/SMS authentication — separate issue
- Rate limiting on auth endpoints — deferred to #53
- Experimental joins (performance) — deferred to #72

## Database Schema

Generated by `npx @better-auth/cli generate` with organization + admin plugins. All tables use **UUID primary keys**.

| Table | Purpose | Key Columns |
|-------|---------|-------------|
| `users` | User accounts | id (UUID), name, email, emailVerified, image, role, banned, banReason |
| `sessions` | Active sessions | id (UUID), userId, token, expiresAt, ipAddress, userAgent |
| `accounts` | Auth providers | id (UUID), userId, accountId, providerId, accessToken, password |
| `verifications` | Email/reset tokens | id (UUID), identifier, value, expiresAt |
| `organizations` | Tenants | id (UUID), name, slug, logo, metadata |
| `members` | Org membership | id (UUID), userId, organizationId, role |
| `invitations` | Pending invites | id (UUID), organizationId, email, role, status, expiresAt |

## Success Criteria

- [ ] Backend runs with ESM module system (Phase 0)
- [ ] Users can register with email/password
- [ ] Users can sign in with email/password
- [ ] Users can sign in with magic link
- [ ] OAuth login works (Google, GitHub) when configured
- [ ] Password reset flow sends email and works end-to-end
- [ ] Email verification flow works
- [ ] Sessions persist across page reloads (JWE cookie cache)
- [ ] `@AllowAnonymous()` routes are accessible without auth
- [ ] `@OptionalAuth()` routes work with or without session
- [ ] `@Session()` decorator injects session in controllers
- [ ] `@Roles()` decorator restricts access by role
- [ ] `@RequireOrg()` decorator requires active organization
- [ ] Global AuthGuard rejects unauthenticated requests with 401
- [ ] `GET /api/users/me` returns authenticated user profile
- [ ] `PATCH /api/users/me` updates user profile
- [ ] Organization CRUD works (create, invite, accept, list members)
- [ ] Admin can list users and ban/unban
- [ ] All auth tables use UUID primary keys
- [ ] Better Auth schema migrated to PostgreSQL
- [ ] All new code has unit tests (mocked email provider)
- [ ] `bun lint && bun typecheck && bun run test` passes
- [ ] Reverse proxy works in development (frontend → API)
- [ ] Minimal login/register/reset pages render and function
- [ ] API_URL default fixed to `localhost:3001`

## Known Issues

1. **Magic link session response bug:** When logging in via magic link after email/password registration, the session response may show `emailVerified: false` even though the database is updated correctly. This is a Better Auth bug ([#6158](https://github.com/better-auth/better-auth/issues/6158)). **Impact:** Cosmetic only — DB is correct, security is unaffected.

2. **Organization + tenant column alignment:** The Organization plugin's `organizationId` and our existing `tenantId` base column serve different purposes. Alignment is deferred to #21 (RLS). For #19, the Organization plugin is set up without modification to `tenantId`.

## References

- [Better Auth Documentation](https://www.better-auth.com/docs)
- [Better Auth Fastify Integration](https://www.better-auth.com/docs/integrations/fastify)
- [Better Auth Drizzle Adapter](https://www.better-auth.com/docs/adapters/drizzle)
- [Better Auth Organization Plugin](https://www.better-auth.com/docs/plugins/organization)
- [Better Auth Admin Plugin](https://www.better-auth.com/docs/plugins/admin)
- [Better Auth Magic Link Plugin](https://www.better-auth.com/docs/plugins/magic-link)
- [Better Auth Session Management](https://www.better-auth.com/docs/concepts/session-management)
- [Better Auth 1.4 Release](https://www.better-auth.com/blog/1-4)
- [Resend Documentation](https://resend.com/docs)
- [Analysis: #19 Auth + Users](../analyses/19-auth-users)
