---
title: "TanStack Start i18n Integration"
description: "Specification for integrating i18n with TanStack Start SSR in Roxabi Boilerplate"
---

> **Deprecated**: This document is outdated and kept for historical reference only. Please refer to the main documentation sections for current information.

## Context

The i18n infrastructure (PR #27) provides translation utilities, hooks, and server-side functions. However, the TanStack Start integration is incomplete:

- `loadTranslations()` in `server.ts` is a placeholder
- No example route demonstrating the integration
- No documentation on wiring i18n context in route loaders
- SSR hydration pattern not implemented

This spec completes the i18n implementation by integrating it with TanStack Start's file-based routing and SSR capabilities.

**Parent spec:** [docs/specs/20-i18n.mdx](./20-i18n)

## Goal

Implement a complete TanStack Start integration for i18n that:

1. Sets up TanStack Start with file-based routing
2. Uses dynamic `[locale]` route prefix pattern
3. Loads translations server-side and hydrates to client
4. Provides a full example route demonstrating all i18n features
5. Includes proper SEO support (hreflang, canonical URLs)

## Users & Use Cases

### Users

- **Developers** building SaaS apps with Roxabi Boilerplate
- **End users** accessing the app in their preferred language

### Use Cases

1. Developer creates a new route needing translations
2. User visits `/dashboard` → redirected to `/en/dashboard` based on browser preference
3. User switches language via LanguageSwitcher → page reloads with new locale in URL
4. Search engines discover and index all language versions via hreflang tags

## Expected Behavior

### Happy Path

1. User visits `/fr/dashboard`
2. Server detects locale `fr` from URL path
3. Route loader calls `loadTranslations('fr', ['common', 'dashboard'])`
4. Server renders HTML with French translations
5. i18n state is dehydrated into router context
6. Client hydrates with same translations (no flash)
7. `useTranslation()` and `useLocale()` hooks work immediately

### Redirect Flow

1. User visits `/dashboard` (no locale prefix)
2. Root route detects locale preference: cookie → Accept-Language → `en`
3. Server returns 302 redirect to `/{detected-locale}/dashboard`
4. User lands on localized route

### Language Switch Flow

1. User clicks LanguageSwitcher to change from `en` to `fr`
2. Cookie is updated with new preference
3. Page navigates to `/fr/...` (same path, different locale)
4. Server renders with French translations

### Edge Cases

| Case | Behavior |
|------|----------|
| Invalid locale in URL (e.g., `/de/dashboard`) | Redirect to `/en/dashboard` (default locale) |
| Missing translation key | Show `[missing: key.name]` in dev, fallback to English in prod |
| Namespace not loaded | Console warning, return empty translations |
| SSR/client mismatch | Prevented by dehydration pattern |
| Direct navigation to localized URL | Works without redirect |

## Technical Design

### File Structure

```
apps/web/
├── app/
│   ├── client.tsx           # Client entry point
│   ├── router.tsx           # Router configuration
│   ├── routeTree.gen.ts     # Generated route tree
│   └── routes/
│       ├── __root.tsx       # Root layout with i18n provider
│       ├── index.tsx        # / → redirect to /{locale}
│       └── [locale]/
│           ├── _layout.tsx  # Locale layout (validates locale)
│           ├── index.tsx    # Home page
│           └── dashboard.tsx # Example i18n route
├── app.config.ts            # TanStack Start configuration
└── lib/
    └── i18n/
        ├── server.ts        # Updated with actual file loading
        ├── context.ts       # NEW: Router context for i18n
        └── seo.ts           # NEW: SEO utilities (hreflang)
```

### Router Context

```tsx
// lib/i18n/context.ts
import type { Locale, Namespace } from './types'

export type I18nRouterContext = {
  locale: Locale
  resources: Record<Namespace, Record<string, unknown>>
  loadNamespaces: (namespaces: Namespace[]) => Promise<void>
}

export function createI18nContext(locale: Locale): I18nRouterContext {
  const resources: Record<Namespace, Record<string, unknown>> = {} as any

  return {
    locale,
    resources,
    loadNamespaces: async (namespaces: Namespace[]) => {
      const loaded = await loadTranslations(locale, namespaces)
      Object.assign(resources, loaded)
    },
  }
}
```

### Root Route

```tsx
// app/routes/__root.tsx
import { Outlet, createRootRouteWithContext } from '@tanstack/react-router'
import { I18nextProvider } from 'react-i18next'
import type { I18nRouterContext } from '@/lib/i18n/context'

type RouterContext = {
  i18n: I18nRouterContext
}

export const Route = createRootRouteWithContext<RouterContext>()({
  component: RootComponent,
})

function RootComponent() {
  return (
    <html>
      <head>
        <meta charSet="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        {/* SEO: hreflang tags injected per route */}
      </head>
      <body>
        <Outlet />
      </body>
    </html>
  )
}
```

### Locale Layout

```tsx
// app/routes/[locale]/_layout.tsx
import { Outlet, createFileRoute, redirect } from '@tanstack/react-router'
import { I18nextProvider } from 'react-i18next'
import { isValidLocale, DEFAULT_LOCALE, createServerI18n } from '@/lib/i18n'

export const Route = createFileRoute('/[locale]')({
  beforeLoad: async ({ params, context }) => {
    const { locale } = params

    // Validate locale, redirect to default if invalid
    if (!isValidLocale(locale)) {
      throw redirect({
        to: '/$locale',
        params: { locale: DEFAULT_LOCALE },
        replace: true,
      })
    }

    // Load common namespace (always needed)
    await context.i18n.loadNamespaces(['common'])
  },
  component: LocaleLayout,
})

function LocaleLayout() {
  const { locale } = Route.useParams()
  // I18nextProvider wraps all locale routes
  return (
    <I18nextProvider i18n={/* hydrated instance */}>
      <Outlet />
    </I18nextProvider>
  )
}
```

### Example Route with Full i18n

```tsx
// app/routes/[locale]/dashboard.tsx
import { createFileRoute } from '@tanstack/react-router'
import { useTranslation, useLocale } from '@/lib/i18n'
import { LanguageSwitcher } from '@/components/LanguageSwitcher'
import { HreflangTags } from '@/lib/i18n/seo'

export const Route = createFileRoute('/[locale]/dashboard')({
  loader: async ({ context }) => {
    // Load route-specific namespace
    await context.i18n.loadNamespaces(['dashboard'])

    // Return any additional loader data
    return {
      stats: { users: 1234, revenue: 56789 },
    }
  },
  head: ({ params }) => ({
    meta: [
      { title: 'Dashboard | Roxabi' },
      // Add hreflang tags for SEO
    ],
  }),
  component: Dashboard,
})

function Dashboard() {
  const { t } = useTranslation('dashboard')
  const { locale, formatNumber, formatCurrency } = useLocale()
  const { stats } = Route.useLoaderData()

  return (
    <div>
      <HreflangTags path="/dashboard" />

      <header>
        <h1>{t('title')}</h1>
        <LanguageSwitcher />
      </header>

      <main>
        <p>{t('welcome_message')}</p>

        <div className="stats">
          <div>
            <span>{t('stats.users')}</span>
            <strong>{formatNumber(stats.users)}</strong>
          </div>
          <div>
            <span>{t('stats.revenue')}</span>
            <strong>{formatCurrency(stats.revenue, 'EUR')}</strong>
          </div>
        </div>
      </main>
    </div>
  )
}
```

### SEO: Hreflang Component

```tsx
// lib/i18n/seo.tsx
import { LOCALES, type Locale } from './types'

type HreflangTagsProps = {
  path: string // Path without locale prefix, e.g., "/dashboard"
}

export function HreflangTags({ path }: HreflangTagsProps) {
  const baseUrl = process.env.PUBLIC_BASE_URL || 'https://example.com'

  return (
    <>
      {LOCALES.map((locale) => (
        <link
          key={locale}
          rel="alternate"
          hrefLang={locale}
          href={`${baseUrl}/${locale}${path}`}
        />
      ))}
      <link
        rel="alternate"
        hrefLang="x-default"
        href={`${baseUrl}/en${path}`}
      />
    </>
  )
}

export function getCanonicalUrl(locale: Locale, path: string): string {
  const baseUrl = process.env.PUBLIC_BASE_URL || 'https://example.com'
  return `${baseUrl}/${locale}${path}`
}
```

### SSR Hydration Strategy

```tsx
// app/router.tsx
import { createRouter } from '@tanstack/react-router'
import { routeTree } from './routeTree.gen'
import { createI18nContext, detectLanguage, DEFAULT_LOCALE } from '@/lib/i18n'

export function createAppRouter() {
  return createRouter({
    routeTree,
    context: {
      i18n: undefined!, // Will be set in server entry
    },
    // Dehydrate i18n resources for client
    dehydrate: () => ({
      i18nResources: router.options.context.i18n.resources,
      i18nLocale: router.options.context.i18n.locale,
    }),
    // Hydrate i18n on client
    hydrate: (dehydrated) => {
      const { i18nResources, i18nLocale } = dehydrated
      // Initialize client i18n with server resources
      initClientI18n(i18nLocale, { [i18nLocale]: i18nResources })
    },
  })
}
```

### Server Entry

```tsx
// app/ssr.tsx (server entry)
import { createAppRouter } from './router'
import { createI18nContext, detectLanguage } from '@/lib/i18n'

export async function handleRequest(request: Request) {
  const url = new URL(request.url)

  // Detect locale from request
  const { locale } = detectLanguage(
    url.pathname,
    request.headers.get('cookie'),
    request.headers.get('accept-language')
  )

  // Create router with i18n context
  const router = createAppRouter()
  router.update({
    context: {
      i18n: createI18nContext(locale),
    },
  })

  // ... render and return response
}
```

### Updated loadTranslations

```tsx
// lib/i18n/server.ts (updated function)
export async function loadTranslations(
  locale: Locale,
  namespaces: Namespace[]
): Promise<Record<Namespace, Record<string, unknown>>> {
  const resources = {} as Record<Namespace, Record<string, unknown>>

  await Promise.all(
    namespaces.map(async (ns) => {
      try {
        // Dynamic import handles by Vite/Vinxi build system
        const module = await import(`../../locales/${locale}/${ns}.json`)
        resources[ns] = module.default
      } catch (error) {
        if (process.env.NODE_ENV === 'development') {
          console.warn(`Failed to load translations: ${locale}/${ns}`, error)
        }
        resources[ns] = {}
      }
    })
  )

  return resources
}
```

## Constraints

### Technical

- Must work with TanStack Start (Vinxi-based)
- Must support full SSR with zero flash
- Must work with Bun runtime
- Dynamic imports must be handled by Vite/Vinxi build system

### Scope

- Only EN and FR locales
- File-based routing only
- No RTL support

## Non-goals

- Locale persistence in user DB profile (handled elsewhere)
- Translation management UI
- Automatic translation detection from code
- Support for more than 2 locales

## Files to Create/Modify

### New Files

| File | Purpose |
|------|---------|
| `apps/web/app.config.ts` | TanStack Start configuration |
| `apps/web/app/client.tsx` | Client entry point |
| `apps/web/app/router.tsx` | Router with i18n context |
| `apps/web/app/routes/__root.tsx` | Root layout |
| `apps/web/app/routes/index.tsx` | Redirect to locale |
| `apps/web/app/routes/[locale]/_layout.tsx` | Locale validation + i18n provider |
| `apps/web/app/routes/[locale]/index.tsx` | Localized home |
| `apps/web/app/routes/[locale]/dashboard.tsx` | Example i18n route |
| `apps/web/lib/i18n/context.ts` | Router context types |
| `apps/web/lib/i18n/seo.tsx` | SEO utilities |

### Modified Files

| File | Changes |
|------|---------|
| `apps/web/lib/i18n/server.ts` | Update `loadTranslations()` with proper imports |
| `apps/web/lib/i18n/index.ts` | Export new modules |
| `apps/web/package.json` | Add TanStack Start dependencies |

### Translation Files

Add dashboard translations for the example route:

```json
// locales/en/dashboard.json
{
  "title": "Dashboard",
  "welcome_message": "Welcome to your dashboard",
  "stats": {
    "users": "Total users",
    "revenue": "Revenue"
  }
}
```

```json
// locales/fr/dashboard.json
{
  "title": "Tableau de bord",
  "welcome_message": "Bienvenue sur votre tableau de bord",
  "stats": {
    "users": "Utilisateurs totaux",
    "revenue": "Revenus"
  }
}
```

## Testing Strategy

### Unit Tests

| Test | File | Description |
|------|------|-------------|
| `loadTranslations` | `lib/i18n/server.test.ts` | Loads correct files, handles missing |
| `createI18nContext` | `lib/i18n/context.test.ts` | Context creation and namespace loading |
| `isValidLocale` | `lib/i18n/server.test.ts` | Validates locale strings |
| `detectLanguage` | `lib/i18n/server.test.ts` | Priority: path → cookie → header → default |
| `HreflangTags` | `lib/i18n/seo.test.tsx` | Generates correct tags for all locales |

### E2E Tests (Playwright)

```ts
// e2e/i18n.spec.ts

test.describe('i18n integration', () => {
  test('redirects / to /en by default', async ({ page }) => {
    await page.goto('/')
    await expect(page).toHaveURL(/\/en$/)
  })

  test('redirects / to /fr with French browser preference', async ({ page, context }) => {
    await context.setExtraHTTPHeaders({
      'Accept-Language': 'fr-FR,fr;q=0.9',
    })
    await page.goto('/')
    await expect(page).toHaveURL(/\/fr$/)
  })

  test('renders French translations on /fr/dashboard', async ({ page }) => {
    await page.goto('/fr/dashboard')
    await expect(page.locator('h1')).toHaveText('Tableau de bord')
  })

  test('renders English translations on /en/dashboard', async ({ page }) => {
    await page.goto('/en/dashboard')
    await expect(page.locator('h1')).toHaveText('Dashboard')
  })

  test('language switcher changes locale', async ({ page }) => {
    await page.goto('/en/dashboard')
    await page.click('[data-testid="language-switcher"]')
    await page.click('[data-testid="locale-fr"]')
    await expect(page).toHaveURL(/\/fr\/dashboard$/)
    await expect(page.locator('h1')).toHaveText('Tableau de bord')
  })

  test('invalid locale redirects to default', async ({ page }) => {
    await page.goto('/de/dashboard')
    await expect(page).toHaveURL(/\/en\/dashboard$/)
  })

  test('SSR renders correct locale (no flash)', async ({ page }) => {
    // Disable JavaScript to verify SSR content
    await page.setJavaScriptEnabled(false)
    await page.goto('/fr/dashboard')
    await expect(page.locator('h1')).toHaveText('Tableau de bord')
  })

  test('hreflang tags are present', async ({ page }) => {
    await page.goto('/en/dashboard')
    const hreflangEn = page.locator('link[hreflang="en"]')
    const hreflangFr = page.locator('link[hreflang="fr"]')
    const hreflangDefault = page.locator('link[hreflang="x-default"]')

    await expect(hreflangEn).toHaveAttribute('href', /\/en\/dashboard$/)
    await expect(hreflangFr).toHaveAttribute('href', /\/fr\/dashboard$/)
    await expect(hreflangDefault).toHaveAttribute('href', /\/en\/dashboard$/)
  })
})
```

## Developer Guide

### Adding Translations to a New Route

1. **Create namespace file** (if needed):
   ```json
   // locales/en/my-feature.json
   { "title": "My Feature" }

   // locales/fr/my-feature.json
   { "title": "Ma fonctionnalité" }
   ```

2. **Register namespace** in `lib/i18n/types.ts`:
   ```ts
   export const NAMESPACES = ['common', 'auth', 'dashboard', 'settings', 'my-feature'] as const
   ```

3. **Load namespace in route loader**:
   ```tsx
   export const Route = createFileRoute('/[locale]/my-feature')({
     loader: async ({ context }) => {
       await context.i18n.loadNamespaces(['my-feature'])
       return {}
     },
     component: MyFeature,
   })
   ```

4. **Use translations in component**:
   ```tsx
   function MyFeature() {
     const { t } = useTranslation('my-feature')
     return <h1>{t('title')}</h1>
   }
   ```

### Adding a New Locale

1. Add locale to `lib/i18n/types.ts`:
   ```ts
   export const LOCALES = ['en', 'fr', 'es'] as const
   ```

2. Create translation files in `locales/es/*.json`

3. Run validation script to ensure all keys exist:
   ```bash
   bun run scripts/validate-translations.ts
   ```

## Success Criteria

- [ ] TanStack Start configured with file-based routing
- [ ] Dynamic `[locale]` route prefix working
- [ ] `loadTranslations()` properly loads JSON files
- [ ] Router context provides i18n to all routes
- [ ] SSR renders correct translations (no flash)
- [ ] Client hydrates without mismatch
- [ ] Redirect from `/` to `/{locale}` based on detection
- [ ] Invalid locale redirects to default
- [ ] Example dashboard route demonstrates all features
- [ ] LanguageSwitcher component works
- [ ] Hreflang tags generated correctly
- [ ] Unit tests pass
- [ ] E2E tests pass
- [ ] Developer guide documented

## Open Questions

- Should we preload adjacent locale translations for instant switching? (Performance vs bundle size trade-off)
- How to handle deep links shared between users with different locales?

## References

- [TanStack Start Documentation](https://tanstack.com/start/latest)
- [TanStack Router File-Based Routing](https://tanstack.com/router/latest/docs/framework/react/guide/file-based-routing)
- [i18next SSR](https://www.i18next.com/overview/getting-started#server-side-rendering)
- [Parent spec: docs/specs/20-i18n.mdx](./20-i18n)
- [GitHub Issue #33](https://github.com/roxabi/roxabi_boilerplate/issues/33)
