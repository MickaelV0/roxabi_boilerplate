---
title: "Code Quality Fixes from Project Audit"
description: "Refactor production and demo code to fix type safety, error handling, and standards violations identified in the project audit."
---

## Context

The [project audit (2026-02-09)](../analyses/project-audit-2026-02-09.mdx) and subsequent specialized agent reviews identified 14 code quality findings across the codebase. Two items (M-8 DocsErrorBoundary, M-12 handleOAuth) have already been fixed. This spec covers the remaining 12 items.

**Promoted from:** [Project Audit — Full Health Check](../analyses/project-audit-2026-02-09.mdx)

## Goal

Resolve all code quality findings from the project audit: eliminate unsafe type casts, remove dead code, enforce coding standards (named exports, `type` over `interface`, no `console.log`/`alert` in committed code), and improve error handling in both production and demo code.

## Users &amp; Use Cases

- **Developers**: Safer types reduce runtime bugs and improve IDE support. Removing dead code reduces confusion.
- **API consumers**: Proper error responses (404 instead of 200-with-null) for missing users.
- **Demo users**: Debug output removed, fetch errors handled gracefully.

## Expected Behavior

### Production-critical items

#### M-9: Remove unused `ApiResponse&lt;T>`

**File:** `packages/types/src/index.ts:14-21`

The `ApiResponse&lt;T>` type allows `data` and `error` simultaneously (not a discriminated union) and is not used by any controller or service. Remove it entirely.

- Delete the `ApiResponse&lt;T>` type export from `packages/types/src/index.ts`.
- Verify no imports reference it (confirmed: only Swagger's `@ApiResponse` decorator appears in grep results, which is unrelated).
- If any import is found, fix it before removing.

#### M-10: Replace `as` casts with type guards

Replace unsafe `as` casts with runtime type guards or proper typing. 12 instances across 6 files:

**Backend (4 casts):**

| File | Line | Current | Fix |
|------|------|---------|-----|
| `auth.guard.ts` | 37 | `as AuthSession \| null` | Type the `getSession()` return properly, or add a type guard `isAuthSession()` |
| `all-exceptions.filter.ts` | 36 | `as { message: string \| string[] }` | Use `typeof` / `in` operator check before accessing `.message` |
| `cors.ts` | 19 | `as string` | Array is guaranteed length 1 at this point; use `safeOrigins[0]!` with non-null assertion or destructure |
| `cors.ts` | 22 | `as string` | Same approach as line 19 |

**Frontend — production (1 cast):**

| File | Line | Current | Fix |
|------|------|---------|-----|
| `org/members.tsx` | 178 | `as 'admin' \| 'member'` | Import `Role` type from `packages/types` and use a type guard, or type the `Select` component's `onValueChange` generically |

**Frontend — demo (7 casts):**

| File | Line | Current | Fix |
|------|------|---------|-----|
| `demo/table.tsx` | 60 | `as RankingInfo` | Add null check: `if (!itemRank) return 0` before comparison |
| `demo/table.tsx` | 61 | `as RankingInfo` | Same as above |
| `demo/table.tsx` | 174 | `as string` | Type `getIsSorted()` return or use a map with proper key typing |
| `design-system/index.tsx` | 653 | `as 'default'` | Type component props properly or use satisfies |
| `design-system/index.tsx` | 676 | `as 'default'`, `as string` | Same approach |
| `design-system/index.tsx` | 690 | `as string` | Narrow prop type at definition |
| `design-system/index.tsx` | 709, 723 | `as string`, `as boolean` | Narrow prop types at definition |

#### M-11: Type the Roles decorator

**Files:**
- `packages/types/src/index.ts` — Add: `export type Role = 'user' | 'admin' | 'superadmin'`
- `apps/api/src/auth/decorators/roles.decorator.ts:3` — Change `string[]` to `Role[]`
- `apps/api/src/auth/auth.guard.ts` — Import `Role`, type the metadata retrieval
- Any DB schema or auth types referencing `role` as `string` — narrow to `Role`

#### M-13: Handle null user profile

**Files:**
- `apps/api/src/user/user.service.ts` — Create and throw `UserNotFoundException` (extending `NotFoundException`) instead of returning `null` from both `getProfile()` (line 27) and `updateProfile()` (line 36).
- `apps/api/src/user/user.controller.ts` — Remove null handling; the service now throws. Controller methods return the user directly.
- Create `apps/api/src/user/exceptions/user-not-found.exception.ts`:

```typescript
import { NotFoundException } from '@nestjs/common'

export class UserNotFoundException extends NotFoundException {
  constructor(userId: string) {
    super(`User ${userId} not found`)
  }
}
```

### Demo / non-critical items

#### N-1: Replace `interface` with `type`

Standards say "use `type` as default". Change `interface` to `type` at:

| File | Line | Current | Change to |
|------|------|---------|-----------|
| `auth.instance.ts` | 18 | `export interface AuthInstanceConfig` | `export type AuthInstanceConfig =` |
| `email.provider.ts` | 3 | `export interface EmailProvider` | `export type EmailProvider =` |
| `database.module.ts` | 18 | `interface JournalEntry` | `type JournalEntry =` |
| `database.module.ts` | 23 | `interface MigrationJournal` | `type MigrationJournal =` |
| `__root.tsx` | 20 | `export interface MyRouterContext` | `export type MyRouterContext =` |

**Note:** `EmailProvider` uses `interface` for a contract — `type` works identically here since no class `implements` it (it uses structural typing).

#### N-2: Remove `let` reassignment of hook value

**File:** `apps/web/src/routes/demo/start.server-funcs.tsx:63`

Change `let todos = Route.useLoaderData()` to `const todos = Route.useLoaderData()`. The reassignment `todos = await addTodo(...)` on line 68 is unnecessary because `router.invalidate()` already triggers a re-fetch of loader data. Remove the reassignment line.

#### N-3: Add error handling to demo fetch calls

**Files:**
- `apps/web/src/routes/demo/tanstack-query.tsx:17` — Add `res.ok` check
- `apps/web/src/routes/demo/tanstack-query.tsx:26` — Add `res.ok` check
- `apps/web/src/routes/demo/start.api-request.tsx:6` — Add `res.ok` check

Pattern:
```typescript
.then((res) => {
  if (!res.ok) throw new Error(`Request failed: ${res.status}`)
  return res.json()
})
```

#### N-4: Extract hardcoded i18n strings

**Files:**
- `apps/web/src/components/Header.tsx:67,147` — "Design System" label
- `apps/web/src/routes/__root.tsx:35-36,87-88` — "Something went wrong", "404", "Page not found"

Extract to a constants object at the top of each file (e.g., `const LABELS = { ... }`). Full i18n integration is out of scope — this just removes inline magic strings and makes future i18n adoption easier.

#### N-5: Disable debug flags

**File:** `apps/web/src/routes/demo/table.tsx:127-128`

Change `debugTable: true` and `debugHeaders: true` to `false` (or remove the properties entirely since they default to `false`).

#### N-6: Remove `console.log` and `alert()` from demo forms

| File | Line | Current | Fix |
|------|------|---------|-----|
| `demo/form/steps.tsx` | 74 | `console.log('Form submitted:', formData)` | Remove the line |
| `demo/form.address.tsx` | 37 | `console.log(value)` | Remove the line |
| `demo/form.address.tsx` | 39 | `alert('Form submitted successfully!')` | Replace with a toast or inline success message, or remove |
| `demo/form.simple.tsx` | 26 | `alert('Form submitted successfully!')` | Same: toast, inline message, or remove |

#### N-7: Replace default export with named export

**File:** `apps/web/src/lib/demo-store-devtools.tsx:55`

Change:
```typescript
export default { name: 'TanStack Store', render: <DevtoolPanel /> }
```
To:
```typescript
export const demoStoreDevtools = { name: 'TanStack Store', render: <DevtoolPanel /> }
```

Update all imports of this module accordingly.

#### N-8: Accessibility gaps in demo pages

| File | Issue | Fix |
|------|-------|-----|
| `demo/table.tsx` | No ARIA labels or sort indicators | Add `aria-sort` to sortable column headers, `aria-label` to filter input |
| `demo/store.tsx` | No input labels | Add `&lt;label>` elements or `aria-label` to inputs |
| `demo/form/steps.tsx:286-298` | Custom toggle missing semantic role | Add `role="switch"` and `aria-checked` to the toggle element |

## Constraints

- All changes must pass existing tests (no regressions).
- `biome check` and `tsc --noEmit` must pass after changes.
- The `Role` type must be defined in `packages/types` (shared) so both frontend and backend can import it.
- Demo code changes should not alter visible UI behavior (except removing debug output and alerts).

## Non-goals

- **Security hardening** — Covered by #89 (rate limiting, helmet, auth secret, etc.)
- **Test coverage** — Test gaps (M-14 through M-19) are separate work items
- **Documentation fixes** — Covered by #92
- **Infrastructure alignment** — Version mismatches, turbo.json, Biome versions are separate items
- **Full i18n system** — N-4 only extracts strings to constants, not a full i18n implementation

## Technical Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| `ApiResponse&lt;T>` | Remove entirely | Confirmed dead code — no usage in any controller or service |
| `Role` type location | `packages/types/src/index.ts` | Shared between frontend (members page) and backend (decorator, guard) |
| `UserNotFoundException` | Domain exception extending `NotFoundException` | Per `backend-patterns.mdx` Section 1.3 |
| N-4 approach | Constants object, not i18n | Minimal change; full i18n is a separate feature (#20) |
| N-6 alert replacement | Remove entirely | Demo forms don't need success feedback for audit purposes; can be added later with toasts |

## Success Criteria

- [ ] No `ApiResponse` type in `packages/types` (M-9)
- [ ] Zero `as` type casts in production code (`apps/api/`, `apps/web/src/routes/org/`) (M-10 partial)
- [ ] `as` casts in demo/design-system code replaced with proper typing (M-10 remainder)
- [ ] `Role` type exported from `packages/types` and used in decorator, guard, and member page (M-11)
- [ ] `GET /api/users/profile` returns 404 (not 200-with-null) when user not found (M-13)
- [ ] No `interface` keyword in the 4 flagged files (N-1)
- [ ] No `let` reassignment of hook data in `start.server-funcs.tsx` (N-2)
- [ ] All demo fetch calls check `res.ok` (N-3)
- [ ] No inline string literals in Header/root error boundary (N-4)
- [ ] `debugTable` and `debugHeaders` are `false` or removed (N-5)
- [ ] No `console.log` or `alert()` in demo form files (N-6)
- [ ] No default exports in `demo-store-devtools.tsx` (N-7)
- [ ] ARIA attributes added to demo table, store, and form toggle (N-8)
- [ ] All existing tests pass
- [ ] `biome check` and `tsc --noEmit` pass

## Open Questions

- **M-10 design-system casts**: The design system page has many `as` casts for component prop previews. If typing these properly requires significant refactoring of the preview system, consider leaving a `// TODO` with a link to a follow-up issue instead.
- **N-8 depth**: Accessibility improvements can range from minimal (add `aria-label`) to thorough (keyboard navigation, screen reader testing). This spec targets minimal ARIA attributes only.
