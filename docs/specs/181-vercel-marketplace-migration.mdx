---
title: "Migrate to Vercel Marketplace Integrations"
description: Spec for migrating Neon, Resend, and Upstash to Vercel Marketplace integrations with auto-injected environment variables
---

## Context

Roxabi Boilerplate uses three external services — **Neon** (PostgreSQL), **Resend** (transactional emails), and **Upstash Redis** (rate limiting) — all configured as manual environment variables in Vercel. The [analysis](../analyses/181-vercel-marketplace-migration) evaluated migrating to Vercel Marketplace integrations and recommended:

- **Upstash Redis**: Already integrated — verify and document
- **Resend**: Install marketplace integration (env var name matches exactly)
- **Neon**: Use **Option C (hybrid)** — integration for production `DATABASE_URL` auto-injection, keep custom GitHub Actions workflow for preview database branches
- **postgres.js driver**: Keep as-is (no benefit from switching to `@neondatabase/serverless` on Node.js runtime)

**Promoted from:** [Vercel Marketplace Integration Migration Analysis](../analyses/181-vercel-marketplace-migration)

**GitHub Issue:** [#181](https://github.com/MickaelV0/roxabi_boilerplate/issues/181)

## Goal

Migrate Neon and Resend to Vercel Marketplace integrations, verify existing Upstash integration, and update all documentation — reducing fork-user manual setup by ~36% (11 manual env vars to 7 manual + 4 auto-injected).

## Users &amp; Use Cases

| User | Use Case |
|------|----------|
| **Fork user (new setup)** | Follows getting-started guide, installs marketplace integrations instead of manual `vercel env add` for DATABASE_URL, RESEND_API_KEY |
| **Fork user (existing setup)** | Migrates from manual env vars to integrations following migration guide |
| **Maintainer** | Manages production env vars via Vercel dashboard integrations panel |
| **CI/CD (preview deploys)** | GitHub Actions workflow continues using custom Neon branching with `--env` override |

## Expected Behavior

### Phase 0 — Prerequisites and Staging Validation

Before installing any new integration, validate assumptions on a low-risk target:

1. **Production database initialized**: Verify production Neon database has tables (run `DATABASE_URL="<prod>" bun run db:migrate` locally — if it fails with "relation 'users' does not exist", run `bunx drizzle-kit push --force` first). This is a prerequisite for the Neon integration to work.
2. **Test env var precedence**: Using the existing Upstash integration (already installed), temporarily add a manual `KV_REST_API_URL` via `vercel env add` and check which value the runtime sees. Document the precedence behavior, then remove the test var.
3. **Verify `--env` override**: Confirm that `vercel deploy --env "KEY=value"` overrides integration-injected vars by testing with a non-destructive variable.
4. **Verify `previewDeploymentsDisabled` is active**: Run `curl -s -H "Authorization: Bearer $TOKEN" "https://api.vercel.com/v9/projects/$PROJECT_ID?teamId=$TEAM_ID" | jq .previewDeploymentsDisabled` — must return `true`. Integration installs must not re-enable automatic previews.

**Gate:** Do not proceed to Phase 2 until precedence and override behavior are documented.

### Phase 1 — Verify Upstash Integration

1. Confirm Upstash Redis integration is active on the API Vercel project via the integrations panel at `vercel.com/<team>/~/integrations`
2. Verify `KV_REST_API_URL` and `KV_REST_API_TOKEN` appear in `vercel env ls` for all three scopes (production, preview, development)
3. Confirm no duplicate manual env vars exist alongside integration-injected ones. If duplicates found, remove the manual vars: `vercel env rm KV_REST_API_URL production` and redeploy
4. Document verification steps in deployment guide

### Phase 2 — Install Resend Integration

1. Install Resend integration via Vercel Marketplace dashboard (`vercel.com/marketplace/resend`), link to API project
2. Trigger a redeploy for the integration-injected env var to take effect: `vercel redeploy <latest-deployment-url>`
3. Verify `RESEND_API_KEY` is injected for all environments: `cd apps/api && vercel env ls | grep RESEND`
4. Confirm env var precedence matches Phase 0 findings (integration-injected vs manual coexistence)
5. Send a test email from the production deployment (e.g., trigger a password reset via `/api/auth/forgot-password`) to confirm the API key works
6. Remove the manual `RESEND_API_KEY` env var if it coexists: `vercel env rm RESEND_API_KEY production`
7. Update deployment docs to replace `vercel env add RESEND_API_KEY` with integration install steps

**Rollback trigger:** If test email fails in step 5, uninstall the integration and re-add the manual env var: `vercel env add RESEND_API_KEY production`

### Phase 3 — Install Neon Integration (Hybrid)

1. Install Neon integration via Vercel Marketplace dashboard (`vercel.com/marketplace/neon`), link to API project
2. Verify `DATABASE_URL` is injected: `cd apps/api && vercel env ls production | grep DATABASE_URL`
   - The integration may also inject into preview and development scopes — this is expected and harmless
   - Preview scope: overridden by `deploy-preview.yml` workflow's `--env` flag
   - Development scope: unused (local dev reads `.env` files, not Vercel project env vars)
3. Inspect the injected connection string format:
   - Run `vercel env pull .env.vercel && grep DATABASE_URL .env.vercel` to inspect the value
   - Expected format: `postgresql://&lt;user&gt;:&lt;pass&gt;@ep-xxx-pooler.&lt;region&gt;.aws.neon.tech/&lt;db&gt;?sslmode=require`
   - If the endpoint does not include `-pooler.`, the integration is injecting a direct connection — verify this is acceptable or adjust in Neon console
   - If `?sslmode=require` is missing, contact Neon support or add via manual env var override
   - Delete `.env.vercel` after inspection (contains secrets)
4. Trigger a redeploy: `vercel redeploy <latest-deployment-url>`
5. Test the production deployment: verify `/api/health` returns 200 and confirm DB connectivity via deployment logs (`vercel logs <url>`)
6. Verify `previewDeploymentsDisabled` is still `true` (integration install must not re-enable automatic previews)
7. Verify the `deploy-preview.yml` workflow still works — trigger a preview deploy and confirm the `--env "DATABASE_URL=$DATABASE_URL"` override takes precedence (preview should connect to its isolated Neon branch, not production)
8. Remove the manual `DATABASE_URL` env var from the production environment: `vercel env rm DATABASE_URL production`
9. Add a comment in `deploy-preview.yml` above the `--env "DATABASE_URL=$DATABASE_URL"` line in the "Deploy API preview" step explaining the override is intentional even with the Neon integration installed

**Rollback trigger:** If production deploy fails with database connection errors in step 5, re-add the manual env var (`vercel env add DATABASE_URL production`) and redeploy. Estimated rollback time: &lt;5 minutes.

### Phase 4 — Documentation Updates

Update these documents to reflect the new integration-based setup:

**`docs/guides/deployment.mdx`:**
- Replace manual `vercel env add DATABASE_URL` steps with Neon integration install instructions
- Replace manual `vercel env add RESEND_API_KEY` steps with Resend integration install instructions
- Add verification steps for all three integrations (Upstash, Resend, Neon)
- Document the hybrid approach: Neon integration owns production env vars, GitHub Actions workflow owns preview branches
- Add a "Credential Rotation" section: production `DATABASE_URL` auto-rotates via Neon integration (no manual action), preview workflow secrets (`NEON_API_KEY`, `NEON_PROJECT_ID`) require manual rotation in GitHub Settings &rarr; Secrets
- Add troubleshooting section for common integration issues (env var not showing &rarr; redeploy required, manual var conflicts &rarr; remove manual var, preview pointing to production DB &rarr; check `--env` override in workflow)

**`docs/configuration.mdx`:**
- Update the API project env var table to indicate which vars are auto-injected by marketplace integrations vs manually configured
- Add notes for `DATABASE_URL`, `RESEND_API_KEY`, `KV_REST_API_URL`, `KV_REST_API_TOKEN`
- **No `turbo.jsonc` changes needed** — wildcard patterns (`KV_*`, `REDIS_*`) already cover marketplace-injected Upstash vars, and `DATABASE_URL` is a passThroughEnv in `apps/api/turbo.json` (runtime secret, not build cache)

**`.env.example`:**
- Update comments to mark auto-injected vars (e.g., `# Auto-injected by Vercel Marketplace integration — manual setup only needed for local dev`)

**`docs/getting-started.mdx`** (if fork checklist exists):
- Simplify the fork setup flow to reference marketplace integrations for Neon, Resend, Upstash

**`.github/workflows/deploy-preview.yml`:**
- Add a comment above `--env "DATABASE_URL=$DATABASE_URL"` explaining the intentional override

### Edge cases

| Scenario | Handling |
|----------|----------|
| Manual env var coexists with integration-injected var | Remove the manual var after verifying integration works. Integration-injected vars appear with a badge in the Vercel dashboard. |
| Neon integration injects `DATABASE_URL` for preview scope | Harmless — the `deploy-preview.yml` workflow's `--env` flag overrides it at deploy time |
| Neon injects extra `POSTGRES_*` vars we don't use | Harmless — code only reads `DATABASE_URL`. Ignore extra vars. |
| Fork user hasn't initialized production database | Prerequisite: run `drizzle-kit push --force` against production before first deploy (already documented in deployment guide) |
| Integration install fails mid-setup | Uninstall and retry, or fall back to manual `vercel env add`. No code changes needed. |
| Neon credential rotation | Production auto-rotates via integration. Preview workflow secrets (`NEON_API_KEY`, `NEON_PROJECT_ID`) still require manual rotation. |

## Constraints

- **No code changes** — this is purely infrastructure and documentation. The application reads standard env var names regardless of source.
- **No driver change** — keep postgres.js. No need to switch to `@neondatabase/serverless`.
- **Preview deploys stay disabled** — automatic Vercel preview deployments remain disabled at the project level. Manual preview deploys via GitHub Actions workflow are unchanged.
- **Custom preview workflow preserved** — `deploy-preview.yml` continues to manage Neon preview branches via the Neon API. The `--env` override is preserved and documented.
- **Local development unchanged** — marketplace integrations only inject into Vercel environments. Local `.env` files remain manual.
- **Devops agent executes** — all Vercel CLI operations and integration installs are delegated to the devops agent per project rules.

## Non-goals

- Re-enabling Vercel automatic preview deploys (Option B from analysis)
- Switching to `@neondatabase/serverless` driver
- Migrating OAuth provider credentials (Google, GitHub) to marketplace integrations (none available)
- Migrating AI API keys (OpenAI, Anthropic) to marketplace integrations (none available)
- Automating Neon API key rotation for the preview workflow

## Technical Decisions

| Decision | Rationale |
|----------|-----------|
| **Option C (hybrid) for Neon** | Auto-branching only triggers on Vercel's built-in preview system, not CLI `vercel deploy`. Re-enabling auto-previews would reintroduce rate-limit issues. Hybrid gives production simplification without touching the preview workflow. |
| **Keep postgres.js** | We run on Vercel Functions (Node.js), not Edge. Serverless driver provides no benefit. Revisit if migrating to Edge. |
| **Phased rollout** | Verify Upstash first (zero risk), then Resend (low risk), then Neon (medium risk). Each phase can be validated independently. |
| **Rollback via manual env vars** | If any integration causes issues: uninstall &rarr; `vercel env add` &rarr; redeploy. No code changes. |

## Success Criteria

- [ ] Env var precedence behavior documented (Phase 0 — integration vs manual coexistence)
- [ ] `--env` CLI override confirmed working over integration-injected vars (Phase 0)
- [ ] `previewDeploymentsDisabled` remains `true` after all integration installs
- [ ] Upstash Redis integration verified in all three scopes (production/preview/development) via `vercel env ls`
- [ ] Resend integration installed; `RESEND_API_KEY` auto-injected; test email from production returns 200
- [ ] Neon integration installed; production `DATABASE_URL` auto-injected; `/api/health` returns 200 with valid DB connection
- [ ] Neon `DATABASE_URL` format verified (pooled endpoint, `?sslmode=require`)
- [ ] Preview deploy workflow (`deploy-preview.yml`) creates isolated Neon branches; preview `DATABASE_URL` points to branch, not production
- [ ] `deploy-preview.yml` has a comment documenting the intentional `--env` override
- [ ] `deployment.mdx` updated with integration-based setup, credential rotation section, and troubleshooting
- [ ] `configuration.mdx` updated to indicate auto-injected vs manual env vars
- [ ] `.env.example` comments updated to mark auto-injected vars
- [ ] Fork setup checklist simplified with marketplace integration steps
- [ ] No manual `DATABASE_URL` or `RESEND_API_KEY` env vars remain in production (replaced by integration)
- [ ] GitHub Actions secrets (`NEON_API_KEY`, `NEON_PROJECT_ID`) verified still valid after integration install

## Open Questions

- **Env var precedence:** When a manual env var coexists with an integration-injected one, which takes precedence at runtime? **Must be answered in Phase 0** before proceeding to Phases 2-3.
- **Connection string format:** Does the Neon integration inject a pooled or direct connection string by default? **Must be verified in Phase 3 step 3** before removing the manual `DATABASE_URL`.
- **Future Option B re-evaluation:** If Vercel increases preview deploy rate limits or adds rate-limit controls, Option B (full integration with auto-branching) could eliminate the custom workflow entirely. Monitor Vercel changelog.
