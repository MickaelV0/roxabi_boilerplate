---
title: "Migrate i18n from i18next to Paraglide JS"
description: "Replace runtime i18next with compile-time Paraglide JS for type-safe, lighter i18n with first-class TanStack Start support"
---

> **Deprecated**: This document is outdated and kept for historical reference only. Please refer to the main documentation sections for current information.

# Migrate i18n from i18next to Paraglide JS

## Context

The current i18n implementation (specs [#20](/docs/specs/20-i18n), [#33](/docs/specs/33-tanstack-start-i18n-integration)) uses i18next with react-i18next. PR #63 fixed immediate issues (preload guard, hydration loop, `&lt;html lang>`), but revealed architectural limitations:

1. **SSR cookie access**: `document.cookie` is always `null` during SSR — the current code silently falls back to path/default detection, losing cookie-persisted preferences on first render
2. **`$locale` route param pollution**: Every route must nest under `/$locale`, adding boilerplate and complexity to route definitions
3. **Runtime overhead**: i18next ships ~40-50KB of parsing/formatting engine to the client
4. **No type-safe keys**: Translation keys are plain strings — typos only caught at runtime
5. **Manual instance management**: `createInstance()`/`cloneInstance()` per request for SSR isolation

**Paraglide JS** (by inlang) solves all of these by compiling translations at build time into typed JS functions.

## Goals

1. Replace i18next/react-i18next with Paraglide JS
2. Eliminate `$locale` route param — use TanStack Router rewrite API instead
3. Fix SSR locale detection via `paraglideMiddleware()` (AsyncLocalStorage-based)
4. Achieve type-safe translation keys with compile-time validation
5. Reduce i18n bundle size by ~70%

## Non-Goals

- Changing the supported locales (`en`, `fr`) — same set carries over
- Migrating translation content — existing JSON keys/values are preserved in Paraglide format
- Adding new languages in this PR

## Version Requirements

| Package | Minimum | Recommended | Notes |
|---------|---------|-------------|-------|
| `@inlang/paraglide-js` | `^2.7.2` | `^2.9.x` (latest) | v2.7.2 fixes redirect loop bug ([TanStack/router#6089](https://github.com/TanStack/router/issues/6089)) |
| `@tanstack/react-start` | `^1.142.7` | `^1.158.0` | Fixes underlying srvx Request compatibility |
| `@tanstack/react-router` | `^1.142.7` | `^1.158.0` | Must match react-start version |

> **Critical**: Paraglide v2.7.0 with TanStack Start v1.141.2–1.141.7 causes `ERR_TOO_MANY_REDIRECT` due to a Request cloning bug in `paraglideMiddleware`. Both sides have applied fixes. Pin to the minimum versions above.

## Technical Design

### Architecture Overview

```
Build Time                          Runtime (SSR)                        Runtime (Client)
┌──────────────┐                   ┌──────────────────────┐             ┌─────────────────┐
│ messages/    │  Vite plugin      │ paraglideMiddleware  │             │ getLocale()     │
│  en.json     │ ─────────────►   │  ├─ AsyncLocalStorage│             │  reads cookie   │
│  fr.json     │  compiles to     │  ├─ detect locale    │             │                 │
│              │  typed functions  │  └─ set on request   │             │ m.greeting()    │
└──────────────┘                   └──────────┬───────────┘             │  returns string │
       │                                      │                         └─────────────────┘
       ▼                                      ▼
┌──────────────┐                   ┌──────────────────────┐
│ paraglide/   │                   │ TanStack Router      │
│  messages.js │                   │  rewrite.input()     │
│  runtime.js  │                   │   deLocalizeUrl()    │
│  server.js   │                   │  rewrite.output()    │
└──────────────┘                   │   localizeUrl()      │
                                   └──────────────────────┘
```

### 1. Vite Plugin Configuration

> **Plugin order**: `paraglideVitePlugin` MUST be placed BEFORE `tanstackStart()` and `react()`. The Paraglide plugin needs to intercept module resolution before other plugins process the code.

```typescript
// apps/web/vite.config.ts
import { paraglideVitePlugin } from '@inlang/paraglide-js'
import tailwindcss from '@tailwindcss/vite'
import { tanstackStart } from '@tanstack/react-start/plugin/vite'
import react from '@vitejs/plugin-react'
import mdx from 'fumadocs-mdx/vite'
import tsConfigPaths from 'vite-tsconfig-paths'

export default defineConfig({
  server: { port: 3000 },
  plugins: [
    // Paraglide MUST be first
    paraglideVitePlugin({
      project: './project.inlang',
      outdir: './src/paraglide',
      outputStructure: 'message-modules', // enables tree-shaking per message
      strategy: ['url', 'cookie', 'preferredLanguage', 'baseLocale'],
      cookieName: 'locale', // matches existing LOCALE_COOKIE_NAME
      urlPatterns: [
        // Specific routes first — wildcard MUST be last (opral/paraglide-js#548)
        { pattern: '/', localized: [['en', '/en'], ['fr', '/fr']] },
        { pattern: '/dashboard', localized: [['en', '/en/dashboard'], ['fr', '/fr/dashboard']] },
        // NOTE: /docs/* is NOT localized — Fumadocs routes are excluded
        { pattern: '/:path(.*)?', localized: [['en', '/en/:path(.*)?'], ['fr', '/fr/:path(.*)?']] },
      ],
    }),
    tanstackStart(),
    react(),
    mdx(await import('./source.config')),
    tailwindcss(),
    tsConfigPaths({ projects: ['./tsconfig.json'] }),
  ],
})
```

### 2. Server Middleware (SSR Locale Detection)

> **New file**: `apps/web/src/server.ts` does not exist yet — TanStack Start auto-generates the server entry. This file must be **created** to intercept requests with Paraglide middleware.

```typescript
// apps/web/src/server.ts (NEW FILE)
import { paraglideMiddleware } from './paraglide/server.js'
import handler from '@tanstack/react-start/server-entry'

export default {
  fetch(req: Request): Promise&lt;Response> {
    // IMPORTANT: Pass the original `req` to handler.fetch(), NOT the middleware's
    // modified `request`. This avoids the Request cloning bug (TanStack/router#6089)
    // where undici cannot access private #state fields from TanStack's Request wrapper.
    return paraglideMiddleware(req, () => handler.fetch(req))
  },
}
```

This replaces the current `document.cookie` approach. The middleware:
1. Detects locale using the configured strategy chain (url → cookie → preferredLanguage → baseLocale)
2. Creates an `AsyncLocalStorage` context with the detected locale
3. Runs the handler inside this context — `getLocale()` and `m.key()` automatically resolve to the correct locale
4. Sets a locale cookie on the response for persistence

### 3. URL Rewriting (Replace `$locale` Param)

```typescript
// apps/web/src/router.tsx
import { deLocalizeUrl, localizeUrl } from './paraglide/runtime'

const router = createRouter({
  routeTree,
  rewrite: {
    input: ({ url }) => deLocalizeUrl(url),   // /fr/dashboard → /dashboard
    output: ({ url }) => localizeUrl(url),     // /dashboard → /fr/dashboard
  },
})
```

This eliminates the `$locale` route param entirely. Routes become clean:
- `routes/index.tsx` (was `routes/$locale/index.tsx`)
- `routes/dashboard.tsx` (was `routes/$locale/dashboard.tsx`)

### 4. Component Usage

```typescript
// Before (i18next)
import { useTranslation } from 'react-i18next'

function Dashboard() {
  const { t } = useTranslation('dashboard')
  return <h1>{t('welcome')}</h1>
}

// After (Paraglide)
import { m } from '@/paraglide/messages'

function Dashboard() {
  return <h1>{m.dashboard_welcome()}</h1>
}
```

Key differences:
- **No hooks needed** — `m.key()` is a plain function call
- **Type-safe** — `m.nonexistent_key()` is a compile error
- **Tree-shaken** — unused messages are stripped from the bundle
- **No namespaces** — flat key structure with prefixes (e.g., `dashboard_welcome`)

### 5. Language Switching

> **Note**: In Paraglide v2, `setLocale()` triggers a **page reload** by design. This eliminates the need for React context providers and adapters — the page re-renders with the new locale from the server.

```typescript
// Before
import { changeLanguage } from '@/lib/i18n/client'
changeLanguage('fr') // sets cookie + window.location.href

// After
import { setLocale, localizeUrl } from '@/paraglide/runtime'

function LanguageSwitcher() {
  return (
    <button onClick={() => {
      setLocale('fr')
      window.location.href = localizeUrl(window.location.href)
    }}>
      Français
    </button>
  )
}
```

### 6. Locale Formatting Utilities

The current `useLocale()` hook provides `formatDate`, `formatNumber`, `formatCurrency` using the `Intl` API. Paraglide does **not** provide formatting utilities — these must be preserved as a standalone hook.

```typescript
// apps/web/src/lib/locale-utils.ts (extracted from lib/i18n/hooks.ts)
import { getLocale } from '@/paraglide/runtime'

export function useLocaleFormatters() {
  const locale = getLocale()

  return {
    locale,
    formatDate: (date: Date, options?: Intl.DateTimeFormatOptions) =>
      new Intl.DateTimeFormat(locale, options).format(date),
    formatNumber: (value: number, options?: Intl.NumberFormatOptions) =>
      new Intl.NumberFormat(locale, options).format(value),
    formatCurrency: (value: number, currency = 'EUR') =>
      new Intl.NumberFormat(locale, { style: 'currency', currency }).format(value),
  }
}
```

### 7. Dynamic `&lt;html lang>`

```typescript
// apps/web/src/routes/__root.tsx
import { getLocale } from '@/paraglide/runtime'

function RootDocument({ children }) {
  return (
    <html lang={getLocale()} suppressHydrationWarning>
```

No more `useMatches()` workaround — `getLocale()` reads from the middleware context on server and cookie/URL on client.

## Migration Steps

### Phase 1: Setup Paraglide (no behavior change)

| # | Task | Files |
|---|------|-------|
| 1 | Install `@inlang/paraglide-js@^2.7.2` | `package.json` |
| 2 | Bump `@tanstack/react-start` and `@tanstack/react-router` to `^1.158.0` | `package.json` |
| 3 | Create `project.inlang/settings.json` | new file |
| 4 | Add Vite plugin to config (**before** other plugins) | `vite.config.ts` |
| 5 | Convert translation JSONs to Paraglide format (flatten keys, `{{var}}` → `{var}`, plurals → ICU) | `messages/en.json`, `messages/fr.json` |
| 6 | Add `src/paraglide/` to `.gitignore` | `.gitignore` |

### Phase 2: Server middleware + routing

| # | Task | Files |
|---|------|-------|
| 7 | **Create** `server.ts` with `paraglideMiddleware` (use `handler.fetch(req)` pattern) | `server.ts` (new) |
| 8 | Add rewrite config to router | `router.tsx` |
| 9 | Move route files out of `$locale/` directory | `routes/` directory |
| 10 | Delete `_layout.tsx` i18next provider | `routes/$locale/_layout.tsx` |
| 11 | Update `__root.tsx` (remove i18n beforeLoad, use `getLocale()`) | `routes/__root.tsx` |
| 12 | Verify `/docs/*` routes are NOT affected by locale rewriting | `routes/docs/$.tsx` |

### Phase 3: Migrate components

| # | Task | Files |
|---|------|-------|
| 13 | Replace `useTranslation()` with `m.key()` in all components | all components using translations |
| 14 | Replace `changeLanguage()` with `setLocale()` + `localizeUrl()` | `LanguageSwitcher.tsx` |
| 15 | Replace `useLocale()` with `useLocaleFormatters()` | components using formatDate/formatNumber/formatCurrency |
| 16 | Remove `I18nextProvider` wrapper | layout components |
| 17 | Update `HreflangTags` and `getCanonicalUrl` to use `localizeUrl()` | `seo.tsx` |

### Phase 4: Cleanup

| # | Task | Files |
|---|------|-------|
| 18 | Remove i18next, react-i18next dependencies | `package.json` |
| 19 | Delete `lib/i18n/` directory (keep `locale-utils.ts` if extracted) | `client.ts`, `config.ts`, `server.ts`, `types.ts`, `hooks.ts`, `context.ts`, `seo.tsx`, `index.ts` |
| 20 | Delete old `locales/` translation files | `locales/en/*.json`, `locales/fr/*.json` |
| 21 | Update/rewrite i18n tests | `__tests__/config.test.ts`, `__tests__/server.test.ts` |
| 22 | Run full quality checks: `bun lint && bun typecheck && bun run test` | — |

## Translation Migration

### Namespace Flattening

i18next uses namespaces (`common`, `auth`, `dashboard`, `settings`). Paraglide uses a flat key structure. Migration mapping:

```
# i18next (namespaced)
common:welcome  →  common_welcome
auth:login      →  auth_login
dashboard:title →  dashboard_title
settings:theme  →  settings_theme
```

Nested keys are also flattened with underscores:

```
# i18next nested keys
common:buttons.submit    →  common_buttons_submit
common:errors.required   →  common_errors_required
dashboard:stats.revenue  →  dashboard_stats_revenue
```

All keys live in a single `messages/en.json` per locale. Tree-shaking ensures only used keys are bundled.

### Interpolation Syntax

i18next uses double curly braces; Paraglide uses single curly braces. **All** interpolated values must be converted:

```json
// i18next format
"min_length": "Must be at least {{min}} characters"
"items": "{{count}} item"

// Paraglide format
"common_errors_min_length": "Must be at least {min} characters"
"common_items": "{count} item"
```

Parameters become **required typed function arguments**:

```typescript
m.common_errors_min_length({ min: "8" })  // type-safe
m.common_items({ count: "5" })
```

### Pluralization

i18next uses `_other`/`_zero`/`_one` suffixes. Paraglide v2 uses ICU `{count, plural, ...}` syntax with `Intl.PluralRules`:

```json
// i18next (two separate keys)
"items": "{{count}} item"
"items_other": "{{count}} items"

// Paraglide (single key with plural expression)
"common_items": "{count, plural, one {# item} other {# items}}"
```

The `#` symbol is replaced with the `count` value at runtime.

## Risks & Mitigations

| Risk | Severity | Impact | Mitigation |
|------|----------|--------|------------|
| Redirect loop (TanStack compat) | **High** | `ERR_TOO_MANY_REDIRECT` on all pages | Pin Paraglide ≥2.7.2 + TanStack ≥1.142.7; use `handler.fetch(req)` pattern (not `handler.fetch(request)`) |
| Fumadocs route conflict | **Medium** | `/docs/*` pages incorrectly localized or 404 | Exclude `/docs` from `urlPatterns` — wildcard must be last |
| Pluralization migration | **Medium** | Broken plural forms at runtime | Manually convert i18next `_other`/`_zero` suffixes to ICU `{count, plural, ...}` syntax |
| Interpolation syntax change | **Low** | Missing variables in rendered translations | Convert all `{{var}}` to `{var}` in message files |
| `useLocale()` formatting loss | **Low** | `formatDate`/`formatNumber`/`formatCurrency` unavailable | Extract as standalone `useLocaleFormatters()` utility using `getLocale()` |
| `setLocale()` triggers page reload | **Low** | Full page reload on language switch | By design in Paraglide v2 — acceptable tradeoff |
| No namespace support | **Low** | Flat key space less organized | Use `namespace_` prefix convention (`common_`, `auth_`, etc.) |
| Generated code in `src/paraglide/` | **Low** | Must not be committed | Add to `.gitignore`; plugin auto-generates `.gitignore` in outdir |
| Cloudflare deployment | **Info** | Open issues with locale redirects ([TanStack/router#6268](https://github.com/TanStack/router/issues/6268)) | Not currently deploying to Cloudflare; monitor if needed |

## Bundle Size Impact

| | i18next | Paraglide |
|---|---------|-----------|
| Runtime library | ~40-50KB | ~2KB |
| Translation loading | All namespaces at runtime | Tree-shaken per-page |
| Type safety | None (string keys) | Full (compile-time) |

## Testing

### Functional Tests

- Verify SSR renders correct locale from URL (`/fr/dashboard` → French content)
- Verify SSR reads locale from cookie when no locale in URL
- Verify client hydration matches server locale (no mismatch flicker)
- Verify language switching updates URL, cookie, and content
- Verify `&lt;html lang>` attribute is dynamic via `getLocale()`
- Verify `/docs/*` routes are NOT affected by locale rewriting
- Verify interpolation parameters render correctly (`m.key({ name: "..." })`)
- Verify plural forms work correctly (1 item / 2 items)

### Regression Tests

- Verify no redirect loops on any route
- Verify `Accept-Language` header fallback works when no cookie/URL locale
- Verify `HreflangTags` and canonical URLs are correct
- Run full quality suite: `bun lint && bun typecheck && bun run test`

### Build Verification

- Verify tree-shaking: unused translation keys not in client bundle
- Verify `src/paraglide/` is regenerated on `bun build` and not committed

## References

- [Paraglide JS documentation](https://inlang.com/m/gerre34r/library-inlang-paraglideJs)
- [TanStack Start + Paraglide example](https://github.com/TanStack/router/tree/main/examples/react/start-i18n-paraglide)
- [Modern i18n DX in TanStack Start](https://eugeneistrach.com/blog/paraglide-tanstack-start/)
- [Why I replaced i18next with Paraglide](https://dropanote.de/en/blog/20250726-why-i-replaced-i18next-with-paraglide-js/)
- Spec [#20 — i18n foundation](/docs/specs/20-i18n)
- Spec [#33 — TanStack Start i18n integration](/docs/specs/33-tanstack-start-i18n-integration)
- PR #63 — i18n fixes (preload, cloneInstance, html lang)
