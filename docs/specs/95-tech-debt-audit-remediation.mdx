---
title: "Tech Debt Audit Remediation"
description: Resolve 9 tech debt items from the 2026-02-09 project audit and 2026-02-10 specialized agent reviews in a single mega-PR.
---

## Context

A project audit on 2026-02-09 and a follow-up specialized agent review (backend-dev, security-auditor, reviewer) on 2026-02-10 identified 12 tech debt items. Two were already resolved (Dockerfiles, .dockerignore). One (CSP `unsafe-inline`) is deferred to issue #101 (Swagger UI migration). This spec covers the remaining **9 items**.

**Promoted from:** [Tech Debt Tracker — Project Audit Remediation](../analyses/95-tech-debt-audit-remediation.mdx)

## Goal

Resolve all 9 open tech debt items in a single PR, grouped by domain with schema changes isolated from code-only changes. Eliminate the BLOCKER item, fix security-relevant gaps, and align the codebase with documented standards.

## Users &amp; Use Cases

**Developers** maintaining and extending the Roxabi boilerplate:
- Consistent test infrastructure (no globals leaking, proper cleanup)
- Correct timestamps with timezone support across all auth tables
- Performant queries via FK indexes
- Validated environment configuration at startup
- Accurate Swagger documentation for API consumers

## Expected Behavior

### Happy path

#### Group A — Testing Infrastructure

**A1. Remove `globals: true` from vitest config**

File: `packages/config/src/vitest.ts`

Remove `globals: true` from `baseConfig`. All 80 test files (56 in `apps/`, 24 in `packages/`) already have explicit `import { describe, it, expect, ... } from 'vitest'` — no test file changes needed.

```typescript
// Before
export const baseConfig = {
  globals: true,
  passWithNoTests: false,
  // ...
}

// After
export const baseConfig = {
  passWithNoTests: false,
  // ...
}
```

**A2. Add `cleanup()` to test setup files**

Files: `apps/web/src/test/setup.ts`, `packages/ui/src/test/setup.ts`

Both currently only contain `import '@testing-library/jest-dom/vitest'`. Add `cleanup()` to prevent component state leaking between tests:

```typescript
import '@testing-library/jest-dom/vitest'
import { cleanup } from '@testing-library/react'
import { afterEach } from 'vitest'

afterEach(() => {
  cleanup()
})
```

**A3. Create shared mock factories**

Create `apps/web/src/test/__mocks__/` directory with initial factory files. Move `mock-messages.ts` into this directory and add standard factories:

- `apps/web/src/test/__mocks__/mock-messages.ts` — move from `apps/web/src/test/mock-messages.ts`
- `apps/web/src/test/__mocks__/mock-user.ts` — factory for user objects
- `apps/web/src/test/__mocks__/mock-session.ts` — factory for session objects
- `apps/web/src/test/__mocks__/index.ts` — re-export all factories

Update any imports of `mock-messages` in existing test files.

#### Group B — Schema Changes

All three items modify `apps/api/src/database/schema/auth.schema.ts` and produce a **single Drizzle migration**.

**B1. Use shared timestamps in auth schema**

Replace hardcoded `timestamp('created_at').notNull().defaultNow()` / `timestamp('updated_at').notNull().defaultNow()` with the shared `timestamps` spread from `base.ts`:

```typescript
import { timestamps } from './base.js'

// Apply to: users, sessions, accounts, verifications
// These tables have both createdAt and updatedAt
export const users = pgTable('users', {
  // ... other columns ...
  ...timestamps,
})
```

For `organizations` (only has `createdAt`, no `updatedAt`): spread `...timestamps` to add both `createdAt` and `updatedAt` with timezone support. This is intentional — organizations should track updates.

For `members` (only has `createdAt`): same as organizations — spread `...timestamps`.

For `invitations` (no timestamps): leave as-is — invitations are immutable records with `expiresAt`.

**Migration impact:** Changes column type from `timestamp` to `timestamptz` (adds `withTimezone: true`). Adds `$onUpdateFn` to `updatedAt`. Safe for all environments — existing timestamp values are interpreted as UTC.

**B2. Add indexes on FK columns**

Add indexes to FK columns in `auth.schema.ts`. PostgreSQL does NOT auto-create indexes on FK columns.

Columns to index:
- `sessions.userId`
- `accounts.userId`
- `members.userId`
- `members.organizationId`
- `invitations.organizationId`
- `invitations.inviterId`

Use Drizzle's `index()` function on each `pgTable`:

```typescript
import { index, pgTable, text, timestamp } from 'drizzle-orm/pg-core'

export const sessions = pgTable('sessions', {
  // ... columns ...
}, (table) => [
  index('sessions_user_id_idx').on(table.userId),
])
```

**B3. Add unique constraint on invitations**

Add compound unique constraint on `(organizationId, email)` to prevent duplicate invitations:

```typescript
import { unique } from 'drizzle-orm/pg-core'

export const invitations = pgTable('invitations', {
  // ... columns ...
}, (table) => [
  index('invitations_organization_id_idx').on(table.organizationId),
  index('invitations_inviter_id_idx').on(table.inviterId),
  unique('invitations_org_email_unique').on(table.organizationId, table.email),
])
```

**After all three B items:** run `bunx drizzle-kit generate` to produce a single migration.

#### Group C — Backend Config &amp; Validation

**C1. Migrate env validation from class-validator to Zod**

File: `apps/api/src/config/env.validation.ts`

Replace the `class-validator` + `class-transformer` approach with Zod. The codebase already uses Zod elsewhere (ZodValidationPipe).

```typescript
import { z } from 'zod'

const Environment = z.enum(['development', 'production', 'test'])

const envSchema = z.object({
  NODE_ENV: Environment.default('development'),
  PORT: z.coerce.number().default(3001),
  DATABASE_URL: z.string().optional(),
  CORS_ORIGIN: z.string().default('http://localhost:3000'),
  LOG_LEVEL: z.string().default('debug'),
  BETTER_AUTH_SECRET: z.string().default('dev-secret-do-not-use-in-production'),
  BETTER_AUTH_URL: z.string().url().default('http://localhost:3001'),
  GOOGLE_CLIENT_ID: z.string().optional(),
  GOOGLE_CLIENT_SECRET: z.string().optional(),
  GITHUB_CLIENT_ID: z.string().optional(),
  GITHUB_CLIENT_SECRET: z.string().optional(),
  RESEND_API_KEY: z.string().optional(),
  EMAIL_FROM: z.string().default('noreply@yourdomain.com'),
  APP_URL: z.string().url().optional(),
})

export type EnvironmentVariables = z.infer<typeof envSchema>
```

Keep the production secret check (INSECURE_SECRETS validation). Export the same `validate(config)` function signature for NestJS `ConfigModule.forRoot()` compatibility.

After migration, remove `class-validator` and `class-transformer` from `apps/api/package.json` if no other code imports them.

**C2. Validate `APP_URL` env var**

Included in C1 — `APP_URL` is added to the Zod schema with `z.string().url().optional()`. Currently `AuthService` reads it from config (used in `trustedOrigins`) but it's not validated. Making it optional preserves the current fallback behavior while adding URL format validation when provided.

#### Group D — API Documentation &amp; Frontend

**D1. Add `@ApiBearerAuth()` to protected endpoints**

Files: `apps/api/src/user/user.controller.ts`

The `AuthController` is excluded from Swagger (`@ApiExcludeController()`). The `AppController` has a public health endpoint. Only `UserController` needs `@ApiBearerAuth()`:

```typescript
import { ApiBearerAuth } from '@nestjs/swagger'

@ApiTags('Users')
@ApiBearerAuth()
@Controller('api/users')
export class UserController {
  // ...
}
```

**D2. Add response type schemas to Swagger**

File: `apps/api/src/user/user.controller.ts`

Add `type` property to `@ApiResponse` decorators. Create simple response DTOs or use Zod-derived types:

```typescript
@ApiResponse({ status: 200, description: 'User profile', type: UserProfileDto })
@ApiResponse({ status: 401, description: 'Not authenticated' })
```

**D3. Replace hardcoded Tailwind with design tokens in demo table**

File: `apps/web/src/routes/demo/table.tsx`

Replace hardcoded color classes with design token classes:

| Hardcoded | Token |
|-----------|-------|
| `bg-gray-900` | `bg-background` |
| `bg-gray-800` | `bg-muted` |
| `text-white` | `text-foreground` |
| `text-gray-200` | `text-foreground` |
| `text-gray-100` | `text-foreground` |
| `border-gray-700` | `border-border` |
| `focus:ring-blue-500` | `focus:ring-ring` |

### Edge cases

| Scenario | Handling |
|----------|----------|
| Test file uses vitest globals without import | All 80 files already import explicitly — verified via grep. Safe to remove `globals: true` |
| `organizations` table gains `updatedAt` column | Intentional. New `updatedAt` will default to `now()` for existing rows. No data loss |
| `APP_URL` not set in existing deployments | Schema uses `.optional()` — existing behavior preserved. Validation only triggers when value is provided |
| Duplicate invitation already exists in DB | Migration adds unique constraint. If duplicates exist, migration will fail. Clean up duplicates before migrating, or use `CREATE UNIQUE INDEX ... WHERE status = 'pending'` |
| `class-validator` used elsewhere in API | Verified: only used in `env.validation.ts`. Safe to remove from dependencies |
| Existing tests import from `mock-messages` at old path | Update imports to new `__mocks__/` path. Grep for all usages |

## Constraints

- Single mega-PR — all 9 items in one PR with clean commit history
- Schema changes (Group B) must be isolated from code-only changes in separate commits
- Must generate a single Drizzle migration for all Group B items
- All existing tests must pass after changes
- No breaking changes to runtime behavior

## Non-goals

- CSP `unsafe-inline` fix — deferred to #101 (Swagger UI migration to frontend)
- Swagger UI disable in production — handled by #101
- Comprehensive mock factory library — only create initial factories; expand as needed
- Schema redesign — only fix timestamps, add indexes, and add constraint

## Technical Decisions

| Decision | Rationale |
|----------|-----------|
| Zod over class-validator | Codebase already uses Zod for DTOs (ZodValidationPipe). Eliminates class-validator/class-transformer deps |
| Spread `...timestamps` vs individual columns | `base.ts` already provides the pattern. Consistent, DRY, and includes `withTimezone` + `$onUpdateFn` |
| Single migration for Group B | Fewer migration files, atomic schema update. All three changes are safe to combine |
| `@ApiBearerAuth()` at class level | All `UserController` endpoints require auth. Class-level decorator is cleaner than per-method |
| Optional `APP_URL` | Preserves backward compatibility. Existing deployments without `APP_URL` continue to work |

## Success Criteria

- [ ] `globals: true` removed from vitest config — all tests pass
- [ ] `cleanup()` added to both test setup files
- [ ] Mock factories created in `__mocks__/` directory
- [ ] All auth schema tables use shared `timestamps` from `base.ts`
- [ ] FK indexes added to `sessions`, `accounts`, `members`, `invitations`
- [ ] Unique constraint on `invitations(organizationId, email)`
- [ ] Drizzle migration generated successfully
- [ ] `env.validation.ts` uses Zod — `class-validator`/`class-transformer` removed from deps
- [ ] `APP_URL` validated in env schema
- [ ] `@ApiBearerAuth()` on `UserController`
- [ ] Swagger response types added
- [ ] Demo table uses design tokens
- [ ] Full test suite passes (`bun test`)
- [ ] Type checking passes (`bun run typecheck`)
- [ ] Biome lint/format passes

## Open Questions

- Should the `invitations` unique constraint be a partial index (`WHERE status = 'pending'`)? This would allow re-inviting users whose previous invitation expired or was rejected. **Recommendation:** Use a partial index — `unique().where(sql\`status = 'pending'\`)`.
- Should `APP_URL` be required in production? Currently optional for backward compatibility, but it's security-relevant (used in `trustedOrigins`). **Recommendation:** Keep optional for now; add a startup warning in production if not set.
