---
title: "User Account Management (Edit & Delete)"
description: User profile editing (name, email, password, avatar), account soft-deletion with 30-day grace period, and GDPR-compliant data anonymization
---

## Context

Users cannot currently edit their profile beyond name and image URL, and there is no way to delete an account. The backend exposes `GET/PATCH api/users/me` (name + image only), but **no frontend profile page exists**. This spec adds full profile editing, DiceBear avatar generation, and account deletion with a 30-day soft-delete grace period.

This spec also defines the **shared soft-delete pattern** and **GDPR purge cron** used by both this feature and [#202 Organization Management](./202-org-management).

**Promoted from:** [User Account &amp; Organization Management Analysis](../analyses/201-202-account-org-management)

**Dependencies:**
- Better Auth field mapping spike (must validate `firstName`/`lastName` alongside `name` column)
- Existing auth system ([Spec: #19 Auth + Users](./19-auth-users))
- Existing RBAC system ([Spec: #24 RBAC](./24-rbac))

## Goal

Enable users to fully manage their account: edit profile information (name fields, email, password, avatar), and delete their account with a safe, reversible 30-day grace period that complies with GDPR data erasure requirements.

## Users &amp; Use Cases

**Primary user:** Authenticated user managing their own account.

| Use Case | Workflow |
|----------|----------|
| Edit profile | User navigates to `/settings/profile`, updates firstName/lastName/fullName/avatar, saves |
| Change email | User navigates to `/settings/account`, enters new email, verifies via link sent to new address |
| Change password | User navigates to `/settings/account`, enters current + new password, submits |
| Delete account | User navigates to `/settings/account`, clicks delete, resolves org ownership, confirms by typing email |
| Reactivate account | Soft-deleted user logs in during grace period, sees reactivation prompt, confirms to restore |

## Expected Behavior

### Happy path — Profile editing

1. User navigates to `/settings/profile`
2. Page loads current profile data (firstName, lastName, fullName, avatar)
3. User edits fields and clicks Save
4. `PATCH api/users/me` validates and updates — toast confirms success
5. If `firstName` or `lastName` changed and `fullNameCustomized` is false, `fullName` is auto-updated to `firstName + ' ' + lastName`
6. If `fullName` is directly edited, `fullNameCustomized` is set to `true`

### Happy path — Avatar customization

1. User navigates to `/settings/profile`
2. Avatar section shows current DiceBear avatar with style selector
3. User picks a style from the dropdown (5-6 curated options)
4. Avatar preview updates in real-time (client-side generation)
5. User optionally types a custom seed (defaults to user ID)
6. User clicks Save — `avatarSeed` and `avatarStyle` saved to profile

### Happy path — Email change

1. User navigates to `/settings/account`
2. User enters new email and clicks "Change email"
3. Frontend calls `authClient.changeEmail({ newEmail })`
4. Verification email sent to **new** address
5. Toast: "Verification email sent to {new email}"
6. User clicks verification link &rarr; email updated
7. Notification sent to old email (security measure, handled by Better Auth)

### Happy path — Password change

1. User navigates to `/settings/account`
2. User enters current password, new password, and confirmation
3. Frontend calls `authClient.changePassword({ currentPassword, newPassword })`
4. Toast: "Password updated successfully"

### Happy path — Account deletion

1. User clicks "Delete my account" on `/settings/account`
2. System checks for owned organizations
3. **If user owns orgs:** Modal shows list of owned orgs. For each org:
   - Option A: **Transfer ownership** — select an active member from dropdown
   - Option B: **Delete organization** — org will be soft-deleted alongside account
   - All orgs must be resolved before proceeding
4. **Confirmation dialog:** `DestructiveConfirmDialog` with warning, impact summary, and email input
5. User types their email (case-insensitive match) &rarr; "Delete" button enables
6. System executes:
   - Ownership transfers for orgs marked "transfer"
   - Set `deletedAt` + `deleteScheduledFor` (now + 30 days) on user
   - Set `deletedAt` + `deleteScheduledFor` on orgs marked "delete"
   - `DELETE FROM sessions WHERE user_id = $1` (force logout all devices)
   - Clear `activeOrganizationId` on other users' sessions referencing deleted orgs
7. Redirect to confirmation page: "Your account is scheduled for deletion on {date}."

### Happy path — Reactivation

1. Soft-deleted user navigates to login page
2. User enters credentials &rarr; Better Auth authenticates successfully
3. Auth guard detects `deletedAt IS NOT NULL`
4. User sees "Account scheduled for deletion" page with reactivation button
5. User clicks "Reactivate" &rarr; `POST api/users/me/reactivate`
6. Clear `deletedAt` and `deleteScheduledFor` &rarr; redirect to dashboard
7. If user also had orgs marked for deletion, those remain soft-deleted (reactivate separately via [#202 org reactivation](./202-org-management)). Dashboard shows a banner listing orgs pending deletion.

### Edge cases

| Scenario | Behavior |
|----------|----------|
| New email already in use | Better Auth returns error &rarr; show toast "Email already in use" |
| Email verification link expired | User must re-initiate email change |
| OAuth-only account | Hide email change and password change sections entirely |
| Incorrect current password | Show validation error on password field |
| User is sole owner of org with other members | Must transfer ownership before deletion |
| User initiates deletion while ownership transfer pending | Block deletion — show "Complete pending transfers first" |
| Multi-owner org | User can delete freely — remaining owners continue |
| Login attempt after grace period (account anonymized) | Normal "invalid credentials" error (email is anonymized) |
| Reactivation of account whose orgs were deleted | Account is restored but orgs remain soft-deleted (separate lifecycle via [#202](./202-org-management)) |
| New password same as current | Better Auth rejects — show validation error |
| Password confirmation mismatch | Client-side validation — disable submit until match |

## Constraints

- **Better Auth compatibility:** The `name` DB column must remain as-is. `firstName`/`lastName` are added alongside. Spike required to validate `additionalFields` config.
- **Serverless deployment:** No persistent process — purge cron uses Vercel Cron Jobs, not `@nestjs/schedule`.
- **No file upload:** Avatar is DiceBear-generated client-side. No S3/blob storage needed.
- **Bundle size:** DiceBear styles imported individually (not `@dicebear/collection`). Frontend-only — never imported in `apps/api`.
- **Env var:** `CRON_SECRET` must be added to `.env.example` and Vercel env vars for purge cron authentication.
- **`name` column is `fullName`:** The existing `name` column in the DB serves as `fullName` at the app layer. No new `full_name` column is created — `name` is aliased in DTOs and types.

## Non-goals

- File upload for avatar (infrastructure not set up)
- "Set password" flow for OAuth-only accounts (separate feature)
- Organization hierarchy/sub-organizations
- Billing/subscription cancellation on deletion
- Member notification system for org deletion (handled in #202 as follow-up)
- Real-time avatar editor with color picker (keep it simple: style + seed)

## Technical Decisions

### Schema Migration

Add to `users` table:

```sql
ALTER TABLE users
  ADD COLUMN first_name TEXT,
  ADD COLUMN last_name TEXT,
  ADD COLUMN full_name_customized BOOLEAN NOT NULL DEFAULT false,
  ADD COLUMN avatar_seed TEXT,
  ADD COLUMN avatar_style TEXT DEFAULT 'lorelei',
  ADD COLUMN deleted_at TIMESTAMPTZ,
  ADD COLUMN delete_scheduled_for TIMESTAMPTZ;

-- Backfill (first word → firstName, rest → lastName)
UPDATE users SET
  first_name = split_part(name, ' ', 1),
  last_name = CASE
    WHEN position(' ' IN name) > 0
    THEN substring(name FROM position(' ' IN name) + 1)
    ELSE ''
  END;

ALTER TABLE users
  ALTER COLUMN first_name SET NOT NULL,
  ALTER COLUMN last_name SET NOT NULL;

-- Partial indexes for soft-delete queries
CREATE INDEX users_deleted_at_idx ON users (deleted_at) WHERE deleted_at IS NOT NULL;
CREATE INDEX users_delete_scheduled_for_idx ON users (delete_scheduled_for) WHERE delete_scheduled_for IS NOT NULL;
```

### API Endpoints

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `api/users/me` | Bearer | Get profile (add firstName, lastName, fullName, avatarSeed, avatarStyle) |
| PATCH | `api/users/me` | Bearer | Update profile (fields: firstName, lastName, fullName, avatarSeed, avatarStyle) |
| DELETE | `api/users/me` | Bearer | Initiate account soft-deletion |
| POST | `api/users/me/reactivate` | Bearer | Reactivate soft-deleted account |
| POST | `api/internal/purge` | Cron secret | Daily purge cron (GDPR anonymization) |

### Purge Cron (Vercel Cron Jobs)

- Endpoint: `POST /api/internal/purge`
- Schedule: daily at 02:00 UTC
- Auth: `Authorization: Bearer $CRON_SECRET` (Vercel's standard cron auth injection)
- Logic: query `users` and `organizations` where `deleteScheduledFor &lt; NOW()`, execute anonymization in a transaction
- **Must be idempotent** — re-running on already-anonymized records is a no-op
- **Transactional** — each entity's anonymization runs in a single transaction
- **Batch size:** Process up to 100 records per invocation to avoid Vercel function timeout. Multiple cron runs complete large backlogs.
- **Ordering:** Process user anonymization first, then organization anonymization (preserves member rows correctly)

### GDPR Anonymization (User)

| Table | Action |
|-------|--------|
| `users` | UPDATE: `first_name` &rarr; `'Deleted'`, `last_name` &rarr; `'User'`, `name` &rarr; `'Deleted User'`, `email` &rarr; `'deleted-{uuid}@anonymized.local'`, `image` &rarr; null, `email_verified` &rarr; false, `avatar_seed` &rarr; null, `avatar_style` &rarr; null |
| `sessions` | DELETE all |
| `accounts` | DELETE all |
| `verifications` | DELETE all |
| `members` | KEEP (referential integrity — userId references anonymized row) |
| `invitations` (as inviter) | DELETE where `inviterId = userId` |
| `invitations` (as recipient) | DELETE where `email = user's original email` |

### Auth Guard Enhancement

After `AuthService.getSession()` resolves:
1. Query `users.deletedAt` for the session's user
2. If `deletedAt IS NOT NULL`:
   - Allow only: `POST api/users/me/reactivate` and `GET api/users/me`
   - All other requests: return `403` with `{ errorCode: 'ACCOUNT_SCHEDULED_FOR_DELETION', deleteScheduledFor }`
3. Frontend renders the "Account scheduled for deletion" page when receiving this error code

### Drizzle Query Helper

```typescript
import { type AnyColumn, isNull } from 'drizzle-orm';

export function whereActive(table: { deletedAt: AnyColumn }) {
  return isNull(table.deletedAt);
}
```

### DiceBear — Curated Styles

Install individual packages:
- `@dicebear/core`
- `@dicebear/lorelei` — artistic line-art faces
- `@dicebear/bottts` — robot/bot style
- `@dicebear/pixel-art` — 8-bit pixel art
- `@dicebear/thumbs` — emoji-like thumbs
- `@dicebear/avataaars` — cartoon characters

Style selection on the profile page with real-time preview. Final list can be adjusted during implementation.

### Frontend Routes

| Route | Component | Layout |
|-------|-----------|--------|
| `/settings` | `SettingsLayout` | Sidebar with nav links (Profile, Account) |
| `/settings/profile` | `ProfileSettings` | Name fields, avatar customization |
| `/settings/account` | `AccountSettings` | Email change, password change, delete account |

## Success Criteria

- [ ] User can edit firstName, lastName, fullName on `/settings/profile`
- [ ] fullName auto-updates from first+last unless manually customized
- [ ] User can select DiceBear avatar style and see real-time preview
- [ ] User can change email via Better Auth verify-new-email-first flow
- [ ] User can change password (email+password accounts only)
- [ ] OAuth-only accounts hide email/password change sections
- [ ] User can delete account with org ownership resolution flow
- [ ] Confirmation dialog requires typing email to enable delete button
- [ ] Sessions are invalidated on deletion (force logout all devices)
- [ ] Soft-deleted user sees reactivation page on login
- [ ] Reactivation clears deletedAt and restores account
- [ ] Purge cron runs daily and anonymizes expired records
- [ ] Anonymized user shows as "Deleted User" in member lists
- [ ] Soft-deleted users do not appear in member lists, org selectors, or invitation targets
- [ ] Purge ordering: users anonymized before orgs in each cron run
- [ ] `DestructiveConfirmDialog` component is reusable (shared with [#202](./202-org-management))
- [ ] Entire deletion + transfer batch runs in a single DB transaction

## Open Questions

- **Better Auth `additionalFields` for firstName/lastName:** Does this work cleanly with the organization plugin's member list rendering? (Spike required)
- **Reactivation window UX:** Should we show a countdown ("X days remaining") on the reactivation page?
- **Purge cron monitoring:** Should we add logging/alerting for purge job failures? (Vercel function logs may suffice initially)
- **Auth guard performance:** Should the `deletedAt` check be cached in the session cookie (5-min TTL already exists) to avoid an extra DB query per request?
- **`fullNameCustomized` reset:** Should there be a "Sync from first/last name" button to reset `fullNameCustomized` to false? Or is one-way customization sufficient?
