---
title: "Local Database Isolation per Worktree"
description: Branch-named databases with fresh migrate + seed for isolated local development per git worktree
---

## Context

All local development shares a single `roxabi` PostgreSQL database. When working on feature branches with schema changes, running `db:migrate` modifies the shared database ‚Äî breaking other worktrees that expect a different schema state.

**Promoted from:** [Local Database Isolation per Worktree](../analyses/local-db-isolation)

**Current state:**

- Single Postgres container via Docker Compose (`roxabi-postgres`, port 5432).
- Single `roxabi` database for all worktrees.
- `DATABASE_URL` defined in root `.env` only ‚Äî drizzle-kit commands need it passed explicitly.
- No seed script ‚Äî fresh databases are empty after migration.
- Worktree lifecycle managed by `/scaffold` (create), `/cleanup` (remove), and manual commands.

## Goal

Each git worktree gets its own isolated PostgreSQL database (`roxabi_<issue_number>`) within the existing Postgres container, automatically created with migrations and seed data, and automatically cleaned up when the worktree is removed.

## Users & Use Cases

| User | Workflow |
|------|----------|
| **Developer (Claude/human)** | Creates a worktree for a feature branch. Expects `bun run dev` to use an isolated database with seed data ready for login. |
| **`/scaffold` skill** | After `git worktree add`, creates the branch database, runs migrations, seeds, and updates `.env`. |
| **`/cleanup` skill** | When removing a worktree, drops the associated branch database. |
| **Developer (manual)** | Can run `bun run db:branch:create` / `db:branch:drop` independently of scaffold/cleanup. |

## Expected Behavior

### Happy path

#### Creating a branch database

1. Developer (or `/scaffold`) runs `bun run db:branch:create` from a worktree on branch `feat/150-billing`.
2. Script extracts issue number `150` from the branch name.
3. Script checks that `roxabi-postgres` container is running via `pg_isready`.
4. Script creates database `roxabi_150` via `docker exec roxabi-postgres createdb -U roxabi roxabi_150`.
5. Script runs migrations: `DATABASE_URL=postgresql://roxabi:roxabi@localhost:5432/roxabi_150 bun run db:migrate`.
6. Script runs seed: `DATABASE_URL=postgresql://roxabi:roxabi@localhost:5432/roxabi_150 bun run db:seed`.
7. Script updates the worktree's `.env` file: replaces `DATABASE_URL=...` line with the branch-specific URL.
8. Developer runs `bun run dev` ‚Äî app uses `roxabi_150` automatically.

#### Dropping a branch database

1. Developer (or `/cleanup`) runs `bun run db:branch:drop` from a worktree on branch `feat/150-billing`.
2. Script extracts issue number `150`.
3. Script verifies the target is not the default `roxabi` database (safety guard).
4. Script drops `roxabi_150` via `docker exec roxabi-postgres dropdb -U roxabi --if-exists roxabi_150`.

#### Listing branch databases

1. Developer runs `bun run db:branch:list`.
2. Script queries Postgres: `SELECT datname FROM pg_database WHERE datname ~ '^roxabi_[0-9]+$'`.
3. Script cross-references with `git worktree list` to show which databases have active worktrees and which are orphans.

### Edge cases

| Scenario | Behavior |
|----------|----------|
| Database already exists | `createdb` fails with "already exists" ‚Äî script detects this and asks: recreate (drop + create) or skip. |
| Postgres container not running | Script fails with: "Postgres container is not running. Run `bun run db:up` first." |
| No issue number in branch name | Script fails with: "Cannot extract issue number from branch `docs/readme`. Use `bun run db:branch:create <number>` to specify manually." |
| Migration fails | Script drops the partially-created database and reports the error. No half-initialized state. |
| Seed fails | Script drops the database and reports the error. No half-initialized state. |
| Attempting to drop `roxabi` | Script refuses: "Cannot drop the default database `roxabi`. Only branch databases (roxabi_NNN) can be dropped." |
| Orphaned databases (no matching branch) | `db:branch:list` flags these. `/cleanup` presents them for explicit confirmation. |
| Branch name has explicit issue number argument | `bun run db:branch:create 150` overrides auto-detection. |

## Constraints

- **Docker required**: Scripts use `docker exec` against the `roxabi-postgres` container. No local `psql` needed.
- **Superuser assumption**: The Postgres user (from `POSTGRES_USER` in Docker Compose, default `roxabi`) must have `CREATE DATABASE` privileges. This is the default for `POSTGRES_USER`.
- **Parameterized credentials**: Scripts read `POSTGRES_USER` (default `roxabi`), `POSTGRES_PASSWORD` (default `roxabi`), and `POSTGRES_DB` (default `roxabi`) from environment to match `docker-compose.yml`. Never hardcode credentials.
- **Connection pool awareness**: Each running worktree uses up to 10 connections (Drizzle provider `max: 10`). With 5 worktrees, that's 50 of Postgres' default 100 connections. Not a blocker but worth monitoring.
- **CI/CD unaffected**: These scripts are local-dev only. CI uses its own Postgres service, Vercel uses Neon.
- **Volume persistence**: `bun run db:down` (`docker compose down`) preserves volumes. `docker compose down -v` destroys ALL databases including branch databases. This is known behavior.

## Non-goals

- **Template cloning** (`createdb -T`): Rejected ‚Äî requires no active connections on template DB, which conflicts with concurrent worktrees.
- **Separate Docker containers per worktree**: Over-engineered for the problem.
- **Neon branching for local dev**: Adds network latency and external dependency.
- **Automated schema rollback**: Drizzle Kit doesn't support down migrations. Each branch database is fresh.

## Technical Decisions

### 1. New scripts in `apps/api/package.json`

```json
{
  "db:branch:create": "tsx scripts/db-branch.ts create",
  "db:branch:drop": "tsx scripts/db-branch.ts drop",
  "db:branch:list": "tsx scripts/db-branch.ts list",
  "db:seed": "tsx scripts/db-seed.ts"
}
```

All scripts live in `apps/api/scripts/` as TypeScript files run via `tsx` (consistent with existing `db:generate`/`db:migrate` scripts). Subprocess calls use `Bun.spawn` (or `Bun.$` shell tagged template) with stderr captured and displayed on failure. Exit codes from `docker exec` and `bun run` subprocesses must be checked.

### 2. `db-branch.ts` ‚Äî Branch database lifecycle

Single script with subcommands: `create`, `drop`, `list`.

**`create [issue_number] [--force]`:**

```
1. Read POSTGRES_USER (default: 'roxabi'), POSTGRES_PASSWORD, POSTGRES_DB from env
2. Parse issue number from argument or git branch name (regex: /(?:feat|fix|hotfix)\/(\d+)/)
3. Check container liveness: docker exec roxabi-postgres pg_isready -U $POSTGRES_USER
4. Check if database exists: docker exec roxabi-postgres psql -U $POSTGRES_USER -tc "SELECT 1 FROM pg_database WHERE datname = 'roxabi_<N>'"
   - If exists and --force: drop and recreate
   - If exists and interactive: prompt (recreate / skip)
   - If exists and non-interactive (no TTY): fail with error
5. Create database: docker exec roxabi-postgres createdb -U $POSTGRES_USER roxabi_<N>
6. Build DATABASE_URL: postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@localhost:5432/roxabi_<N>
7. Run migrations: spawn `bun run db:migrate` with DATABASE_URL in env
8. Run seed: spawn `bun run db:seed` with DATABASE_URL in env
9. Update worktree root .env: replace line matching ^DATABASE_URL= with branch-specific URL
   - Resolve worktree root: walk up from apps/api/ to find .env
   - If .env does not exist: fail with "Run 'cp .env.example .env' first"
   - Use line-by-line read/write, match ^DATABASE_URL= (not commented lines)
10. On any failure after step 5: drop the database and exit with error
```

**`drop [issue_number]`:**

```
1. Read POSTGRES_USER and POSTGRES_DB from env
2. Parse issue number from argument or git branch name
3. Validate: refuse if target database name equals $POSTGRES_DB (default 'roxabi')
4. Drop database: docker exec roxabi-postgres dropdb -U $POSTGRES_USER --if-exists roxabi_<N>
```

**`list`:**

```
1. Query: docker exec roxabi-postgres psql -U roxabi -tc "SELECT datname FROM pg_database WHERE datname ~ '^roxabi_[0-9]+$'"
2. Parse git worktree list for active worktrees
3. Cross-reference: show which DBs have active worktrees and which are orphans
4. Output table format:
   Database      ‚îÇ Worktree                ‚îÇ Branch              ‚îÇ Status
   roxabi_150    ‚îÇ ../roxabi-150           ‚îÇ feat/150-billing    ‚îÇ ‚úì Active
   roxabi_123    ‚îÇ ‚Äî                       ‚îÇ ‚Äî                   ‚îÇ ‚ö† Orphan
```

### 3. `db-seed.ts` ‚Äî Seed script

A TypeScript script using Drizzle ORM to insert dev essentials. Reads `DATABASE_URL` from environment.

**Idempotency:** The seed script is designed for **fresh databases only**. Running it twice on the same database will fail on unique constraints (`users.email`, `organizations.slug`). This is intentional ‚Äî branch databases are always fresh. For re-seeding, drop and recreate the database (`db:branch:create --force`).

**Seed data:**

```typescript
import { hashPassword } from 'better-auth/crypto'
import { DEFAULT_ROLES } from '../src/rbac/rbac.service.js'

// 1. Create user
const userId = crypto.randomUUID()
// Insert into users: { id: userId, name: 'Dev User', email: 'dev@roxabi.local', emailVerified: true }

// 2. Create account (Better Auth credential provider)
const hashedPassword = await hashPassword('password123')
// Insert into accounts: { userId, accountId: userId, providerId: 'credential', password: hashedPassword }

// 3. Create organization
const orgId = crypto.randomUUID()
// Insert into organizations: { id: orgId, name: 'Roxabi Dev', slug: 'roxabi-dev' }

// 4. Create member (user ‚Üí org) ‚Äî set BOTH role columns
const memberId = crypto.randomUUID()
// Insert into members: { id: memberId, userId, organizationId: orgId, role: 'owner', roleId: null }
// (roleId updated in step 5 after Owner role is created)

// 5. Seed RBAC (direct insert using imported DEFAULT_ROLES)
// For each role in DEFAULT_ROLES:
//   a. Insert role: { tenantId: orgId, name, slug, description, isDefault: true }
//   b. Resolve permissions: query permissions table, build resource:action ‚Üí id map
//   c. Insert role_permissions: { roleId, permissionId } for each permission string
// After all roles inserted:
//   d. Find Owner role ID, update member.roleId = ownerRoleId

// 6. Log seed summary: "Seeded: 1 user, 1 org, 1 member, 4 roles, N role_permissions"
```

**RBAC seeding: Import, don't duplicate.**

The `DEFAULT_ROLES` constant and `DefaultRoleDefinition` type in `rbac.service.ts` (lines 14-88) are plain data ‚Äî not coupled to NestJS DI. The seed script imports them directly to avoid drift. If `DEFAULT_ROLES` changes in the future, the seed automatically stays in sync.

**Permission resolution:**

The 15 permissions are seeded by migration `0002` and have auto-generated UUIDs. The seed script must query the `permissions` table and build a `Map<string, string>` (`resource:action` ‚Üí `id`), then map each role's permission strings to IDs ‚Äî identical to the `syncPermissions` method in `RbacService`.

**Password hashing:**

```typescript
import { hashPassword } from 'better-auth/crypto'
```

Confirmed available at `better-auth/dist/crypto/index.mjs`. No fallback needed.

### 4. `/scaffold` integration (Step 3d)

**Current Step 3d:**

```bash
git worktree add ../roxabi-<issue_number> -b feat/<issue_number>-<slug> staging
cd ../roxabi-<issue_number> && cp .env.example .env && bun install
```

**Updated Step 3d:**

```bash
git worktree add ../roxabi-<issue_number> -b feat/<issue_number>-<slug> staging
cd ../roxabi-<issue_number> && cp .env.example .env && bun install
cd apps/api && bun run db:branch:create --force <issue_number>
```

The `--force` flag ensures non-interactive behavior (no prompts) when called from `/scaffold`. The `db:branch:create` script handles database creation, migration, seed, and `.env` update.

### 5. `/cleanup` integration

**Add to Step 5 (before `git worktree remove`):**

For each worktree being removed, extract the issue number and run:

```bash
cd <worktree-path>/apps/api && bun run db:branch:drop <issue_number>
```

**Add to Step 1 (Gather State):**

Query branch databases and include them in the summary table:

```bash
docker exec roxabi-postgres psql -U roxabi -tc "SELECT datname FROM pg_database WHERE datname ~ '^roxabi_[0-9]+$'" 2>/dev/null
```

**Update summary table format:**

```
Branch              ‚îÇ Merged ‚îÇ PR    ‚îÇ Worktree        ‚îÇ Database     ‚îÇ Action
feat/150-billing    ‚îÇ ‚úÖ yes ‚îÇ ‚Äî     ‚îÇ ../roxabi-150   ‚îÇ roxabi_150   ‚îÇ üóë Safe to delete
feat/155-fix-auth   ‚îÇ ‚ùå no  ‚îÇ #42   ‚îÇ ../roxabi-155   ‚îÇ roxabi_155   ‚îÇ ‚ö†Ô∏è Active work
‚Äî                   ‚îÇ ‚Äî      ‚îÇ ‚Äî     ‚îÇ ‚Äî               ‚îÇ roxabi_123   ‚îÇ ‚ö†Ô∏è Orphan DB
```

### 6. Documentation updates

| File | Change |
|------|--------|
| `CLAUDE.md` (Worktree section) | Add `cd apps/api && bun run db:branch:create` after worktree creation |
| `docs/processes/dev-process.mdx` (S.2, F-lite, F-full) | Add DB creation step to worktree creation instructions |
| `docs/configuration.mdx` | Add branch database section under Database configuration |
| `.claude/skills/scaffold/SKILL.md` (Step 3d) | Add `db:branch:create` after `bun install` |
| `.claude/skills/cleanup/SKILL.md` (Step 5) | Add `db:branch:drop` before `git worktree remove` |

## Success Criteria

- [ ] `bun run db:branch:create` creates database, runs migrations, seeds, and updates `.env`
- [ ] `bun run db:branch:drop` drops the branch database (refuses to drop `roxabi`)
- [ ] `bun run db:branch:list` shows all branch databases with worktree status
- [ ] `bun run db:seed` seeds a database with dev essentials (user, account, org, member, roles, permissions)
- [ ] Seeded user can log in via email/password (`dev@roxabi.local` / `password123`)
- [ ] `/scaffold` automatically creates branch database during worktree setup
- [ ] `/cleanup` automatically drops branch database during worktree removal
- [ ] Container liveness check prevents cryptic errors when Postgres is down
- [ ] Safety guard prevents dropping the default `roxabi` database
- [ ] Failed migrations/seeds result in database cleanup (no half-initialized state)

## Open Questions

1. ~~**Better Auth password hashing import path**~~: **Resolved** ‚Äî `import { hashPassword } from 'better-auth/crypto'` is confirmed available.
2. **RBAC permissions drift**: The 15 permissions are seeded by migration `0002`. The seed script imports `DEFAULT_ROLES` to stay in sync with role definitions. If permissions themselves change in a future migration (new resources/actions), the seed will fail on missing permission lookups ‚Äî the seed script should log a clear error in this case.
3. **Staging database**: `bun run db:seed` works on any database pointed to by `DATABASE_URL`. It can be used on the staging `roxabi` database, but only on a fresh one (not idempotent).
