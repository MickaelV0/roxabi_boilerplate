---
title: Backend Infrastructure Setup
description: NestJS 11 + Fastify 5 + Drizzle ORM setup for Roxabi API
---

## Overview

Setup the foundational backend infrastructure for the Roxabi API. This is a **critical blocker** - all backend features (#19 Auth, #21 Multi-tenant, #22-25) depend on this.

Currently `apps/api` contains only placeholder scripts and no actual implementation.

## Goals

- Bootstrap NestJS 11 with Fastify 5 adapter for high performance
- Configure Drizzle ORM with PostgreSQL for type-safe database access
- Setup OpenAPI documentation with Swagger UI
- Establish patterns for multi-tenant architecture (tenant_id columns)
- Provide developer-friendly tooling (migrations, studio, hot reload)

## Technical Stack

| Component | Package | Version |
|-----------|---------|---------|
| Framework | `@nestjs/core` | ^11.0.0 |
| HTTP Adapter | `@nestjs/platform-fastify` | ^11.0.0 |
| Fastify | `fastify` | ^5.6.2 |
| ORM | `drizzle-orm` | ^0.45.1 |
| Migrations | `drizzle-kit` | ^0.30.0 |
| PostgreSQL Driver | `postgres` | ^3.x |
| OpenAPI | `@nestjs/swagger` | ^11.2.5 |
| Validation | `class-validator` + `class-transformer` | latest |

## Architecture

### Directory Structure

```
apps/api/
├── src/
│   ├── main.ts                 # Bootstrap application
│   ├── app.module.ts           # Root module
│   ├── app.controller.ts       # Health endpoint
│   ├── config/
│   │   ├── config.module.ts    # Environment configuration
│   │   └── env.validation.ts   # Env schema validation
│   ├── database/
│   │   ├── database.module.ts  # Database provider
│   │   ├── schema/
│   │   │   ├── index.ts        # Schema exports
│   │   │   └── base.ts         # Shared column patterns
│   │   └── drizzle.provider.ts # Drizzle instance
│   ├── common/
│   │   ├── filters/
│   │   │   └── http-exception.filter.ts
│   │   └── interceptors/
│   │       └── correlation-id.interceptor.ts
│   └── test/
│       └── setup.ts            # Test utilities
├── drizzle/
│   └── migrations/             # Generated migrations
├── drizzle.config.ts           # Drizzle Kit config
├── nest-cli.json               # NestJS CLI config
└── package.json
```

### Module Dependencies

```
AppModule
├── ConfigModule (global)
├── DatabaseModule (global)
└── HealthModule
```

## Implementation Phases

### Phase 1: Core Setup

| Task | Description |
|------|-------------|
| Install dependencies | NestJS 11, Fastify 5, validation packages |
| Bootstrap `main.ts` | Fastify adapter, global pipes, CORS |
| Configuration module | Environment validation with class-validator |
| Health endpoint | `GET /health` returns `{ status: "ok" }` |

### Phase 2: Database Layer

| Task | Description |
|------|-------------|
| Install Drizzle | drizzle-orm, drizzle-kit, postgres driver |
| Database module | Connection pooling, provider setup |
| Base schema | Timestamps + tenant_id patterns |
| Migration workflow | `db:generate`, `db:migrate`, `db:studio` |

### Phase 3: OpenAPI Documentation

| Task | Description |
|------|-------------|
| Install Swagger | @nestjs/swagger, @fastify/static |
| Configure Swagger UI | Available at `/api/docs` |
| CLI plugin | Auto-generate DTOs from TypeScript |

### Phase 4: DevOps & Quality

| Task | Description |
|------|-------------|
| Structured logging | Fastify logger configuration |
| Exception filter | Global error handling with correlation IDs |
| Request correlation | X-Correlation-ID header propagation |
| Update scripts | Replace placeholder scripts |

## Configuration

### Environment Variables

```bash
# Database
DATABASE_URL=postgres://user:pass@localhost:5432/roxabi

# Server
PORT=4000
NODE_ENV=development

# Logging
LOG_LEVEL=debug
```

### Bootstrap (`main.ts`)

```typescript
import { NestFactory } from '@nestjs/core';
import { FastifyAdapter, NestFastifyApplication } from '@nestjs/platform-fastify';
import { ValidationPipe } from '@nestjs/common';
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create&lt;NestFastifyApplication&gt;(
    AppModule,
    new FastifyAdapter({ logger: true }),
  );

  app.useGlobalPipes(new ValidationPipe({
    whitelist: true,
    forbidNonWhitelisted: true,
    transform: true,
  }));

  app.enableCors({
    origin: process.env.CORS_ORIGIN || 'http://localhost:3000',
  });

  const config = new DocumentBuilder()
    .setTitle('Roxabi API')
    .setVersion('1.0')
    .addBearerAuth()
    .build();
  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('api/docs', app, document);

  await app.listen(process.env.PORT || 4000, '0.0.0.0');
}
bootstrap();
```

### Drizzle Schema Pattern

```typescript
import { pgTable, integer, text, timestamp } from 'drizzle-orm/pg-core';

// Reusable timestamps
export const timestamps = {
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull().$onUpdateFn(() =&gt; new Date()),
};

// Tenant-aware base pattern (for future RLS)
export const tenantColumn = {
  tenantId: text('tenant_id').notNull(),
};
```

## Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `bun dev` | `nest start --watch` | Development with hot reload |
| `bun build` | `nest build` | Production build |
| `bun start` | `node dist/main` | Start production server |
| `bun start:prod` | `NODE_ENV=production node dist/main` | Production with env |
| `bun db:generate` | `drizzle-kit generate` | Generate migrations |
| `bun db:migrate` | `drizzle-kit migrate` | Run migrations |
| `bun db:studio` | `drizzle-kit studio` | Open Drizzle Studio |
| `bun test` | `vitest run` | Run tests |

## Acceptance Criteria

- [ ] `bun dev` starts NestJS server on port 4000
- [ ] `GET /health` returns `{ status: "ok" }`
- [ ] `GET /api/docs` shows Swagger UI
- [ ] `bun db:migrate` runs without error (with valid DATABASE_URL)
- [ ] All existing tests pass
- [ ] TypeScript strict mode passes
- [ ] Biome linting passes

## Dependencies

**Blocks:** #19, #21, #22, #23, #24, #25 (all backend features)

## Implementation Checklist

- [ ] Phase 1: Core Setup
  - [ ] Install NestJS 11 + Fastify 5 dependencies
  - [ ] Create `main.ts` with Fastify adapter
  - [ ] Create `app.module.ts` root module
  - [ ] Create `config.module.ts` with env validation
  - [ ] Add health endpoint (`GET /health`)
  - [ ] Configure CORS
- [ ] Phase 2: Database Layer
  - [ ] Install Drizzle ORM + postgres driver
  - [ ] Create `drizzle.config.ts`
  - [ ] Create database module with connection pooling
  - [ ] Create base schema patterns (timestamps, tenant_id)
  - [ ] Setup migration scripts
- [ ] Phase 3: OpenAPI Documentation
  - [ ] Install @nestjs/swagger
  - [ ] Configure Swagger UI at `/api/docs`
  - [ ] Setup NestJS CLI plugin for auto-generation
- [ ] Phase 4: DevOps & Quality
  - [ ] Update package.json scripts
  - [ ] Add global exception filter
  - [ ] Add correlation ID interceptor
  - [ ] Configure structured logging

## References

- [NestJS 11 Documentation](https://docs.nestjs.com/)
- [Drizzle ORM Documentation](https://orm.drizzle.team/)
- [NestJS + Fastify Performance Guide](https://docs.nestjs.com/techniques/performance)
- [NestJS Swagger](https://docs.nestjs.com/openapi/introduction)
