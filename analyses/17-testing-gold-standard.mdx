---
title: "Issue #17: Upgrade Testing Infrastructure to Gold Standard"
description: Analysis of the migration path from Option C (Balanced) to Option B (Gold Standard) testing infrastructure
---

## Context

Issue #9 established the testing infrastructure using Option C (Balanced Approach) from the [original testing analysis](./09-testing-infrastructure.mdx). Option C delivered per-package Vitest configs extending `@repo/config/vitest`, a root Playwright config with Chromium-only, and TurboRepo caching for test tasks.

Issue #17 upgrades to Option B (Gold Standard) proactively, before the pain points that motivated the deferral (insufficient E2E tests, single developer, manageable imports) become blockers. The project is maturing and this upgrade positions the testing infrastructure for multi-developer collaboration and growing E2E coverage.

## Questions Explored

1. What are the concrete gaps between the current Option C implementation and the Gold Standard?
2. What is the safest migration strategy for shared config extraction?
3. How should Playwright browser matrix and sharding scale given current E2E test volume?
4. Should coverage thresholds auto-ratchet, and what are the risks?
5. What CI workflow changes are needed and what are the cost/operational implications?
6. How does the upgrade affect local developer experience?

## Analysis

### Gap Audit: Current State vs Gold Standard

| Area | Current (Option C) | Gold Standard Target | Status |
|------|-------------------|---------------------|--------|
| Vitest shared config | `packages/config/src/vitest.ts` (embedded, 21 LOC) | Dedicated `packages/vitest-config/` with `base.ts`, `react.ts`, `node.ts` | Gap |
| Playwright shared config | Single root `playwright.config.ts` | Dedicated `packages/playwright-config/` with `base.ts` | Gap |
| Browser projects | Chromium only | Chromium + Firefox + Safari + Mobile Chrome | Gap |
| E2E sharding | None (`workers: 1` in CI) | Matrix strategy with parallel shards | Gap |
| E2E reporter | `html` + `list` | Blob reporter + merge-reports job | Gap |
| Coverage thresholds | Static (90/86/76/90) | Auto-update with floor | Gap |
| Import paths | `@repo/config/vitest` | `@repo/vitest-config` | Gap (migration) |
| Per-package vitest configs | `apps/web`, `apps/api`, `packages/ui`, `tools/` | Same | Done |
| Root vitest.config.ts | Projects array, V8 coverage | Same | Done |
| Coverage PR comments | `davelosert/vitest-coverage-report-action` | Same | Done |
| TurboRepo test caching | Configured in `turbo.jsonc` | Same | Done |
| E2E path-change filtering | `dorny/paths-filter@v3` in CI | Same | Done |
| Playwright browser caching | `actions/cache` for `~/.cache/ms-playwright` | Same | Done |

### 1. Dedicated Config Packages

**Current:** Vitest configs live in `packages/config/src/vitest.ts` (21 lines). This module exports `baseConfig`, `reactConfig`, and `nodeConfig` as plain objects spread into per-package `vitest.config.ts` files.

**Target:** Two new packages:

- **`packages/vitest-config/`** (`@repo/vitest-config`): Exports `base.ts`, `react.ts`, `node.ts` using `defineConfig` and `mergeConfig` from `vitest/config`. Each preset includes coverage config, threshold settings, and environment-specific defaults.

- **`packages/playwright-config/`** (`@repo/playwright-config`): Exports `base.ts` with shared Playwright settings (fullyParallel, retries, reporter selection, browser projects, webServer config).

**Migration strategy:** All-at-once. Create the new packages, update all import paths in a single PR, then remove the vitest exports from `packages/config/src/vitest.ts`. No dual-path re-exports.

**New packages must be registered** in the TurboRepo workspace (root `package.json` `workspaces` field) and may need pipeline tasks in `turbo.jsonc`.

**Files affected by import migration:**
- `apps/web/vitest.config.ts` (`@repo/config/vitest` → `@repo/vitest-config`)
- `apps/api/vitest.config.ts` (`@repo/config/vitest` → `@repo/vitest-config`)
- `packages/ui/vitest.config.ts` (`@repo/config/vitest` → `@repo/vitest-config`)
- `vitest.config.ts` (root, if it imports shared config)
- `docs/standards/testing.mdx` (documentation references — import path examples, package name references)

### 2. Playwright Browser Matrix

**Current:** Chromium only, single worker in CI. E2E runs as a single job after build.

**Target:** Four browser projects — Chromium, Firefox, Safari (webkit), Mobile Chrome (Pixel 5).

**Decision:** Tiered matrix by branch:
- **PRs:** Chromium only (fast feedback, ~2-3 min)
- **staging/main pushes:** Full 4-browser matrix (comprehensive, ~8-12 min with sharding)

This avoids slowing down PR feedback loops while catching cross-browser issues before release.

**Implementation:** Use two separate E2E job definitions — one for PRs (Chromium-only, no sharding) and one for staging/main pushes (full matrix with sharding). This is simpler and more readable than conditional matrix expressions.

**Local DX:** Running `bun run test:e2e` locally defaults to all configured browser projects. Developers should use `--project=chromium` for fast local runs. The `@repo/playwright-config` base config will document this in a comment.

### 3. E2E Sharding

**Current:** No sharding. Single E2E job.

**Target:** 2 shards initially (expandable to 4 when E2E suite grows).

**Implementation:**
- Matrix strategy: `shard: [1/2, 2/2]`
- Each shard uploads a blob report artifact
- A `merge-reports` job downloads all blob artifacts and merges them with `playwright merge-reports`
- Final merged report uploaded as a single artifact

**Why 2 shards, not 4:** The current E2E suite is small. Two empty shards waste CI minutes. Starting at 2 and bumping to 4 when E2E test count exceeds ~20 is more cost-effective.

### 4. Coverage Auto-Update Thresholds

**Current:** Static thresholds — `lines: 90, functions: 86, branches: 76, statements: 90`.

**Target:** Auto-update with an 80% floor.

**How it works:** Vitest's `autoUpdate: true` rewrites the vitest config file to raise thresholds whenever a test run exceeds the current values. The threshold only goes up, never down. This creates a coverage ratchet that prevents regression.

**Risk:** A refactoring PR that moves code between files or deletes well-tested code could temporarily drop coverage below the auto-ratcheted threshold, blocking the PR.

**Mitigation:** Set a floor at 80% for all metrics. If a PR legitimately drops coverage, the developer can manually lower the threshold in that PR with a comment explaining why. The `autoUpdate` will re-ratchet on the next coverage improvement.

**Configuration:**
```typescript
thresholds: {
  lines: 80,
  functions: 80,
  branches: 80,
  statements: 80,
  autoUpdate: true,
}
```

**Clarification on initial behavior:** The 80% values in the config above are the floor. On the first test run with `autoUpdate: true`, Vitest will compare actual coverage to the configured thresholds (80%). If actual coverage is higher (which it should be — current static thresholds are 90/86/76/90), it will rewrite the config to the actual values. The floor is what you start from; `autoUpdate` only ratchets upward.

**TurboRepo interaction caveat:** When TurboRepo caches a test run, the threshold file rewrite from `autoUpdate` only occurs in the cache output — it does not update the source config file. The ratchet only fires on non-cached runs. This means thresholds update less frequently than every commit, which is acceptable.

### 5. CI Workflow Changes

**Current `ci.yml` E2E job:** Single job, Chromium only, no sharding, uploads report on failure only.

**Target changes:**

1. **Split E2E into two job variants:**
   - **PR job:** Chromium-only, no sharding (fast feedback)
   - **staging/main job:** Full 4-browser matrix with 2-shard strategy

2. **Blob reporter** in CI mode for sharded runs (replaces `list` + `html`). Each shard uploads a blob artifact with a unique name (e.g., `blob-report-1-2`) to avoid overwrite collisions.

3. **`merge-reports` job:** Depends on all shard jobs with `if: always()` so partial reports are merged even if one shard fails. Downloads all `blob-report-*` artifacts, merges them with `playwright merge-reports`, uploads the merged HTML report.

4. **Install all browsers** needed by the matrix. The cached `install-deps` step must list all browsers: `bunx playwright install-deps chromium firefox webkit`.

5. **Update cache key** to encode browsers and Playwright version: `playwright-${{ runner.os }}-${{ hashFiles('bun.lock') }}` (lock file hash captures Playwright version changes).

6. **Upload strategy:** Blob artifacts use 1-day retention (ephemeral). Merged report uses 7-day retention. Upload always (not just on failure) so `merge-reports` can run.

7. **Update `check-e2e-paths` filter:** Add `packages/playwright-config/**` and `packages/vitest-config/**` to the paths filter so changes to shared config packages trigger E2E runs.

8. **TurboRepo `turbo.jsonc`:** Add `passThroughEnv: ["PLAYWRIGHT_*"]` to the E2E task. Note: the E2E task itself should not be Turbo-cached (sharding is incompatible with caching since each shard needs a unique cache key per shard index). Use `"cache": false` for the E2E turbo task.

**CI cost estimate:** Currently 1 E2E job at ~10 min. With 2 shards x 4 browsers on staging/main: ~20 billed minutes per push plus ~2 min for `merge-reports`. On PRs: unchanged (Chromium-only, no sharding). The increase applies only to staging/main pushes.

### 6. WebKit on Linux

WebKit (Safari) on Ubuntu requires additional system libraries (`libwoff1`, `libopus0`, GStreamer plugins) installed via `playwright install-deps webkit`. This adds 1-2 minutes to the install step on cache misses and can occasionally break when the Ubuntu runner image changes. This is the most common source of webkit-on-Linux CI flakiness — more so than actual test failures. Mitigation: pin Playwright version carefully and allow the webkit E2E job to be `continue-on-error: true` if it becomes persistently flaky.

### 7. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| CI time increase from 4-browser matrix | High | Medium | Tiered: full matrix only on staging/main (~20 billed min vs ~10) |
| WebKit system deps break on runner update | Medium | Medium | Pin Playwright version; `continue-on-error: true` for webkit job |
| Flaky webkit tests (Safari) | Medium | Low | `retries: 2` in CI; monitor and skip flaky tests with `test.fixme()` |
| Auto-threshold blocks refactoring PRs | Low | Medium | 80% floor; manual override with explanation |
| Migration breaks existing test configs | Low | High | Single PR; run full test suite before merge |
| Blob reporter incompatibility with coverage action | Low | Low | Blob reporter is for E2E only; unit coverage uses existing flow |
| Mobile Chrome viewport false failures | Low | Medium | Audit existing E2E tests for viewport assumptions before enabling |
| Broken CI blocks all developers | Low | High | Revert PR as rollback plan; old config is fully recoverable |

## Conclusions

**Recommendation: Proceed with the Gold Standard upgrade in a single PR.**

1. **The upgrade is well-scoped.** Seven concrete gaps, all with clear implementations and low risk. No architectural uncertainty.

2. **Two new packages** (`@repo/vitest-config`, `@repo/playwright-config`) replace embedded config and root-only Playwright setup. This follows TurboRepo best practices for shared config.

3. **Tiered browser matrix** (Chromium on PRs, full on staging/main) balances thoroughness with CI speed. CI cost increase (~10 min extra on staging/main) is acceptable.

4. **2-shard starting point** is pragmatic. The infrastructure is in place to bump to 4 when the E2E suite grows beyond ~20 tests.

5. **Auto-update thresholds with floor** creates a coverage ratchet without becoming a refactoring blocker. TurboRepo caching interaction means thresholds update less frequently, which is acceptable.

6. **All-at-once migration** is safe for a project with 4 vitest configs. No need for gradual deprecation.

7. **Local DX** requires documenting `--project=chromium` for fast local E2E runs.

## Next Steps

- Promote this analysis to a spec (`specs/17-testing-gold-standard.mdx`) with file-by-file implementation details
- Spec acceptance criteria should map 1:1 to each gap item in the audit table
- Audit existing E2E tests for viewport assumptions before enabling Pixel 5 project
- Implement via `/scaffold --issue 17` in a worktree
