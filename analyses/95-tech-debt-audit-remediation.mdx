---
title: "Tech Debt Tracker — Project Audit Remediation"
description: Analysis of 10 tech debt items from the 2026-02-09 project audit and 2026-02-10 specialized agent reviews, with grouping, risk assessment, and implementation approach.
---

## Context

A comprehensive project audit on 2026-02-09 identified 8 tech debt items across the codebase. A follow-up specialized agent audit (backend-dev, security-auditor, reviewer) on 2026-02-10 added 6 more findings. Two original items were already resolved (Dockerfiles and .dockerignore). This analysis covers the remaining **10 open items** from GitHub issue [#95](https://github.com/roxabi/roxabi_boilerplate/issues/95).

## Questions Explored

1. How should the 10 items be grouped and ordered for a single mega-PR?
2. Which items carry risk (schema changes, security implications)?
3. What are the dependencies between items?
4. What is the recommended commit ordering within the PR?

## Analysis

### Item Inventory

| # | Item | Severity | Area | Files Affected |
|---|------|----------|------|----------------|
| 1 | Remove `globals: true` from vitest config | BLOCKER | Testing | `packages/config/src/vitest.ts` + all test files |
| 2 | Add `cleanup()` to test setup files | WARNING | Testing | `apps/web/src/test/setup.ts`, `packages/ui/src/test/setup.ts` |
| 3 | Create shared mock factories | LOW | Testing | New `apps/web/src/test/__mocks__/` directory |
| 4 | Auth schema timestamps → shared `base.ts` | WARNING | Schema | `apps/api/src/database/schema/auth.schema.ts` |
| 5 | Add DB indexes on FK columns | MEDIUM | Schema | `apps/api/src/database/schema/auth.schema.ts` |
| 6 | Add unique constraint on invitations | LOW | Schema | `apps/api/src/database/schema/auth.schema.ts` |
| 7 | Migrate env validation to Zod | MEDIUM | Backend | `apps/api/src/config/env.validation.ts` |
| 8 | Validate `APP_URL` env var | WARNING | Backend | `apps/api/src/config/env.validation.ts` |
| 9 | Add `@ApiBearerAuth()` to protected endpoints | MEDIUM | API docs | Controller files with auth guards |
| 10 | Add Swagger response type schemas | LOW | API docs | Controller files with `@ApiResponse` |
| 11 | CSP `unsafe-inline` conditional | LOW | Security | `apps/api/src/index.ts` |
| 12 | Demo table → design tokens | LOW | Frontend | `apps/web/src/routes/demo/table.tsx` |

### Grouping Strategy

Items are grouped into **4 logical clusters** for clean commit history within the single PR. Schema changes are isolated from code-only changes per user preference.

#### Group A — Testing Infrastructure (items 1, 2, 3)

**Risk: LOW.** Code-only changes, no runtime impact.

- **Item 1 (BLOCKER):** Remove `globals: true` from `packages/config/src/vitest.ts:2`. Every test file that uses `describe`, `it`, `expect`, `vi`, `beforeEach`, `afterEach` without imports will break. Requires adding `import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest'` to all test files. This is the highest-priority item — it contradicts the documented testing standard.
- **Item 2 (WARNING):** Both `apps/web/src/test/setup.ts` and `packages/ui/src/test/setup.ts` only contain `import '@testing-library/jest-dom/vitest'`. Need to add `import { cleanup } from '@testing-library/react'` and `afterEach(() => { cleanup() })` to prevent component state leaking between tests.
- **Item 3 (LOW):** Create `apps/web/src/test/__mocks__/` directory with factory functions. `mock-messages.ts` already exists at the test root but there's no organized `__mocks__/` convention.

**Dependencies:** Item 1 must be done first (removing globals) since Item 2 adds `afterEach` which would need to be imported if globals are removed.

#### Group B — Schema Changes (items 4, 5, 6)

**Risk: MEDIUM.** Generates a Drizzle migration. Requires careful review.

- **Item 4 (WARNING):** `auth.schema.ts` has 7 tables with hardcoded `timestamp('created_at').notNull().defaultNow()` and `timestamp('updated_at').notNull().defaultNow()`. These are missing `{ withTimezone: true }` and `$onUpdateFn(() => new Date())`. The shared `timestamps` object in `base.ts:7-12` already provides the correct pattern — spread `...timestamps` into each table.
  - **Caveat:** `organizations` table only has `createdAt` (no `updatedAt`). Spreading `...timestamps` would add `updatedAt` — this is intentional since organizations should track updates.
  - **Caveat:** Some tables (`sessions`, `verifications`, `invitations`) have `expiresAt` — this is unrelated to `timestamps` and stays as-is.
  - **Migration impact:** Adding `withTimezone: true` changes the column type from `timestamp` to `timestamptz`. Existing data will be interpreted as UTC (safe for new projects, verify for existing data).
- **Item 5 (MEDIUM):** Add indexes on FK columns: `sessions.userId`, `accounts.userId`, `members.userId`, `members.organizationId`, `invitations.organizationId`, `invitations.inviterId`. PostgreSQL does NOT auto-create indexes on FK columns. Uses Drizzle's `.index()` on the table definition.
- **Item 6 (LOW):** Add compound unique constraint on `(organizationId, email)` for the `invitations` table to prevent duplicate invitations.

**Dependencies:** Items 4, 5, 6 all touch `auth.schema.ts` and should be in a single migration. Order: timestamps first (structural), then indexes, then constraints.

#### Group C — Backend Config &amp; Validation (items 7, 8)

**Risk: MEDIUM.** Changes how the app validates its environment at startup.

- **Item 7 (MEDIUM):** Replace `class-validator` + `class-transformer` with Zod in `env.validation.ts`. The codebase already uses Zod elsewhere (ZodValidationPipe exists for DTOs). This removes the only remaining usage of `class-validator`/`class-transformer`, allowing those packages to be uninstalled.
- **Item 8 (WARNING):** Add `APP_URL` to the env validation schema with URL format check. Currently `AuthService` reads `APP_URL` from config (used in `trustedOrigins`) but it's not validated at startup. This is security-relevant — an invalid `APP_URL` could misconfigure CORS trusted origins.

**Dependencies:** Items 7 and 8 touch the same file. Do them together — migrate to Zod AND add `APP_URL` in one pass.

#### Group D — API Documentation &amp; Hardening (items 9, 10, 11, 12)

**Risk: LOW.** No behavioral changes — only documentation, CSP, and styling.

- **Item 9 (MEDIUM):** Add `@ApiBearerAuth()` decorator to all controller methods/classes that use auth guards. Swagger already has `addBearerAuth()` configured but no endpoint declares it.
- **Item 10 (LOW):** Add `type` property to `@ApiResponse` decorators so Swagger shows response schemas.
- **Item 11 (LOW):** Make `'unsafe-inline'` in CSP `script-src` conditional on `NODE_ENV !== 'production'`. Currently it's always included (needed for Swagger UI). In production, Swagger UI should either be disabled or served differently.
- **Item 12 (LOW):** Replace hardcoded Tailwind classes (`bg-gray-900`, `border-gray-700`) with design tokens (`bg-background`, `text-foreground`, `border-border`) in `apps/web/src/routes/demo/table.tsx`.

**Dependencies:** None between items. Order doesn't matter.

### Recommended Commit Order

```
1. fix(test):  remove globals:true from vitest + add explicit imports
2. fix(test):  add cleanup() to web and UI test setup files
3. feat(test): create shared mock factories in __mocks__/
4. fix(db):    use shared timestamps in auth schema
5. perf(db):   add indexes on FK columns in auth schema
6. fix(db):    add unique constraint on invitations(org, email)
   → generate single Drizzle migration for commits 4-6
7. refactor(config): migrate env validation from class-validator to Zod
8. fix(config): add APP_URL to env validation
9. docs(api):  add @ApiBearerAuth() to protected endpoints
10. docs(api): add response type schemas to Swagger
11. fix(security): make CSP unsafe-inline conditional on environment
12. style(web): replace hardcoded Tailwind with design tokens in demo table
```

### Risk Assessment

| Risk | Mitigation |
|------|------------|
| Vitest globals removal breaks tests | Run full test suite after imports are added; CI will catch misses |
| Timestamp migration changes column types | `timestamptz` is backward-compatible for new-ish projects; verify with `drizzle-kit generate` output |
| Zod migration changes startup behavior | Keep same validation semantics; test with missing/invalid env vars |
| `APP_URL` suddenly required | Make it optional with fallback (same as current behavior) but validate format if provided |

## Conclusions

- **Tier: M** (Medium) — touches 10+ files across 4 areas but all changes are well-scoped.
- **Approach:** Single mega-PR with clean commit history grouped by domain.
- **Schema changes** (Group B) carry the most risk and should be reviewed carefully. The Drizzle migration should be generated once after all three schema changes.
- **Testing fixes** (Group A) should be done first since they improve the test infrastructure used to validate everything else.
- The `globals: true` removal (BLOCKER) is the single most impactful change — every test file will need an import line added.

## Next Steps

- Promote this analysis to a **spec** with detailed implementation steps per item
- Create implementation plan with file-level changes
- Execute via `/scaffold` in a worktree
