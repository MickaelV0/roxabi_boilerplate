---
title: "#19 Auth + Users (Better Auth)"
description: Pre-spec analysis of authentication and user management with Better Auth, NestJS/Fastify, and TanStack Start.
---

## Context

Issue #19 is the authentication and user management foundation for Roxabi. From the vision (Phase 1 MVP): "Auth, billing, multi-tenant: ready out of the box." Better Auth was chosen as the auth library.

**Dependency:** #43 Backend Infrastructure (NestJS + Fastify + Drizzle) — **CLOSED**.

**Blocks:** #21 Multi-tenant (RLS), #22 Audit Logs, #23 Notifications, #24 RBAC, #25 Admin Panel.

**Existing spec:** `specs/19-auth-users.mdx` — written before this analysis. This analysis validates and updates assumptions made in the spec.

## Current State

### What Exists

| Area | Status | Details |
|------|--------|---------|
| NestJS + Fastify | Done | NestJS 11 + Fastify 5 via #43 |
| Drizzle ORM | Done | PostgreSQL driver, connection pooling, base schema |
| Base schema patterns | Done | `timestamps` + `tenantColumn` in `base.ts` |
| Global validation | Done | `ValidationPipe` (whitelist, transform) |
| Exception filter | Done | `AllExceptionsFilter` with correlation IDs |
| CORS | Done | Configurable origin (defaults `localhost:3000`) |
| Swagger/OpenAPI | Done | At `/api/docs` (non-prod only) |
| API client (frontend) | Done | `ofetch` with retry, correlation IDs |
| Auth module | Missing | No auth code in backend |
| Auth routes | Missing | No login/register/reset endpoints |
| Auth guard | Missing | All routes currently unprotected |
| User schema | Missing | No database tables |
| Frontend auth | Missing | No auth client, no protected routes |
| Reverse proxy | Missing | Frontend calls API directly at `localhost:4000` |

### Key Infrastructure Details

| Config | Value | Notes |
|--------|-------|-------|
| Backend port | 3001 (env `PORT`) | Spec assumed 3001 ✓ |
| Frontend port | 3000 (env `WEB_PORT`) | Spec assumed 3000 ✓ |
| API client base URL | `localhost:4000` (env `API_URL`) | ⚠️ Mismatch with backend port |
| Backend module system | CommonJS (tsconfig) | ⚠️ Better Auth 1.4+ is ESM-only |
| Body parser | Fastify default (enabled) | Needs strategy for auth routes |
| Existing `tenantId` column | `text('tenant_id').notNull()` | Needs alignment with org plugin |

## Questions Explored

### Q1: Can Better Auth work with Fastify's parsed bodies?

**Answer: Yes.** The vanilla Fastify integration re-serializes parsed bodies:

```typescript
...(request.body ? { body: JSON.stringify(request.body) } : {})
```

Fastify parses the body first, then it gets re-stringified into a Fetch API `Request`. This is the documented approach and avoids disabling body parsing globally.

**Impact on spec:** The spec's `AuthController` pattern is correct. No need to disable `bodyParser`.

### Q2: Should we use `@thallesp/nestjs-better-auth`?

**Answer: No.** Confirmed the spec's decision:

| Issue | Severity |
|-------|----------|
| `req.baseUrl` is Express-only (issue #53) | Crashes on Fastify |
| CORS double-registration (issue #52) | Conflict |
| NestJS v11 wildcard routes (issue #102) | Broken |
| Fastify support is "beta" per docs | Unstable |
| Requires `bodyParser: false` globally | Breaks all other routes |

**Decision: Build thin integration layer (~150 lines) as spec proposes.**

### Q3: Does magic link auto-verify email?

**Answer: Yes, with a caveat.** When a user logs in via magic link, `emailVerified` is set to `true` in the database. However, there's a **known bug** ([issue #6158](https://github.com/better-auth/better-auth/issues/6158)): the returned session object may still show `emailVerified: false` even though the database is correct.

**Mitigation:** After magic link login, either:
- Re-fetch session from DB (skip cookie cache for this request)
- Accept the visual inconsistency (DB is correct, security is unaffected)

### Q4: How does Organization plugin's `organizationId` relate to `tenantId`?

**Answer: They're different concepts that need alignment.**

- Better Auth's `organizationId`: Lives on `members` and `invitations` tables, identifies which org a user belongs to
- Our `tenantId` base column: Exists on all tenant-scoped tables for RLS

**Strategy for #21 (RLS):** The Organization plugin's `organizationId` becomes the source of truth for tenant identity. The existing `tenantId` base column should reference the organization's ID. This alignment is a concern for #21, not #19.

**For #19:** Just set up the Organization plugin. Don't add `tenantId` to auth tables — Better Auth manages its own schema.

### Q5: ESM compatibility with NestJS (CommonJS)?

**Answer: Needs investigation but likely works.**

Better Auth 1.4+ ships as ESM-only. The NestJS backend uses CommonJS (`module: CommonJS` in tsconfig). However:
- Node.js supports importing ESM packages from CommonJS via dynamic `import()`
- NestJS 11 + TypeScript 5.x handle ESM interop in most cases
- The Fastify ecosystem has largely moved to ESM
- Many Better Auth users run NestJS setups (per their docs having a NestJS integration page)

**Risk:** Medium. If static `import` fails, fallback to dynamic `import()` in the auth instance file. Need to test during implementation.

### Q6: What's new in Better Auth since the spec was written?

**Better Auth v1.4.18** (latest, Feb 2026) added:

| Feature | Relevance |
|---------|-----------|
| JWE cookie caching | Higher security than `compact` strategy |
| UUID primary key support | Align with our ID strategy |
| Experimental joins (2-3x perf) | Consider for production |
| Stateless auth (no DB) | Not needed — we have PostgreSQL |
| Cookie chunking | Handles large session payloads |
| JWT key rotation | Production hardening |
| SCIM provisioning plugin | Enterprise SSO (future) |
| Device authorization (RFC 8628) | IoT/CLI auth (future) |

**Spec updates needed:**
- Consider JWE over compact for cookie cache strategy
- Add UUID PK option decision
- Note experimental joins for future optimization

## Technical Decisions

### 1. Cookie Cache Strategy: JWE over Compact

| Strategy | Size | Security | Readable |
|----------|------|----------|----------|
| `compact` | Smallest | Signed only | Yes |
| `jwt` | Medium | Signed | Yes |
| `jwe` | Largest | **Encrypted** | No |

**Decision: Use `jwe`.** Session data is encrypted in the cookie, not just signed. Slightly larger cookies but session contents are opaque to the client. Better security posture for a SaaS framework.

### 2. API URL: Fix the Mismatch

The frontend `ofetch` client defaults to `localhost:4000` (env `API_URL`), but the backend runs on port 3001. Two options:

| Option | Approach | Trade-off |
|--------|----------|-----------|
| A: Fix env default | Change `API_URL` default to `localhost:3001` | Simple, direct calls |
| B: Reverse proxy | Proxy `/api/*` from frontend (port 3000) → backend (port 3001) | Same-origin cookies |

**Decision: Option B (reverse proxy).** Required for same-origin cookies anyway. The `ofetch` client is for server-side API calls; browser auth requests go through the proxy.

### 3. Primary Key Strategy: UUID

Better Auth 1.4 supports UUID PKs. Since this is a greenfield project with no existing tables:

**Decision: Use UUIDs for all auth tables.** Consistent with distributed systems best practices, no sequential ID enumeration.

### 4. Email Provider: Resend with Console Fallback

**Decision (confirmed from spec):** Resend in production, console logging in development. Build an `EmailProvider` interface for swappability.

### 5. Auth Methods: Email/Password + OAuth + Magic Link

**Decision (confirmed from spec):** Ship with:
- Email/password (with email verification)
- Google OAuth
- GitHub OAuth
- Magic link

All configurable via env vars. OAuth providers are opt-in (only enabled when credentials are set).

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| ESM/CJS incompatibility | Medium | High | Test early; dynamic import fallback |
| Body parsing edge cases | Low | Medium | Test file uploads, multipart |
| Magic link session bug | Known | Low | DB is correct; cosmetic only |
| Cookie cache revocation delay | Expected | Medium | Document 5-min max delay |
| Better Auth breaking changes | Low | High | Pin exact version |
| Organization + RLS alignment | Deferred | High | Address in #21, not #19 |

## Scope Assessment

**Tier: L (Large)** — System architecture, >10 files, multiple packages affected.

### Estimated File Count

| Package | New Files | Modified Files |
|---------|-----------|----------------|
| `apps/api` | ~12 | ~4 |
| `apps/web` | ~5 | ~3 |
| `packages/types` | ~1 | ~1 |
| Root config | 0 | ~2 |
| **Total** | **~18** | **~10** |

### Phases (from spec, validated)

1. **Better Auth Core Setup** — Install, configure, generate schema, migrate
2. **NestJS Integration Layer** — Controller, guard, decorators
3. **Email Provider** — Resend implementation
4. **User Endpoints** — GET/PATCH profile
5. **Frontend Setup** — Reverse proxy, auth client, minimal pages
6. **Tests** — Unit tests for all new code

## Conclusions

1. **The existing spec is solid.** Most decisions were validated by this research. Key updates needed:
   - Cookie cache strategy → JWE (upgrade from compact)
   - Add UUID PK decision
   - Note ESM compatibility risk + mitigation
   - Fix API URL mismatch documentation
   - Document magic link email verification behavior + known bug

2. **Skip the third-party NestJS library.** Confirmed with additional evidence (beta Fastify support, global body parser requirement).

3. **Body parsing is a non-issue.** Re-serializing parsed JSON works fine for the vanilla Fastify integration pattern.

4. **Organization/tenant alignment is deferred to #21.** Issue #19 sets up the Organization plugin; #21 handles RLS and `tenantId` mapping.

5. **ESM compatibility is the biggest unknown.** Must be tested early in implementation (Phase 1). If it fails, the fallback is straightforward (dynamic imports).

## Next Steps

1. **Update the spec** with findings from this analysis (JWE, UUID, ESM risk, API URL fix)
2. **Test ESM compatibility** as first implementation step
3. **Create worktree** `../roxabi-19` for Tier L implementation
4. **Implement in phases** per spec (core → integration → email → user → frontend → tests)

## References

- [Better Auth Documentation](https://www.better-auth.com/docs)
- [Better Auth Fastify Integration](https://www.better-auth.com/docs/integrations/fastify)
- [Better Auth NestJS Integration](https://www.better-auth.com/docs/integrations/nestjs)
- [Better Auth Drizzle Adapter](https://www.better-auth.com/docs/adapters/drizzle)
- [Better Auth Organization Plugin](https://www.better-auth.com/docs/plugins/organization)
- [Better Auth Admin Plugin](https://www.better-auth.com/docs/plugins/admin)
- [Better Auth Magic Link Plugin](https://www.better-auth.com/docs/plugins/magic-link)
- [Better Auth Session Management](https://www.better-auth.com/docs/concepts/session-management)
- [Better Auth 1.4 Release](https://www.better-auth.com/blog/1-4)
- [Magic Link emailVerified Bug (issue #6158)](https://github.com/better-auth/better-auth/issues/6158)
- [nestjs-better-auth GitHub](https://github.com/ThallesP/nestjs-better-auth)
- [Resend Documentation](https://resend.com/docs)
