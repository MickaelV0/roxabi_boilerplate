---
title: "Shared Task Lists with Tag-Based Isolation"
description: Analysis of agent coordination via shared task lists. Concluded that TeamCreate already provides the needed functionality — CLAUDE_CODE_TASK_LIST_ID integration is unnecessary for our workflow.
---

## Context

Issue [#283](https://github.com/roxabi/roxabi_boilerplate/issues/283) — Phase 4 of the AI workflow improvement strategy ([#251](https://github.com/roxabi/roxabi_boilerplate/issues/251)).

**Parent spec:** [specs/251-ai-workflow-improvement-strategy.mdx](../specs/251-ai-workflow-improvement-strategy.mdx) — defines `CLAUDE_CODE_TASK_LIST_ID={issue_number}-{slug}` per worktree as the technical decision (see "Shared task lists: per-worktree isolation" section).

**Sibling dependency:** [#282 (scaffold micro-tasks)](../specs/282-scaffold-micro-task-planning.mdx) — already shipped. Scaffold generates `TaskCreate` entries with metadata. The #282 analysis documents the before/after integration point with #283.

**Current state — what's already done:**

| Area | Status | Evidence |
|------|--------|----------|
| Agent frontmatter (`memory`, `maxTurns`, `permissionMode`) | Done (all 9 agents) | `grep` across `.claude/agents/*.md` confirms all have these fields |
| AGENTS.md task lifecycle &amp; micro-task protocol | Done | Includes micro-task consumption protocol and claiming rules |
| Scaffold TaskCreate with metadata | Done (#282) | Step 4f generates micro-tasks with verification commands |
| `CLAUDE_CODE_TASK_LIST_ID` integration | **Not needed** | TeamCreate already provides shared task lists; env var is only for cross-session resume which our workflow doesn't require |
| TeamDelete cleanup step | **Deferred** | Optional — risk of not cleaning up is negligible (disk clutter only, no functional impact) |
| AGENTS.md "Post-#283" flip to current | **Done** | Flipped to "Dynamic task claiming" with arbitration rule |
| `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1` in `.env.example` | Done | Present at line 65 of `.env.example` |
| Tag isolation documentation | **Not needed** | TeamCreate's `team_name={issue}-{slug}` convention already provides per-worktree isolation |

**Key discovery:** `CLAUDE_CODE_TASK_LIST_ID` is a real, documented Claude Code feature for cross-session task list persistence. However, **it is unnecessary for our workflow** because:
1. Scaffold runs from the main repo, not the worktree — sub-agents inherit the main session's context
2. `TeamCreate(team_name="{issue}-{slug}")` already creates a shared task list at `~/.claude/tasks/{team-name}/`
3. All teammates automatically share this task list within the scaffold session
4. We don't start separate Claude sessions in worktrees — everything runs from the main session

## Questions Explored

1. Does `CLAUDE_CODE_TASK_LIST_ID` actually work for cross-session task sharing? — **Yes**, confirmed via official docs. See [API Confirmation](#api-confirmation).
2. What's the relationship between this env var and the existing TeamCreate flow? — **Same persistence layer.** See [API Confirmation](#api-confirmation).
3. What changes are actually needed given the prerequisites already shipped? — **6 items remain.** See [Remaining Delta](#remaining-delta).
4. How should agents discover and claim tasks — spawn-prompt, TaskList, or both? — **Both**, with spawn-prompt authoritative. See [Claiming Arbitration](#claiming-arbitration-rule).
5. What's the fallback if the experimental API changes? — **TeamCreate convention (Shape 2)** is the fallback. See [Shapes](#shapes).

## Analysis

### API Confirmation

Research into official Claude Code documentation confirms:

- **`CLAUDE_CODE_TASK_LIST_ID=name claude`** tells Claude Code which named task list to use. Without it, each session gets its own ephemeral list. With it, multiple sessions point to the same persisted directory.
- Storage is plain JSON files on disk: `~/.claude/tasks/{id}/{task_number}.json` with a `.lock` file for concurrency.
- **TeamCreate with `team_name`** creates the same directory structure: `~/.claude/tasks/{team-name}/` for tasks + `~/.claude/teams/{team-name}/config.json` for membership.
- Any new session with the matching ID sees all persisted tasks immediately. No session coupling — the ID alone is sufficient.
- `CLAUDE_CODE_TASK_LIST_ID` works independently as a task persistence mechanism. `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1` is additionally required for TeamCreate/SendMessage agent coordination features.

**Implication:** The env var and TeamCreate are two entry points to the same persistence layer. Setting `CLAUDE_CODE_TASK_LIST_ID={issue}-{slug}` in a worktree's environment means every Claude session in that worktree shares the task list automatically — even sessions started after the original scaffold session ends.

**Naming contract (critical):** The `CLAUDE_CODE_TASK_LIST_ID` value MUST equal the `team_name` passed to TeamCreate. If they differ, tasks will be created in two separate directories. Scaffold must enforce this: `CLAUDE_CODE_TASK_LIST_ID={issue}-{slug}` and `TeamCreate(team_name="{issue}-{slug}")` use the same value.

### Current Scaffold Flow (Post-#282)

1. Scaffold parses spec → generates micro-tasks (Step 4f)
2. Scaffold creates TaskCreate entries with metadata
3. Scaffold uses TeamCreate with `team_name` → creates `~/.claude/tasks/{team-name}/`
4. Agents receive tasks via spawn prompts (Task tool `prompt` parameter)
5. **Gap:** If a session is interrupted and resumed, agents don't automatically reconnect to the task list
6. **Gap:** No TeamDelete cleanup after PR creation
7. **Gap:** AGENTS.md still describes TaskList claiming as "Post-#283" future behavior

### Remaining Delta

> **Note:** This delta was the original analysis before selecting Shape 2. After selecting Shape 2 (TeamCreate Convention Only), most items were eliminated. The only remaining item was the AGENTS.md "Post-#283" flip, which has been completed.

The actual work is smaller than the issue body suggests because prerequisites are done:

| Change | Files | Complexity |
|--------|-------|-----------|
| Add `CLAUDE_CODE_TASK_LIST_ID` to `.env.example` with docs | `.env.example`, `docs/configuration.mdx` | Low |
| Scaffold: inject `CLAUDE_CODE_TASK_LIST_ID={issue}-{slug}` into worktree `.env` at setup time (dynamic, not placeholder) | `.claude/skills/scaffold/SKILL.md` | Medium |
| Scaffold: add Step 5a for TeamDelete + env var cleanup | `.claude/skills/scaffold/SKILL.md` | Low |
| AGENTS.md: flip "Post-#283" to current protocol | `AGENTS.md` | Low |
| Agent claiming: dual-mode with arbitration rule | `AGENTS.md` (no individual agent file changes needed — frontmatter is done) | Medium |
| Per-worktree isolation: document tag format and worked example | `docs/guides/agent-teams.mdx` | Low |
| Task auto-unblocking: verify `blockedBy` behavior and document | `AGENTS.md`, spike validation | Low |

### Known Limitation

The Claude Code docs note: **in-process teammates do not survive session resumption via `/resume`** — the lead may try to message teammates that no longer exist. This is a teammate-process limitation, not a task persistence limitation. The task data itself is always on disk. This means:

- Task persistence works across sessions ✅
- Agent coordination (SendMessage) does NOT survive session restarts ❌
- Practical impact: if a scaffold session crashes mid-implementation, a new session can see the task list state but cannot message existing agents. The new session must re-spawn agents.

### Claiming Arbitration Rule

With dual-mode claiming (spawn-prompt + TaskList), a conflict can arise: an agent receives a task in its spawn prompt AND later discovers the same task in TaskList (potentially owned by another agent from a previous session). The arbitration rule is:

- **Spawn-prompt assignment is authoritative.** If an agent receives a task in its spawn prompt, it owns that task regardless of TaskList state.
- **TaskList is for discovery of unassigned tasks only.** Agents check TaskList for tasks with `status: "pending"` and no owner. They claim via TaskUpdate.
- **Re-read after claiming.** After calling TaskUpdate to claim a task, re-read TaskList to verify ownership was not overwritten by a concurrent claim (optimistic locking race).

### `.env` Injection Mechanism

Scaffold Step 3d currently does `cp .env.example .env`. The `CLAUDE_CODE_TASK_LIST_ID` value must be **dynamically injected** at scaffold setup time, not stored as a placeholder in `.env.example`. A placeholder value like `{issue_number}-{slug}` in `.env.example` would cause every dev session to accidentally share a task list with a literal string name.

**Approach:** After `cp .env.example .env`, scaffold appends:

```bash
echo "CLAUDE_CODE_TASK_LIST_ID={issue}-{slug}" >> .env
```

`.env.example` gets a commented-out documentation line only:

```bash
# CLAUDE_CODE_TASK_LIST_ID=  # Set by /scaffold — shared task list ID per worktree
```

### TeamDelete and Env Var Cleanup

When scaffold completes (Step 5a), cleanup includes:
1. `TeamDelete` — removes `~/.claude/teams/{team-name}/` and `~/.claude/tasks/{team-name}/`
2. Remove `CLAUDE_CODE_TASK_LIST_ID` line from worktree `.env` — prevents stale task list references if the worktree is reused

Cleanup happens after PR creation, not before. If the worktree is reused for a new scaffold session, the new session injects a fresh ID.

### Task Auto-Unblocking

Issue #283 success criterion 2: "Tasks auto-unblock when dependencies complete." Claude Code's `TaskUpdate` with `addBlockedBy` creates dependency relationships. When a blocking task is marked `completed`, the blocked task becomes eligible for claiming. This is a built-in Claude Code behavior — **this remains unverified; if auto-unblocking is relied upon in a future feature, verify with a two-agent dependency chain test.**

### Per-Worktree Isolation

Issue #283 success criterion 3: "Per-worktree isolation works." The tag format `{issue}-{slug}` (e.g., `283-shared-task-lists`) is unique per feature. Each worktree gets its own `.env` with a distinct `CLAUDE_CODE_TASK_LIST_ID`, pointing to a separate task directory. Two parallel features (e.g., `283-shared-task-lists` and `25-admin-panel`) produce non-overlapping task lists at `~/.claude/tasks/283-shared-task-lists/` and `~/.claude/tasks/25-admin-panel/`.

**Worked example:**

```
# Worktree A: ../roxabi-283
CLAUDE_CODE_TASK_LIST_ID=283-shared-task-lists
# Tasks at ~/.claude/tasks/283-shared-task-lists/

# Worktree B: ../roxabi-25
CLAUDE_CODE_TASK_LIST_ID=25-admin-panel
# Tasks at ~/.claude/tasks/25-admin-panel/

# No cross-contamination — different IDs, different directories.
```

## Shapes

### Shape 1: Full CLAUDE_CODE_TASK_LIST_ID Integration

- **Description:** Set `CLAUDE_CODE_TASK_LIST_ID={issue}-{slug}` in worktree `.env` during scaffold setup. Scaffold's TeamCreate uses matching `team_name`. Agents check TaskList on startup to discover existing tasks. Dual-mode claiming: TaskList first, spawn-prompt fallback.
- **Trade-offs:**
  - Pro: Seamless cross-session persistence. Interrupted scaffolds can resume by re-reading task state.
  - Pro: Aligns with official Claude Code API — not a hack.
  - Con: Depends on experimental API stability.
  - Con: Requires worktree `.env` manipulation (scaffold already does `cp .env.example .env`, so adding a line is low-risk).
- **Rough scope:** 5-6 files, ~2-3 hours of work. Scaffold SKILL.md (medium changes), AGENTS.md (flip sections), `.env.example`, `docs/configuration.mdx`, `docs/guides/agent-teams.mdx`.

### Shape 2: TeamCreate Convention Only

- **Description:** Don't add `CLAUDE_CODE_TASK_LIST_ID` to `.env`. Rely solely on TeamCreate with `team_name={issue}-{slug}` convention. Tasks persist at `~/.claude/tasks/{team-name}/` via TeamCreate. New standalone sessions don't auto-share (they need to call TeamCreate with the same name).
- **Trade-offs:**
  - Pro: Simpler — no env var manipulation.
  - Pro: Already works today (TeamCreate persists tasks).
  - Con: New sessions must explicitly re-create the team to access the task list.
  - Con: No automatic cross-session sharing for ad-hoc sessions.
- **Rough scope:** 4-5 files, ~1-2 hours. Scaffold SKILL.md (minor), AGENTS.md (flip sections), `docs/guides/agent-teams.mdx`.

### Shape 3: Hybrid with Graceful Degradation

- **Description:** Scaffold sets `CLAUDE_CODE_TASK_LIST_ID` in worktree `.env` AND uses TeamCreate with matching name. If the env var is present, sessions share tasks automatically. If not (e.g., API changes), TeamCreate still creates the list and agents get tasks via spawn prompts. Both modes always work.
- **Trade-offs:**
  - Pro: Maximum resilience — works regardless of API stability.
  - Pro: Agents never hard-fail if the env var is missing.
  - Con: Slightly more complex agent logic (check TaskList, fall back to prompt).
  - Con: Two code paths to maintain.
- **Rough scope:** 5-6 files, ~3-4 hours. Same as Shape 1 plus explicit fallback logic in AGENTS.md claiming protocol.

## Fit Check

| Requirement | Shape 1: Full Env Var | Shape 2: TeamCreate Only | Shape 3: Hybrid |
|-------------|----------------------|-------------------------|----------------|
| Cross-session task persistence | ✅ | ❌ | ✅ |
| Degrades gracefully if env var absent | ❌ | ✅ | ✅ |
| Backward compatible with current scaffold | ✅ | ✅ | ✅ |
| Resilient to API changes | ❌ | ✅ | ✅ |
| Minimal implementation effort | ✅ | ✅ | ❌ |
| Session resumption after crash | ✅ | ❌ | ✅ |

**Selected shape:** Shape 2 (TeamCreate Convention Only) — TeamCreate already provides everything we need. `CLAUDE_CODE_TASK_LIST_ID` is unnecessary because scaffold runs from the main repo session, not from worktrees.

## Conclusions

This analysis began as an investigation into `CLAUDE_CODE_TASK_LIST_ID` integration but discovered that **the problem was already solved by existing infrastructure.**

1. **TeamCreate is the shared task list mechanism.** `TeamCreate(team_name="{issue}-{slug}")` creates `~/.claude/tasks/{team-name}/` shared by all teammates. This was already in place from #282.

2. **`CLAUDE_CODE_TASK_LIST_ID` is unnecessary for our workflow.** It enables cross-session task list sharing via env var, but scaffold runs from the main repo — sub-agents are subprocesses of the current session, not separate launches. The env var adds no value.

3. **Most of #283's original scope was already shipped.** Agent frontmatter (9 agents), AGENTS.md protocol, and scaffold micro-tasks were done in prior phases. The only remaining item was the AGENTS.md "Post-#283" flip, which is now complete.

4. **Claiming arbitration rule formalized.** Spawn-prompt assignment is authoritative; TaskList is for discovering unassigned tasks. This is documented in AGENTS.md.

5. **TeamDelete cleanup is optional.** The risk of not cleaning up `~/.claude/teams/` and `~/.claude/tasks/` is negligible — small JSON files with no functional impact. Name collision is mitigated by the `{issue}-{slug}` convention.

## Next Steps

1. **Close #283** — the core feature (shared task lists via TeamCreate) already works. AGENTS.md has been updated.
2. **No spec needed** — the remaining work (AGENTS.md flip) was trivial and is already done.
3. **Optional future work:** Add TeamDelete cleanup step to scaffold if task directory accumulation becomes a problem.
