---
title: "Improve Scaffold Planning with Micro-Tasks"
description: Add spec-driven micro-task generation, committed plan artifacts, and cross-artifact consistency checks to the scaffold skill.
---

## Context

The Roxabi scaffold skill (`/scaffold`) plans implementation via a text-based task list (Step 2d) that agents receive as part of their prompt. This creates three problems: inconsistent task granularity (agents must independently determine execution plans), no per-task verification feedback loop (failures discovered only at the final quality gate), and ephemeral plans (lost if a session is interrupted).

Phase 1 (#280, closed) delivered a complexity scoring rubric (1-10 scale mapping to S/F-lite/F-full tiers). Phase 2 (#281, closed) enriched bootstrap with Breadboard tables (UI→Code→Data affordances) and Slices (demo-able vertical increments). These provide the structured inputs that make spec-driven micro-task generation possible.

**Promoted from:** [Scaffold Micro-Task Planning (Analysis)](../analyses/282-scaffold-micro-task-planning)
**Tier:** F-full (score 4/10, upgraded due to execution model change)

## Goal

Transform scaffold's planning step to produce 2-5 minute micro-tasks with verification commands, scale task count dynamically via complexity scoring, commit a durable plan artifact, and validate spec-to-task consistency — so agents receive precise, verifiable work units instead of vague text plans.

## Users &amp; Use Cases

**Primary user:** Solo developer (project owner) who orchestrates the AI team via `/scaffold`.

| Use Case | Current Pain | Target State |
|----------|-------------|--------------|
| Planning a scaffold session | Text-based task descriptions, arbitrary granularity | Micro-tasks with file paths, code snippets, and verification commands |
| Verifying agent work | Quality gate only at the end (`bun lint &amp;&amp; bun typecheck &amp;&amp; bun test`) | Per-task verification after each micro-task completion |
| Resuming an interrupted scaffold | Plan lost — must re-plan from scratch | Plan persists in `plans/{issue}-{slug}.mdx` on the worktree branch |
| Reviewing a PR | No visibility into what was planned vs. implemented | Plan artifact in the PR shows intended vs. actual |
| Ensuring spec coverage | Manual comparison of spec criteria to implementation | Automated bidirectional consistency check (spec↔tasks) |

## Expected Behavior

### Happy path

**Tier S:** Step 4f is skipped entirely. Scaffold proceeds directly from stubs (Step 4e) to single-session implementation (existing Step 5 path). No micro-tasks generated.

**Tier F-lite / F-full:**

1. Scaffold completes Steps 1-4e as today (locate spec, plan, setup worktree, scaffold stubs).
2. **Step 4f begins.** Scaffold reads the spec and detects whether Breadboard + Slices sections exist.
3. **Primary mode** (post-#281 specs): Scaffold parses Breadboard affordances (U*, N*, S*) and Slices (V1, V2, ...). For each slice, it generates micro-tasks organized by affordance type: data stores first, then code handlers, then UI, then tests.
4. **Fallback mode** (pre-#281 specs): Scaffold parses Success Criteria as SC-1, SC-2, etc., and expands each criterion into 1-5 micro-tasks based on affected files and logic complexity.
5. Each micro-task includes: description, file path, code snippet (lightweight skeleton), verification command, expected output, time estimate (2-5 min), `[P]` marker if parallel-safe, agent assignment, and spec trace. `[P]` means the task has no file-path overlap or import dependency with other tasks in the same slice — it can run concurrently.
6. Scaffold calculates the feature-level complexity score (from #280 rubric) and derives the target task count range: F-lite = 5-15, F-full = 15-30. Minimum floor: 3 tasks (one infrastructure/setup, one core implementation, one test/verification).
7. Scaffold runs the **cross-artifact consistency check** (bidirectional: spec→tasks coverage, tasks→spec gold plating). A consistency report is generated.
8. If the task count exceeds 30, scaffold warns the user via `AskUserQuestion` and suggests splitting via `/bootstrap` Gate 2.5 (#285) or manual decomposition. The full task list is shown — no truncation.
9. Scaffold commits the plan artifact as a **standalone commit** (separate from the Step 4e stub commit, never amending):
   ```bash
   git add plans/{issue}-{slug}.mdx
   git commit -m "$(cat <<'EOF'
   docs(<scope>): add scaffold plan for <feature>

   Micro-task plan with consistency report. Generated from spec.

   Refs #<issue_number>

   Co-Authored-By: Claude <model> <noreply@anthropic.com>
   EOF
   )"
   ```
10. Scaffold presents the micro-task queue and consistency report to the user via `AskUserQuestion`. Options: approve, modify (regenerate with adjusted parameters or manual task edits), return to spec.
11. On approval, scaffold creates `TaskCreate` entries for each micro-task with metadata.
12. **Step 5 begins.** Agents receive their assigned micro-tasks instead of text-based plans.
13. **RED phase:** Tester agent receives test micro-tasks, writes failing tests per slice. After completing all test tasks for a slice, the tester marks a sentinel task `"RED complete: V{N}"` as completed. This sentinel task is auto-generated per slice during TaskCreate (one per slice, assigned to tester, with `phase: "RED-GATE"`).
14. **GREEN phase:** Domain agents receive implementation micro-tasks. Before running a deferred verification command, the agent checks whether the `"RED complete: V{N}"` sentinel for that task's slice is marked completed. If completed → verification status is `[ready]`, run the command. If not completed → skip verification, continue to next task (or wait if no other tasks are available). Agents run verification after each task where status is `[ready]`.
15. **REFACTOR phase:** Domain agents refactor while keeping tests green.
16. Verification failure loop: fix → re-verify (max 3 retries) → escalate to lead with task ID, error output, attempted fixes, and affected files.

### Edge cases

| Scenario | Handling |
|----------|----------|
| **Spec has no Breadboard AND no Success Criteria** | Scaffold falls back to Step 2d's text-based task list and warns the user that micro-task generation requires structured spec content. Step 4f is skipped. |
| **Task count exceeds 30** | Warn user, show full task list, suggest splitting. Do not truncate. User can proceed or return to spec. |
| **Complexity score changes between bootstrap and scaffold** | Re-score at scaffold time using the spec's final content. Bootstrap score is informational; scaffold score is authoritative. |
| **Verification command references a file that doesn't exist** | The command should be marked `[deferred]` with a note. If it fails after RED phase, escalate to lead. |
| **Consistency check finds 0 coverage (no tasks match any criterion)** | Block agent spawning. This indicates the micro-task generation failed fundamentally — return to spec or regenerate. |
| **Agent completes all tasks but quality gate fails** | Standard flow: agents fix and re-test. Micro-tasks are complete but the integration failed — this is expected and handled by the existing loop. |
| **Pre-commit hook failure on plan artifact commit** | Fix + new commit (never amend). Plan artifact is a non-blocking commit — stubs are already committed. |
| **`plans/` directory doesn't exist** | Scaffold creates `plans/` on first use. |
| **Spec has `[NEEDS CLARIFICATION]` markers** | Handled by existing Step 2a.1 pre-flight (before Step 4f). Micro-task generation only runs after the pre-flight passes. |
| **Single affordance expands beyond 5 minutes** | Split into 2-3 sub-tasks. The 2-5 min target is a guide; some tasks may reach 8-10 min for atomic operations. |
| **Import analysis finds no imports in new file stubs** | Default to non-parallel-safe (conservative). File-path check alone catches common conflicts. |
| **Session interrupted after plan commit but before agent spawning** | S2 (TaskCreate entries) is transient and lost. On resume: re-read the plan artifact (S3), reconstruct TaskCreate entries from it (N6), skip consistency check (already in the plan). |
| **User wants to regenerate micro-tasks after plan commit** | Create a new commit with the regenerated plan (never amend the previous plan commit). The latest plan artifact is authoritative. |

## Breadboard

Adapted for a skill/config change (no traditional UI). "UI" = scaffold CLI interactions, "Code" = skill processing logic, "Data" = artifacts and task entries.

### CLI Affordances (User Interaction)

| ID | Element | Location | Trigger |
|----|---------|----------|---------|
| U1 | Micro-task queue display | Step 4f approval prompt | Generation complete |
| U2 | Consistency report display | Step 4f approval prompt | Consistency check complete |
| U3 | Over-cap warning | Step 4f approval prompt | Task count &gt; 30 |
| U4 | Verification result display | Step 5 agent execution | Each task completion |

### Code Affordances (Skill Processing)

| ID | Handler | Wiring | Logic |
|----|---------|--------|-------|
| N1 | Spec parser | Spec file → N1 | Extract Breadboard affordances (U*, N*, S*) and Slices (V*) from MDX. Fallback: extract Success Criteria as SC-*. |
| N2 | Micro-task generator | N1 → N2 → S2 | For each slice: expand affordances into micro-tasks (1-3 per affordance). Assign agents, set [P] markers, generate verification commands. |
| N3 | Parallelization detector | N2 → N3 | File-path overlap check + design-time import inference (from Breadboard wiring: N1→S1 implies handler imports store). Default new-file tasks to non-parallel-safe. |
| N4 | Consistency checker | N2 + S1 → N4 → U2 | Bidirectional: every spec criterion/affordance has &gt;=1 task (coverage), every task traces to spec (gold plating check with exemptions). |
| N5 | Plan artifact writer | N2 + N4 → N5 → S3 | Generate `plans/{issue}-{slug}.mdx` with full micro-task details, consistency report, and bootstrap context (from analysis). |
| N6 | TaskCreate dispatcher | N2 → N6 → S2 | Create TaskCreate entries with metadata: `taskDifficulty`, `verificationCommand`, `verificationStatus`, `estimatedMinutes`, `parallel`, `specTrace`, `slice`, `phase`. |
| N7 | Verification runner | S2 → N7 → U4 | Agent runs verification after each task. Check `verificationStatus` (skip if `deferred` and RED incomplete). Fix + re-verify loop (max 3 retries). |

### Data Stores

| ID | Store | Type | Accessed by |
|----|-------|------|-------------|
| S1 | Spec file (`specs/{issue}-{slug}.mdx`) | Persistent (git) | N1, N4 |
| S2 | TaskCreate entries | Transient (session) | N2, N6, N7 |
| S3 | Plan artifact (`plans/{issue}-{slug}.mdx`) | Persistent (git, worktree branch) | N5 |
| S4 | Analysis file (`analyses/{issue}-*.mdx`) | Persistent (git) | N5 (bootstrap context extraction) |

**Unknowns:** None — all wiring is determined. The Breadboard/Slices MDX format is established by #281's spec template in the interview skill.

### TaskCreate Metadata Schema

Each micro-task created via N6 carries this metadata:

```json
{
  "taskDifficulty": 3,
  "verificationCommand": "bun run test apps/api/test/auth.test.ts",
  "verificationStatus": "deferred",
  "expectedOutput": "1 passing test: validate email format",
  "estimatedMinutes": 3,
  "parallel": true,
  "specTrace": "SC-3, N1→S1",
  "slice": "V1",
  "phase": "GREEN"
}
```

| Field | Type | Values | Description |
|-------|------|--------|-------------|
| `taskDifficulty` | number | 1-5 | Per-task difficulty (not feature complexity). 1=trivial, 5=complex multi-concern. |
| `verificationCommand` | string | bash command | Executable check that confirms completion. |
| `verificationStatus` | string | `"ready"`, `"deferred"`, or `"manual"` | `"ready"` = run immediately. `"deferred"` = wait for RED-GATE sentinel. `"manual"` = no automated check available, agent marks complete after code/file inspection. |
| `expectedOutput` | string | text | What success looks like when the verification command runs. |
| `estimatedMinutes` | number | 2-10 | Target: 2-5 min. May reach 8-10 for atomic operations. |
| `parallel` | boolean | true/false | `true` if `[P]` (no file/import conflicts with sibling tasks). |
| `specTrace` | string | IDs | Spec criterion (`SC-N`) or affordance wiring (`U1→N1→S1`). |
| `slice` | string | `V1`, `V2`, ... | Which vertical slice this task belongs to. |
| `phase` | string | `"RED"`, `"GREEN"`, `"REFACTOR"`, `"RED-GATE"` | Which implementation phase. `"RED-GATE"` is the per-slice sentinel. |

### Plan Artifact Template

The plan artifact committed to `plans/{issue}-{slug}.mdx` follows this structure:

```markdown
---
title: "Plan: {Feature Title}"
issue: {issue_number}
spec: specs/{issue}-{slug}.mdx
complexity: {score}/10
tier: {S|F-lite|F-full}
generated: {ISO timestamp}
---

## Summary

{1-2 sentence overview of the feature and implementation approach}

## Bootstrap Context

{Conclusions and selected shape from analyses/{issue}-*.mdx, if exists}

## Agents

| Agent | Task count | Files |
|-------|-----------|-------|
| {agent} | {N} | {comma-separated file list} |

## Consistency Report

- Criteria covered: {N}/{total}
- Uncovered criteria: {list or "none"}
- Tasks without spec backing: {list or "none"}
- Gold plating exemptions applied: {count}

## Micro-Tasks

### Slice V1: {Description}

#### Task 1: {Description} [P] → {agent}
- **File:** {path}
- **Snippet:** {code skeleton}
- **Verify:** `{command}` ({ready|deferred|manual})
- **Expected:** {output}
- **Time:** {N} min
- **Difficulty:** {1-5}
- **Traces:** {SC-N, U1→N1→S1}
- **Phase:** {RED|GREEN|REFACTOR}

#### Task 2: {Description} → {agent}
...

#### RED-GATE: RED complete V1 → tester
- **Verify:** All test tasks for V1 marked complete
- **Phase:** RED-GATE
```

The `plans/` directory is intentionally tracked in git (not gitignored). It lives at project root alongside `analyses/` and `specs/`.

## Slices

| Slice | Description | Affordances | Demo |
|-------|-------------|-------------|------|
| V1 | Micro-task generation from spec | N1, N2, N3, U1 | Run `/scaffold --spec N` on a test spec. Step 4f generates micro-tasks from Breadboard+Slices (or criteria fallback). Tasks displayed with file paths, snippets, verification commands, [P] markers, and agent assignments. |
| V2 | Consistency check + plan artifact | N4, N5, U2, U3, S3, S4 | Consistency report shows coverage gaps and gold plating flags. Plan committed to `plans/{issue}-{slug}.mdx`. Over-cap warning triggers if &gt;30 tasks. |
| V3 | Agent micro-task consumption | N6, N7, U4, S2 | Step 5 agents receive micro-tasks via TaskCreate. RED→GREEN→REFACTOR with deferred verification. Verification runs after each GREEN task, with fix+re-verify loop. |

## Constraints

- **Depends on #280 (closed):** Complexity scoring rubric used for dynamic task count.
- **Depends on #281 (closed):** Breadboard/Slices spec format used for primary generation mode.
- **Compatible with #283 (open):** TaskCreate works with or without shared task lists. If #283 ships later, tasks use `CLAUDE_CODE_TASK_LIST_ID` for shared access. If not, tasks are passed to agents via spawn prompts.
- **#285 (open) is recommended but not required:** Over-cap handling suggests Gate 2.5 splitting but does not depend on it. Manual decomposition is the fallback.
- **Files in scope:** Primary: `.claude/skills/scaffold/SKILL.md` (Step 4f + modified Step 5). Secondary: `AGENTS.md` (add micro-task consumption protocol: how agents claim tasks, run verification, handle deferred status, escalate failures). Optional: `.claude/skills/scaffold/references/` (plan template, micro-task examples).
- **Backward compatible:** Pre-#281 specs (without Breadboard/Slices) use fallback mode. Specs with no structured content skip Step 4f entirely.

## Non-goals

- **No changes to `/review` or `/promote` skills.** These pipelines are untouched.
- **No auto-splitting.** The 30-task cap warns and suggests splitting but does not auto-create sub-issues. That is #285 (Gate 2.5).
- **No MCP or external tool integration.** No TaskMaster.dev MCP server or other external tools.
- **No `/retro` skill integration.** Plan artifacts are stored but `/retro` does not yet consume them. This is a forward reference for future enhancement.
- **No changes to Step 2d.** The existing high-level task breakdown remains as the human-readable plan. Step 4f expands it into agent-consumable micro-tasks.
- **No per-task model switching.** All agents use their existing model assignments. Per-task Sonnet/Opus selection is deferred to #286.

## Technical Decisions

### Step 2d and Step 4f are complementary, not redundant

**Decision:** Step 2d continues to produce the same agent-assigned task groups as today (coarse planning for human approval). Step 4f expands each 2d task into fine-grained micro-tasks for agent execution. Both exist — 2d for human understanding, 4f for agent precision.

**Rationale:** Removing 2d would force users to review 15-30 micro-tasks at the approval step (Step 2e), which is too granular for a go/no-go decision. The two-level approach gives humans the big picture (2d) and agents the details (4f).

### Spec-driven generation over LLM-planned or template-based

**Decision:** Parse spec's Breadboard + Slices to generate micro-tasks deterministically. Fall back to acceptance criteria for pre-#281 specs.

**Rationale:** Leverages #281 investment (breadboard/slices become actionable, not just documentation). Enables bidirectional consistency checking. The "novel architectures" gap is mitigated by the fallback mode. See analysis Fit Check for full comparison.

### `taskDifficulty` (1-5) distinct from feature `complexity` (1-10)

**Decision:** Per-task difficulty uses a separate 1-5 scale: 1 = trivial single-line change, 2 = straightforward single-file, 3 = multi-concern within one file, 4 = cross-file coordination, 5 = complex multi-concern logic. This is distinct from #280's feature-level complexity score (1-10 weighted average).

**Rationale:** Feature complexity and task difficulty measure different things. Using the same field name with different semantics creates confusion for agents and downstream tools.

### Deferred verification preserves RED→GREEN→REFACTOR

**Decision:** Verification commands on implementation tasks are generated with `verificationStatus: "deferred"` until the tester completes RED for the corresponding slice. Domain agents check verification status before running — skip if deferred and RED incomplete.

**Rationale:** Test stubs from Step 4c contain `// TODO` blocks. Running `bun run test` against them would always fail, wasting retry loops. The deferred model ensures verification runs only after real test bodies exist.

**Ordering protocol:** Within each slice, tester completes all RED tasks before domain agents start GREEN tasks. Across slices, this pipelines: tester works on V2's RED while domain agents work on V1's GREEN.

### Design-time import analysis, not runtime

**Decision:** The 1-hop import analysis at Step 4f uses design-time estimation: for existing files, read current imports; for new files, infer planned imports from Breadboard wiring (e.g., N1→S1 implies handler imports store). New-file tasks with unknown imports default to non-parallel-safe.

**Rationale:** Stubs have minimal imports. The actual import graph is unknowable until implementation. Conservative defaults prevent race conditions; file-path checking catches the most common conflicts.

### Plan artifacts persist on main after merge

**Decision:** Plans are committed to the worktree branch, included in the PR, and merged to main as a historical archive. `plans/` lives at project root (not inside `docs/`), is not rendered by Fumadocs.

**Rationale:** Lightweight markdown artifacts. Long-term traceability outweighs the cost of a few KB per feature. If accumulation becomes a concern, a future cleanup policy can archive them.

### Gold plating exemption allowlist

**Decision:** The consistency check does not flag tasks in these exempt categories as gold plating:

| Category | Examples |
|----------|---------|
| **Infrastructure** | DB migrations, schema changes, config file updates |
| **Quality** | Linting fixes, formatting, barrel/index export updates |
| **Build** | Package.json changes, build configuration, environment setup |
| **Documentation** | Inline code comments, JSDoc, README updates required by the feature |

All other tasks without spec backing require justification.

**Rationale:** These task types are architecturally required but rarely appear as explicit spec criteria. A formal allowlist prevents the check from being too strict while preserving its value for implementation tasks.

### Bootstrap context caching in plan artifact

**Decision:** When generating the plan artifact, if an analysis exists at `analyses/{issue}-*.mdx`, include its Conclusions and selected Shape sections under a `## Bootstrap Context` heading in the plan. This gives domain agents architectural rationale without re-reading the analysis.

**Rationale:** Per #280's recommendation (Hotspot 4 mitigation): avoid architect agents re-reading 30-50 files by passing bootstrap findings as plan context.

## Success Criteria

- [ ] Scaffold generates micro-tasks with verification commands from a spec containing Breadboard + Slices sections — at least 3 micro-tasks per slice with at least 1 verification command per task. Validated on 1 real feature with &gt;=10 total micro-tasks.
- [ ] At least 80% of generated verification commands pass on first try during GREEN phase (denominator = tasks with `verificationStatus: "ready"` at execution time, measured per scaffold session). Validated on 1 real feature with &gt;=10 micro-tasks.
- [ ] Plan artifact is committed to `plans/{issue}-{slug}.mdx` as a standalone commit (not amending stubs) before agent spawning, and appears in the PR diff.
- [ ] Tier S scaffolds skip Step 4f entirely — confirmed by running a Tier S scaffold and verifying no micro-task generation occurs.
- [ ] Consistency check detects coverage gaps (criterion with no task) AND gold plating (task with no spec trace) — validated with at least 1 intentionally planted instance of each.
- [ ] Consistency check with 0 coverage blocks agent spawning — validated by providing a spec where no generated tasks match any criterion.
- [ ] Fallback mode generates at least 1 micro-task per success criterion, each with a verification command (or explicit `[manual]` marker) — validated on a pre-#281 spec without Breadboard/Slices.
- [ ] Over-cap warning triggers when task count exceeds 30 — validated by testing with a dense spec.
- [ ] RED-GATE sentinel tasks are auto-generated per slice and domain agents correctly defer verification until the sentinel is completed.

## Open Questions

- **Breadboard/Slices MDX format stability:** The format is defined by #281's interview skill template. If the template evolves, Step 4f's parser must adapt. Pin the current format as v1 and version the parser if format changes.
- **`CLAUDE_CODE_TASK_LIST_ID` API stability:** #283 depends on this experimental API. If it changes, TaskCreate entries still work but shared persistent access may not. Monitor Claude Code changelogs.
- **Over-cap threshold calibration:** 30 is an initial estimate. After 3-5 scaffold sessions with micro-tasks, revisit whether the cap should be adjusted (especially after #283 adds shared task lists that may improve coordination at higher task counts).
- **Verification command false positive rate:** The 80% first-try pass rate is a target. If below 60% on 3 consecutive scaffolds, trigger root-cause investigation: command generation quality vs. agent implementation quality — different root causes require different fixes.
- **Session resumption orchestration:** The plan artifact persists, but full resume orchestration (re-reading the plan, reconstructing task state, resuming agents mid-flow) is a best-effort behavior, not a guaranteed feature. Full resume may require #283's persistent task lists.
- **Breadboard/Slices format pin:** At implementation time, document the exact heading patterns N1 uses to identify Breadboard and Slices sections in SKILL.md Step 4f. Add a version comment so format changes are detectable.
