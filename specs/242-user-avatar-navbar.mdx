---
title: "User Avatar System — DiceBear Customization & Navbar Integration"
description: DiceBear avatar in navbar via CDN URL, UserMenu org-link cleanup, new styles, and dynamic per-style customization options.
---

## Context

The profile settings page (`/settings/profile`) already has a working DiceBear avatar picker with 5 styles and a seed input. The backend stores `avatarStyle` and `avatarSeed` on the user profile via `PATCH /api/users/me`. However, the navbar avatar reads `user.image` from the Better Auth session (usually null) and falls back to text initials — the DiceBear configuration is never displayed outside the settings page.

The `UserMenu` dropdown also duplicates org-related links (Org Settings, Org Members) that already exist in the `OrgSwitcher` component.

**Promoted from:** [User Avatar System Analysis](../analyses/242-user-avatar-navbar)

**Dependencies:**
- Existing auth system ([Spec: #19 Auth + Users](./19-auth-users))
- Existing user profile editing ([Spec: #201 User Account Management](./201-user-account-management))

## Goal

Enable users to fully customize their DiceBear avatar (style, seed, per-style options), display it in the navbar and everywhere `user.image` is used, clean up the `UserMenu` by removing duplicate org links, and ensure every user has a unique avatar from day one.

## Users &amp; Use Cases

**Primary user:** Authenticated user managing their profile avatar.

| Use Case | Workflow |
|----------|----------|
| Customize avatar | User navigates to `/settings/profile`, selects a style, adjusts options (colors, features), sees real-time preview, saves |
| Randomize avatar | User clicks "Randomize" button on profile page to generate a new random avatar, adjusts if desired, saves |
| View avatar in navbar | User sees their DiceBear avatar in the `UserMenu` trigger button across all pages |
| New user default | New user signs up and immediately sees a unique DiceBear avatar (lorelei style, user ID seed) in the navbar |

## Expected Behavior

### Happy path — Avatar customization

1. User navigates to `/settings/profile`
2. Avatar section shows current DiceBear avatar with large preview
3. User selects a style from the dropdown (7 options: lorelei, bottts, pixel-art, thumbs, avataaars, adventurer, toon-head)
4. Dynamic options form renders controls for the selected style:
   - **Primary options** (always visible): `backgroundColor`, color options (`hairColor`, `skinColor`), major feature selectors (`eyes`, `mouth`, `hair`, `clothing`)
   - **Advanced options** (behind collapsible toggle): positioning (`flip`, `rotate`, `scale`), probability toggles (`glassesProbability`, `facialHairProbability`), minor features
5. Avatar preview updates **in real-time** as user changes any option
6. User optionally types a custom seed or clicks the **Randomize** button (generates a new random seed via `crypto.randomUUID()` and resets all options to the style's defaults — producing a fresh, unique avatar)
7. User clicks Save:
   - Frontend constructs the DiceBear CDN URL from style + seed + options
   - Frontend sends `PATCH /api/users/me` with `{ avatarStyle, avatarSeed, avatarOptions, image: cdnUrl }`
   - Backend persists all fields
   - Frontend calls `authClient.getSession({ fetchOptions: { cache: 'no-cache' } })` to force session refresh
   - Navbar avatar updates immediately to show the new DiceBear avatar

### Happy path — Navbar display

1. User is authenticated and has a DiceBear avatar configured (or default)
2. The `UserMenu` trigger shows `&lt;AvatarImage src={user.image}>` — which now contains the DiceBear CDN URL
3. The avatar displays as an SVG image loaded from `api.dicebear.com`
4. If the CDN image fails to load, the `&lt;AvatarFallback>` shows text initials (existing behavior)

### Happy path — UserMenu cleanup

1. User clicks the avatar to open the `UserMenu` dropdown
2. Dropdown shows: name/email label, Profile link, Account link, separator, Sign Out
3. Org Settings and Org Members links are **no longer present** (accessible via `OrgSwitcher` instead)

### Happy path — New user default

1. New user signs up (email/password or OAuth)
2. Backend sets `avatar_style = 'lorelei'`, `avatar_seed = user.id`, `avatar_options = '{}'`
3. Backend computes the DiceBear CDN URL and writes it to `image`
4. User sees a unique DiceBear avatar in the navbar immediately after signup
5. OAuth users who have a provider profile photo: the OAuth photo is preserved in `image` (DiceBear defaults are set but `image` is not overwritten)

### Edge cases

| Scenario | Behavior |
|----------|----------|
| DiceBear CDN is unreachable | `&lt;AvatarFallback>` shows text initials. Avatar will recover when CDN comes back (browser re-fetches). |
| CDN URL exceeds 2000 characters | Frontend shows a warning before save: "Avatar URL is very long. Some features may not display correctly." Allow save anyway. |
| User changes style but doesn't save | No changes persisted. Navigating away discards unsaved changes. |
| OAuth user has existing profile photo | Default DiceBear values set on signup but `image` column keeps the OAuth photo. User can overwrite by explicitly saving avatar settings. |
| OAuth user wants to restore provider photo | Out of scope for V1. User would need to re-authenticate with the provider. |
| `@dicebear/toon-head` package doesn't exist | Verify on npm during implementation. If the package name differs, use the correct name (e.g., `@dicebear/big-ears` or `@dicebear/croodles`). Update the style list accordingly. |
| User saves with no options changed | Save persists defaults — no-op effectively. CDN URL generated from default options. |
| Session cookie stale after save | Force session refresh (`authClient.getSession({ cache: 'no-cache' })`) resolves this. If refresh fails, avatar updates on next page load (5-min cache TTL). |
| Randomize button pressed multiple times | Each press generates a new random seed + options. Only the last state is saved when user clicks Save. |

## Constraints

- **CSP update required:** `api.dicebear.com` must be added to `imgSrc` in the Content Security Policy. **Hard blocker** — without it, avatars fail silently in production.
- **No file upload:** Avatar is DiceBear-generated. No S3/blob storage needed.
- **Bundle size:** DiceBear style packages are code-split via dynamic import on `/settings/profile` only. Never imported in `apps/api` or navbar components.
- **Better Auth session sync:** The `image` column is managed by Better Auth. Writing via direct Drizzle UPDATE is how the existing `PATCH /api/users/me` works — verify this doesn't conflict with Better Auth's session management. If it does, use `auth.api.updateUser()` instead.
- **DiceBear CDN dependency:** Accepted for V1. Self-hosting is a future hardening option.
- **`user.image` is shared:** DiceBear URLs and OAuth photos coexist in the same column. No distinction mechanism in V1.

## Non-goals

- File upload for avatar (no S3/blob infrastructure)
- OAuth photo preservation or revert functionality
- Exhaustive per-style option validation on the backend (frontend owns the option schema per style; backend validates JSON and URL only)
- Self-hosting the DiceBear API
- Notification to other users when avatar changes
- Avatar in contexts outside `user.image` (e.g., separate avatar column for different sizes)

## Technical Decisions

### Schema Migration

Add to `users` table:

```sql
ALTER TABLE users ADD COLUMN avatar_options JSONB DEFAULT '{}';
```

Existing columns `avatar_seed` and `avatar_style` are already present.

**Drizzle schema update:** Add `jsonb` import and define:

```typescript
avatarOptions: jsonb('avatar_options').default({}).$type<Record<string, unknown>>(),
```

### Data Backfill Migration

After schema migration, run a data backfill:

```sql
-- Case 1: avatar_style set, image null → compute CDN URL
UPDATE users
SET image = concat(
  'https://api.dicebear.com/9.x/',
  avatar_style,
  '/svg?seed=',
  COALESCE(avatar_seed, id::text)
)
WHERE avatar_style IS NOT NULL AND image IS NULL;

-- Case 2: both null → set defaults + CDN URL
UPDATE users
SET
  avatar_style = 'lorelei',
  avatar_seed = id::text,
  avatar_options = '{}',
  image = concat('https://api.dicebear.com/9.x/lorelei/svg?seed=', id::text)
WHERE avatar_style IS NULL AND image IS NULL;

-- Case 3: image already set (OAuth) → only set defaults if missing
UPDATE users
SET
  avatar_style = COALESCE(avatar_style, 'lorelei'),
  avatar_seed = COALESCE(avatar_seed, id::text),
  avatar_options = COALESCE(avatar_options, '{}')
WHERE avatar_style IS NULL AND image IS NOT NULL;
```

### API Changes

| Method | Endpoint | Change |
|--------|----------|--------|
| PATCH | `/api/users/me` | Accept new field `avatarOptions` (JSONB) and `image` (string, the CDN URL). Validate: `image` starts with `https://api.dicebear.com/`, max 2000 characters. `avatarOptions` must be a valid JSON object (no array/primitive). |
| GET | `/api/users/me` | Return `avatarOptions` in response. Add `avatarOptions` to `profileColumns` projection. |

### New DiceBear Packages

Install in `apps/web`:
```bash
bun add @dicebear/adventurer @dicebear/toon-head
```

Verify `@dicebear/toon-head` exists on npm first. If not, substitute with the correct package name.

### CSP Update

Add `api.dicebear.com` to the Content Security Policy `imgSrc` directive. The CSP is configured via `@fastify/helmet` in the API bootstrap (`apps/api/src/index.ts`), with `imgSrc` currently set to `["'self'", 'data:']`. Add `'https://api.dicebear.com'` to this array.

### CDN URL Builder (Frontend Utility)

```typescript
function buildDiceBearUrl(
  style: string,
  seed: string,
  options: Record<string, unknown> = {},
): string {
  const params = new URLSearchParams({ seed })
  for (const [key, value] of Object.entries(options)) {
    if (value !== undefined && value !== null) {
      params.set(key, Array.isArray(value) ? value.join(',') : String(value))
    }
  }
  return `https://api.dicebear.com/9.x/${style}/svg?${params.toString()}`
}
```

### Dynamic Options Form

The form reads the selected style's options from the DiceBear style module's schema/metadata at runtime. Control types:

| Option Type | UI Control |
|-------------|------------|
| Color (palette array) | Swatch picker from allowed colors |
| Enum (string variants) | Select dropdown with variant names |
| Probability (0-100) | Toggle on/off (maps to 0 or 100) |
| Boolean | Toggle switch |

**Primary vs. Advanced grouping rule:**
- **Primary**: options where a change is visible at a glance (colors, major features like eyes/mouth/hair/clothing)
- **Advanced**: positioning, probability, minor features — behind a collapsible "Advanced" toggle
- If a style has no advanced options, hide the collapsible toggle entirely

**DiceBear schema dependency:** If style modules do not export a machine-readable option schema at runtime, the dynamic form must use a hardcoded configuration map per style. In that case, define a `STYLE_OPTIONS_CONFIG` record mapping each style to its primary/advanced option definitions. This increases maintenance burden but is the fallback if runtime schema is unavailable.

### Frontend File Changes

| File | Change |
|------|--------|
| `apps/web/src/components/UserMenu.tsx` | Remove `activeOrg` conditional block (org settings/members links + separator) |
| `apps/web/src/components/__tests__/UserMenu.test.tsx` | Update tests to remove assertions for org settings/members links |
| `apps/web/src/routes/settings/profile.tsx` | Add new styles to `AVATAR_STYLES`, add `avatarOptions` state, add dynamic options form, add Randomize button, add CDN URL builder, add session refresh after save |
| `apps/web/package.json` | Add `@dicebear/adventurer` and `@dicebear/toon-head` |
| i18n message files | Add Paraglide message keys for new UI strings (Randomize button, Advanced toggle, style names, option labels) |

### Backend File Changes

| File | Change |
|------|--------|
| Users Drizzle schema | Add `avatarOptions` JSONB column (`.notNull().default({})`) |
| Users service / DTO | Accept `avatarOptions` and `image` in PATCH; validate `image` URL prefix + max 2000 chars; add `avatarOptions` to `profileColumns` |
| Users service (purge) | Add `avatarOptions: {}` to the purge/anonymization SET clause (alongside existing `avatarSeed: null`, `avatarStyle: null`, `image: null`) |
| Migration file | Schema migration + data backfill |
| User creation hook/service | Set default `avatarStyle`, `avatarSeed`, compute `image` CDN URL for new users without OAuth photos. Use Better Auth `databaseHooks` with `user.create.after` callback in `auth.instance.ts`. |
| CSP config (`apps/api/src/index.ts`) | Add `'https://api.dicebear.com'` to Helmet `imgSrc` |

## Success Criteria

- [ ] User can select from 7 DiceBear styles (lorelei, bottts, pixel-art, thumbs, avataaars, adventurer, toon-head) on `/settings/profile`
- [ ] Dynamic options form renders style-specific controls (colors, features, toggles)
- [ ] Primary options are always visible; advanced options are behind a collapsible toggle
- [ ] Avatar preview updates in real-time as user changes any option
- [ ] Randomize button generates a new random seed and shuffles options
- [ ] Saving avatar writes `avatarStyle`, `avatarSeed`, `avatarOptions`, and DiceBear CDN URL to backend
- [ ] Navbar `UserMenu` avatar displays the DiceBear CDN image from `user.image`
- [ ] Navbar avatar updates immediately after save (session refresh)
- [ ] `UserMenu` dropdown no longer shows Org Settings or Org Members links
- [ ] New users get a default DiceBear avatar (lorelei + user ID seed) written to `user.image` on account creation
- [ ] OAuth users keep their provider photo on signup; can overwrite by saving avatar settings
- [ ] Existing users without avatars are backfilled via data migration
- [ ] CSP updated to allow `api.dicebear.com` in `imgSrc`
- [ ] Backend validates that `image` URL starts with `https://api.dicebear.com/` on PATCH
- [ ] DiceBear packages are code-split — not in the main bundle
- [ ] Frontend warns if generated CDN URL exceeds 2000 characters
- [ ] Backend rejects `image` URLs longer than 2000 characters
- [ ] Purge/anonymization clears `avatarOptions` alongside `avatarSeed`, `avatarStyle`, and `image`
- [ ] New UI strings use Paraglide i18n message keys (not hardcoded English)
- [ ] `UserMenu` tests updated to reflect removed org links

## Open Questions

- **`@dicebear/toon-head` package name:** Verify this exact package exists on npm. DiceBear style names sometimes differ from their display names. Fallback options: `@dicebear/big-ears`, `@dicebear/croodles`, or `@dicebear/fun-emoji`. Substitute and update the style list if needed.
- **Better Auth `image` field sync:** Does writing to `image` via direct Drizzle UPDATE conflict with Better Auth's session management? If so, use `auth.api.updateUser()` instead.
- **DiceBear schema export:** Does each style module export a machine-readable schema of its options at runtime, or does the dynamic form need a hardcoded `STYLE_OPTIONS_CONFIG` map? Verify by importing a style module and checking for `schema` or `meta` exports. If not available, budget extra time for hardcoded config.
