---
title: "Staging Environment with On-Demand Preview Deploys"
description: Add a staging branch as integration point with manual preview deploys via GitHub Actions
status: implemented
---

## Context

All changes merged to `main` currently trigger an automatic Vercel production deploy. This means WIP or non-production-ready code can reach production prematurely. A staging gate is needed between feature work and production.

The project currently uses GitHub Flow (feature branches → main → auto-deploy). This spec introduces a `staging` branch as an integration point while keeping `main` as the production-only branch.

**Promoted from:** [Staging Environment Analysis](../analyses/114-staging-environment-preview-deploys)

## Goal

Introduce a `staging` branch that serves as the default PR target for all feature work. Production deploys only happen when `staging` is promoted to `main`. On-demand preview deploys are available via GitHub Actions for testing before promotion.

## Users &amp; Use Cases

| User | Workflow |
|------|----------|
| **Developer** | Creates feature branch → opens PR to `staging` → CI runs → merges |
| **Developer (preview)** | Goes to Actions → "Deploy Preview" → selects web/api/both → gets preview URL |
| **Developer (promote)** | Opens PR from `staging` to `main` → CI runs → merges → auto-deploy to production |
| **Developer (hotfix)** | Creates `hotfix/*` branch → opens PR directly to `main` → CI runs → merges → auto-deploy |

## Expected Behavior

### Happy path

1. Developer creates a feature branch from `staging`
2. Opens PR targeting `staging`
3. CI runs (lint, typecheck, test, build, E2E) — same gates as main
4. PR is reviewed and merged to `staging`
5. No Vercel deploy occurs (staging is a quiet integration branch)
6. Developer optionally triggers "Deploy Preview" from GitHub Actions UI:
   - Selects target app: `web`, `api`, or `both`
   - Workflow runs `vercel pull` → `vercel build` → `vercel deploy --prebuilt`
   - Preview URL is written to GitHub Actions step summary
7. When ready for production, developer opens PR from `staging` to `main`
8. CI runs again on the promotion PR
9. PR is merged to `main` → Vercel auto-deploys both web and API to production

### Edge cases

| Scenario | Expected behavior |
|----------|------------------|
| PR opened directly to `main` (not `hotfix/*`) | Blocked by branch protection rules |
| `hotfix/*` branch PR to `main` | Allowed — CI runs, merge triggers production deploy |
| Preview deploy fails | Error reported in GitHub Actions; no silent failures |
| Concurrent preview deploys on same branch | Concurrency group ensures one deploy per branch at a time |
| Staging diverges from main after hotfix | Hotfix should be cherry-picked or merged back to staging |
| E2E tests skipped on staging PR | E2E runs if changed paths match or `e2e` label is added (same logic as current main) |

## Constraints

- Vercel `ignoreCommand` in `vercel.json` must remain unchanged — only `main` triggers Vercel auto-deploys
- Preview deploys require 4 GitHub secrets: `VERCEL_TOKEN`, `VERCEL_ORG_ID`, `VERCEL_PROJECT_ID_WEB`, `VERCEL_PROJECT_ID_API`
- Branch protection for `main` (block non-hotfix direct PRs) requires manual GitHub Settings configuration post-merge
- `staging` must be set as default branch in GitHub Settings post-merge
- No application code changes — only CI/CD workflows and documentation

## Non-goals

- **Automated staging cleanup or reset** — staging is a long-lived branch, not ephemeral
- **Separate Vercel environment configs** for staging vs production — preview deploys use the same Vercel project
- **Automated staging-to-main promotion** — promotion is always a manual PR
- **Vercel preview deployments** (Vercel's built-in) — using GitHub Actions + Vercel CLI instead to avoid rate-limiting

## Technical Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Preview trigger | `workflow_dispatch` (manual) | Keeps staging quiet; avoids unnecessary deploys on every merge |
| Preview mechanism | GitHub Actions + Vercel CLI | More control than Vercel's built-in previews; avoids rate-limiting |
| Vercel `ignoreCommand` | Unchanged | Only main auto-deploys; GitHub Actions handles previews |
| CI on staging PRs | Full CI including E2E | Same quality gates as main; catch issues early |
| Direct-to-main PRs | Blocked (except `hotfix/*`) | Enforced via branch protection rules |
| Concurrency | One deploy per branch | `concurrency` group in workflow prevents conflicts |

## Files to Change

| # | File | Action | Description |
|---|------|--------|-------------|
| 1 | `.github/workflows/ci.yml` | Modify | Add `staging` to `pull_request.branches`; update E2E condition to include staging ref |
| 2 | `.github/workflows/deploy-preview.yml` | **Create** | New `workflow_dispatch` workflow with web/api/both input; parallel deploy jobs |
| 3 | `docs/guides/deployment.mdx` | Modify | Add staging flow diagram, preview deploys section, GitHub Actions secrets section |
| 4 | `docs/processes/dev-process.mdx` | Modify | Update branch bases: `git checkout -b ... staging`, worktree bases to staging |
| 5 | `docs/contributing.mdx` | Modify | Replace GitHub Flow with staging-based flow; update workflow, PR checklist, branch protection |
| 6 | `CLAUDE.md` | Modify | Update worktree example to include `staging` as base branch |

## Post-Merge Manual Steps

These must be performed after the PR is merged to `main`:

1. **Push staging branch**: `git push origin main:staging`
2. **Set default branch** to `staging` in GitHub Settings → General
3. **Configure branch protection** in GitHub Settings → Branches:
   - `main`: require PR + CI status checks + 1 review, no direct push, only `hotfix/*` branches
   - `staging`: require CI status checks, no direct push
4. **Add GitHub Actions secrets** in Settings → Secrets → Actions:
   - `VERCEL_TOKEN` — from Vercel Settings → Tokens
   - `VERCEL_ORG_ID` — from `.vercel/project.json` after `vercel link`
   - `VERCEL_PROJECT_ID_WEB` — from `apps/web/.vercel/project.json`
   - `VERCEL_PROJECT_ID_API` — from `apps/api/.vercel/project.json`

## Success Criteria

- [ ] CI (lint, typecheck, test, build) runs on PRs targeting `staging`
- [ ] E2E tests run on staging PRs when relevant paths change
- [ ] "Deploy Preview" workflow is available in GitHub Actions with web/api/both input
- [ ] Preview deploy produces a working preview URL in step summary
- [ ] Merging to `staging` does NOT trigger a Vercel production deploy
- [ ] Merging to `main` triggers Vercel auto-deploy to production (unchanged behavior)
- [ ] Hotfix PRs to `main` work correctly (CI runs, merge triggers deploy)
- [ ] All documentation reflects the new staging-based flow
- [ ] `CLAUDE.md` worktree examples use `staging` as base branch

## Open Questions

- Should `staging` branch protection require reviews, or only CI checks? (Currently proposed: CI only)
- After a hotfix merges to `main`, should there be an automated process to sync it back to `staging`, or is manual cherry-pick/merge sufficient?
