name: Deploy Preview

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Which app to deploy"
        required: true
        type: choice
        options:
          - both
          - web
          - api
          - cleanup

permissions:
  contents: read

concurrency:
  group: preview-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: "1.3.9"
  NODE_VERSION: "24"

jobs:
  deploy-web:
    name: Deploy Web Preview
    runs-on: ubuntu-latest
    if: inputs.target == 'web' || inputs.target == 'both'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache Bun dependencies
        uses: actions/cache@v5
        with:
          path: node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy
        id: deploy
        run: |
          for attempt in 1 2 3; do
            if URL=$(vercel deploy --token "$VERCEL_TOKEN"); then break; fi
            if [ "$attempt" -lt 3 ]; then
              echo "::warning::Deploy attempt $attempt/3 failed, retrying in 10s..."
              sleep 10
            else
              echo "::error::All 3 deploy attempts failed"
              exit 1
            fi
          done
          echo "url=$URL" >> "$GITHUB_OUTPUT"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_WEB }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Summary
        run: |
          echo "### Web Preview" >> "$GITHUB_STEP_SUMMARY"
          echo "${{ steps.deploy.outputs.url }}" >> "$GITHUB_STEP_SUMMARY"

  deploy-api:
    name: Deploy API Preview
    runs-on: ubuntu-latest
    if: inputs.target == 'api' || inputs.target == 'both'
    steps:
      - name: Delete existing Neon branch (if any)
        continue-on-error: true
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ secrets.NEON_PROJECT_ID }}
          api_key: ${{ secrets.NEON_API_KEY }}
          branch: preview/${{ github.ref_name }}

      - name: Create Neon database branch
        id: create-branch
        uses: neondatabase/create-branch-action@v6
        with:
          project_id: ${{ secrets.NEON_PROJECT_ID }}
          api_key: ${{ secrets.NEON_API_KEY }}
          branch_name: preview/${{ github.ref_name }}
          # neondb_owner is the Neon-managed admin role (has stored password).
          # Required for direct psql DDL (DROP/CREATE SCHEMA) in the reset step.
          role: neondb_owner

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache Bun dependencies
        uses: actions/cache@v5
        with:
          path: node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Vercel CLI and Turbo
        run: npm install -g vercel@latest turbo

      - name: Reset database for clean migrations
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url }}
        run: |
          set -euo pipefail
          # Neon branches fork from production, so the schema already exists
          # but the Drizzle migration journal is empty.  Drop and recreate the
          # public schema so that db:migrate in the Vercel build can bootstrap
          # from the baseline migration.
          psql "$DATABASE_URL" -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
          echo "Schema reset for clean migration"

      - name: Deploy API preview
        id: deploy
        # DATABASE_URL is passed via step env (not inline shell interpolation).
        # Rate limiting uses in-memory storage in previews (no Upstash) — resets on cold start.
        run: |
          for attempt in 1 2 3; do
            # --build-env overrides the Neon Marketplace integration's production
            # DATABASE_URL during the Vercel build step (db:migrate).
            # --env sets the same value for runtime (serverless functions).
            if URL=$(vercel deploy --token "$VERCEL_TOKEN" \
              --build-env "DATABASE_URL=$DATABASE_URL" \
              --env "DATABASE_URL=$DATABASE_URL" \
              --env "BETTER_AUTH_SECRET=$(openssl rand -base64 32)" \
              --env "SWAGGER_ENABLED=true" \
              --env "RATE_LIMIT_ENABLED=false"); then break; fi
            if [ "$attempt" -lt 3 ]; then
              echo "::warning::Deploy attempt $attempt/3 failed, retrying in 10s..."
              sleep 10
            else
              echo "::error::All 3 deploy attempts failed"
              exit 1
            fi
          done
          echo "url=$URL" >> "$GITHUB_OUTPUT"
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_API }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Health check (best-effort)
        continue-on-error: true
        run: |
          PREVIEW_URL="${{ steps.deploy.outputs.url }}"
          echo "Checking preview URL: $PREVIEW_URL"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$PREVIEW_URL" || echo "000")
          echo "HTTP status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" = "401" ]; then
            echo "::warning::Preview URL returned 401 — Vercel Deployment Protection (SSO) is enabled. Preview requires Vercel team authentication to access."
          elif [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "302" ]; then
            echo "Preview URL is accessible"
          else
            echo "::warning::Preview URL returned unexpected status $HTTP_STATUS"
          fi

      - name: Summary
        run: |
          echo "### API Preview" >> "$GITHUB_STEP_SUMMARY"
          echo "${{ steps.deploy.outputs.url }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Neon branch:** \`preview/${GITHUB_REF_NAME}\` (${{ steps.create-branch.outputs.branch_id }})" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "> **Note:** If Vercel Deployment Protection is enabled, preview URLs return HTTP 401 and require Vercel team SSO authentication." >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "To clean up: re-run this workflow with target=cleanup (or delete via Neon console)" >> "$GITHUB_STEP_SUMMARY"

  cleanup-neon-branch:
    name: Cleanup Neon Branch
    runs-on: ubuntu-latest
    if: inputs.target == 'cleanup'
    steps:
      - name: Delete Neon branch
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ secrets.NEON_PROJECT_ID }}
          api_key: ${{ secrets.NEON_API_KEY }}
          branch: preview/${{ github.ref_name }}
