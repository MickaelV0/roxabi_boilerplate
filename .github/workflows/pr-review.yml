name: PR Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main, staging]

permissions:
  pull-requests: write
  contents: read
  issues: read

concurrency:
  group: pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  BUN_VERSION: "1.3.9"

jobs:
  review:
    name: Automated Review
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Bun dependencies
        uses: actions/cache@v5
        with:
          path: node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Preflight — check PR size
        id: preflight
        run: |
          LINES=$(gh pr diff "$PR_NUMBER" | wc -l)
          if [ "$LINES" -gt 2000 ]; then
            gh pr comment "$PR_NUMBER" \
              --body "<!-- review-skipped-by-bot -->⚠️ PR too large for automated review (${LINES} diff lines > 2000). Run \`/review\` manually."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Build PR context
        if: steps.preflight.outputs.skip != 'true'
        id: context
        run: |
          bun run tools/buildPrContext.ts "$PR_NUMBER"
          PRIOR=$(jq -r '.priorReviewFound' /tmp/pr-context.json)
          HEAD_SHA=$(jq -r '.headSha' /tmp/pr-context.json)
          [[ "$HEAD_SHA" =~ ^[0-9a-f]{40}$ ]] || { echo "Invalid HEAD_SHA: $HEAD_SHA"; exit 1; }
          echo "prior_review=$PRIOR" >> "$GITHUB_OUTPUT"
          echo "head_sha=$HEAD_SHA" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Download prior findings artifact
        if: steps.preflight.outputs.skip != 'true' && steps.context.outputs.prior_review == 'true'
        uses: actions/download-artifact@v7  # v7 can read v6 artifacts — matches ci.yml pattern
        with:
          name: review-findings-${{ github.event.pull_request.number }}
          path: /tmp/prior-findings/
        continue-on-error: true  # artifact may have expired (>90 days)

      - name: Run review (first-time)
        if: steps.preflight.outputs.skip != 'true' && steps.context.outputs.prior_review != 'true'
        id: review-first
        run: |
          claude --print \
            --allowedTools 'Bash(gh pr comment:*),Bash(gh api:*),Bash(gh pr view:*),Bash(gh pr diff:*),Read,Write' \
            --model claude-sonnet-4-6 \
            "/review #${PR_NUMBER}
          IMPORTANT: Stop after Phase 6 (post the PR comment). Do NOT call AskUserQuestion or proceed to Phase 8."
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Run review (follow-up)
        if: steps.preflight.outputs.skip != 'true' && steps.context.outputs.prior_review == 'true'
        id: review-followup
        run: |
          PRIOR_PATH=""
          if [ -f "/tmp/prior-findings/review-findings.json" ]; then
            PRIOR_PATH="/tmp/prior-findings/review-findings.json"
          fi
          claude --print \
            --allowedTools 'Bash(gh pr comment:*),Bash(gh api:*),Bash(gh pr view:*),Bash(gh pr diff:*),Read,Write' \
            --model claude-sonnet-4-6 \
            "/review #${PR_NUMBER}
          Follow-up mode: this PR was previously reviewed.${PRIOR_PATH:+ Prior findings available at $PRIOR_PATH.}
          Focus on whether previous findings are fixed in the new diff. Report verified-fixed vs remaining.
          IMPORTANT: Stop after Phase 6 (post the PR comment). Do NOT call AskUserQuestion or proceed to Phase 8."
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Attach review markers to Claude's comment
        if: steps.preflight.outputs.skip != 'true' && (steps.review-first.outcome == 'success' || steps.review-followup.outcome == 'success')
        run: |
          # Find the most recently posted PR comment containing the review header
          COMMENT_ID=$(gh api "repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments" \
            --jq '[.[] | select(.body | contains("## Code Review"))] | last | .id // empty')

          if [ -z "$COMMENT_ID" ]; then
            echo "Warning: could not find Claude's review comment — posting standalone marker as fallback"
            gh pr comment "$PR_NUMBER" \
              --body "<!-- reviewed-by-bot --><!-- review-sha: ${HEAD_SHA} -->"
            exit 0
          fi

          # Append hidden markers to Claude's existing comment (no visible change)
          CURRENT_BODY=$(gh api "repos/${GITHUB_REPOSITORY}/issues/comments/${COMMENT_ID}" \
            --jq '.body')
          printf '%s' "${CURRENT_BODY}"$'\n'"<!-- reviewed-by-bot -->"$'\n'"<!-- review-sha: ${HEAD_SHA} -->" \
            | gh api "repos/${GITHUB_REPOSITORY}/issues/comments/${COMMENT_ID}" \
              -X PATCH --input <(jq -Rs '{body: .}')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ steps.context.outputs.head_sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Post inline comments
        if: steps.preflight.outputs.skip != 'true'
        run: bun run tools/postInlineComments.ts "$PR_NUMBER" "${{ steps.context.outputs.head_sha }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Resolve fixed threads (follow-up only)
        if: steps.preflight.outputs.skip != 'true' && steps.context.outputs.prior_review == 'true'
        run: bun run tools/resolveThreads.ts "$PR_NUMBER"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Upload findings artifact
        if: always() && steps.preflight.outputs.skip != 'true'
        uses: actions/upload-artifact@v6
        with:
          name: review-findings-${{ github.event.pull_request.number }}
          path: /tmp/review-findings.json
          retention-days: 90
          if-no-files-found: ignore

      - name: Post fallback comment on failure
        if: failure()
        run: |
          gh pr comment "$PR_NUMBER" \
            --body "<!-- review-failed-by-bot -->⚠️ Automated review failed. Please run \`/review\` manually or check [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
