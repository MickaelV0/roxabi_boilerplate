---
title: Automated PR Review & Auto-fix Pipeline
issue: 379
status: approved
tier: F-lite
date: 2026-02-26
revised: 2026-02-26
promoted-from: artifacts/frames/pr-review-pipeline.mdx
---

## Context

Revised to use `anthropics/claude-code-action@v1` with `CLAUDE_CODE_OAUTH_TOKEN` (Claude Pro/Max OAuth),
replacing the original `claude --print` + custom tooling approach. No Anthropic API billing account required.

## Goal

On every PR open or push:
1. Claude reviews the diff → posts findings as a PR comment
2. Claude auto-fixes what it can → commits with `[skip ci]` → updates the comment with what was fixed
3. The same comment lists what needs manual human attention

## Users

- **Developer opening a PR** — receives automatic review findings within minutes, and sees auto-fixes committed directly to their branch.
- **Reviewer / maintainer** — the review comment is always up to date; resolved items are removed on each re-run.

## Expected Behavior

1. Developer opens a PR or pushes to an existing PR branch.
2. `pr-review.yml` triggers. If another review is already running for that PR (rapid pushes), the old run is cancelled (`concurrency: pr-review-{PR#}`, `cancel-in-progress: true`).
3. A fork guard skips the job entirely for PRs from forks (no `CLAUDE_CODE_OAUTH_TOKEN` available).
4. A preflight check counts diff lines; if > 2000, it posts a warning comment and skips Claude.
5. `claude-code-action@v1` runs with the review+fix prompt:
   - Claude reviews the full diff
   - Claude runs `bun run lint:fix` + `bun run format` and applies safe code corrections
   - If fixes were made, Claude commits them with `fix(review): automated fixes [skip ci]`
   - Claude posts (or updates via sticky comment) a structured PR comment
6. The sticky comment (`use_sticky_comment: true`) means each push updates the same comment — no accumulation.
7. The `[skip ci]` token in the auto-fix commit message prevents the commit from re-triggering the workflow.
8. If the action fails (timeout, auth error), a fallback comment is posted.

## Comment Format

```markdown
<!-- reviewed-by-claude -->
## Automated Review

### ✅ Auto-fixed
- `src/foo.ts` — Biome format violation corrected
- `apps/api/src/bar.ts` — Missing trailing comma added

### ⚠️ Manual action needed
- `apps/web/src/page.tsx:42` — Unhandled promise rejection
- `apps/api/src/service.ts:17` — SQL query missing parameterization

_Reviewed commit: abc1234_
```

## Breadboard

### Nodes

| ID | Affordance | Handler | Data |
|----|-----------|---------|------|
| N1 | PR `opened` / `synchronize` event | `.github/workflows/pr-review.yml` | `github.event.pull_request.number`, `github.sha` |
| N2 | Concurrency lock | Workflow `concurrency:` group | `pr-review-{PR#}` — cancel-in-progress |
| N3 | Fork guard | Workflow `if:` condition | Skip if `head.repo.full_name != github.repository` |
| N4 | Preflight size check | Workflow step (`gh pr diff | wc -l`) | If > 2000 lines → post warning + skip |
| N5 | Claude review + fix + comment | `claude-code-action@v1` | OAuth token, `use_sticky_comment: true`, review prompt |
| N6 | Auto-fix commit | Claude (inside action) | `bun run lint:fix && format` → commit `[skip ci]` |
| N7 | Structured comment | Claude (inside action) | Auto-fixed list + manual-action list, sticky |
| N8 | Fallback error comment | Workflow `if: failure()` step | `gh pr comment` with error notice |

### Wiring

```
PR event → N1 → N2 (dedup) → N3 (fork guard) → N4 (size preflight)
                                                          ↓
                                               N5 (claude-code-action)
                                                    ↙         ↘
                                              N6 (commit)   N7 (comment)
                                                          ↓
                                                N8 (fallback if failure)
```

## Slices

| # | Slice | Nodes | Deliverable | Demo |
|---|-------|-------|-------------|------|
| 1 | Workflow skeleton | N1, N2, N3, N4 | `pr-review.yml` with triggers, concurrency, fork guard, preflight | Workflow file exists; fork PRs skipped |
| 2 | Claude action + auth | N5 | `claude-code-action@v1` step wired with `CLAUDE_CODE_OAUTH_TOKEN`, sticky comment, commit signing | Action runs on PR open |
| 3 | Review + fix prompt | N6, N7 | Prompt drives review → lint:fix → commit `[skip ci]` → structured comment | Comment appears with two sections; auto-fix committed |
| 4 | Fallback + [skip ci] guard | N8 | Failure step posts error comment; `[skip ci]` confirmed to not re-trigger | Push fix after failure → no loop |

## Success Criteria

- [ ] Opening a PR triggers `pr-review.yml` and a structured comment with `<!-- reviewed-by-claude -->` appears.
- [ ] The comment has two sections: **Auto-fixed** and **Manual action needed**.
- [ ] Auto-fixable issues (Biome lint/format) are committed to the PR branch with `[skip ci]` in the commit message.
- [ ] The `[skip ci]` commit does not re-trigger `pr-review.yml`.
- [ ] Pushing two commits in rapid succession runs only one review (concurrency cancel).
- [ ] Fork PRs are silently skipped — no error, no comment.
- [ ] PRs with > 2000 diff lines get a warning comment and skip Claude.
- [ ] If Claude fails (timeout / auth error), a fallback comment is posted and the job is marked failed.
- [ ] Each new push updates the existing review comment (sticky) — no duplicate comments accumulate.

## Implementation Notes

- **Auth:** `claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}` — generated by repo admin via `claude setup-token`.
- **Permissions:** `contents: write` (auto-fix commits), `pull-requests: write` (comments), `id-token: write` (OIDC for commit signing).
- **Commit signing:** `use_commit_signing: true` — verified commits from `claude[bot]`.
- **Sticky comment:** `use_sticky_comment: true` — one comment per PR, updated on each run.
- **Model:** Action uses Sonnet by default via Claude Max subscription — no model override needed.
- **Timeout:** `timeout-minutes: 15` on the review job.
- **Loop prevention:** `[skip ci]` in auto-fix commit message; no workflow condition needed.
- **No custom tooling:** `build-pr-context.ts`, `post-inline-comments.ts`, `resolve-threads.ts` are not needed — Claude handles everything inside the action.
