---
title: "Self-Role-Change with Confirmation + Sole-Owner Guard"
description: Allow superadmin self-role-change with confirmation dialog, last-superadmin guard, and session invalidation.
---

## Context

Issue [#311](https://github.com/roxabi/roxabi_boilerplate/issues/311) — from code review finding Q1 on PR #308 (`feat/269-admin-phase2`). Parent: #269.

**Promoted from:** [Self-Role-Change Analysis](../analyses/311-self-role-change-sole-owner-guard.mdx)

The current `SelfActionException` in `AdminUsersService.validateUpdatePermissions` blocks ALL self-role-changes. Per the Phase 2 spec, self-role-change should be allowed with confirmation. Additionally, the system needs a "last active superadmin" guard to prevent orphaned platform administration.

**Dependencies:** Admin Phase 2 (#269, merged). Existing `ConfirmDialog` component in `@repo/ui`.

## Goal

Enable superadmins to voluntarily change their own global role with explicit confirmation, while preventing the last active superadmin from demoting themselves (or being banned), ensuring the platform always has at least one accessible superadmin.

## Users &amp; Use Cases

### Super Admin (global `superadmin` user role)

- **Voluntary step-down**: A superadmin wants to change their own role to `user` (e.g., leaving the admin team). They see a confirmation dialog warning about consequences, confirm, and are logged out.
- **Blocked step-down**: The only active superadmin tries to change their role. The role dropdown shows a locked state with an explanation — the action is not possible.
- **Org-aware step-down**: A superadmin who is also an org owner sees additional context in the confirmation dialog about their org ownership being unaffected but admin panel access being lost.

## Expected Behavior

### Happy path

#### Self-role-change (superadmin &rarr; user)

1. Superadmin navigates to `/admin/users/:ownId` (their own user detail page).
2. The `EditUserForm` shows the role dropdown. If the user is NOT the last active superadmin, the dropdown is fully interactive.
3. Superadmin selects `user` from the role dropdown.
4. A `ConfirmDialog` (variant: `warning`) appears:
   - **Title:** "Change Your Role"
   - **Description:** "You are about to change your role from Superadmin to User. You will lose access to the admin panel and will be logged out on all devices. Another superadmin will need to restore your access."
   - If the user owns organizations, an additional paragraph: "Note: You are still an owner in {orgNames}. Your organization ownership is not affected, but you won't be able to manage these organizations from the admin panel."
   - **Confirm button:** "Change Role"
   - **Cancel button:** "Cancel"
5. Superadmin clicks "Change Role".
6. Frontend sends `PATCH /api/admin/users/:id` with `{ role: 'user' }`.
7. Backend:
   a. Fetches before-snapshot of the user.
   b. Detects `actorId === userId` AND `data.role` is present — enters self-role-change path.
   c. Counts active superadmins: `SELECT COUNT(*) FROM users WHERE role = 'superadmin' AND banned = false AND "deletedAt" IS NULL AND id != :actorId`.
   d. Count > 0 — proceeds with the update.
   e. Updates the user's role to `user`.
   f. Logs audit: `user.role_changed` with before/after snapshots.
   g. Invalidates all sessions for the user: `DELETE FROM sessions WHERE "userId" = :userId`.
   h. Returns the updated user.
8. Frontend receives 200 response. Because all sessions are invalidated, the user's auth state becomes invalid. The frontend detects the invalid session and redirects to the login page.

#### Last-superadmin blocked state

1. Superadmin navigates to `/admin/users/:ownId`.
2. The `getUserDetail` response includes `isLastActiveSuperadmin: true`.
3. The role dropdown renders with the current `superadmin` option visually locked (lock icon + tooltip: "You are the last active superadmin and cannot change your role."). The dropdown remains interactive for inspection but the `superadmin` value cannot be changed.
4. The form can still save name/email changes — only role selection is blocked.

#### Banning a superadmin

1. A superadmin navigates to another superadmin's detail page and clicks "Ban".
2. Backend checks: is the target user the last active superadmin?
3. If yes — returns `LastSuperadminException`. Frontend shows error.
4. If no — existing `SuperadminProtectionException` applies (cannot ban a superadmin at all per current rules).

> **Note:** The ban guard for last-superadmin is additive. The existing `SuperadminProtectionException` already blocks banning ANY superadmin. The `LastSuperadminException` guard is a safety net for the case where `SuperadminProtectionException` is relaxed in a future iteration.

### Edge cases

| Case | Expected Behavior |
|------|-------------------|
| Superadmin demotes self, is last active superadmin | Backend returns `LastSuperadminException` (HTTP 400, code: `LAST_SUPERADMIN`). FE shows error toast. |
| Superadmin demotes self, other superadmins exist but are all banned | Backend blocks — counts active only (non-banned, non-deleted). |
| Superadmin demotes self, other active superadmins exist | Allowed with confirmation dialog. All sessions invalidated. |
| Superadmin demotes self while being org owner | Allowed. Org membership unaffected. Dialog shows extra context about org ownership. |
| Superadmin changes only name/email on own account | Allowed without confirmation. No session invalidation. Self-role-change guard does not apply. |
| Superadmin bans/deletes self | Blocked by `SelfActionException` in `AdminUsersLifecycleService` (unchanged). |
| Race: two superadmins demote simultaneously | Serializable transaction. Second transaction gets serialization failure, returns HTTP 500 or retries. |
| Race: superadmin A demotes self while B is being banned | Both operations wrapped in serializable transactions with active-superadmin count check. Only one succeeds. |
| Superadmin promotes user &rarr; superadmin, then demotes self | Allowed — the new superadmin counts as active. |
| Frontend loads user detail, another admin demotes/bans the last other superadmin before save | Stale `isLastActiveSuperadmin: false` on frontend. Backend guard catches it on submission — returns `LastSuperadminException`. FE refetches and shows locked state. |

## Constraints

- **Appetite:** 1 day.
- **Tier:** S — single module (admin), no new abstractions.
- **Transaction isolation:** Serializable transactions required for the last-superadmin count + update. Drizzle supports `SET TRANSACTION ISOLATION LEVEL SERIALIZABLE` via raw SQL or transaction options.
- **Session invalidation:** Via Drizzle `DELETE` on `sessions` table (consistent with admin module's raw-DB pattern, no dependency on Better Auth API).
- **Global/org role independence:** Changing global role MUST NOT cascade to org memberships.

## Non-goals

- **Org-level self-role-change:** Handled separately by `SelfRoleChangeException` in `AdminMembersService`. Not changed here.
- **Auto-unban / auto-restore:** No scheduled job for expiring bans. Informational only (per Phase 2 spec).
- **Superadmin promotion UX:** Promoting `user` &rarr; `superadmin` is already allowed. No changes.
- **Relaxing `SuperadminProtectionException`:** The ban path still blocks banning any superadmin. The `LastSuperadminException` guard is additive for future-proofing.

## Technical Decisions

### 1. Split `SelfActionException` by operation type

**Decision:** Remove `SelfActionException` from `validateUpdatePermissions` for role changes. Keep it in `AdminUsersLifecycleService` for ban/delete.

**Rationale:** Role changes are recoverable (another superadmin can re-promote). Ban/delete are destructive self-actions that should remain blocked.

### 2. Active-only superadmin counting

**Decision:** Count only superadmins where `banned = false AND deletedAt IS NULL`.

**Rationale:** Banned/deleted superadmins cannot manage the platform. Counting them would create a false safety net — the system could end up with only inaccessible superadmins.

### 3. Session invalidation via Drizzle DELETE

**Decision:** `DELETE FROM sessions WHERE userId = :userId` via raw Drizzle (not Better Auth API).

**Rationale:** The admin module uses raw Drizzle for all operations (cross-tenant, bypasses RLS). Adding a dependency on the auth module's Better Auth instance would break module boundaries and risk circular dependencies.

### 4. `isLastActiveSuperadmin` flag on user detail

**Decision:** Enrich the existing `getUserDetail` response with a computed `isLastActiveSuperadmin: boolean` field.

**Rationale:** Avoids a new endpoint. The FE already fetches user detail on page load — adding a boolean flag is zero extra round trips. The count query is lightweight (indexed on `role`).

### 5. Serializable transactions for race protection

**Decision:** Wrap the count query + role update in a serializable transaction.

**Rationale:** Two superadmins demoting simultaneously (or one demoting while another is banned) could both pass the count check under READ COMMITTED. Serializable isolation prevents this by detecting conflicting reads.

### 6. Locked dropdown option (not disabled form)

**Decision:** The role dropdown stays interactive but the current `superadmin` option shows a lock icon with tooltip. The form's save button is unaffected.

**Rationale:** The user can still edit name/email. Disabling the entire form or save button would prevent valid non-role edits. The locked option is more discoverable than an error on submission.

## Success Criteria

- [ ] Superadmin can change their own global role with a confirmation dialog
- [ ] Confirmation dialog shows dynamic content (base warning + org ownership context if applicable)
- [ ] If user is the last active superadmin, role dropdown shows locked state with tooltip
- [ ] Backend returns `LAST_SUPERADMIN` error code when last active superadmin tries to self-demote
- [ ] Backend blocks banning the last active superadmin (additive to existing `SuperadminProtectionException`)
- [ ] All sessions for the user are invalidated after successful self-demotion
- [ ] Self-ban and self-delete remain blocked by `SelfActionException` (unchanged)
- [ ] Tests cover: self-demotion allowed, last-superadmin blocked, active-only counting, session invalidation, ban guard

## Open Questions

None — all ambiguities resolved during analysis interview.
