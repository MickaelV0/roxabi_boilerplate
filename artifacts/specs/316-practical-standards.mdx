---
title: 'Phase 1: Practical Standards — Solution Spec'
issue: 316
status: approved
tier: F-full
date: 2026-02-26
---

## Context

Promoted from [analyses/316-practical-standards.mdx](../analyses/316-practical-standards.mdx). Recommended Shape 1: extend the three existing standards docs. Frame at [frames/practical-standards.mdx](../frames/practical-standards.mdx).

## Goal

Close the gap between implicit codebase patterns and explicit documentation so that AI agents generate pattern-compliant code on first pass, new developers understand architecture without reverse-engineering, and reviewers can cite specific section numbers.

## Users

- **Primary:** AI agents (Claude Code) — consume standards docs via CLAUDE.md Rule 9 to generate pattern-compliant code
- **Secondary:** Developers onboarding to the boilerplate
- **Secondary:** Code reviewers citing standards in reviews

## Expected Behavior

**TanStack Query scenario:** An AI agent asked to "add a new query for fetching user preferences" reads `frontend-patterns.mdx` section 1.7, uses the `queryOptions()` factory pattern with the key convention, and produces a query hook that follows the documented cache strategy.

**Review scenario:** A reviewer seeing inline `useQuery({ queryKey: ['prefs'] })` cites "Section 1.7: use `queryOptions()` factories" to request a change.

**SOLID scenario:** An AI agent asked to "add a new service for processing webhooks" reads `backend-patterns.mdx` section 1.6, produces a service that follows SRP (single domain, <100 lines), uses DIP (`@Inject(TOKEN)` for dependencies), and avoids god-service anti-patterns.

**Testing scenario:** A developer writing a new test reads `testing.mdx`, understands when to use unit vs integration vs E2E from the layer guidance section, and uses the MSW pattern for HTTP mocking instead of `vi.spyOn(fetch)`.

## Implementation Notes

### Renumbering

Both `frontend-patterns.mdx` and `backend-patterns.mdx` end with an AI Quick Reference section that must be renumbered to make room for new content:

- `frontend-patterns.mdx`: existing **1.7 AI Quick Reference** → renumber to **1.9**. Insert new 1.7 (TanStack Query) and 1.8 (SOLID) after existing 1.6 (Shared UI Library).
- `backend-patterns.mdx`: existing **1.6 AI Quick Reference** → renumber to **1.7**. Insert new 1.6 (SOLID) after existing 1.5 (Correlation ID).
- `testing.mdx`: uses unnumbered `##` headings (not hierarchical numbering). New sections follow this same style.

### Key Decisions

- **`useQuery` vs `useSuspenseQuery`:** Document `useQuery` as the default (matches current codebase). Note `useSuspenseQuery` as the recommended pattern when a Suspense boundary wraps the component. Prefetch examples (F3) use `ensureQueryData` which works with both.
- **Optimistic updates:** F4 documents *when* to consider optimistic updates. F5 provides the *how* (code example). No overlap.
- **MSW is aspirational:** MSW is not installed. The MSW section documents the recommended adoption path and must include: "MSW is the recommended replacement for `vi.spyOn(fetch)`. Install with `bun add -d msw` before using these patterns." Migration path is reference guidance only — no migration scripts or refactored tests.
- **Frontend LSP:** Excluded from the frontend SOLID section (N/A — no class inheritance in React). Acknowledged with one sentence.

## Breadboard

### Doc 1: `frontend-patterns.mdx` (extends existing)

Insert after existing section 1.6 (Shared UI Library). Renumber existing 1.7 AI Quick Reference → 1.9.

| ID | Affordance | Section | Content |
|----|-----------|---------|---------|
| F1 | `queryOptions()` factory pattern | 1.7.1 | Factory function that co-locates queryKey + queryFn. Show before/after: inline → factory. Reference existing `useOrganizations.ts` as partial example |
| F2 | Query key convention | 1.7.2 | Hierarchical key factory: `queryKeys.users.detail(id)`. Show the key factory pattern. Reference existing `FEATURE_FLAGS_QUERY_KEY` as starting point |
| F3 | Route-level prefetching | 1.7.3 | `beforeLoad` + `ensureQueryData` pattern. Note: `setupRouterSsrQueryIntegration` already configured. Show guard-then-prefetch ordering (auth guard must succeed before data prefetch). Note: `beforeLoad` is already used in 33 files for auth — this adds data prefetching alongside |
| F4 | Cache strategy | 1.7.4 | Global `staleTime` recommendation, `invalidateQueries` patterns (broad vs targeted), when to consider `setQueryData` for optimistic updates (the *when*). Document existing broad invalidation pattern and the targeted alternative. Note: `useQuery` is the default; `useSuspenseQuery` is recommended when a Suspense boundary wraps the component |
| F5 | Mutation patterns | 1.7.5 | Canonical `useMutation` + cache invalidation. Document existing `onSuccess` → `invalidateQueries` pattern. Optimistic update code example (the *how*) |
| F6 | Rules + anti-patterns | 1.7.6 | Bullet list: always use `queryOptions()`, never hardcode keys, always invalidate after mutation, prefer `useQuery` unless Suspense boundary exists, etc. |
| F7 | SOLID — Frontend | 1.8 | SRP (route = orchestrator, hooks = logic, components = presentation), OCP (callback props, composition), ISP (lean props), DIP (hooks as abstraction). Each principle: 1 paragraph + 1 code example from existing codebase. LSP excluded with one-sentence acknowledgment (N/A — no class inheritance) |
| F8 | AI Quick Reference updates | 1.9 | Add TanStack Query + SOLID compressed rules to existing AI Quick Reference (renumbered from 1.7 → 1.9) |

### Doc 2: `backend-patterns.mdx` (extends existing)

Insert after existing section 1.5 (Correlation ID). Renumber existing 1.6 AI Quick Reference → 1.7.

| ID | Affordance | Section | Content |
|----|-----------|---------|---------|
| B1 | SOLID — Backend | 1.6 | Each principle: definition + how the codebase implements it + code example + gap acknowledgment where codebase diverges from ideal |
| B2 | SRP examples | 1.6.1 | AuthService (79 lines, single domain), PermissionService (63 lines). Anti-pattern: god-services |
| B3 | OCP examples | 1.6.2 | `@Catch()` decorator extension, Reflector-based guards. Anti-pattern: instanceof chains. Gap: `AllExceptionsFilter` |
| B4 | LSP examples | 1.6.3 | Domain exceptions extending Error. Composition over inheritance pattern |
| B5 | ISP examples | 1.6.4 | Lean DI tokens (`DRIZZLE`, `EMAIL_PROVIDER`). Focused service methods |
| B6 | DIP examples | 1.6.5 | `@Inject(TOKEN)` pattern, `forwardRef` for cycles, module-level composition. Gap: raw Drizzle queries (no repository abstraction) |
| B7 | Rules + anti-patterns | 1.6.6 | SOLID-specific rules consolidated |
| B8 | AI Quick Reference updates | 1.7 | Add SOLID compressed rules (renumbered from 1.6 → 1.7) |

### Doc 3: `testing.mdx` (extends existing)

Uses unnumbered `##` headings (not hierarchical numbering). New sections follow same style.

| ID | Affordance | Placement | Content |
|----|-----------|-----------|---------|
| T1 | Testing layer guidance | New `##` section after "Testing Philosophy — The Testing Trophy" and before "Red-Green-Refactor Cycle" | When to use each layer: unit (isolated logic), integration (module wiring), E2E (critical user flows). Decision table. Complements existing Testing Trophy section without duplicating it |
| T2 | MSW adoption plan | New `##` section after "Mocking Strategies" (after the existing Rules subsection at ~line 291) and before "Test Data Management" | Why MSW > `vi.spyOn(fetch)`. Setup guide: `msw/node` + handlers. Before/after comparison. Must note MSW is not yet installed and include installation command. Migration path is reference only — no scripts |
| T3 | MSW handler patterns | New `###` sub-section within T2 | Request handler examples for GET/POST/PATCH. Error simulation. Network delay simulation |
| T4 | TanStack Query testing | New `###` sub-section under "Frontend Testing Patterns" (after existing "Utility Testing" at ~line 207) | Testing `queryOptions()` factories, testing components with queries (requires `QueryClientProvider` wrapper setup), testing mutations + cache invalidation. Reference existing `createMockSession` factories. Cross-reference `frontend-patterns.mdx` section 1.7 for `queryOptions()` pattern |
| T5 | Rules updates | Extend existing `### Rules` within "Mocking Strategies" (~line 283) + add `### Rules` within new T4 section | MSW-specific rules added to Mocking Strategies rules list. TanStack Query testing rules added to new T4 section |

## Slices

| Slice | Affordances | Deliverable | Independent? |
|-------|------------|-------------|-------------|
| **S1: TanStack Query (#260)** | F1-F6 | New section 1.7 in `frontend-patterns.mdx` | Yes — touches only 1.7 content |
| **S2: SOLID (#258)** | F7, B1-B8 | New section 1.8 in `frontend-patterns.mdx` + new section 1.6 in `backend-patterns.mdx` | Yes — touches 1.8 content (frontend) and backend-patterns.mdx |
| **S3: Testing (#261)** | T1-T5 | New sections in `testing.mdx` | Yes — touches only testing.mdx |
| **S4: Finalize** | F8, B8 | Renumber AI Quick Reference sections in both docs. Add compressed rules from S1+S2+S3 | Depends on S1, S2, S3 |

S1, S2, and S3 are independent and can be implemented in parallel. S4 (renumbering + AI Quick Reference updates) runs after all three complete to avoid merge conflicts. S4 is a small mechanical step.

## Success Criteria

### S1: TanStack Query (#260)

- [ ] `frontend-patterns.mdx` contains section **1.7 TanStack Query Patterns** with subsections 1.7.1-1.7.6
- [ ] Section 1.7.1 includes a `queryOptions()` factory code example showing before (inline) and after (factory) patterns
- [ ] Section 1.7.2 includes a query key factory code example (`queryKeys.domain.action(params)`)
- [ ] Section 1.7.3 includes a `beforeLoad` + `ensureQueryData` prefetch example showing guard-then-prefetch ordering
- [ ] Section 1.7.4 documents `useQuery` as default and `useSuspenseQuery` as the Suspense-boundary alternative
- [ ] Section 1.7.5 includes an optimistic update code example using `setQueryData`

### S2: SOLID (#258)

- [ ] `frontend-patterns.mdx` contains section **1.8 SOLID Principles — Frontend** covering SRP, OCP, ISP, DIP with one code example each
- [ ] Section 1.8 acknowledges LSP as N/A for React (one sentence, no forced example)
- [ ] `backend-patterns.mdx` contains section **1.6 SOLID Principles — Backend** with subsections 1.6.1-1.6.6
- [ ] Each backend SOLID subsection includes one code example drawn from the existing codebase
- [ ] Each backend SOLID subsection includes a gap note where the codebase diverges from ideal (e.g., B3 `AllExceptionsFilter`, B6 raw Drizzle)

### S3: Testing (#261)

- [ ] `testing.mdx` contains a **Testing Layer Guidance** section with decision criteria for unit vs integration vs E2E
- [ ] `testing.mdx` contains an **MSW Adoption** section with setup guide, handler examples, and migration path from `vi.spyOn(fetch)`
- [ ] MSW section clearly states MSW is not yet installed and provides the `bun add -d msw` installation command
- [ ] `testing.mdx` contains a **TanStack Query Testing** subsection under Frontend Testing Patterns
- [ ] TanStack Query Testing section includes `QueryClientProvider` wrapper setup for component tests
- [ ] TanStack Query Testing section cross-references `frontend-patterns.mdx` section 1.7 for `queryOptions()` patterns

### S4: Finalize

- [ ] `frontend-patterns.mdx` AI Quick Reference renumbered to **1.9** with compressed TanStack Query and SOLID rules added
- [ ] `backend-patterns.mdx` AI Quick Reference renumbered to **1.7** with compressed SOLID rules added

### Cross-cutting

- [ ] All new sections follow existing doc conventions of their respective file (hierarchical numbering for frontend/backend, unnumbered `##` for testing)
- [ ] New sections cross-reference related existing sections where applicable (e.g., T4 links to F1, B6 references section 1.4 Provider Patterns)
- [ ] No duplication with existing doc content — new sections complement, not repeat
- [ ] Code examples use valid TypeScript syntax and reference correct TanStack Query v5 / NestJS / Vitest API names
