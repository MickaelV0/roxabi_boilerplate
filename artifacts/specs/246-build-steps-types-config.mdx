---
title: "Add Build Steps to @repo/types and @repo/config"
description: Add tsup build steps to shared packages so they export compiled JavaScript, fixing runtime ERR_MODULE_NOT_FOUND on Vercel
---

## Context

After the v0.3.0 release, every API endpoint returned 500 errors on Vercel. `@repo/types` and `@repo/config` export raw TypeScript via `"exports": { ".": "./src/index.ts" }`. This works for `import type` (erased at compile time) and for bundled consumers (Vite/TanStack Start), but fails at runtime on Vercel where the NestJS API runs on Node.js without a bundler.

A hotfix (commit `9049f7b`) inlined constants locally in `apps/api/src/auth/auth.instance.ts` and `apps/api/src/user/user.controller.ts`. The underlying issue remains — any future runtime import from either package will break production.

**Promoted from:** [Add Build Steps to @repo/types and @repo/config](../analyses/246-build-steps-types-config.mdx)

**Refs #246**

## Goal

Make runtime value imports from `@repo/types` and `@repo/config` safe for all consumers (bundled and unbundled) by adding a tsup build step that compiles TypeScript to JavaScript. Additionally, improve `@repo/types` maintainability by splitting the monolithic `index.ts` into domain files.

## Users &amp; Use Cases

| User | Use case | Current pain |
|------|----------|-------------|
| **API (NestJS on Vercel)** | Imports runtime values (`DICEBEAR_CDN_BASE`, `AVATAR_STYLES`, `ERROR_CODES`) from `@repo/types` | `ERR_MODULE_NOT_FOUND` — Node.js cannot execute raw `.ts` files |
| **Web (TanStack Start)** | Imports types and runtime values from `@repo/types` | Works today (Vite handles `.ts`), but inconsistent with API behavior |
| **Developers** | Add new shared types/constants to `@repo/types` or `@repo/config` | Must remember not to import runtime values in the API — easy to forget and causes production outages |
| **CI/CD pipeline** | Builds and tests all packages | No build step for these packages today; test task doesn't depend on `^build` |

## Expected Behavior

### Happy path

1. **Build phase**: Running `bun run build` compiles `@repo/types` and `@repo/config` via tsup, producing `dist/index.js`, `dist/index.d.ts`, and sourcemaps in each package.
2. **Import resolution**: When the API imports `{ DICEBEAR_CDN_BASE } from '@repo/types'`, Node.js resolves via the `exports` field to `dist/index.js` — compiled JavaScript that executes without error.
3. **Type resolution**: TypeScript resolves `import type { User } from '@repo/types'` to `dist/index.d.ts` via the `types` export field, preserving full IntelliSense.
4. **Bundler resolution**: Vite (TanStack Start) resolves via the `source` export field to `src/index.ts` for optimal DX (hot reload, no build step needed during dev). The `source` field is a Vite/Rollup convention — tools that don't understand it fall through to `import` (compiled JS), which is the correct and safe fallback.
5. **Dev mode**: Running `bun run dev` starts `tsup --watch` for both packages via TurboRepo's workspace task propagation (same mechanism as `@repo/ui`). No `turbo.jsonc` changes are needed for `dev` — the task already has `"cache": false` and `"persistent": true`. TanStack Start/Vite bypasses `dist/` entirely via the `source` field, so web consumers get instant hot reload without waiting for tsup recompilation.
6. **Domain files**: `@repo/types/src/index.ts` is a barrel that re-exports from 8 domain files. All existing consumer imports (`from '@repo/types'`) continue to work unchanged.

### Edge cases

| Scenario | Expected behavior |
|----------|------------------|
| Clean checkout, run tests without prior build | `turbo run test` triggers `^build` first (after `turbo.jsonc` fix), so `dist/` exists before tests run |
| Clean checkout, run typecheck without prior build | Already handled — `typecheck` task already depends on `^build` in `turbo.jsonc` |
| Developer adds a new type to a domain file | `tsup --watch` recompiles; the barrel re-exports it automatically via `export *` |
| Developer adds a new runtime value without running dev | Build-time compilation catches it; no runtime error on Vercel |
| `dist/` accidentally deleted | `bun run build` regenerates it; TurboRepo cache restores it if available |
| Consumer imports a non-existent export | TypeScript catches it at compile/typecheck time — no runtime risk |
| `@repo/config` gets its first runtime consumer in the API | Works immediately — build step already in place |

## Constraints

- **tsup version**: Use `^8.0.0` (matches `@repo/ui` — already in the lockfile)
- **ESM only**: Both packages use `"type": "module"`; no CJS output needed
- **No breaking changes**: All existing `import` and `import type` statements must continue to work without modification
- **TurboRepo pipeline**: The `build` task's `"dependsOn": ["codegen", "^build"]` already handles dependency ordering; only the `test` task needs a new dependency
- **P0 urgency**: This is a blocking bug. The critical path (build step + exports) should not be blocked by the domain split

## Non-goals

- **Sub-path exports** (e.g., `@repo/types/avatar`) — consumers use the barrel `@repo/types` only
- **CJS format** — the project is ESM-only
- **Publishing to npm** — these are private workspace packages
- **Changes to `@repo/ui`** — its tsup setup already works correctly

## Technical Decisions

### 1. tsup as build tool

**Decision:** Use tsup, matching the `@repo/ui` precedent. Add `"tsup": "^8.0.0"` as a `devDependency` to both `@repo/types` and `@repo/config` — it is not hoisted to the workspace root.

**Rationale:** Already in the project, proven to work with the monorepo's TurboRepo pipeline, and handles ESM + declaration generation with minimal configuration.

**Config for both packages:**

```ts
import { defineConfig } from 'tsup'

export default defineConfig({
  entry: ['src/index.ts'],
  format: ['esm'],
  dts: true,
  splitting: false,
  sourcemap: true,
  clean: true,
})
```

### 2. tsconfig overrides for declaration generation

**Decision:** Add `"incremental": false` and `"composite": false` to both `packages/types/tsconfig.json` and `packages/config/tsconfig.json`.

**Rationale:** The shared `tsconfig.base` sets `"composite": true` and `"incremental": true`. tsup's `dts: true` invokes `tsc` for declaration generation but does not manage `.tsbuildinfo` files that composite projects require. Without these overrides, declaration generation may fail or produce stale output. `@repo/ui` already has these overrides — this brings the new packages into alignment.

```json
{
  "compilerOptions": {
    "rootDir": "src",
    "outDir": "dist",
    "incremental": false,
    "composite": false
  }
}
```

### 3. Package.json export pattern

**Decision:** Adopt the same conditional export pattern as `@repo/ui`.

**`@repo/types` package.json:**

```json
{
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "source": "./src/index.ts",
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },
  "files": ["dist"],
  "scripts": {
    "build": "tsup",
    "dev": "tsup --watch",
    "typecheck": "tsc --noEmit"
  },
  "devDependencies": {
    "@repo/config": "workspace:*",
    "tsup": "^8.0.0",
    "typescript": "^5.9.3"
  }
}
```

**`@repo/config` package.json** — same pattern but preserves existing JSON sub-path exports:

```json
{
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "source": "./src/index.ts",
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    },
    "./tsconfig": "./tsconfig.json",
    "./tsconfig.base": "./tsconfig.base.json"
  },
  "files": ["dist"],
  "scripts": {
    "build": "tsup",
    "dev": "tsup --watch",
    "typecheck": "tsc --noEmit"
  },
  "devDependencies": {
    "tsup": "^8.0.0",
    "typescript": "^5.9.3"
  }
}
```

The `"./tsconfig"` and `"./tsconfig.base"` sub-path exports point to raw JSON files (TSConfig references consumed by the TypeScript compiler, not runtime imports). They are unaffected by the build step. The `"files": ["dist"]` field restricts npm publish content but has no effect on workspace-local resolution (workspace symlinks bypass `files`), so these JSON exports continue to work.

### 4. Domain file split (`@repo/types`)

**Decision:** Split `index.ts` (206 lines, 7+ domains) into 8 domain files with barrel re-export.

| File | Exports |
|------|---------|
| `src/auth.ts` | `User`, `Role` |
| `src/api.ts` | `ApiErrorResponse` |
| `src/avatar.ts` | `DICEBEAR_CDN_BASE`, `AVATAR_STYLES`, `AvatarStyle` |
| `src/profile.ts` | `UserProfile`, `UpdateProfilePayload` (imports `AvatarStyle` from `./avatar`) |
| `src/account.ts` | `OrgOwnershipResolution`, `DeleteAccountPayload`, `AccountDeletionStatus`, `DeletionImpact`, `DeleteOrgPayload` |
| `src/errors.ts` | `ERROR_CODES` |
| `src/consent.ts` | `ConsentCategories`, `ConsentAction`, `ConsentCookiePayload`, `ConsentState`, `ConsentActions`, `ConsentRecord` |
| `src/rbac.ts` | `PermissionResource`, `PermissionAction`, `PermissionString`, `DefaultRoleSlug`, `Permission`, `OrgRole`, `RolePermission` |
| `src/index.ts` | Barrel: `export * from './auth'`, `export * from './api'`, etc. |

**Rationale:** All domains are self-contained (no circular cross-domain imports). The barrel uses flat `export *` statements (order-independent). All consumer imports remain unchanged.

### 5. TurboRepo `test` task dependency

**Decision:** Add `"dependsOn": ["^build"]` to the `test` task in `turbo.jsonc`.

**Rationale:** Without this, `turbo run test --filter=@repo/api` on a clean checkout fails because `dist/` doesn't exist yet. The API test file `user.controller.test.ts` imports `DICEBEAR_CDN_BASE` at runtime from `@repo/types`.

**Note:** This adds `^build` as a dependency for all packages' test runs. On a clean checkout, `bun run test --filter=@repo/ui` will now wait for `@repo/types` and `@repo/config` to build first. This is intentional and the performance impact is negligible (both packages compile in under a second).

### 6. Hotfix cleanup

**Decision:** Replace inlined constants after the build step is confirmed working in CI. Do not merge the cleanup until the build step is verified — this prevents a regression window.

| File | Remove | Add |
|------|--------|-----|
| `apps/api/src/auth/auth.instance.ts` | `const DICEBEAR_CDN_BASE = 'https://api.dicebear.com/9.x'` | `import { DICEBEAR_CDN_BASE } from '@repo/types'` |
| `apps/api/src/user/user.controller.ts` | `const DICEBEAR_CDN_BASE = ...` + `const AVATAR_STYLES = [...]` | `import { DICEBEAR_CDN_BASE, AVATAR_STYLES } from '@repo/types'` |

### 7. `@repo/config` — preventive fix

**Decision:** Add the build step to `@repo/config` now, despite having zero runtime consumers today.

**Rationale:** The `config` object is a runtime value (`export const config = { ... }`). Any future API consumer importing it would trigger the same `ERR_MODULE_NOT_FOUND` production outage. The cost is negligible (7-line file, identical tsup config), and it eliminates a known future incident.

## Implementation Order

1. **tsconfig overrides** — Add `incremental: false`, `composite: false` to both packages' `tsconfig.json`
2. **tsup config + package.json** — Add `tsup.config.ts`, update `package.json` exports/scripts/devDependencies for both packages
3. **Verify build** — `bun run build` succeeds, `dist/` output is correct
4. **Domain file split** — Split `@repo/types/src/index.ts` into 8 domain files with barrel re-export
5. **TurboRepo fix** — Add `"dependsOn": ["^build"]` to `test` task in `turbo.jsonc`
6. **Hotfix cleanup** — Replace inlined constants in API files with imports from `@repo/types`
7. **Full verification** — `bun run build && bun run typecheck && bun run test` all pass
8. **Vercel verification** — Preview deploy confirms no `ERR_MODULE_NOT_FOUND`

## Success Criteria

### Critical (P0 — gates PR merge)

- [ ] `@repo/types` has a tsup build step that compiles `.ts` → `.js` + `.d.ts` in `dist/`
- [ ] `@repo/config` has a tsup build step that compiles `.ts` → `.js` + `.d.ts` in `dist/`
- [ ] Both `package.json` files export compiled output (not raw `.ts`)
- [ ] Both `tsconfig.json` files have `incremental: false` and `composite: false`
- [ ] All existing `import type` usages still work (verified by `bun run typecheck`)
- [ ] All existing runtime value imports work (no `ERR_MODULE_NOT_FOUND`)
- [ ] Inlined constants in `auth.instance.ts` and `user.controller.ts` are replaced with imports from `@repo/types`
- [ ] `turbo.jsonc` `test` task depends on `^build`
- [ ] `bun run build` succeeds
- [ ] `bun run typecheck` succeeds
- [ ] `bun run test` succeeds
- [ ] API deploys successfully to Vercel preview with no `ERR_MODULE_NOT_FOUND`

### Required (ships in same PR)

- [ ] `@repo/types/src/index.ts` is split into 8 domain files with barrel re-export

### Already satisfied (no action needed)

- [x] `dist/` directories are gitignored — covered by root `.gitignore` line 7: `dist/`

## Open Questions

- **`dts` generation with `noEmit: true`**: The shared `tsconfig.base` sets `"noEmit": true`. tsup overrides this internally when generating declarations. Combined with the required `incremental: false` and `composite: false` overrides (Decision 2), this should work correctly — matching `@repo/ui`'s proven setup. If declaration generation fails during implementation, the fallback is a dedicated `tsconfig.build.json` with `"noEmit": false` referenced via `tsconfig` in the tsup config.
