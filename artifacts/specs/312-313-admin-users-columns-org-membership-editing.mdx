---
title: "Admin Panel Enhancements: Users List Columns & Org Membership Editing"
description: Add organizations count and last active columns to admin users list (#312) and superadmin inline-edit org memberships via context menu (#313).
---

## Context

Issues [#312](https://github.com/roxabi/roxabi_boilerplate/issues/312) and [#313](https://github.com/roxabi/roxabi_boilerplate/issues/313) — incremental enhancements to the Admin Panel Phase 2 ([#269](https://github.com/roxabi/roxabi_boilerplate/issues/269), completed).

**Promoted from:** [Admin Panel Enhancements Analysis](../analyses/312-313-admin-users-columns-org-membership-editing)

**Phase 2 delivered:** Cross-tenant user CRUD, cross-tenant organization CRUD with hierarchy, audit log viewer — all cursor-paginated and restricted to super admins. See [Phase 2 Spec](./269-admin-phase2).

## Goal

1. Make the admin users list more informative by adding organizations count and last active columns (#312).
2. Enable super admins to manage org memberships inline from the org detail page via context menu — changing roles and editing user profiles without navigating away (#313).

## Users &amp; Use Cases

### Super Admin (global `superadmin` user role)

- **Scan users at a glance**: See how many orgs each user belongs to and when they were last active, directly in the users list. Quickly identify inactive users or users with unusual org membership patterns.
- **Manage memberships inline**: From the org detail page, right-click a member row (or click the kebab menu) to change their role or edit their profile. No need to navigate to the user detail page for quick membership changes.

## Expected Behavior

### Happy path

#### #312 — Users list columns

1. Super admin navigates to `/admin/users`.
2. Table shows existing columns (Name, Email, Role, Status, Created) plus two new columns:
   - **Orgs**: A static count badge showing the number of organizations the user belongs to (e.g., `3`). Display-only — no tooltip or click behavior (full memberships visible on user detail page).
   - **Last Active**: Relative timestamp of the user's most recent audit log entry (e.g., "2 hours ago", "3 days ago"). Users with no audit activity show "Never".
3. Columns are display-only — no sorting or filtering on the new columns.

#### #313 — Org membership context menu

1. Super admin navigates to `/admin/organizations/:id` (org detail page).
2. In the Members table, each row shows a visible **kebab menu button** (`...`) in the rightmost column.
3. Super admin can either **right-click** a member row or **click the kebab button** — both open the same menu.
4. Menu shows:
   - **Change role** → submenu listing available RBAC roles for this org (fetched from `GET /api/admin/organizations/:orgId/roles`). The member's current role is visually indicated (check mark or disabled state). Clicking a different role applies it immediately.
   - **Edit profile** → opens a dialog with Name and Email fields pre-filled. User edits and clicks "Save". Success toast on save.
   - **View user** → navigates to `/admin/users/:userId` for the full detail page.
5. On role change: optimistic UI update (role badge changes immediately), success toast. On failure: rollback + error toast.
6. On profile edit: dialog closes on save, table row updates with new name/email, success toast.

### Edge cases

| Scenario | Behavior |
|----------|----------|
| Self-role-change | "Change role" submenu is disabled for the current user's row with tooltip "Cannot change your own role" |
| Last owner demotion | Service rejects with `LastOwnerConstraintException` → 400 → error toast "Cannot change role: this is the last owner of the organization" |
| Org has no RBAC roles | "Change role" submenu is disabled with tooltip "No roles configured for this organization" |
| Email conflict on profile edit | Service returns 409 → dialog shows inline error "A user with this email already exists" |
| User deleted between list load and action | Service returns 404 → error toast + org detail query refetch |
| Concurrent role change by another admin | Last-write-wins. Both changes audit logged independently |
| Roles endpoint fetch failure | "Change role" submenu shows "Failed to load roles" disabled state. Error toast. Retry on next menu open |
| User with zero audit entries | Last Active column shows "Never" |
| User in 0 organizations | Orgs column shows badge with "0" |

## Breadboard

### UI Affordances

| ID | Element | Location | Trigger |
|----|---------|----------|---------|
| U1 | Orgs count badge column | `/admin/users` table | Display (page load) |
| U2 | Last Active column | `/admin/users` table | Display (page load) |
| U3 | Kebab menu button (`...`) | `/admin/organizations/:id` members table, per row | Click |
| U4 | Context menu (right-click) | `/admin/organizations/:id` members table, per row | Right-click on row |
| U5 | "Change role" submenu | Context menu / dropdown | Hover or click |
| U6 | Role option item | Role submenu | Click → role change |
| U7 | "Edit profile" menu item | Context menu / dropdown | Click → opens dialog |
| U8 | Edit profile dialog | Modal overlay | U7 click |
| U9 | Save button in edit dialog | Edit profile dialog | Click → save |
| U10 | "View user" menu item | Context menu / dropdown | Click → navigate |

### Code Affordances

| ID | Handler | Wiring | Logic |
|----|---------|--------|-------|
| N1 | `listUsers` (extended) | U1, U2 → N1 → S1, S2, S3 | Existing two-query approach + new third query: `SELECT actorId, MAX(timestamp) FROM audit_logs WHERE actorId IN (:ids) GROUP BY actorId`. `organizationCount` derived from existing Query 2 membership map (`.length`), not a separate query. Total: 3 queries per page |
| N2 | `GET /api/admin/organizations/:orgId/roles` | U5 → N2 → S4 | New endpoint on `AdminOrganizationsController`. Query `roles` table WHERE `tenantId = orgId`. Return `{ data: { id, name, slug }[] }` |
| N3 | `PATCH /api/admin/organizations/:orgId/members/:memberId/role` | U6 → N3 → S2, S4 | New superadmin-specific route on `AdminOrganizationsController` (not the existing org-admin `AdminMembersController`). Calls `AdminMembersService.changeMemberRole`. **Add last-owner guard**: dual-check `roleSlug === 'owner' \|\| role === 'owner'` (matching `removeMember` pattern), count owners, reject if count &lt;= 1 and new role differs |
| N4 | `PATCH /api/admin/users/:userId` | U9 → N4 → S1, S3 | Existing `updateUser`. No changes needed |

### Data Stores

| ID | Store | Type | Accessed by |
|----|-------|------|-------------|
| S1 | `users` table | Persistent (PostgreSQL) | N1, N4 |
| S2 | `members` table | Persistent (PostgreSQL) | N1, N3 |
| S3 | `audit_logs` table | Persistent (PostgreSQL) | N1 |
| S4 | `roles` table | Persistent (PostgreSQL) | N2, N3 |

**Unknowns:** None — all wiring uses existing services and table structures.

## Slices

| Slice | Description | Affordances | Demo |
|-------|-------------|-------------|------|
| V1: Users list columns (#312) | Add Orgs count badge + Last Active column to `/admin/users`. Backend: batch audit query in `listUsers`. Frontend: two new `TableHead`/`TableCell`. Add `ContextMenu` component to `@repo/ui` (needed for V2). | U1, U2, N1 | Super admin sees org count and last active for each user in the list. Users with no activity show "Never". Users in 0 orgs show "0". |
| V2: Org membership context menu (#313) | Add `MemberContextMenu` component. Dual trigger: right-click + kebab button. Role submenu (fetch org roles), edit profile dialog, view user link. Add last-owner guard to `changeMemberRole`. New roles endpoint. | U3-U10, N2, N3, N4 | Super admin right-clicks a member in org detail → changes role via submenu. Opens edit dialog → saves name/email. Self-role-change is disabled. Last owner cannot be demoted. |

**Slice dependencies:** V1 → V2 (sequential). V2 depends on V1 only for the `ContextMenu` UI component added in V1. If preferred, the `ContextMenu` component can be added in V2 instead, making the slices independent.

## Constraints

- **No schema migrations.** Both issues are additive on existing tables and queries.
- **Existing guard strategy.** All endpoints use `@Roles('superadmin')` + `@SkipOrg()`. No changes to the guard chain.
- **Rate limiting.** Same as Phase 2: `@Throttle({ global: { ttl: 60_000, limit: 30 } })` on all admin controllers.
- **UI components.** `ContextMenu` must be added to `@repo/ui` (Radix `@radix-ui/react-context-menu`). `DropdownMenu` already exists.
- **Audit logging.** All mutations are already audit-logged by existing services. No additional audit work.

## Non-goals

- **Sorting or filtering** on the new Orgs/Last Active columns — display-only for now
- **Context menu on `/admin/members` page** — only on the org detail page
- **Member status changes** (ban/unban) from context menu — available on user detail page
- **Inline editing** (click-to-edit cells) — dialog-based editing only
- **Mobile-optimized context menu** — desktop-first admin panel; kebab button provides touch access

## Technical Decisions

### Dual-trigger menu (ContextMenu + DropdownMenu)

**Decision:** Both right-click and kebab button open the same menu content.

**Implementation:** The `&lt;MemberContextMenu>` component renders two Radix primitives sharing the same menu content:
- `ContextMenu` wraps the `&lt;TableRow>` — triggered by right-click
- `DropdownMenu` renders a kebab button in the last column — triggered by click

A shared `&lt;MemberMenuContent>` sub-component defines the menu items once, passed to both `ContextMenuContent` and `DropdownMenuContent`. This avoids duplicating menu logic.

### Last active via batch audit query

**Decision:** Add a third query to `listUsers` using `MAX(timestamp)` grouped by `actorId`.

**Rationale:** Matches the existing two-query pattern (users + memberships). One additional query per page load (20 users) is negligible. Avoids schema migration or write-path changes.

### Last owner demotion guard

**Decision:** Add a guard to `AdminMembersService.changeMemberRole()` that checks if the member being changed is the last owner.

**Implementation:** Before applying the role change, use a **dual-field check** (matching the existing pattern in `removeMember()`):
1. Check if `currentRoleSlug === 'owner' || member.role === 'owner'` (covers both RBAC roleId and legacy `role` text field — `roleSlug` can be null if `roleId` is null)
2. If owner, count members with the same `roleId` in the org
3. If count &lt;= 1 and the new role is different, throw `LastOwnerConstraintException`

### Empty roles fallback

**Decision:** Disable the "Change role" submenu when the org has no RBAC roles configured.

**Rationale:** Mixing dynamic RBAC `roleId` with hardcoded legacy role strings could create data inconsistencies. Better to show a clear "no roles" state than to offer misleading options.

### Extracted `&lt;MemberContextMenu>` component

**Decision:** Extract the context menu, role submenu, edit dialog, and mutation hooks into a standalone component at `apps/web/src/components/admin/member-context-menu.tsx`.

**Props:** `member: { id: string; userId: string; name: string; email: string; role: string; roleId: string | null }`, `orgId: string`, `currentUserId: string`, `onActionComplete: () => void`.

**`currentUserId`** is derived from the auth session context via the existing `useSession()` hook (or equivalent session provider) in the parent page component.

### ContextMenu added to `@repo/ui`

**Decision:** Add `ContextMenu` primitives to `packages/ui/src/components/ContextMenu.tsx`, re-exporting from `@radix-ui/react-context-menu` with consistent styling (same pattern as the existing `DropdownMenu` component).

**Exports:** `ContextMenu`, `ContextMenuTrigger`, `ContextMenuContent`, `ContextMenuItem`, `ContextMenuSub`, `ContextMenuSubTrigger`, `ContextMenuSubContent`, `ContextMenuSeparator`.

### Backend file changes

```
apps/api/src/admin/
  admin-users.service.ts             (modify — add batch lastActive query to listUsers)
  admin-organizations.controller.ts  (modify — add GET :orgId/roles endpoint + PATCH :orgId/members/:memberId/role route)
  admin-organizations.service.ts     (modify — add listOrgRoles method + extend getOrganizationDetail to return userId/roleId in members)
  admin-members.service.ts           (modify — add last-owner guard to changeMemberRole)
```

### Frontend file changes

```
packages/ui/src/
  components/ContextMenu.tsx          (new — Radix ContextMenu primitives)
  index.ts                            (modify — export ContextMenu)

apps/web/src/
  routes/admin/users.tsx              (modify — add Orgs + Last Active columns)
  routes/admin/organizations.$orgId.tsx (modify — integrate MemberContextMenu into MembersCard)
  components/admin/member-context-menu.tsx (new — extracted ContextMenu + DropdownMenu + edit dialog)

packages/types/src/
  admin.ts                            (modify — add lastActive + organizationCount to AdminUser, add OrgRole type)
```

## Success Criteria

- [ ] `/admin/users` table shows "Orgs" column with count badge for each user. Users in 0 orgs show "0".
- [ ] `/admin/users` table shows "Last Active" column with relative timestamp. Users with no audit activity show "Never".
- [ ] Org detail members table has a visible kebab menu (`...`) button on each row.
- [ ] Right-clicking a member row opens a context menu with "Change role", "Edit profile", and "View user" options.
- [ ] Clicking the kebab button opens the same menu as right-click.
- [ ] "Change role" submenu lists all RBAC roles for the org. Current role is indicated. Clicking a different role applies it immediately with optimistic update + success toast.
- [ ] "Edit profile" opens a dialog with Name and Email fields. Save updates the user and closes the dialog with success toast.
- [ ] "View user" navigates to `/admin/users/:userId`.
- [ ] Self-role-change option is disabled with tooltip for the current user's row.
- [ ] Attempting to demote the last owner returns 400 with clear error message in toast.
- [ ] Orgs with no configured RBAC roles show disabled "Change role" with tooltip.
- [ ] All role changes and profile edits are audit-logged (verified via `/admin/audit-logs`).
- [ ] `GET /api/admin/organizations/:orgId/roles` returns available roles for the org. Non-superadmin requests return 403.
- [ ] No schema migration required — all changes are additive on existing tables.

## Open Questions

- **ContextMenu touch behavior**: Radix ContextMenu may not work on touch devices. The kebab button provides fallback, but should we add a long-press handler for touch? (Low priority — admin panel is desktop-first.)
