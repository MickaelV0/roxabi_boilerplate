---
title: "Admin Panel"
description: Administrative interface for managing users, organizations, and system settings with role-based access for org admins and super admins.
---

## Context

Issue [#25](https://github.com/roxabi/roxabi_boilerplate/issues/25) — one of the Phase 1 MVP targets from the [vision doc](/docs/vision.mdx) ("B2B: Internal tools, dashboards, admin panels"). Dependencies #19 (RBAC), #21 (Org Management), and #24 (Soft Delete) are all completed.

**Promoted from:** [Admin Panel Analysis](../analyses/25-admin-panel.mdx)

**Current state (updated 2026-02-24):**

- **Phase 1 (#268) — Completed.** Admin layout, sidebar, guards, member management with offset pagination, `AuditService` scaffolding, Better Auth admin plugin restricted, dual `role`/`roleId` sync resolved.
- **Phase 2 (#269) — Completed.** Cross-tenant user/org management with cursor pagination, org hierarchy (tree view, depth/cycle validation), audit log viewer with diff view and sensitive field redaction. See [Phase 2 spec](./269-admin-phase2.mdx).
- **Phase 3 (#270) — Open.** System settings + feature flags. Next in sequence.
- **Phase 4 (#271) — Open.** Impersonation + health dashboard.

**Remaining child issues (execution order):**

| Order | # | Title | Size | Priority | Blocked by |
|:-----:|---|-------|:----:|:--------:|:----------:|
| 1 | [#311](https://github.com/MickaelV0/roxabi_boilerplate/issues/311) | Self-role-change with confirmation + sole-owner guard | S | P2 | — |
| 2 | [#314](https://github.com/MickaelV0/roxabi_boilerplate/issues/314) | Centralized route permission map + useCanAccess hook | M | P2 | — |
| 3 | [#270](https://github.com/MickaelV0/roxabi_boilerplate/issues/270) | Phase 3: System Settings + Feature Flags | M | P2 | #314 |
| 4 | [#271](https://github.com/MickaelV0/roxabi_boilerplate/issues/271) | Phase 4: Impersonation + Health Dashboard | L | P2 | #270 |
| — | [#312](https://github.com/MickaelV0/roxabi_boilerplate/issues/312) | Orgs count + last active columns in users list | S | P3 | — |
| — | [#313](https://github.com/MickaelV0/roxabi_boilerplate/issues/313) | Superadmin inline-edit org memberships | M | P3 | — |
| ~~—~~ | ~~[#293](https://github.com/MickaelV0/roxabi_boilerplate/issues/293)~~ | ~~Sub-org hierarchy~~ | — | — | Closed |

**Rationale:** #311 is a quick standalone fix. #314 refactors route guards to a single-source-of-truth pattern — doing it before Phase 3 means new routes use the clean pattern from the start. #270 and #271 follow the phase sequence. P3 items (#312, #313) can slot in anytime.

## Goal

Provide a unified admin panel where org admins manage their organization's users and settings, and super admins manage all organizations, system configuration, and audit trails — with full accountability via audit logging.

## Users &amp; Use Cases

### Org Admin (org-scoped RBAC role: `admin` or `owner`)

- **Manage members**: List, invite, change roles, remove members within their organization.
- **Manage org settings**: Edit org name/slug, configure org-level settings, manage org hierarchy (set parent).
- **View activity**: See member activity summaries (last login, last 10 audit log entries for that member).

### Super Admin (global `superadmin` user role)

Everything an org admin can do, plus:

- **Cross-tenant user management**: List all users across all orgs, edit user details, ban/unban, soft-delete/restore.
- **Cross-tenant org management**: List all orgs, create/edit/delete orgs, manage org hierarchy tree.
- **Impersonate users**: View the app as a specific user for debugging/support. Required for customer support workflows — super admins must be able to reproduce user-reported issues in their exact context.
- **System settings**: Configure global application settings and feature flags.
- **Health monitoring**: View service status and key operational metrics.
- **Audit logs**: Search and review all admin actions with before/after diffs.

## Expected Behavior

### Happy path

#### Admin panel access

1. Authenticated user with `admin`/`owner` org role or `superadmin` global role clicks "Admin" in the navbar.
2. App navigates to `/admin`. The admin layout renders: sidebar (left) + content area (right).
3. **Sidebar nav groups:**
   - **Organization** (all admins): Members, Organization Settings
   - **System** (super admins only): Users, Organizations, System Settings, Feature Flags, Health Dashboard, Audit Logs
4. Default landing page: `/admin/members` (the most common admin task).
5. **Loading state**: sidebar renders immediately; content area shows a skeleton loader until data is fetched.
6. **Error state**: if the data fetch fails, content area shows an error card with "Retry" button.

#### Member management (org admin)

1. Admin navigates to `/admin/members`.
2. Page shows a searchable, paginated table of org members: name, email, role, joined date, last active, actions.
3. Admin clicks "Invite Member" → dialog with email input and RBAC role select (all org roles from `GET /api/roles`).
4. Admin fills email and selects a role, clicks "Send Invite" → `POST /api/admin/members/invite` with `{ email, roleId }`. On success: toast "Invitation sent", dialog closes, invitation appears in a pending invitations section. If email is already a member: 400 "User is already a member of this organization."
5. Admin changes a member's role via inline dropdown → calls `PATCH /api/admin/members/:memberId` with `{ roleId }`. The `:memberId` is the membership record ID (not user ID).
6. Admin clicks "Remove" on a member → confirmation dialog → calls `DELETE /api/admin/members/:memberId`.
7. All actions are audit logged via `AuditService.log()`.

#### Cross-tenant user management (super admin)

1. Super admin navigates to `/admin/users` (System group).
2. Page shows all platform users (cursor-paginated): name, email, global role, organizations, status (active/banned/deleted), last active.
3. Filters: role, status, organization, text search.
4. Super admin clicks a user row → detail view: profile info, org memberships, activity summary (last 10 audit log entries involving this user).
5. Super admin can: edit details (`PATCH /api/admin/users/:id`), change global role, ban/unban (with reason + optional expiration), soft-delete, restore.
6. Super admin clicks "Impersonate" → new session as that user, persistent banner appears.

#### Impersonation flow

1. Super admin clicks "Impersonate" on a non-superadmin user.
2. Backend: creates a new session via Better Auth with `impersonatorId` set on the session record. Original session is preserved.
3. Frontend: full page reload with impersonation session. Persistent top banner: "Viewing as [User Name] ([email]) — [Stop Impersonating]".
4. Super admin navigates the app as the impersonated user. All pages render with the impersonated user's permissions and data.
5. Every action taken is audit logged with `actorType: 'impersonation'`, `actorId: impersonated_user_id`, `impersonatorId: superadmin_id`.
6. Super admin clicks "Stop Impersonating" → impersonation session destroyed, original admin session restored, redirect to `/admin/users`.

#### Organization management (super admin)

1. Super admin navigates to `/admin/organizations` (System group).
2. Page shows all orgs (cursor-paginated): name, slug, member count, parent org, status (active/deleted), created date.
3. Super admin clicks "Create Organization" → dialog with fields: name, slug (auto-generated from name, editable), parent org (optional select). Submit → `POST /api/admin/organizations` with `{ name, slug, parentOrganizationId? }`. On success: toast "Organization created", redirect to org detail view.
4. Super admin clicks an org row → detail view: org info, member list, child orgs. Edit form for name, slug, parent org. Save → `PATCH /api/admin/organizations/:id`.
5. Soft-delete: "Delete Organization" button → impact preview dialog (fetched from `GET /api/admin/organizations/:id/deletion-impact` — member count, effect) → confirm → `DELETE /api/admin/organizations/:id`. On success: org moves to archived state.
6. Restore: in "Archived" filter, "Restore" button → `POST /api/admin/organizations/:id/restore`.
7. Hierarchy view: toggle between flat list and tree view. Tree view renders expandable/collapsible nodes showing parent → child relationships with member counts. Max 3 levels deep.

#### System settings

1. Super admin navigates to `/admin/system-settings`.
2. Page shows grouped settings cards by category.
3. Each setting renders with the appropriate input type based on its `type` field (text, number, boolean toggle, select dropdown).
4. Super admin edits a value → clicks "Save" button per card → `PATCH /api/admin/settings/:key` with `{ value }`. Success toast confirms the change.
5. Changes are audit logged with before/after values.

#### Feature flags

1. Super admin navigates to `/admin/feature-flags`.
2. Page shows all flags: name, key, description, enabled/disabled toggle.
3. Super admin toggles a flag → `PATCH /api/admin/feature-flags/:id` with `{ enabled }` → in-memory cache invalidated. Success toast.
4. Super admin clicks "Create Flag" → dialog with fields: name, key (auto-slugified, validated unique), description. Submit → `POST /api/admin/feature-flags`. If duplicate key: 400 "A flag with this key already exists."
5. Super admin clicks "Delete" on a flag → confirmation dialog → `DELETE /api/admin/feature-flags/:id`.

#### Health dashboard

1. Super admin navigates to `/admin/health`.
2. Page shows service status cards (API, DB) with up/down indicators. "Up" = health check returns 200 within 5 seconds. "Down" = timeout or error.
3. Key metrics displayed:
   - Active users (24h): count of users with a session updated in the last 24 hours (from `sessions` table).
   - Total users: count from `users` table (excluding soft-deleted).
   - Total organizations: count from `organizations` table (excluding soft-deleted).
   - DB connection pool: pool size, active, idle connections (from Drizzle/pg pool stats).
4. Metrics marked "Not configured" (API request rate, error rate) show a disabled card with tooltip: "Requires application metrics integration."
5. Auto-refresh every 30 seconds. Manual refresh button available. Loading spinner on refresh.

#### Audit logs

1. Super admin navigates to `/admin/audit-logs`.
2. Page shows a filterable, cursor-paginated table: timestamp, actor, action, resource, organization.
3. Filters: date range, actor (user search), action type, resource type, organization.
4. Text search across action descriptions and resource IDs.
5. Click a row to expand → before/after diff view showing what changed (e.g., `role: "member" → "admin"`).

### Edge cases

| Scenario | Behavior |
|----------|----------|
| Org admin navigates to `/admin/users` (super-admin-only page) | Redirect to `/admin` (the admin panel root) |
| Org admin navigates to any `/admin/system/*` route | Redirect to `/admin` |
| Non-admin user navigates to `/admin/*` | Redirect to `/dashboard` |
| Super admin impersonates a user who is then banned | Impersonation session ends immediately, redirect to `/admin/users` with toast notification |
| Super admin tries to impersonate another super admin | Button hidden in UI; backend returns 403 with message "Cannot impersonate super admin users" |
| Impersonation session expires (1h TTL) | Banner shows "Session expired", auto-redirect to `/admin/users`, original session restored |
| Super admin soft-deletes an org with active members | Impact preview dialog shows member count and effect; members lose org access but user accounts remain |
| Org admin tries to remove the last owner from an org | Backend rejects with 400: "Cannot remove the last owner" |
| Feature flag toggle while cached | Cache invalidated immediately on the admin API response; other instances pick up change on next cold start (serverless) or within 60s TTL (long-lived) |
| Audit log for a deleted user | `actorId` references the deleted user; display shows "[Deleted User]" with the original ID |
| Org hierarchy exceeds 3 levels | Backend validation rejects with 400: "Maximum organization depth of 3 levels exceeded" |
| Concurrent admin edits to the same user | Last-write-wins. Audit log captures both changes independently. The second write's `before` snapshot may reflect pre-first-write state. |
| Invite sent to existing member | Backend rejects with 400: "User is already a member of this organization" |
| Invite sent to existing pending invite | Backend rejects with 400: "An invitation has already been sent to this email" |

## Constraints

- **Auth foundation**: Must use the existing two-tier role system (global `users.role` + org-scoped RBAC `roles` table). No new role tiers.
- **Better Auth compatibility**: Impersonation must work with or wrap Better Auth's session model. Cannot break existing auth flows.
- **Tenant isolation**: Cross-tenant queries (super admin endpoints) must not weaken RLS for non-admin code paths. Cross-tenant is achieved by bypassing `TenantService` in admin-specific services only.
- **Legacy field sync**: `members.role` and `invitations.role` (Better Auth legacy fields) coexist with `roleId`. Admin panel uses `roleId` exclusively. **Phase 1 prerequisite**: must resolve sync strategy (write both fields on role change, or migrate away from legacy field) before shipping member management. This is a hard blocker, not an optional investigation.
- **UI components**: Use existing Shadcn/UI components from `packages/ui`. Add new components only when the existing set is insufficient.
- **Dependencies**: #19 (RBAC), #21 (Org Management), #24 (Soft Delete) — all completed.

## Non-goals

- **Mobile-optimized admin UX** — desktop-first. Responsive layout (collapsible sidebar) but not mobile-optimized workflows.
- **Audit log CSV export** — deferred to follow-up issue.
- **Feature flag targeting** (per-org, per-user, percentage rollouts) — MVP is global boolean toggles only.
- **Hard deletion** of users or organizations — soft delete with restore only.
- **Business analytics dashboard** — health dashboard shows operational metrics, not business KPIs.
- **Real-time notifications** for admin events — admin panel is request/response only in MVP.
- **Optimistic locking / conflict resolution** for concurrent admin edits — last-write-wins in MVP.
- **Health alerting** — the health dashboard is a status page, not an alerting system. No notifications when services go down.

## Technical Decisions

### Route architecture

Single `/admin/*` route tree with a dedicated admin layout. Sidebar nav groups ("Organization" visible to all admins, "System" visible to super admins only) provide clean separation without code duplication. Alternative approaches (split `/admin` + `/super`, conditional UI without groups) were rejected for UX and maintenance reasons. See [analysis](../analyses/25-admin-panel.mdx#route-architecture) for full trade-off comparison.

### Guard strategy

**Frontend:**
- `requireAdmin()`: checks `session.user.role === 'superadmin'` first (short-circuit — super admins always pass, even without an active org). Otherwise, checks if `session.permissions` includes `members:write` (indicates admin/owner RBAC role). **Implementation note**: check `superadmin` first, then permissions — never require both.
- `requireSuperAdmin()`: checks `session.user.role === 'superadmin'` only.
- Route-level guards on each admin route. Unauthorized access redirects to `/admin` (org admin hitting super-admin page) or `/dashboard` (non-admin).

**Backend:**
- Org-scoped admin endpoints: `@Permissions('members:write')` etc. — existing tenant-scoped guards.
- Cross-tenant admin endpoints: `@Roles('superadmin')` — direct Drizzle queries without `TenantService`. These admin services do NOT call `TenantService.queryAs()` and instead build queries with explicit filters.
- **Better Auth admin plugin** (`/api/auth/admin/*`): **disable in Phase 1** by removing the `admin()` plugin from `auth.instance.ts` or restricting access at the Fastify route level. All admin actions go through NestJS controllers with proper guards and audit logging. Investigate whether any existing code depends on these endpoints before removal.

### Audit logging

Explicit `AuditService.log()` calls in each controller action (not interceptor-based). Controllers read the entity before mutation (for `before` snapshot), perform the mutation, then log with both snapshots. This avoids N+1 reads on bulk operations — only admin actions are audited, not all DB writes.

**`AuditService` is scaffolded in Phase 1** (with the `audit_logs` table) and wired into controllers as they are written. This avoids the risk of retrofitting audit calls after the fact.

**Action vocabulary** (standardized strings):

| Action | Description |
|--------|-------------|
| `user.created` | New user created |
| `user.updated` | User details changed |
| `user.banned` | User banned |
| `user.unbanned` | User unbanned |
| `user.deleted` | User soft-deleted |
| `user.restored` | User restored from soft-delete |
| `user.role_changed` | User global role changed |
| `member.invited` | Member invited to org |
| `member.role_changed` | Member org role changed |
| `member.removed` | Member removed from org |
| `org.created` | Organization created |
| `org.updated` | Organization details changed |
| `org.deleted` | Organization soft-deleted |
| `org.restored` | Organization restored |
| `org.parent_changed` | Organization parent changed |
| `settings.updated` | System setting changed |
| `flag.created` | Feature flag created |
| `flag.toggled` | Feature flag enabled/disabled |
| `flag.deleted` | Feature flag deleted |
| `impersonation.started` | Impersonation session started |
| `impersonation.ended` | Impersonation session ended |

### Feature flag caching

`FeatureFlagService.isEnabled(key)` uses an in-memory cache with 60-second TTL. Cache is invalidated immediately when a flag is toggled via the admin API (same instance). **On Vercel serverless**: each invocation is effectively a cold start, so the cache provides minimal benefit — flags are read from DB on each invocation. This is acceptable for MVP; a Redis/KV cache can be added if flag check frequency becomes a bottleneck.

### Pagination strategy

- **Cross-tenant lists** (all users, all orgs, audit logs): cursor-based pagination for performance with large datasets.
- **Org-scoped lists** (members within an org): offset-based pagination (smaller, bounded datasets).

### Schema changes

**New tables:**

```
system_settings
  id (PK), key (unique), value (jsonb),
  type ('string' | 'number' | 'boolean' | 'select'),
  name, description, category,
  createdAt, updatedAt

feature_flags
  id (PK), key (unique), name, description,
  enabled (boolean, default false),
  createdAt, updatedAt

audit_logs
  id (PK), timestamp,
  actorId → users.id,
  actorType ('user' | 'system' | 'impersonation'),
  impersonatorId → users.id (nullable),
  organizationId → organizations.id (nullable),
  action (text), resource (text), resourceId (text),
  before (jsonb), after (jsonb), metadata (jsonb),
  createdAt

  Indexes:
    idx_audit_logs_actor (actorId)
    idx_audit_logs_org (organizationId)
    idx_audit_logs_timestamp (timestamp DESC)
    idx_audit_logs_action (action)
```

**Altered tables:**

```
organizations
  + parentOrganizationId (text, nullable, self-referencing FK)
  -- Named to match existing TenantInterceptor field check

sessions
  + impersonatorId (text, nullable, FK → users.id)
```

### Super admin provisioning

- **Seed**: `bun run db:seed` creates a default super admin from `SUPERADMIN_EMAIL` / `SUPERADMIN_PASSWORD` env vars.
- **Promotion**: existing super admins promote users via the admin panel.
- **Emergency**: direct DB update as last resort (documented in deployment guide).

## Implementation Phases

### Phase 1: Admin Layout + Page Migration + Foundation — ✅ Completed (#268)

**Delivered:**

- `/admin` route tree with admin layout (sidebar + content area)
- `requireAdmin()` and `requireSuperAdmin()` route guards (SSR-safe)
- Sidebar with nav groups (Organization + System) — System group hidden for org admins
- `/admin/members` with offset pagination, full RBAC role support, invite, role change, remove
- `/admin/settings` (org settings migration)
- `AdminModule` with `AdminMembersController`, `AdminInvitationsController`, `AdminMembersService`
- `AuditService` with `audit_logs` table (fire-and-forget `log()` method)
- `AdminExceptionFilter` for standardized error responses
- Better Auth admin plugin restricted
- Dual `role`/`roleId` sync resolved (write both fields on role change)

### Phase 2: User &amp; Org Management — ✅ Completed (#269, PR #308)

**Delivered (see [Phase 2 spec](./269-admin-phase2.mdx) for full details):**

- `/admin/users`: cross-tenant user list with cursor pagination, search, filters (role, status, org, text)
- `/admin/users/:id`: user detail with profile, org memberships, activity summary (last 10 audit entries)
- User actions: edit details, change global role, ban/unban (with reason + optional expiry), soft-delete, restore
- `/admin/organizations`: cross-tenant org list with cursor pagination, flat + tree view toggle
- `/admin/organizations/:id`: org detail with members, child orgs, edit form
- Org actions: create (with parent), edit, soft-delete (with impact preview), restore
- `parentOrganizationId` column on organizations, depth validation (max 3), cycle detection
- `/admin/audit-logs`: cursor-paginated audit log viewer with filters, expandable diff view, sensitive field redaction
- `@SkipOrg()` decorator for cross-tenant endpoints
- Cursor pagination utilities (backend + `useCursorPagination` hook + `LoadMoreButton`)
- New components: `FilterBar`, `TreeView`, `DiffViewer`, `UserActions`, `OrgActions`
- Comprehensive test coverage across all controllers and services

### Phase 3: System Settings + Feature Flags — Open (#270)

**Scope:** Global configuration and feature flag management. Needs standalone spec.

- `system_settings` and `feature_flags` DB tables + migrations
- `/admin/system-settings`: grouped settings cards with explicit save per card
- `/admin/feature-flags`: flag list with toggle switches, create/delete with key validation
- `FeatureFlagService` with in-memory cache (60s TTL, graceful fallback to DB on serverless)
- `SystemSettingsService` for CRUD operations
- Backend: `AdminSettingsController`, `AdminFeatureFlagsController`
- Wire `AuditService.log()` into all new controllers
- Enable "System Settings" and "Feature Flags" sidebar nav items (currently `disabled: true`)

### Phase 4: Impersonation + Health Dashboard — Open (#271)

**Scope:** User impersonation and system monitoring. Needs standalone spec.

- `impersonatorId` column on `sessions` table
- Impersonation: `ImpersonationService`, session management, persistent banner in root layout
- `/admin/health`: service status cards + key metrics, auto-refresh (30s)
- Wire `AuditService.log()` into impersonation start/stop
- Verify Better Auth impersonation API compatibility (fallback: direct session manipulation)
- Enable "Health" sidebar nav item (currently `disabled: true`)

## Success Criteria

- [x] **Member management** (Phase 1): Given an org admin session, `GET /api/admin/members` returns only members of the admin's org, paginated. Invite, role-change, and remove operations work and create audit log entries.
- [x] **Permission-based UI** (Phase 1): Org admins see only the Organization nav group. Super admins see both groups. Non-admin users navigating to `/admin` are redirected to `/dashboard`. Org admins navigating to `/admin/users` are redirected to `/admin`.
- [x] **Page migration** (Phase 1): Navigating to `/org/members` redirects to `/admin/members`. Navigating to `/org/settings` redirects to `/admin/settings`. All existing functionality is preserved and enhanced (pagination, all RBAC roles in invite/change dialogs).
- [x] **Cross-tenant CRUD** (Phase 2): Given a super admin session, `GET /api/admin/users` returns users from all organizations. Ban, unban, soft-delete, and restore operations work and create audit log entries. Same for `GET /api/admin/organizations`.
- [ ] **Impersonation** (Phase 4, #271): Super admin can start an impersonation session for a non-superadmin user. Persistent banner is visible on all pages. "Stop Impersonating" restores the original session. Attempting to impersonate a superadmin returns 403. Impersonation start and stop are audit logged.
- [x] **Audit trail** (Phase 2): Every admin action listed in the action vocabulary table produces an audit log entry with correct `before`/`after` data. The audit log viewer at `/admin/audit-logs` displays entries with filters, search, and expandable diff view. Verified by integration tests.
- [ ] **Feature flags** (Phase 3, #270): Super admin can create, toggle, and delete boolean feature flags. `FeatureFlagService.isEnabled(key)` returns the correct value. Duplicate key creation returns 400.
- [ ] **System settings** (Phase 3, #270): Super admin can view and edit typed system settings grouped by category. Changes persist and are audit logged.
- [ ] **Health dashboard** (Phase 4, #271): `/admin/health` displays API status (up/down based on health check), DB status, active users (24h), total users, total orgs, and DB pool stats. Deferred metrics show "Not configured" cards.
- [x] **Org hierarchy** (Phase 2): Setting `parentOrganizationId` on an organization works. Setting a 4th-level parent returns 400. Tree view renders with correct indentation and expand/collapse. Parent/child is display-only grouping (TenantInterceptor parent resolution deferred — guarded with opt-in check).
- [x] **Soft delete** (Phase 2): Soft-deleted users and orgs appear when filtering by "Archived" status. Super admins can restore them via the admin panel.
- [x] **Better Auth plugin** (Phase 1): `/api/auth/admin/*` endpoints are disabled or restricted. Admin actions go through NestJS controllers exclusively.

## Open Questions

- **Impersonation via Better Auth**: Does the current Better Auth version support the `impersonate-user` admin API with custom session fields? If not, impersonation session must be created via direct session manipulation. Investigate during Phase 4 (#271).
- **Audit log retention**: Indefinite for MVP. Configurable retention policy may be needed at scale — defer to follow-up issue. Audit logs are not subject to RLS; future org-admin audit visibility would require adding tenant scoping.
- ~~**`members.role` migration path**~~: **Resolved in Phase 1.** Both `roleId` and legacy `role` field are written on every role change (safe, compatible approach).
- **Initial system settings**: What settings should exist at launch? The schema and UI are defined, but the initial settings catalog needs to be determined during Phase 3 implementation (#270).
- **Rate limiting for admin endpoints**: Phase 2 uses `@Throttle({ global: { ttl: 60_000, limit: 30 } })` on all cross-tenant controllers. Consider whether bulk operations need a higher limit or batch endpoints in a follow-up.
- **Write-time audit redaction**: `AuditService.log()` currently does not strip sensitive keys before writing to DB. Phase 2 redacts at read time (API response) only. A follow-up should add write-time stripping.
- **Ban auto-enforcement**: Ban takes effect on next API request only (no session invalidation). A fast-follow middleware to check `banned` on every request would close this gap. Auto-unban on `banExpires` is also deferred.
