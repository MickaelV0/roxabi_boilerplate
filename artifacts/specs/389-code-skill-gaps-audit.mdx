---
title: "fix: code and skill gaps found during documentation audit"
issue: 389
parent_spec: null
status: approved
tier: F-full
date: 2026-02-27
promoted_from: artifacts/frames/code-skill-gaps-audit.mdx
---

## Context

Three code/skill gaps identified during the documentation accuracy audit (#388). They are real defects — not documentation issues — and were deferred from that PR to this issue. A fourth gap (`api_keys:delete` permission) is tracked in Epic #194 and is out of scope here.

Source: [artifacts/frames/code-skill-gaps-audit.mdx](../frames/code-skill-gaps-audit.mdx)

## Goal

Fix the ADR skill's silent data corruption, migrate `feature-flags.tsx` to the required TanStack Query patterns, and formally document the Phase 3 deferral of parent tenant resolution — with no regressions.

## Users

- **Developers using `/adr`** — the skill currently overwrites `docs/architecture/adr/meta.json` with an incompatible schema, silently breaking the Fumadocs docs sidebar for all ADR pages.
- **Developers maintaining `feature-flags.tsx`** — the file violates two standards from `frontend-patterns.mdx §1.7` (inline `useQuery` config, direct `fetch` in event handlers).
- **Future developers reading `tenant.interceptor.ts`** — the unresolved `TODO` comment is misleading without an explicit deferral reference.

## Expected Behavior

### Item 1 — ADR skill meta.json fix

When a developer runs `/adr "Some Decision"`:

1. The skill reads the existing `docs/architecture/adr/meta.json`.
2. It parses the Fumadocs navigation format: `{ "title": "ADRs", "pages": [...] }`.
3. It appends the new ADR slug (e.g., `"004-some-decision"`) to the `pages` array.
4. It writes the updated object back — preserving `title` and all existing entries.

The old array-of-objects format (`[{ number, title, status, date, file }]`) is never written.

If `meta.json` does not yet exist, the skill creates it with the correct Fumadocs format.

### Item 2 — feature-flags.tsx migration

After the migration, `feature-flags.tsx` and its supporting files follow `frontend-patterns.mdx §1.7`:

- `apps/web/src/lib/featureFlags/queryKeys.ts` exports a hierarchical key factory (`featureFlagKeys`).
- `apps/web/src/lib/featureFlags/queries.ts` exports `featureFlagQueries.list()` as a `queryOptions()` factory.
- The route's `beforeLoad` calls `ensureQueryData(featureFlagQueries.list())` after the auth guard — so the component renders with data already in cache.
- Toggle and delete actions use `useMutation` hooks (`useToggleFeatureFlag`, `useDeleteFeatureFlag`) — no direct `fetch` calls in event handlers.
- `FEATURE_FLAGS_QUERY_KEY` constant is removed; invalidation uses `featureFlagKeys`.

The page behavior (loading/error/empty/list states, toast notifications) is unchanged.

### Item 3 — Tenant interceptor deferral

The `TODO` comment inside `resolveParentOrg()` in `apps/api/src/tenant/tenant.interceptor.ts` is updated to explicitly reference Phase 3 and issue #389, making the deferral intent unambiguous.

## Breadboard

### Item 1 — ADR skill (file I/O, no UI)

| Affordance | Handler | Data |
|------------|---------|------|
| `/adr "Title"` invoked | Read `meta.json` (or init if missing) | `{ title: string, pages: string[] }` |
| New ADR file written | Derive slug from title + number | `"{NNN}-{slug}"` string |
| Append to pages | Write updated `meta.json` | Mutated pages array |

### Item 2 — Feature flags query layer

| Affordance | Handler | Data |
|------------|---------|------|
| Route `beforeLoad` | `ensureQueryData(featureFlagQueries.list())` | `FeatureFlag[]` |
| `FeatureFlagsPage` mounts | `useQuery(featureFlagQueries.list())` | `{ data, isLoading, isError }` |
| Toggle switch interaction | `useToggleFeatureFlag().mutate({ id, enabled })` | `{ id: string, enabled: boolean }` |
| Delete button click | `useDeleteFeatureFlag().mutate(id)` | `{ id: string }` |
| Mutation `onSuccess` | `queryClient.invalidateQueries({ queryKey: featureFlagKeys.list() })` | — |
| `CreateFlagDialog.onCreated` | `queryClient.invalidateQueries({ queryKey: featureFlagKeys.list() })` | — |

**API wiring:**

| Node | Endpoint | Method |
|------|----------|--------|
| N1 `featureFlagQueries.list()` | `/api/admin/feature-flags` | GET |
| N2 `useToggleFeatureFlag` | `/api/admin/feature-flags/:id` | PATCH |
| N3 `useDeleteFeatureFlag` | `/api/admin/feature-flags/:id` | DELETE |

## Slices

| # | Slice | Files | Depends on |
|---|-------|-------|-----------|
| S1 | ADR skill meta.json fix | `.claude/skills/adr/SKILL.md` (step 5 Update meta.json + List Mode section) | — |
| S2 | Feature flags query infrastructure | `apps/web/src/lib/featureFlags/queryKeys.ts`, `apps/web/src/lib/featureFlags/queries.ts` | — |
| S3 | Feature flags component migration | `apps/web/src/routes/admin/feature-flags.tsx` | S2 |
| S4 | Tenant interceptor deferral comment | `apps/api/src/tenant/tenant.interceptor.ts` | — |

S1, S2, S4 are independent. S3 depends on S2.

## Success Criteria

- [ ] Running `/adr "Title"` appends the slug (without `.mdx`) to the `pages` array in `docs/architecture/adr/meta.json`, never overwriting with the old array-of-objects format.
- [ ] Running `/adr "Title"` on a repo with 3 existing ADRs results in a `meta.json` with 4 entries in `pages`.
- [ ] SKILL.md "Update meta.json" step and "List Mode" section both document the Fumadocs `{ title, pages }` format — not the old array-of-objects format.
- [ ] `feature-flags.tsx` imports and uses `featureFlagQueries.list()` from `@/lib/featureFlags/queries` — no inline `queryKey`/`queryFn` in `useQuery`.
- [ ] The `queryFn` in `featureFlagQueries.list()` passes `signal` from the `queryFn` context to `fetch`.
- [ ] Toggle and delete actions use `useMutation` hooks — no direct `fetch` calls in event handlers; toast notifications fire in `onSuccess`/`onError`.
- [ ] Cache invalidation after toggle, delete, and `CreateFlagDialog.onCreated` uses `featureFlagKeys.list()` — no references to the old `FEATURE_FLAGS_QUERY_KEY`.
- [ ] The route `beforeLoad` is an async function that calls `enforceRoutePermission(ctx)` first, then `ctx.context.queryClient.ensureQueryData(featureFlagQueries.list())`.
- [ ] `resolveParentOrg()` TODO in `tenant.interceptor.ts` references issue #389 and Phase 3 explicitly.
