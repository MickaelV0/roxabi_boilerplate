---
title: "Legal Compliance, GDPR & Cookies"
description: Cookie consent system, legal pages, GDPR data rights, and script-gating infrastructure for French/EU compliance
---

## Context

Roxabi Boilerplate needs legal compliance before any production deployment in France/EU. This spec covers three pillars:

1. **Cookie consent** — Banner + modal with CNIL-compliant granular opt-in
2. **Legal pages** — Mentions légales, CGU, privacy policy, cookie policy (French-language templates)
3. **GDPR data rights** — Data export, portability, rectification, and Right to Object (erasure is handled by [#201 User Account Management](./201-user-account-management))

**Promoted from:** [Legal Compliance, GDPR &amp; Cookies Analysis](../analyses/204-legal-compliance-gdpr-cookies)

**Dependencies:**
- [#201 User Account Management](./201-user-account-management) — Defines account deletion with 30-day soft-delete, purge cron, auth guard, and GDPR anonymization. This spec builds on #201 without duplicating it.
- [#202 Organization Management](./202-org-management) — Org deletion and reactivation
- Existing auth system ([Spec: #19 Auth + Users](./19-auth-users))

## Goal

Ship a GDPR + CNIL compliant legal foundation: a cookie consent system with script-gating, four French-language legal pages, GDPR data export, and a footer with legal links — enabling production deployment in France/EU.

## Users &amp; Use Cases

### End Users (SaaS customers)

| Use Case | Workflow |
|----------|----------|
| Give cookie consent | First visit → banner appears → Accept All / Reject All / Customize → choice saved |
| Modify cookie consent | Click "Cookie settings" in footer → modal opens → toggle categories → save |
| Read legal pages | Click footer link → legal page renders |
| Export personal data | Navigate to `/settings/account` → Privacy &amp; Data section → click "Download my data" → JSON file downloads |
| Edit personal data | Navigate to `/settings/profile` → edit name, email, avatar (Right to Rectification, covered by #201 profile editing) |
| Exercise Right to Object | Revoke consent via "Cookie settings" or request account deletion via #201 flow |

### SaaS Operators (developers deploying Roxabi)

| Use Case | Workflow |
|----------|----------|
| Configure legal info | Edit `legal.config.ts` with company name, SIRET, address, etc. |
| Customize legal pages | Edit the template content in legal page components |
| Add analytics scripts | Use `useConsentGate('analytics')` hook to conditionally load scripts |

## Expected Behavior

### Happy path — Cookie consent (first visit)

1. User visits any page for the first time (no `consent` cookie exists)
2. Banner slides in at the bottom of the page with:
   - Text: "We use cookies to improve your experience. You can accept all, reject all, or customize your preferences."
   - Three buttons with **equal visual prominence** (CNIL requirement): **Accept All**, **Reject All**, **Customize**
3. **If Accept All:** All categories set to `true`, cookie saved, banner dismissed, DB record created if authenticated
4. **If Reject All:** All non-essential categories set to `false`, cookie saved, banner dismissed, DB record created if authenticated
5. **If Customize:** Modal opens with category toggles:
   - **Necessary** — Always on, toggle disabled, explanation text
   - **Analytics** — Toggle (default off), explanation text
   - **Marketing** — Toggle (default off), explanation text
   - "Save preferences" button
6. After any choice, scripts gated by `useConsentGate` are loaded/blocked according to the new categories

### Happy path — Cookie consent (returning visitor)

1. User visits with an existing `consent` cookie
2. System checks:
   - Is `createdAt` of the consent record older than 6 months? → Re-show banner (see step 3)
   - Is `policyVersion` outdated (differs from `legalConfig.consentPolicyVersion`)? → Re-show banner (see step 3)
   - Otherwise → Banner stays hidden, scripts loaded per saved categories
3. **Re-consent flow:** When the banner is re-shown, previous consent categories are pre-filled as defaults in the Customize modal. The user can quickly re-confirm by clicking Accept All, or adjust their preferences. This minimizes friction for re-consent.

### Happy path — Cookie consent (authenticated user, cross-device)

1. Authenticated user visits from a new device (no cookie, but DB record exists)
2. System reads DB consent record (DB is authoritative)
3. Cookie is populated from DB record, banner stays hidden
4. If DB record is expired (6 months) or policy version is outdated, re-show banner

### Happy path — Modify consent

1. User clicks "Cookie settings" link in the footer (always visible)
2. Consent modal opens with current preferences pre-loaded
3. User toggles categories and clicks "Save preferences"
4. Cookie and DB record updated, scripts re-evaluated

### Happy path — Legal pages

1. User clicks a legal page link in the footer
2. Page renders with content from the template, dynamic fields injected from `legal.config.ts`
3. Four pages available:
   - `/legal/mentions-legales` — Mentions Légales (French legal notice)
   - `/legal/cgu` — Conditions Générales d'Utilisation (Terms of Service)
   - `/legal/confidentialite` — Politique de Confidentialité (Privacy Policy)
   - `/legal/cookies` — Politique de Cookies (Cookie Policy)

### Happy path — GDPR data export

1. User navigates to `/settings/account`
2. "Privacy &amp; Data" section shows:
   - "Download my data" button
   - "Delete my account" link (navigates to #201 deletion flow)
3. User clicks "Download my data"
4. `GET /api/gdpr/export` returns a JSON file download
5. File contains all personal data structured by category (see [Technical Decisions](#gdpr-data-export-endpoint))

### Edge cases

| Scenario | Behavior |
|----------|----------|
| User has JS disabled | Banner is server-rendered. Accept/Reject buttons submit a form that sets the cookie server-side. Customize requires JS. |
| Consent cookie corrupted / invalid JSON | Treat as no consent — re-show banner |
| Authenticated user with conflicting cookie vs DB | DB record takes precedence. Cookie is overwritten with DB values on page load. |
| User logs out after giving consent | Cookie persists (anonymous consent still valid). If different user logs in, DB record for new user takes precedence. |
| policyVersion change | All users see the consent banner again on next visit, regardless of cookie age |
| 6-month re-consent due | Banner re-shown. Previous consent is preserved as default values in the modal (user can quickly re-confirm). |
| User exports data while account is pending deletion | Export still works during the 30-day grace period (account is soft-deleted, not purged) |
| Multiple export requests | No rate limit beyond the global API rate limiter. Export is a read-only operation. |
| `legal.config.ts` not customized by operator | Pages render with sample "ACME Corp" placeholder values. A console warning is logged in development mode. |

## Constraints

- **No third-party cookie library.** Headless approach with custom hook + shadcn/ui.
- **Serverless deployment.** No `@nestjs/schedule`. Use Vercel Cron Jobs for any scheduled tasks.
- **SSR compatibility.** Consent cookie must be readable server-side in TanStack Start loaders via `getCookie` from `vinxi/http`. No `window`-dependent logic at import time.
- **CNIL compliance.** Accept/Reject buttons must have equal visual prominence. No dark patterns. Non-essential scripts blocked by default.
- **French language.** Legal pages are French-only. Operators add translations if needed.
- **Better Auth schema extension.** New columns on `users` table must be nullable and compatible with Better Auth's Drizzle adapter (same pattern as `banned`, `banReason`, etc. in #201).
- **Existing deletion flow.** Account deletion mechanics are defined in [#201](./201-user-account-management). This spec only adds the "Privacy &amp; Data" UI section that links to the existing deletion flow.

## Non-goals

- Visual branding (logo, favicon, og:image) — separate issue
- Admin GDPR dashboard (viewing/managing other users' data)
- IAB TCF certification
- Backend data gating (checking consent before storing data server-side)
- Multilingual legal pages (French-only for now)
- Cookie consent for third-party embeds (YouTube, social widgets)
- Real-time consent sync via WebSockets (page reload is sufficient)

## Technical Decisions

### Cookie Consent Architecture

**Approach:** Headless — custom React hook + shadcn/ui components.

```
                    ┌─────────────────────┐
                    │   consent cookie     │
                    │   (JSON string)      │
                    └──────────┬──────────┘
                               │ read/write
                    ┌──────────┴──────────┐
                    │  useConsent() hook   │
                    │  (React context)     │
                    └──────────┬──────────┘
                        ┌──────┴──────┐
                        │             │
               ┌────────┴───┐  ┌─────┴────────┐
               │ Banner UI  │  │ ConsentGate  │
               │ + Modal UI │  │ (script gate)│
               └────────────┘  └──────────────┘
                        │
                 ┌──────┴──────┐
                 │ POST /api/  │
                 │ consent     │
                 │ (DB sync)   │
                 └─────────────┘
```

### Consent Cookie Schema

Cookie name: `consent`

```json
{
  "categories": {
    "necessary": true,
    "analytics": false,
    "marketing": false
  },
  "consentedAt": "2026-02-17T12:00:00Z",
  "policyVersion": "2026-02-v1",
  "action": "rejected"
}
```

- `categories.necessary` is always `true` (cannot be toggled off)
- `consentedAt` is the ISO timestamp of the last consent action
- `policyVersion` is a string constant in the codebase (bump to trigger re-consent)
- `action` is `"accepted"` (all), `"rejected"` (all non-essential), or `"customized"`
- `consentedAt` represents the timestamp of any consent action, including rejection (not just acceptance)
- Cookie attributes: `Path=/`, `SameSite=Lax`, `Secure` (in production), `Max-Age=15778800` (6 months), **not** `HttpOnly` (must be readable by JS)
- Cookie is **not** `HttpOnly` because the React hook reads it client-side. It contains no sensitive data.
- The `policyVersion` value must always be sourced from `legalConfig.consentPolicyVersion` — this is the single source of truth

### Consent Database Table

Schema file: `apps/api/src/database/schema/consent.schema.ts`

```typescript
import { index, jsonb, pgTable, text, timestamptz } from 'drizzle-orm/pg-core';
import { genId } from './utils';
import { timestamps } from './timestamps';
import { users } from './auth.schema';

export const consentRecords = pgTable(
  'consent_records',
  {
    id: text('id').primaryKey().$defaultFn(genId),
    userId: text('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
    categories: jsonb('categories').notNull(),
    policyVersion: text('policy_version').notNull(),
    action: text('action').notNull(), // 'accepted' | 'rejected' | 'customized'
    ipAddress: text('ip_address'),
    userAgent: text('user_agent'),
    ...timestamps,
  },
  (table) => [
    index('consent_records_user_id_created_at_idx').on(table.userId, table.createdAt),
  ],
);
```

- One row per consent action (immutable audit trail for CNIL proof-of-consent)
- Latest record per user is the current consent state: `WHERE userId = $1 ORDER BY createdAt DESC LIMIT 1`
- Uses `...timestamps` spread (project convention) — `createdAt` serves as the consent timestamp (no separate `consentedAt` column needed since rows are immutable)
- Composite index on `(userId, createdAt)` for efficient latest-record lookups
- `ip_address` and `user_agent` stored for proof-of-consent (CNIL requirement) — **excluded from GDPR export** (internal proof fields, not user-facing data)
- `ON DELETE CASCADE` ensures cleanup when user is purged via #201
- camelCase ↔ snake_case mapping handled by Drizzle ORM column definitions (e.g., `userId` in code → `user_id` in DB)

### API Endpoints

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/api/consent` | `@OptionalAuth()` | Save consent record. If authenticated, persists to DB + cookie. If anonymous, cookie only. |
| GET | `/api/consent` | Bearer | Get current consent state for authenticated user (latest DB record). |
| GET | `/api/gdpr/export` | Bearer | Download all personal data as JSON file. **Must be allowed for soft-deleted users** (add to #201 auth guard allowlist alongside `GET api/users/me` and `POST api/users/me/reactivate`). |

#### POST /api/consent

Request body:

```json
{
  "categories": { "necessary": true, "analytics": true, "marketing": false },
  "policyVersion": "2026-02-v1",
  "action": "customized"
}
```

**Auth behavior:** Endpoint uses `@OptionalAuth()` (not `@AllowAnonymous()` — the auth guard would short-circuit and never call `getSession()`). The guard calls `getSession()`, attaches `null` if unauthenticated, and the controller branches on `request.session !== null`.

**Response (authenticated):** `201 Created` with the consent record from the DB. Also sets the `consent` cookie via `reply.setCookie(...)` (requires `@Res({ passthrough: true })` and `@fastify/cookie` registered in bootstrap).

**Response (anonymous):** `204 No Content`. Only the `consent` cookie is set via the response header. No DB write.

#### GET /api/consent

Response: `200 OK` with the latest consent record for the authenticated user (`WHERE userId = $1 ORDER BY createdAt DESC LIMIT 1`). Returns `404` if no record exists — **the frontend must treat `404` as "no DB consent" (null), not as an error**. The `useConsent()` hook falls back to the cookie value in this case.

#### GDPR Data Export Endpoint

`GET /api/gdpr/export` returns a JSON file with `Content-Disposition: attachment; filename="roxabi-data-export-{date}.json"`.

Structure:

```json
{
  "exportedAt": "2026-02-17T12:00:00Z",
  "user": {
    "name": "...",
    "email": "...",
    "avatar": "...",
    "role": "...",
    "emailVerified": true,
    "createdAt": "..."
  },
  "sessions": [
    {
      "ipAddress": "...",
      "userAgent": "...",
      "createdAt": "...",
      "expiresAt": "..."
    }
  ],
  "accounts": [
    {
      "providerId": "google",
      "scope": "openid email profile",
      "createdAt": "..."
    }
  ],
  "organizations": [
    {
      "name": "...",
      "role": "...",
      "joinedAt": "..."
    }
  ],
  "invitations": [
    {
      "email": "...",
      "organizationName": "...",
      "role": "...",
      "status": "...",
      "direction": "sent|received"
    }
  ],
  "consent": [
    {
      "categories": { "necessary": true, "analytics": false, "marketing": false },
      "action": "rejected",
      "consentedAt": "...",
      "policyVersion": "..."
    }
  ]
}
```

**Excluded from export:** Hashed passwords, OAuth access/refresh/ID tokens, session tokens, verification tokens (sensitive internal data, not personal data in the user-facing sense). Also excluded: `consent_records.ip_address` and `consent_records.user_agent` (internal proof-of-consent fields, not user-facing).

**Included:** OAuth `providerId` and `scope` (reveals what the user consented to share with the provider).

**Computed fields:** `invitations.direction` is not a DB column — computed at query time: if `invitations.inviterId = userId` then `"sent"`, if `invitations.email = user.email` then `"received"`.

### useConsent() Hook

```typescript
interface ConsentState {
  categories: {
    necessary: true;
    analytics: boolean;
    marketing: boolean;
  };
  consentedAt: string | null;
  policyVersion: string | null;
  action: 'accepted' | 'rejected' | 'customized' | null;
  showBanner: boolean;
}

interface ConsentActions {
  acceptAll: () => void;
  rejectAll: () => void;
  saveCustom: (categories: ConsentState['categories']) => void;
  openSettings: () => void;
}

function useConsent(): ConsentState & ConsentActions;
```

The hook:
1. On server: reads `initialConsent` prop (from `ConsentProvider`) and computes `showBanner` — **this must happen server-side, not in a `useEffect`**, to avoid hydration mismatch and layout shift
2. On client: hydrates from `initialConsent`, then if authenticated, fetches `GET /api/consent` and reconciles (DB wins). If DB record differs from cookie, cookie is overwritten and `showBanner` is recomputed.
3. Computes `showBanner` based on: no consent, expired (6 months from `createdAt`), or outdated `policyVersion` (compared against `legalConfig.consentPolicyVersion`)
4. Provides `acceptAll`, `rejectAll`, `saveCustom` actions that update cookie + call `POST /api/consent`
5. Exposes state via React context (`ConsentProvider` wraps the app)

### useConsentGate() Hook (Script Gating)

```typescript
function useConsentGate(category: 'analytics' | 'marketing'): boolean;
```

Returns `true` if the user has consented to the given category, `false` otherwise. Use in components that load third-party scripts:

```tsx
function AnalyticsProvider({ children }: { children: React.ReactNode }) {
  const analyticsAllowed = useConsentGate('analytics');

  useEffect(() => {
    if (analyticsAllowed) {
      // Load analytics script (e.g., PostHog, GA4)
    }
  }, [analyticsAllowed]);

  return <>{children}</>;
}
```

This hook is the contract for future integrations. When analytics or marketing tools are added, they wrap their initialization in `useConsentGate`. No actual scripts are gated today — the hook ships as ready infrastructure.

### Legal Pages

#### Configuration File

`apps/web/src/config/legal.config.ts`:

```typescript
export const legalConfig = {
  /** Company name (dénomination sociale) */
  companyName: 'ACME Corp SAS',
  /** Legal form (SAS, SARL, EURL, etc.) */
  legalForm: 'SAS',
  /** Share capital (capital social) */
  shareCapital: '10 000 €',
  /** Registered address (siège social) */
  registeredAddress: '1 rue de la Paix, 75001 Paris, France',
  /** RCS registration number */
  rcsNumber: 'Paris B 123 456 789',
  /** SIRET number */
  siretNumber: '123 456 789 00001',
  /** Intra-community VAT number */
  vatNumber: 'FR 12 123456789',
  /** Publication director (directeur de publication) */
  publicationDirector: 'Jean Dupont',
  /** Contact email for GDPR rights */
  gdprContactEmail: 'privacy@example.com',
  /** Hosting provider details */
  host: {
    name: 'Vercel Inc.',
    address: '440 N Barranca Ave #4133, Covina, CA 91723, USA',
    phone: '+1 (559) 288-7060',
  },
  /** Current consent policy version — bump to trigger re-consent */
  consentPolicyVersion: '2026-02-v1',
} as const;
```

All values are placeholder samples. A JSDoc comment at the top of the file:

```typescript
/**
 * CUSTOMIZE BEFORE DEPLOYMENT
 *
 * Replace all values below with your company's actual legal information.
 * These values are used in the Mentions Légales, CGU, Privacy Policy,
 * and Cookie Policy pages. Failure to customize may result in legal
 * non-compliance under French law (LCEN).
 */
```

#### Routes

| Route | Page | Content |
|-------|------|---------|
| `/legal/mentions-legales` | Mentions Légales | Editor identity, RCS, VAT, host identity, GDPR rights notice (per LCEN) |
| `/legal/cgu` | CGU (Terms of Service) | Usage terms, intellectual property, liability, applicable law |
| `/legal/confidentialite` | Privacy Policy | Data collected, processors (Neon, Upstash, Resend, Vercel), GDPR rights, CNIL contact |
| `/legal/cookies` | Cookie Policy | Categories, purpose of each, retention, how to manage preferences |

Each page is a React component in `apps/web/src/routes/legal/`. Content is inline JSX with dynamic fields from `legalConfig`. Pages use a shared `LegalPageLayout` component with a back link and consistent typography.

### Footer Component

The app footer includes a legal links section:

```
Mentions légales · CGU · Confidentialité · Cookies · Paramètres cookies
```

- First 4 are `&lt;Link&gt;` components to the legal pages
- "Paramètres cookies" opens the consent modal (calls `openSettings()` from `useConsent`). Label is intentionally French-only (consistent with French legal pages). Future i18n would source from translation files.
- Footer renders on all pages (part of the root layout)
- The footer is a new shared component in `apps/web` (not `packages/ui` — it's app-specific with legal config dependency)

### SSR Consent Reading

In TanStack Start route loaders, consent state is available server-side:

```typescript
import { getCookie } from 'vinxi/http';

export const Route = createFileRoute('/')({
  beforeLoad: () => {
    const consentCookie = getCookie('consent');
    const consent = consentCookie ? JSON.parse(consentCookie) : null;
    // Use consent state for SSR decisions (e.g., skip analytics script tags)
  },
});
```

The `ConsentProvider` accepts initial consent state from the server to avoid hydration mismatch:

```tsx
{/* ConsentProvider accepts initialConsent from server to avoid hydration mismatch */}
<ConsentProvider initialConsent={serverConsent}>
  {children}
</ConsentProvider>
```

## Success Criteria

- [ ] Cookie consent banner appears on every page for first-time visitors
- [ ] Accept All / Reject All / Customize buttons have equal visual prominence
- [ ] Customize modal shows category toggles (necessary always on, analytics, marketing)
- [ ] Consent is saved to cookie with correct JSON schema (categories, consentedAt, policyVersion, action)
- [ ] Authenticated users' consent is persisted to `consent_records` DB table
- [ ] Cross-device: DB consent syncs to cookie on page load (DB wins)
- [ ] Banner re-shown after 6 months or when `policyVersion` changes
- [ ] "Paramètres cookies" footer link opens consent modal
- [ ] `useConsentGate('analytics')` returns correct boolean based on current consent
- [ ] Footer renders on all pages with links to 4 legal pages + cookie settings
- [ ] `/legal/mentions-legales` renders with fields from `legal.config.ts`
- [ ] `/legal/cgu` renders complete terms of service template
- [ ] `/legal/confidentialite` renders privacy policy listing all data processors
- [ ] `/legal/cookies` renders cookie policy with category descriptions
- [ ] `GET /api/gdpr/export` returns JSON file with all personal data categories
- [ ] Export includes: user profile, sessions (IPs, user-agents), OAuth providers (providerId, scope), org memberships, invitations, consent records
- [ ] Export excludes: passwords, OAuth tokens, session tokens, verification tokens
- [ ] `/settings/account` "Privacy &amp; Data" section shows export button and deletion link
- [ ] `POST /api/consent` works for both anonymous and authenticated users
- [ ] `consent_records` table stores audit trail (ip_address, user_agent, timestamp)
- [ ] No hydration mismatch — consent state is SSR-compatible via `getCookie`
- [ ] Right to Rectification: user can edit name, email, and avatar via `/settings/profile` (covered by #201 — verify integration)
- [ ] `GET /api/gdpr/export` is allowed for soft-deleted users during the 30-day grace period (#201 auth guard allowlist updated)

## Open Questions

- **Consent banner animation:** Should the banner slide up or appear instantly? Slide-up is more polished but adds complexity.
- **Consent banner z-index:** Must appear above all other content. What z-index layer should it occupy in the design system?
- **Export file size limit:** Should there be a guard against extremely large exports (users with thousands of sessions)?
- **Server-side consent for API-only requests:** Should the NestJS API check consent before processing requests (e.g., reject analytics-related API calls if consent not given)? Currently out of scope (non-goal), but worth revisiting when analytics is added.

### Closed Decisions

- **"Functional" cookie category:** Ship with 3 categories (necessary, analytics, marketing). Add a "Functional / Preferences" category later when a concrete use case arises. Adding it now would be speculative.
- **Right to Rectification:** Covered by #201 profile editing (`/settings/profile` — name, email, avatar). No separate endpoint needed for this spec. A success criterion verifies the integration.
