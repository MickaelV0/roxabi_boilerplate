---
title: "Admin Panel Phase 2: Cross-Tenant User & Organization Management"
description: Cross-tenant user management, cross-tenant organization management with hierarchy, and audit log viewer for super admins.
---

## Context

Issue [#269](https://github.com/roxabi/roxabi_boilerplate/issues/269) — Phase 2 of the Admin Panel ([#25](https://github.com/roxabi/roxabi_boilerplate/issues/25)). Depends on Phase 1 (#268, completed).

**Promoted from:** [Admin Phase 2 Analysis](../analyses/269-admin-phase2.mdx)

**Phase 1 delivered:**

- Admin layout at `/admin` with sidebar nav groups (Organization + System placeholders)
- `requireAdmin()` and `requireSuperAdmin()` route guards (SSR-safe)
- `AdminModule` with `AdminMembersController`, `AdminInvitationsController`, `AdminMembersService`
- `AuditService` with `audit_logs` table (fire-and-forget `log()` method)
- Offset-based pagination for member list (`PaginationControls` component)
- `AdminExceptionFilter` with standardized error responses
- Better Auth admin plugin restricted
- Dual `role`/`roleId` sync resolved in member management

**Phase 2 adds:** cross-tenant user CRUD, cross-tenant organization CRUD with hierarchy, and audit log viewer — all cursor-paginated and restricted to super admins.

## Goal

Enable super admins to manage all platform users and organizations from the admin panel — including ban/unban, soft-delete/restore, org hierarchy, and full audit trail visibility — with cursor-based pagination for large datasets.

## Users &amp; Use Cases

### Super Admin (global `superadmin` user role)

- **Manage users cross-tenant**: List, search, filter, edit, ban/unban, soft-delete/restore users across all organizations. View user detail with org memberships and activity summary.
- **Manage organizations cross-tenant**: List, search, create, edit, soft-delete/restore organizations. View org detail with member list and child orgs. Set parent/child hierarchy (display-only grouping, max 3 levels).
- **View audit logs**: Search and filter all admin actions with before/after diff view. Investigate who changed what, when.

## Expected Behavior

### Happy path

#### Cross-tenant user list

1. Super admin navigates to `/admin/users` (System nav group).
2. Page shows all platform users (cursor-paginated, 20 per page): name, email, global role, organizations (comma-separated names), status badge (Active / Banned / Archived), last active date.
3. **Filter bar** above the table: role dropdown (`All | User | Admin | Super Admin`), status dropdown (`All | Active | Banned | Archived`), organization dropdown (searchable, all orgs), text search (debounced 300ms, matches name/email).
4. Applying a filter resets the cursor and reloads the list. "Load more" button at bottom loads next page.
5. Super admin clicks a user row → navigates to `/admin/users/:id` (detail view).

#### User detail view

1. **Profile section**: name, email, global role (editable dropdown), status badge, avatar, created date, last active.
2. **Organization memberships section**: table of org memberships (org name, role, joined date). Each row links to `/admin/organizations/:orgId`.
3. **Activity summary section**: last 10 audit log entries involving this user — queried as `WHERE (resourceId = :userId AND resource = 'user') OR actorId = :userId`. Each row shows timestamp, action, resource. Expandable for before/after diff.
4. **Action buttons** in header:
   - "Edit" → inline edit of name, email, global role. Save → `PATCH /api/admin/users/:id`. Success toast.
   - "Ban" (if not banned) → dialog: reason (required, 5-500 chars, plain text), expiration (optional date picker — **note:** auto-unban on expiry is not implemented in Phase 2; the date is stored for future enforcement and displayed as informational). Submit → `POST /api/admin/users/:id/ban`. Status badge updates to "Banned".
   - "Unban" (if banned) → confirmation dialog → `POST /api/admin/users/:id/unban`. Status badge updates to "Active".
   - "Delete" (if not archived) → confirmation dialog with user name → `DELETE /api/admin/users/:id`. User moves to Archived status.
   - "Restore" (if archived) → confirmation dialog → `POST /api/admin/users/:id/restore`. Status badge updates to "Active".
5. All actions audit logged with before/after data.

#### Cross-tenant organization list

1. Super admin navigates to `/admin/organizations` (System nav group).
2. Default view: **flat list** (cursor-paginated, 20 per page). Columns: name, slug, member count, parent org (or "—"), status badge, created date.
3. **View toggle**: "List" (default) | "Tree" buttons. Tree view loads all non-deleted orgs and assembles a hierarchy client-side with expandable/collapsible nodes showing member counts.
4. **Filter bar**: status dropdown (`All | Active | Archived`), text search (name/slug).
5. "Create Organization" button → dialog: name (required), slug (auto-generated from name, editable), parent org (optional searchable dropdown). Submit → `POST /api/admin/organizations`. Success toast, navigate to org detail.
6. Super admin clicks an org row → navigates to `/admin/organizations/:id` (detail view).

#### Organization detail view

1. **Info section**: name, slug, parent org (link to parent detail or "None"), status badge, created date, member count.
2. **Edit form**: inline edit name, slug, parent org (searchable dropdown with "None" option). Save → `PATCH /api/admin/organizations/:id`. Success toast.
3. **Members section**: table of org members (name, email, role, joined date). Read-only — member management is done via `/admin/members` (org-scoped).
4. **Child organizations section**: list of direct children (name, slug, member count). Each links to its detail view.
5. **Action buttons**:
   - "Delete" → fetches impact preview (`GET /api/admin/organizations/:id/deletion-impact`) → shows dialog: "This will archive {org name}. {memberCount} direct members and {childMemberCount} members across {childOrgCount} child organizations will be affected. {childOrgCount} child organizations will become top-level." Confirm → `DELETE /api/admin/organizations/:id`.
   - "Restore" (if archived) → confirmation dialog → `POST /api/admin/organizations/:id/restore`.
6. All actions audit logged.

#### Tree view

1. Super admin clicks "Tree" toggle on the organizations list.
2. If org count ≤ 1000: frontend fetches all non-deleted orgs via `GET /api/admin/organizations?view=tree`, assembles tree client-side. Displays expandable/collapsible nodes with: org name, slug, member count, status. Root orgs (no parent) are top-level. Indentation shows depth.
3. If org count > 1000: tree view is disabled. The `?view=tree` endpoint returns 200 with `{ treeViewAvailable: false, reason: "Too many organizations for tree view. Use the flat list with search filters." }` — not a 400 (the request is valid; the server state prevents tree rendering).
4. Clicking an org node navigates to its detail view.

#### Audit log viewer

1. Super admin navigates to `/admin/audit-logs` (System nav group).
2. Page shows cursor-paginated audit log entries (30 per page): timestamp, actor name (or "[Deleted User]"), action (human-readable label), resource type + ID, organization name (or "—").
3. **Filter bar**: date range (from/to date pickers), actor (searchable user dropdown), action type (dropdown of action vocabulary), resource type (dropdown: `user | member | invitation | organization`), organization (searchable dropdown), text search (searches `action`, `resource`, `resourceId` fields only — not JSONB `before`/`after` which would require expensive GIN indexes).
4. Clicking a row expands it inline to show before/after diff. Changed fields highlighted. Sensitive fields redacted as `[REDACTED]` (redaction applied both backend-side in the API response and frontend-side as defense-in-depth).
5. "Load more" button at bottom. Applying filters resets cursor and reloads.

### Edge cases

| Scenario | Behavior |
|----------|----------|
| Soft-delete org with active members | Impact preview shows direct + child member counts. Confirm required |
| Soft-delete org with child orgs | Children become orphaned (top-level). Impact preview warns: "N child organizations will become top-level." No cascade delete |
| Reparent org creates depth > 3 | 400: "Maximum organization depth of 3 levels exceeded." Validates full subtree depth |
| Reparent org creates cycle | 400: "Cannot set parent to a descendant organization." Walks parent chain to detect |
| Concurrent admin edits to same entity | Last-write-wins. Both changes audit logged independently |
| Audit log for soft-deleted user | Displays "[Deleted User]" with original ID |
| Ban user who is currently logged in | Ban takes effect on next API request. Current session remains active |
| Ban expiration | Auto-unban **not** implemented. Lifted only on explicit unban |
| Restore org whose parent is deleted | Restore succeeds. UI shows warning: "Parent organization is archived" |
| Tree view with > 1000 orgs | `?view=tree` returns 200 with `treeViewAvailable: false`. UI shows message suggesting flat list with search |
| ILIKE search with special chars | Server-side escaping of `%` and `_` characters |
| Diff viewer with sensitive fields | Frontend redacts known-sensitive keys before rendering |
| Super admin edits own global role | Allowed but shows confirmation: "Changing your own role will affect your access" |
| Org slug conflict on create/edit | 409: "An organization with this slug already exists" (Conflict, consistent with existing `RoleSlugConflictException` pattern) |
| Email conflict on user edit | 409: "A user with this email already exists" |
| Ban reason too short or too long | 400: ban reason must be 5-500 characters, plain text only (no HTML/markdown) |
| Orphaned org in tree view (parent deleted) | Renders at top level with a visual indicator: "(parent archived)" badge |
| Concurrent reparent creating cycle | TOCTOU race is possible but negligible for admin-only operations. Validation reads should use `db.transaction()` for consistency |
| User not found (deleted between list and detail) | 404: "User not found." Redirect to user list with toast |

## Breadboard

### UI Affordances

| ID | Element | Location | Trigger |
|----|---------|----------|---------|
| U1 | Users list page | `/admin/users` | Nav click |
| U2 | User filter bar | Users list | Filter change / search input |
| U3 | "Load more" button | Users list bottom | Click |
| U4 | User row (clickable) | Users list table | Click → navigate to detail |
| U5 | User detail page | `/admin/users/:id` | URL navigation |
| U6 | Edit user form | User detail header | "Edit" button |
| U7 | Ban dialog | User detail | "Ban" button |
| U8 | Unban confirmation | User detail | "Unban" button |
| U9 | Delete user confirmation | User detail | "Delete" button |
| U10 | Restore user confirmation | User detail | "Restore" button |
| U11 | Organizations list page | `/admin/organizations` | Nav click |
| U12 | Org filter bar | Orgs list | Filter change / search input |
| U13 | List/Tree view toggle | Orgs list header | Click |
| U14 | Tree view | Orgs list (tree mode) | Toggle to tree |
| U15 | "Create Organization" dialog | Orgs list | Button click |
| U16 | Org row (clickable) | Orgs list table | Click → navigate to detail |
| U17 | Org detail page | `/admin/organizations/:id` | URL navigation |
| U18 | Edit org form | Org detail | Inline edit |
| U19 | Delete org dialog (with impact preview) | Org detail | "Delete" button |
| U20 | Restore org confirmation | Org detail | "Restore" button |
| U21 | Audit log list page | `/admin/audit-logs` | Nav click |
| U22 | Audit log filter bar | Audit log list | Filter change |
| U23 | Expandable log row (diff view) | Audit log table | Click row |
| U24 | "Load more" button | Audit log list bottom | Click |

### Code Affordances

| ID | Handler | Wiring | Logic |
|----|---------|--------|-------|
| N1 | `GET /api/admin/users` | U1,U2,U3 → N1 → S1,S2 | Cursor-paginated user list with filters. Join users + members for org names. ILIKE search with escaping |
| N2 | `GET /api/admin/users/:id` | U4,U5 → N2 → S1,S2,S3,S4 | User profile (S1) + memberships via S4 joined to S2 for org names (2 queries) + last 10 audit entries from S3 (query: `WHERE (resourceId = :userId AND resource = 'user') OR actorId = :userId`) |
| N3 | `PATCH /api/admin/users/:id` | U6 → N3 → S1,S3 | Update name/email/role. Read before-state, mutate, audit log |
| N4 | `POST /api/admin/users/:id/ban` | U7 → N4 → S1,S3 | Set `banned=true`, `banReason`, optional `banExpires`. Audit log |
| N5 | `POST /api/admin/users/:id/unban` | U8 → N5 → S1,S3 | Set `banned=false`, clear `banReason`/`banExpires`. Audit log |
| N6 | `DELETE /api/admin/users/:id` | U9 → N6 → S1,S3 | Set `deletedAt` + `deleteScheduledFor`. Audit log |
| N7 | `POST /api/admin/users/:id/restore` | U10 → N7 → S1,S3 | Clear `deletedAt` + `deleteScheduledFor`. Audit log |
| N8 | `GET /api/admin/organizations` | U11,U12,U13 → N8 → S2 | Cursor-paginated flat list OR full list for tree view (`?view=tree`). Join for member counts |
| N9 | `POST /api/admin/organizations` | U15 → N9 → S2,S3 | Create org. Validate parent depth (≤3), slug uniqueness. Audit log |
| N10 | `GET /api/admin/organizations/:id` | U16,U17 → N10 → S2,S4 | Org detail + members + children |
| N11 | `PATCH /api/admin/organizations/:id` | U18 → N11 → S2,S3 | Update name/slug/parent. Validate depth + cycle detection. Audit log |
| N12 | `GET /api/admin/organizations/:id/deletion-impact` | U19 → N12 → S2,S4 | Count direct members, child orgs, child members recursively |
| N13 | `DELETE /api/admin/organizations/:id` | U19 → N13 → S2,S3 | Soft-delete org. Children become orphaned. Audit log |
| N14 | `POST /api/admin/organizations/:id/restore` | U20 → N14 → S2,S3 | Clear `deletedAt` + `deleteScheduledFor`. Audit log |
| N15 | `GET /api/admin/audit-logs` | U21,U22,U24 → N15 → S3 | Cursor-paginated audit entries with filters. Join actor name |
| N16 | `cursorPaginate()` utility | N1,N8,N15 → N16 | Shared stateless helper. Builds `WHERE ts < ? OR (ts = ? AND id < ?)` clause, returns `{ data, cursor }` |

### Data Stores

| ID | Store | Type | Accessed by |
|----|-------|------|-------------|
| S1 | `users` table | Persistent (PostgreSQL) | N1, N2, N3, N4, N5, N6, N7 |
| S2 | `organizations` table (+ new `parentOrganizationId` column) | Persistent (PostgreSQL) | N1, N8, N9, N10, N11, N12, N13, N14 |
| S3 | `audit_logs` table | Persistent (PostgreSQL) | N2, N3-N7, N9, N11, N13, N14, N15 |
| S4 | `members` table | Persistent (PostgreSQL) | N1, N2, N10, N12 |

**Unknowns:**

- **TenantInterceptor behavior** when `parentOrganizationId` is populated — the interceptor at `tenant.interceptor.ts:133` does a dynamic cast `(org as Record<string, unknown>).parentOrganizationId`. If the migration adds this column and it appears in the interceptor's SELECT, tenant resolution changes globally. Must be gated (see Technical Decisions). Investigation required before N9/N11 implementation.
- **Guard chain clarification:** `@Roles('superadmin')` does NOT short-circuit subsequent checks. However, `@RequireOrg` and `@Permissions` are **opt-in metadata decorators** — they only fire when explicitly set. Since Phase 2 controllers use only `@Roles('superadmin')` (not `@RequireOrg` or `@Permissions`), the org check is never triggered. The `@SkipOrg()` decorator is added as **defensive documentation** to prevent future regressions if the guard chain is refactored.

## Slices

| Slice | Description | Affordances | Demo |
|-------|-------------|-------------|------|
| V1: Foundation | Cursor pagination utility (backend helpers + composite indexes), `useCursorPagination` frontend hook, `CursorPaginatedResponse&lt;T&gt;` type, `@SkipOrg()` decorator, `LoadMoreButton` component, DB migration (parentOrganizationId + indexes) | N16 | Unit tests pass for all cursor helpers. Schema migration applies cleanly. "Load more" button renders and functions on a test page (temporary `/admin/test-pagination` route, removed before merge) |
| V2: Users | Users list page with filters, user detail page, all user actions (edit, ban, unban, delete, restore). `AdminUsersController` + `AdminUsersService`. New exception types. Audit logging for all user actions | U1-U10, N1-N7 | Super admin can list all users, filter by role/status/org, view detail with memberships + activity, ban/unban/delete/restore a user |
| V3: Organizations | Orgs list (flat + tree), org detail, create/edit/delete (with impact preview)/restore. `AdminOrganizationsController` + `AdminOrganizationsService`. `parentOrganizationId` schema migration. Depth + cycle validation. Tree view component | U11-U20, N8-N14 | Super admin can list orgs (flat + tree), create org with parent, edit org hierarchy, delete with impact preview, restore |
| V4: Audit Logs | Audit log viewer page with filters, expandable diff view with sensitive field redaction. `AdminAuditLogsController` | U21-U24, N15 | Super admin can list audit entries, filter by date/actor/action/resource/org, expand row to see before/after diff |

**Slice dependencies:** V1 → V2 → V3 → V4 (sequential). V2 depends on V1 (cursor pagination). V3 depends on V2 (establishes controller/service patterns, filter bar component). V4 depends on V3 (reuses filter bar, all action types available for testing).

## Constraints

- **Auth foundation**: Uses existing two-tier role system (global `users.role` + org-scoped RBAC `roles` table). No new role tiers.
- **Guard strategy**: All Phase 2 endpoints use `@Roles('superadmin')` with `@SkipOrg()` to bypass active-org requirement. Direct Drizzle queries without `TenantService`.
- **TenantInterceptor**: Adding `parentOrganizationId` must NOT change tenant resolution for existing features. The interceptor must be made opt-in (only resolve to parent when `enableParentTenantResolution` is explicitly configured on the org, or interceptor logic is gated behind a flag).
- **Rate limiting**: Same tier as Phase 1: `@Throttle({ global: { ttl: 60_000, limit: 30 } })` on all Phase 2 controllers.
- **UI components**: Use existing Shadcn/UI components from `packages/ui`. New components: `LoadMoreButton`, `FilterBar`, `TreeView`, `DiffViewer`.
- **Pagination**: Cross-tenant lists use cursor-based pagination. Composite index `(createdAt DESC, id DESC)` required on `users` and `organizations` tables. `(timestamp DESC, id DESC)` on `audit_logs`.
- **Soft delete only**: No hard-delete capability. `audit_logs.actorId` FK (`ON DELETE NO ACTION`) intentionally prevents hard-delete of users.
- **Dependencies**: Phase 1 (#268) completed. No dependency on Phase 3/4 features.

## Non-goals

- **System settings** and **feature flags** — Phase 3 scope
- **User impersonation** and **health dashboard** — Phase 4 scope
- **Audit log CSV export** — follow-up issue
- **Org hierarchy cross-access inheritance** — parent/child is display-only grouping only
- **Optimistic locking / conflict resolution** — last-write-wins, compensated by audit trail
- **Session invalidation on ban** — deferred; banned user active until next request
- **Auto-unban on expiry** — deferred; expired bans require explicit unban
- **Mobile-optimized admin UX** — desktop-first with responsive layout
- **Real-time updates** — request/response only, no WebSocket push

## Technical Decisions

### Cursor-based pagination

**Decision:** Base64-encoded `(timestamp, id)` cursor with "Load more" UX.

**Backend:** Shared cursor pagination utilities in `apps/api/src/admin/utils/cursor-pagination.util.ts`:
- `decodeCursor(cursor: string): { timestamp: Date, id: string }` — decodes a Base64 cursor string.
- `encodeCursor(timestamp: Date, id: string): string` — encodes a cursor from row values.
- `buildCursorCondition(cursor: string, tsColumn, idColumn): SQL` — returns a Drizzle SQL condition (`tsColumn < cursor_ts OR (tsColumn = cursor_ts AND idColumn < cursor_id)`). Each service composes its own query and applies this condition in the WHERE clause — the utility does **not** wrap query builders (avoids Drizzle generic typing complexity).
- `buildCursorResponse<T>(rows: T[], limit: number, getTimestamp, getId): CursorPaginatedResponse<T>` — takes N+1 rows, trims to N, builds the `{ data, cursor: { next, hasMore } }` response.

**Frontend:** `useCursorPagination` hook in `apps/web/src/hooks/use-cursor-pagination.ts`. Wraps TanStack Query's `useInfiniteQuery`. Returns `{ data, loadMore, hasMore, isLoading }`. Used by all three list pages.

**Indexes:** New composite indexes in a single migration:
- `idx_users_cursor (createdAt DESC, id DESC)` on `users`
- `idx_orgs_cursor (createdAt DESC, id DESC)` on `organizations`
- `idx_audit_cursor (timestamp DESC, id DESC)` on `audit_logs`

### Guard chain: `@SkipOrg()` decorator

**Decision:** Add a `@SkipOrg()` metadata decorator at `apps/api/src/common/decorators/skip-org.decorator.ts`. Applied to all Phase 2 controllers.

**How it works:** `@RequireOrg` and `@Permissions` are opt-in metadata decorators — they only fire when explicitly set on a handler. Since Phase 2 controllers use only `@Roles('superadmin')`, no org check is triggered regardless. `@SkipOrg()` is added as **defensive documentation** — it sets metadata that the `@RequireOrg` guard respects, preventing future regressions if the guard chain is refactored to be default-on.

**Rationale:** Superadmins must access cross-tenant endpoints without selecting an active org. The frontend `requireSuperAdmin()` already bypasses org checks. Backend must match.

### TenantInterceptor: opt-in parent resolution

**Decision:** The `TenantInterceptor` must NOT automatically resolve child orgs to parent tenant boundary when `parentOrganizationId` is populated. Parent/child is display-only in Phase 2.

**Implementation:** The interceptor at `tenant.interceptor.ts:133` does a dynamic cast `(org as Record<string, unknown>).parentOrganizationId`. Once the column exists in the schema, it will be populated by Drizzle's SELECT and the interceptor will start resolving to parent — **breaking existing tenant isolation**. The fix: guard the parent-resolution branch with an explicit opt-in check. Since `organizations.metadata` is a `text` column (not `jsonb`), the opt-in mechanism should be a dedicated `boolean` column (`enableParentTenantResolution`, default `false`) rather than a parsed metadata flag. Alternatively, the interceptor's dynamic cast branch can be disabled entirely behind a feature flag or environment variable until Phase 3+ explicitly enables it. The simplest approach for Phase 2: **comment out or guard the `parentOrganizationId` branch in the interceptor** with a `TODO: re-enable in Phase 3 when parent tenant resolution is designed`.

### Org hierarchy depth validation

**Decision:** Application-layer only. No DB trigger or CHECK constraint.

**Implementation:** `AdminOrganizationsService.validateHierarchy(orgId, newParentId)` — all three checks run inside a single `db.transaction()` for consistency (prevents TOCTOU race where concurrent reparent operations could both pass validation):
1. Walk up from `newParentId` to root, counting levels. If levels + 1 (for the org being reparented) > 3 → reject.
2. Check for cycles: walk up from `newParentId` and verify `orgId` is not in the ancestor chain.
3. Check subtree depth: walk down from `orgId` to find max depth below it. If ancestor depth + subtree depth > 3 → reject.

### Org member count in list views

**Decision:** Live count via subquery, not a denormalized counter.

**Implementation:** The `GET /api/admin/organizations` list endpoint includes member count as a correlated subquery: `(SELECT COUNT(*) FROM members WHERE organizationId = organizations.id)`. This is acceptable for cursor-paginated results (only 20 rows per page). For the tree view (all orgs), the count is included in the flat list query. If performance degrades at scale, a denormalized `memberCount` column can be added as a follow-up.

### Audit log diff viewer

**Decision:** Dual-layer sensitive field redaction — backend redacts in the API response, frontend redacts as defense-in-depth.

**Redaction list:** `['password', 'passwordHash', 'token', 'secret', 'accessToken', 'refreshToken', 'idToken']`. Fields matching these keys (case-insensitive) are replaced with `[REDACTED]`.

**Backend redaction:** The `GET /api/admin/audit-logs` endpoint applies the redaction list to `before`/`after` JSONB before serialization. This prevents sensitive values from being exposed over the network. The raw data remains in the database for forensic purposes (DB access is separately controlled).

**Frontend redaction:** The diff viewer component applies the same redaction list client-side as defense-in-depth (protects against a backend bug that skips redaction).

**Write-time redaction (not implemented in Phase 2):** Ideally, `AuditService.log()` would strip sensitive keys before writing. This is deferred because retroactively changing the audit service affects all existing callers. A follow-up issue should add this.

### Schema migration

**Single migration** adding:
1. `parentOrganizationId TEXT` (nullable, self-ref FK → `organizations.id`) on `organizations` table
2. Composite index `idx_users_cursor (createdAt DESC, id DESC)` on `users`
3. Composite index `idx_orgs_cursor (createdAt DESC, id DESC)` on `organizations`
4. Composite index `idx_audit_cursor (timestamp DESC, id DESC)` on `audit_logs`

### Shared types

New file `packages/types/src/pagination.ts`:
- `CursorPaginationMeta { next: string | null; hasMore: boolean }`
- `CursorPaginatedResponse<T> { data: T[]; cursor: CursorPaginationMeta }`

Extend `packages/types/src/admin.ts`:
- `AdminUser { id, name, email, role, banned, banReason, banExpires, deletedAt, createdAt, updatedAt, organizations: { id, name, slug, role }[] }`
- `AdminOrganization { id, name, slug, parentOrganizationId, memberCount, childCount, deletedAt, createdAt, updatedAt }`
- `AdminUserDetail` (extends AdminUser with activity summary)
- `AdminOrgDetail` (extends AdminOrganization with members and children arrays)
- `UserFilters { role?, status?, organizationId?, search? }`
- `OrgFilters { status?, search?, view?: 'list' | 'tree' }`
- `AuditLogFilters { from?, to?, actorId?, action?, resource?, organizationId?, search? }`
- `DeletionImpact { memberCount, activeMembers, childOrgCount, childMemberCount }` — no `effect` string; the frontend assembles the human-readable message from the numeric fields (avoids coupling backend to UI copy and simplifies i18n)

Re-export `AuditLogEntry` from `packages/types/src/audit.ts` — do not duplicate.

### Backend file structure

```
apps/api/src/
  common/decorators/
    skip-org.decorator.ts            (new — @SkipOrg() metadata decorator)
  admin/
    admin.module.ts                    (extend — register new controllers + services)
    filters/
      admin-exception.filter.ts        (extend — register new Phase 2 exception types)
    admin-users.controller.ts          (new)
    admin-users.controller.test.ts     (new)
    admin-users.service.ts             (new)
    admin-users.service.test.ts        (new)
    admin-organizations.controller.ts  (new)
    admin-organizations.controller.test.ts (new)
    admin-organizations.service.ts     (new)
    admin-organizations.service.test.ts (new)
    admin-audit-logs.controller.ts     (new)
    admin-audit-logs.controller.test.ts (new)
    admin-audit-logs.service.ts        (new — query builder + response redaction)
    admin-audit-logs.service.test.ts   (new)
    utils/
      cursor-pagination.util.ts        (new)
      cursor-pagination.util.test.ts   (new)
    exceptions/
      user-not-found.exception.ts      (new)
      user-already-banned.exception.ts (new)
      email-conflict.exception.ts      (new)
      org-not-found.exception.ts       (new)
      org-slug-conflict.exception.ts   (new — 409 Conflict, consistent with existing patterns)
      org-depth-exceeded.exception.ts  (new)
      org-cycle-detected.exception.ts  (new)
```

### Frontend file structure

```
apps/web/src/
  routes/admin/
    users.tsx                        (new — list page)
    users.$userId.tsx                (new — detail page)
    organizations.tsx                (new — list page)
    organizations.$orgId.tsx         (new — detail page)
    audit-logs.tsx                   (new — list page)
  hooks/
    use-cursor-pagination.ts         (new)
  components/admin/
    load-more-button.tsx             (new)
    filter-bar.tsx                   (new)
    tree-view.tsx                    (new)
    diff-viewer.tsx                  (new)
    user-actions.tsx                 (new — ban/unban/delete/restore dialogs)
    org-actions.tsx                  (new — delete impact/restore dialogs)
```

## Success Criteria

- [ ] `GET /api/admin/users` returns users from all organizations, cursor-paginated. Filters by role, status, organization, and text search work correctly. Non-superadmin requests return 403.
- [ ] `GET /api/admin/users/:id` returns user profile, org memberships, and last 10 audit entries. Soft-deleted users display correctly.
- [ ] `PATCH /api/admin/users/:id` updates name, email, and global role with audit log entry (before/after snapshots).
- [ ] `POST /api/admin/users/:id/ban` sets `banned=true`, `banReason`, and optional `banExpires` with audit log. `POST .../unban` clears ban with audit log.
- [ ] `DELETE /api/admin/users/:id` soft-deletes the user. `POST .../restore` restores. Both audit logged.
- [ ] Filtering users by status "Archived" shows only soft-deleted users. Filtering orgs by status "Archived" shows only soft-deleted orgs. Both are restorable via admin panel.
- [ ] `GET /api/admin/organizations` returns all orgs cursor-paginated. `?view=tree` returns flat list for client-side tree assembly (returns 200 with `treeViewAvailable: false` if > 1000 orgs).
- [ ] `POST /api/admin/organizations` creates an org with optional `parentOrganizationId`. Setting a parent that would create depth > 3 returns 400. Duplicate slug returns 409.
- [ ] `PATCH /api/admin/organizations/:id` updates name, slug, parent. Validates depth (full subtree) and cycle detection. Audit logged.
- [ ] `GET /api/admin/organizations/:id/deletion-impact` returns `memberCount`, `activeMembers`, `childOrgCount`, `childMemberCount`. Recursive child member count is correct.
- [ ] `DELETE /api/admin/organizations/:id` soft-deletes the org. Children become orphaned (not cascade-deleted). `POST .../restore` restores. Both audit logged.
- [ ] Org tree view: collapsible nodes with correct depth indentation and member counts. Orphaned orgs (parent deleted) render at top level with "(parent archived)" badge. Tree view disabled with message when > 1000 orgs.
- [ ] `GET /api/admin/audit-logs` returns cursor-paginated audit entries with filters (date range, actor, action, resource, org, text search).
- [ ] Audit log diff viewer expands to show before/after changes. Sensitive fields (`password`, `token`, etc.) are redacted in the API response (backend) and display as `[REDACTED]` in the UI (frontend defense-in-depth).
- [ ] `PATCH /api/admin/users/:id` with a duplicate email returns 409. Ban reason shorter than 5 chars or longer than 500 chars returns 400.
- [ ] All Phase 2 endpoints use `@Roles('superadmin')` with `@SkipOrg()`. Superadmin without active org can access all endpoints.
- [ ] Adding `parentOrganizationId` column does NOT change tenant resolution for existing org-scoped features (TenantInterceptor is opt-in).
- [ ] All Phase 2 actions produce audit log entries with correct before/after data. Action vocabulary: `user.updated`, `user.banned`, `user.unbanned`, `user.deleted`, `user.restored`, `user.role_changed`, `org.created`, `org.updated`, `org.deleted`, `org.restored`, `org.parent_changed`.
- [ ] Cursor pagination is consistent across users, orgs, and audit logs (shared utility, no per-feature divergence).

## Open Questions

- **TenantInterceptor opt-in mechanism**: The exact implementation (org metadata flag vs. interceptor config vs. feature flag) should be determined during V3 implementation when the full interceptor code is reviewed. The constraint is: existing behavior must not change.
- **Ban middleware**: A fast-follow middleware that checks `banned` on every request (not just admin endpoints) would close the session gap. Determine priority after Phase 2 ships.
- **Rate limiting for bulk operations**: If a super admin needs to ban/delete many users in sequence, the 30 req/min throttle may be restrictive. Consider an admin-tier rate limit or batch endpoints in a follow-up.
- **Write-time audit redaction**: A follow-up should add sensitive field stripping in `AuditService.log()` before writing to the DB. Phase 2 redacts at read time (API response) only.
- **Ban expiry auto-enforcement**: The ban dialog includes an expiration date picker, but auto-unban is not implemented. A follow-up issue should add a middleware or cron job to honor `banExpires`. The UI should display the expiry date as informational until then.
