---
title: "Token Optimization — Scaffold Context Injection & Security-Auditor Scoping"
description: Targeted read instructions for scaffold agents (#290) and grep-based file scoping for security-auditor (#291) to reduce redundant token consumption.
---

**Promoted from:** [Token Optimization Analysis](../analyses/290-291-token-optimization-scaffold-review.mdx)
**Issues:** #290, #291 (children of #251)
**Tier:** F-full (user override)

## Context

The [token consumption investigation](../analyses/280-token-consumption.mdx) identified 307k-439k tokens per F-full pipeline run. Two optimization opportunities require only skill-file changes:

- **Hotspots 3+5** (#290): Scaffold agents redundantly read the same standards docs. 5 agents reading overlapping files waste ~16,000-22,000 tokens per scaffold.
- **Hotspots 1+2** (#291): Security-auditor scans 40-100 files per audit instead of targeting changed files + dependencies. At 18,000-48,000 input tokens, it's the most expensive single agent.

The analysis evaluated 6 shapes and selected:
- **#290 Shape C (Targeted Read Instructions)** — inject per-agent section references into Task prompts
- **#291 Shape E (Grep-Based 1-Hop Imports)** — scope security-auditor to changed files + direct imports + auth modules

## Goal

Reduce per-pipeline token consumption by ~20k-25k tokens (5-7% of baseline) through two non-interacting skill-file modifications, with zero maintenance burden and no security coverage regression.

## Users &amp; Use Cases

| User | Workflow | Impact |
|------|----------|--------|
| **Orchestrator (scaffold)** | Spawns 4-6 agents via Task in Step 5 | Adds ~40 tokens of instructions per agent prompt; agents skip discovery overhead |
| **Orchestrator (review)** | Spawns security-auditor via Task in Phase 2 | Builds scoped file list before spawning; adds ~500-1,000 tokens to prompt |
| **Scaffold agents** (FE, BE, tester, devops, architect) | Read standards docs at session start | Receive targeted section pointers; read fewer total tokens |
| **Security-auditor** | Reads files to audit for OWASP vulnerabilities | Receives scoped file list; reads 15-25 files instead of 40-100; retains ability to request scope expansion |

## Expected Behavior

### Happy path

#### #290 — Scaffold Context Injection

**Insertion point:** Add a new sub-section `### 5a. Context Injection (Tier F only)` in `scaffold/SKILL.md` between the current `## Step 5 — Implement` heading and the existing `### Tier S — Direct` sub-section. Tier S path remains unchanged below it.

1. Orchestrator reaches scaffold Step 5 (Implement), Tier F
2. For each agent to spawn, orchestrator includes domain-specific read instructions in the Task prompt. Use section header text only (no numeric prefixes) for robustness against section renumbering:
   - **frontend-dev**: "Before implementing, read `docs/standards/frontend-patterns.mdx` sections: Component Patterns, AI Quick Reference. Read `docs/standards/testing.mdx` section: Frontend Testing Patterns."
   - **backend-dev**: "Before implementing, read `docs/standards/backend-patterns.mdx` sections: Design Patterns, Error Handling, AI Quick Reference. Read `docs/standards/testing.mdx` section: Backend Testing Patterns."
   - **tester**: "Before writing tests, read `docs/standards/testing.mdx` sections: Test Structure (AAA Pattern), Coverage Guidelines, Mocking Strategies, AI-Assisted TDD Workflow."
   - **architect**: "Before reviewing architecture, read `docs/standards/frontend-patterns.mdx` section: AI Quick Reference. Read `docs/standards/backend-patterns.mdx` section: AI Quick Reference."
   - **devops**: No standards doc injection (devops reads config files, not standards docs)
3. Agents receive the instructions as part of their Task prompt
4. Agents read the specified sections instead of discovering and reading full docs
5. Net savings: ~4,800-14,800 tokens per F-full scaffold

#### #291 — Security-Auditor Scoping

**Insertion point:** Add a new step `1.5` in `review/SKILL.md` Phase 2, between the current step 1 ("Determine which agents to spawn") and step 2 ("Spawn each agent"). Renumber subsequent steps. The new step runs only for the security-auditor spawn — other agents are unaffected.

1. Orchestrator reaches review Phase 2 (Multi-Domain Review)
2. Before spawning the security-auditor, orchestrator builds a scoped file list:
   ```bash
   # Step 1: Get changed files
   CHANGED=$(git diff --name-only staging...HEAD)
   # or for PR mode:
   CHANGED=$(gh pr diff &lt;number&gt; --name-only)
   ```
3. For each changed file, orchestrator extracts import paths. The codebase uses ESM (`"type": "module"`) — `require()` is not used in application source, so only `from '...'` clauses are matched:
   ```bash
   # Step 2: Extract import paths from each changed file
   # Matches 'from "..."' on ANY line (handles multi-line imports)
   grep -ohE "from ['\"][^'\"]+['\"]" &lt;file&gt; | grep -oE "['\"][^'\"]+['\"]" | tr -d "'\""
   ```
   This pattern matches the `from '...'` clause regardless of line position, correctly capturing multi-line named imports like:
   ```ts
   import {
     SomeType,
     AnotherType,
   } from '@repo/types'   // ← matched by: from '@repo/types'
   ```
4. Orchestrator resolves imports to file paths using the alias mapping table:

   | Import Pattern | Resolution Rule |
   |---------------|----------------|
   | `./foo`, `../bar` | Resolve relative to importing file's directory, try `.ts` and `/index.ts` extensions |
   | `@repo/types` | → `packages/types/src/index.ts` (barrel file — sufficient for security audit; type definitions rarely contain vulnerabilities) |
   | `@repo/ui` | → `packages/ui/src/index.ts` |
   | `@repo/config` | → `packages/config/src/index.ts` |
   | `@repo/email` | → `packages/email/src/index.ts` |
   | `@/*` (web files only) | → `apps/web/src/` + remainder + `.ts` |
   | External packages | Skip (not local files) |

5. Orchestrator adds always-include paths: `apps/api/src/auth/**`
6. Orchestrator deduplicates and passes combined list to security-auditor prompt:
   "Audit the following files for OWASP Top 10 vulnerabilities. This is a scoped list of changed files, their direct imports, and all auth modules: {file_list}"
7. Security-auditor reads and audits only the provided files (15-25 typically)
8. Net savings: ~5,000-35,000 tokens per review

#### Security-Auditor Scope Expansion

**Insertion point:** Add to the `## Boundaries` section of `security-auditor.md`, after the existing "Read-only for source" line.

The security-auditor agent definition receives a new directive:

> "When you receive a scoped file list from the review orchestrator, focus your audit on those files first. If a finding suggests a vulnerability may exist in a file outside the provided scope (e.g., a called function in an unscoped dependency), include the additional files you need in your plan. Note in your report which files were added beyond the initial scope and why."

Note: The security-auditor runs in `permissionMode: plan`. Scope expansion requires presenting the additional reads in its plan for approval. This adds one plan-approval round-trip but ensures human oversight of scope changes.

### Edge cases

| Scenario | Behavior |
|----------|----------|
| Tier S scaffold (no agents) | Skip context injection entirely — Step 5 Tier S path is unchanged |
| Tier F-lite scaffold (2-3 agents) | Apply context injection normally; savings scale with agent count |
| No changed files in review | Review Phase 1 already handles this (early exit). Scoping logic never runs. |
| Changed file has no imports | No imports resolved; file still included in scope. Auth always-include still applies. |
| Import resolves to non-existent file | Skip silently — file may have been deleted or is a type-only import. For deleted-and-replaced files, the new file appears in the changed-files list directly. |
| `@repo/*` package not in mapping table | Skip — treated as external. New packages are rare (last: `@repo/email`). Update mapping table when new `@repo/*` packages are added. |
| Security-auditor finds vulnerability requiring deeper investigation | Agent includes additional files in its plan (plan-mode approval required). Reports which files were added beyond initial scope. |
| Standards doc section header renamed | Agent falls back to reading full file — savings negated for that agent, no correctness impact |
| Standards doc section renumbered | No impact — instructions reference header text only, not numeric prefixes |
| Scaffold + review in same pipeline | Changes don't interact — different skills, different pipeline stages |
| PR with 50+ changed files | Review SKILL.md already warns about large PRs. Scoped list grows but still smaller than unscoped scan. |
| Security-auditor spawned from scaffold (not review) | Scaffold does not run scoping logic. The auditor operates in full-scan mode as it does today. The scope-expansion directive is inert when no scoped list is provided. |
| Multi-line TypeScript imports | Handled — grep pattern matches `from '...'` on any line, not just lines starting with `import` |
| PR mode (`/review #42`) | Same scoping logic applies; `gh pr diff &lt;number&gt; --name-only` replaces `git diff` |

## Breadboard

### Code Affordances

| ID | Handler | Wiring | Logic |
|----|---------|--------|-------|
| N1 | Scaffold SKILL.md Step 5a (new) | Reads agent type → selects section references → injects into Task prompt | Per-agent-type mapping table of standards doc sections (header text only) |
| N2 | Review SKILL.md Phase 2 step 1.5 (new) | Runs git diff → greps `from` clauses → resolves aliases → adds auth paths → deduplicates | Builds scoped file list; passes to security-auditor Task prompt only |
| N3 | Security-auditor.md Boundaries (amended) | Receives scoped list → audits listed files → requests expansion via plan if needed | Directive in Boundaries section; plan-mode approval required for expansion |

### Data Stores

| ID | Store | Type | Accessed by |
|----|-------|------|-------------|
| S1 | `docs/standards/*.mdx` | Persistent (repo) | N1 (section references), scaffold agents (read) |
| S2 | Git diff output | Transient (runtime) | N2 (changed file list) |
| S3 | `apps/api/src/auth/**` | Persistent (repo) | N2 (always-include), N3 (audit) |

**Unknowns:** None — all wiring is deterministic and uses existing tools.

## Slices

| Slice | Description | Affordances | Demo |
|-------|-------------|-------------|------|
| V1 | Scaffold targeted read instructions (#290) | N1, S1 | Run `/scaffold --spec X` on a Tier F feature → verify agents receive section pointers in Task prompts → count Read tool calls vs baseline |
| V2 | Review security-auditor scoping (#291) | N2, N3, S2, S3 | Run `/review` on a PR (both branch and PR-number modes) → verify security-auditor receives scoped file list → count file reads vs baseline → confirm no coverage regression |

V1 and V2 are independent — no ordering dependency.

## Constraints

- **Skill-file changes only** — no new TypeScript code, no build changes, no runtime dependencies
- **Three files modified:** `.claude/skills/scaffold/SKILL.md`, `.claude/skills/review/SKILL.md`, `.claude/agents/security-auditor.md`
- **No new artifacts** that require ongoing synchronization
- **Security-auditor's existing tools unchanged** — retains Read, Glob, Grep, Bash, WebSearch, Task, SendMessage
- **Security-auditor's permissionMode unchanged** — stays `plan`; scope expansion goes through plan approval

## Non-goals

- Dynamic context extraction or summarization (Shape B — rejected due to output token cost)
- Static curated excerpt files (Shape A — rejected due to staleness risk)
- AST-based import resolution (too heavy for skill-file instructions)
- Pattern-based auto-detection of security files (Shape F — rejected, adds complexity without benefit)
- Modifying other review agents (architect, product-lead, tester, etc.) — only security-auditor is scoped; other agents were not identified as hotspots in the parent analysis
- Scoping changes to other review phases (Phase 1, 3, 4, 5) — only Phase 2 agent spawning is modified
- Token counting tooling or dashboards — measurement uses manual tool-call counting per parent analysis methodology

## Technical Decisions

1. **Shape C over A/B for #290:** Targeted read instructions avoid creating new artifacts (Shape A's reference files) and avoid LLM-dependent extraction quality (Shape B). Agents read source docs directly — guaranteed correctness, zero maintenance.

2. **Shape E over D/F for #291:** Grep-based 1-hop resolution balances security coverage with simplicity. Changed-files-only (Shape D) has unacceptable security gaps. Pattern-based detection (Shape F) adds complexity for the same coverage in this codebase.

3. **Scope-expansion directive in security-auditor.md only:** The directive belongs in the agent's system prompt so it applies regardless of which skill spawns the auditor. The review SKILL.md passes the scoped list; the auditor's own definition governs its behavior. Plan-mode approval ensures human oversight.

4. **Hardcoded alias mapping table:** The `@repo/*` package list is small (6 packages) and stable. A dynamic resolver would require TypeScript tooling — overkill for a skill-file change. Table updates needed only when new `@repo/*` packages are added. All `@repo/*` entries resolve to `index.ts` (barrel entry point) — sufficient for security analysis.

5. **Always-include `apps/api/src/auth/**`:** Single glob covers auth.guard.ts, decorators, email providers, and services. No separate guards directory exists.

6. **Header text only for section references (#290):** Section references use descriptive header text (e.g., "Component Patterns") without numeric prefixes (e.g., ~~"1.5 Component Patterns"~~). This prevents breakage when sections are renumbered.

7. **ESM-only import grep (#291):** The codebase uses ESM exclusively (`"type": "module"`). The grep pattern matches `from '...'` clauses only — no `require()` matching needed. This simplifies the pattern and avoids false positives from config files.

## Success Criteria

- [ ] Scaffold SKILL.md has new Step 5a with per-agent-type targeted section references (header text only, no numeric prefixes)
- [ ] Tier S scaffold path is unmodified (no context injection)
- [ ] Review SKILL.md Phase 2 has new step 1.5 that builds a scoped file list (changed + 1-hop imports + auth) before spawning security-auditor
- [ ] Review SKILL.md Phase 2 step 1.5 includes the alias mapping table resolving `@repo/*` → `packages/*/src/index.ts` and `@/*` → `apps/web/src/`
- [ ] Review SKILL.md Phase 2 step 1.5 uses `grep -ohE "from ['\"][^'\"]+['\"]"` (matches multi-line imports)
- [ ] Security-auditor.md Boundaries section includes scope-expansion directive with plan-mode acknowledgment and reporting requirement
- [ ] Other review agents (architect, product-lead, tester, frontend-dev, backend-dev, devops) are unmodified
- [ ] After 3 features: scaffold agents make fewer total Read calls than pre-change baseline (both Tier F-full and F-lite paths)
- [ ] After 3 features: security-auditor file reads decrease from 40-100 range to 15-30 range (tested in both branch mode and PR-number mode)
- [ ] After 3 features: zero security findings missed due to scoping (coverage regression = 0)
- [ ] Combined net savings &gt; 5,000 tokens per pipeline run (measured via tool-call counting by orchestrator during `/promote` or post-merge)
- [ ] Rollback triggered if net savings &lt; 5,000 tokens or any coverage regression detected

## Open Questions

None — all ambiguities were resolved during analysis and expert review. The alias mapping table, auth module paths, section references, insertion points, grep patterns, and plan-mode interaction are fully specified.
