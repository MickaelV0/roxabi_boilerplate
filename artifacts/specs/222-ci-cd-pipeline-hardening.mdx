---
title: "CI/CD Pipeline Hardening"
description: Spec for five CI/CD improvements — PR title enforcement, scope-aware CI, release-please evaluation, docs link audit, and PR template audit.
---

## Context

The Roxabi boilerplate's CI pipeline has gaps identified during the [repo comparison epic (#163)](https://github.com/MickaelV0/roxabi_boilerplate/issues/163). Local commitlint (lefthook) enforces Conventional Commits on individual commits, but squash-merge uses the PR title as the final commit message — bypassing commitlint entirely. Additionally, documentation-only changes trigger the full CI pipeline unnecessarily, internal MDX links are not validated, and the PR template has minor gaps.

**Promoted from:** [CI/CD Pipeline Hardening Analysis](../analyses/222-ci-cd-pipeline-hardening.mdx)

**Current CI infrastructure:**

- `ci.yml` — Lint, Typecheck, Test, Build, E2E (with `dorny/paths-filter` for E2E path detection)
- `deploy-preview.yml` — Manual preview deploys (web + API with Neon branch management)
- `auto-merge.yml` — Squash-merge when "reviewed" label is present
- `neon-cleanup.yml` — Deletes Neon DB branches on PR close
- `lefthook.yml` — Local hooks: commitlint (commit-msg), biome (pre-commit), lint+typecheck+test (pre-push)

## Goal

Harden the CI/CD pipeline with five targeted improvements that close enforcement gaps, reduce wasted CI minutes, validate documentation integrity, and lay groundwork for automated releases. All five tasks ship in a single PR.

1. **PR title enforcement** (XS) — validate PR titles against Conventional Commits in CI
2. **Scope-aware CI skip** (S) — skip heavy jobs for docs-only PRs
3. **Release-please evaluation** (M) — ADR researching automated releases
4. **Docs link audit** (S) — validate internal MDX/MD links in CI
5. **PR template audit** (XS) — fill gaps in the existing PR template

## Users & Use Cases

**Developers (primary):**
- Open PRs and expect fast feedback — docs-only PRs should not wait 5-10 min for irrelevant jobs
- Write PR titles that pass CI validation without guessing the format
- Trust that internal doc links work after renaming/moving files

**Reviewers:**
- See consistent, structured PR descriptions (template) regardless of who opens the PR
- Trust that merged commits follow Conventional Commits (PR title enforcement)

**Release managers (future):**
- Rely on deterministic Conventional Commits history for automated changelog generation (release-please evaluation)

## Expected Behavior

### Task 1: PR Title Enforcement

#### Happy path

1. Developer opens a PR targeting `main` or `staging`
2. The `pr-title.yml` workflow triggers on `pull_request` events (`opened`, `edited`, `synchronize`, `reopened`)
3. `amannn/action-semantic-pull-request` validates the PR title against allowed types: `feat`, `fix`, `refactor`, `docs`, `style`, `test`, `chore`, `ci`, `perf`, `build`, `revert`
4. Scopes are optional and freeform (e.g., `feat(auth):`, `fix(web):`)
5. Breaking change indicator `!` is allowed (e.g., `feat!:`)
6. If valid, the check passes. If invalid, the check fails and blocks merge (required status check)

#### Edge cases

- **Bot PRs:** `dependabot[bot]` and `renovate[bot]` are exempt via `ignoredAuthors` input
- **Empty/multi-line titles:** Fail validation
- **Title edited after opening:** `edited` event type triggers revalidation
- **Branch protection:** This workflow must be added as a required status check in GitHub branch protection settings for `main` and `staging`

### Task 2: Scope-Aware CI Skip

#### Happy path

1. Developer opens a PR that only changes files in `docs/`, `artifacts/analyses/`, `artifacts/specs/`, root `*.md`, or `.claude/**`
2. The new `detect-changes` job runs `dorny/paths-filter` with a `code` filter
3. The `code` filter returns `false` (no code files changed)
4. Jobs `lint`, `typecheck`, `test`, `build`, and `e2e` are skipped via `if: needs.detect-changes.outputs.code == 'true'`
5. The `ci-success` aggregator job still runs and reports success
6. PR is mergeable without waiting for skipped jobs

#### Edge cases

- **Push to `main`/`staging`:** Always runs full CI regardless of paths — skip filter applies only to `pull_request` events
- **`workflow_call` trigger:** Treated as "always run" (like `push`) since the calling workflow controls when it fires
- **Mixed changes (code + docs):** `code` filter returns `true`, full CI runs
- **Required status checks:** A terminal `ci-success` aggregator job (with `if: always()`) depends on all other jobs (including `docs-links`) and is the **only** required branch protection check. The aggregator must check for both `failure` and `cancelled` outcomes to prevent a cancelled run from producing a false green
- **`workflow_call` + `detect-changes` interaction:** `dorny/paths-filter` requires a base ref for comparison. For `workflow_call` events, there is no implicit base ref and the filter may produce incorrect results. Downstream jobs should bypass the filter entirely for `workflow_call` events via an explicit event-name condition (e.g., `if: github.event_name != 'pull_request' || needs.detect-changes.outputs.code == 'true'`)
- **E2E consolidation:** The existing `check-e2e-paths` job is consolidated into `detect-changes` to avoid redundant checkout+filter steps. The E2E filter output is preserved as a separate output of the same job

**Code filter paths (trigger full CI when changed):**

```yaml
code:
  - 'apps/**'
  - 'packages/**'
  - 'turbo.jsonc'
  - 'bun.lock'
  - 'biome.json'
  - 'tsconfig*.json'
  - 'lefthook.yml'
  - '.github/workflows/**'
```

### Task 3: Release-Please Evaluation (ADR)

#### Happy path

1. An ADR document exists at `docs/architecture/adr/NNN-release-please.mdx` with a clear recommendation (adopt, defer, or reject)
2. The ADR evaluates: (a) monorepo configuration complexity, (b) squash vs merge conflict with auto-merge, (c) `/promote` coexistence or replacement, (d) changelog format impact
3. If the recommendation is "adopt", the ADR includes a follow-up issue number for implementation
4. No workflow files are created — Task 3 is a research deliverable only

#### Edge cases

- **Auto-merge conflict:** Release-please Release PRs must not be squash-merged (squashing collapses commit history). The ADR must address this — e.g., label-based merge strategy selector in auto-merge workflow. Note: adding a label-based merge selector changes the semantics of the `reviewed` label workflow for all PRs, not just Release PRs — the ADR should evaluate this side effect
- **No code changes:** Task 3 produces a document only, no workflow files. Implementation (if recommended) is a separate issue
- **Dependency on Task 1:** The ADR should be written assuming Task 1 (PR title enforcement) will be merged as part of this PR. The ADR should not be merged independently ahead of Task 1

### Task 4: Docs Link Audit

#### Happy path

1. CI runs the `docs-links` job using `bun run tools/docs-link-audit.ts`
2. The custom script scans all `.mdx` and `.md` files for internal links
3. Links are resolved Fumadocs-style (extensionless links map to `.mdx`/`.md`, directories map to `index.mdx`) and checked against the filesystem (external URLs excluded via `isInternalLink()` filter)
4. If all internal links resolve, the job passes
5. If any link is broken, the job fails with a report listing broken links and their locations

#### Edge cases

- **External URLs:** Excluded via `isInternalLink()` filter to avoid flaky CI
- **Anchor links (`#section`):** Not validated initially. The script strips fragments before filesystem resolution. Enable anchor validation as a follow-up if reliable
- **Generated files:** Links to files that only exist after build (e.g., API docs) are skipped by the scan patterns
- **MDX syntax:** The custom script uses regex-based link extraction, avoiding JSX/MDX parser complications
- **Docs-only CI integration:** This job always runs (it is fast and catches broken links regardless of what changed). It is included in the `ci-success` aggregator's `needs` list

**Configuration (inline in `tools/docs-link-audit.ts`):**

- `SCAN_PATTERNS`: Glob patterns for files to scan (e.g., `docs/**/*.mdx`, `artifacts/analyses/*.mdx`, `artifacts/specs/*.mdx`)
- `SKIP_DIRS`: Directories excluded from scanning (e.g., `node_modules`, `.turbo`)
- `isInternalLink()`: Filters out external URLs (`http://`, `https://`), anchors-only (`#...`), and mailto links

### Task 5: PR Template Audit

#### Happy path

1. Update `.github/PULL_REQUEST_TEMPLATE.md` to add missing commit types and checklist items
2. Developer opens a PR manually (not via `/pr` skill)
3. GitHub auto-fills the PR body with the updated template
4. Developer fills in the sections and submits

#### Edge cases

- **`/pr` skill:** Already generates structured PR bodies — the template complements but does not conflict
- **Bot PRs:** Dependabot auto-fills with its own format — the template is additive
- **Existing PRs:** Template changes only affect newly opened PRs

**Changes to existing template:**

- Add missing type checkboxes: `style`, `perf`, `build`, `revert`
- Add checklist items: "PR title follows Conventional Commits", "No secrets committed"
- Verify alignment with `/pr` skill output

## Constraints

- All 5 tasks ship in a **single PR** targeting `staging`
- No new runtime dependencies — all changes are CI workflows, config files, and documentation
- Must not break existing CI pipeline — changes are additive or modify existing jobs with backward-compatible conditions
- **Branch protection migration (atomic):** Immediately after the PR merges, update branch protection for `main` and `staging` to: (1) add `pr-title` as a required status check, (2) switch the required check from individual CI jobs to `ci-success` only. This must be done atomically — a gap between merging and updating branch protection creates a window where docs-only PRs are blocked by skipped jobs
- The `ci-success` aggregator must check for both `failure` and `cancelled` outcomes — a cancelled upstream must not produce a green aggregator
- The `docs-links` job must be included in the `ci-success` aggregator's `needs` list

## Non-goals

- **External URL validation in CI** — internal links only for now; external URL checking is a future enhancement
- **Monorepo versioning** — even if release-please is adopted, keep single-version until per-package releases are needed
- **Implementing release-please** — Task 3 produces an ADR only; implementation is a separate issue if the ADR recommends adoption
- **Enforcing a fixed scope list** — PR title scopes remain freeform; no restriction to monorepo package names
- **Modifying deploy-preview or neon-cleanup workflows** — out of scope for this issue

## Technical Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| PR title validation tool | `amannn/action-semantic-pull-request` | Most popular, well-maintained, supports all Conventional Commits features |
| Path filter approach | Positive code filter (list code paths) | More robust than listing skip paths — new non-code dirs are automatically skipped |
| Required status check pattern | `ci-success` aggregator job | Standard pattern for conditional CI; only job that branch protection requires |
| Link checker tool | Custom Bun script (`tools/docs-link-audit.ts`) | Fumadocs-aware resolution (extensionless links to `.mdx`/`.md`, directory to `index.mdx`), zero external dependency, Bun-native |
| Link check job placement | Separate lightweight job | Keeps lint gate focused on code quality; docs-link failures are independent |
| Bot exemption mechanism | `ignoredAuthors` input | Correct mechanism for `amannn/action-semantic-pull-request` (not labels) |

## Success Criteria

- [ ] PR titles are validated in CI — PRs with non-conventional titles cannot be merged
- [ ] Bot PRs (dependabot, renovate) are exempt from title validation
- [ ] Docs-only PRs skip lint, typecheck, test, build, and e2e jobs
- [ ] Push events to `main`/`staging` always run full CI
- [ ] `ci-success` aggregator job is the only required branch protection check
- [ ] `check-e2e-paths` job is consolidated into `detect-changes`
- [ ] Internal MDX/MD links are validated in CI — broken links fail the build
- [ ] Custom link audit script excludes external URLs via `isInternalLink()` filter
- [ ] PR template includes all 11 commit types as checkboxes
- [ ] PR template checklist includes "PR title follows Conventional Commits" and "No secrets committed"
- [ ] ADR for release-please evaluates: (a) monorepo config complexity, (b) squash vs merge auto-merge conflict, (c) `/promote` coexistence/replacement, (d) changelog format impact
- [ ] ADR contains a clear recommendation (adopt, defer, or reject) with rationale
- [ ] Updated PR template sections do not conflict with `/pr` skill output format
- [ ] E2E pipeline continues to trigger correctly after `check-e2e-paths` consolidation into `detect-changes`
- [ ] `ci-success` aggregator checks for both `failure` and `cancelled` upstream outcomes
- [ ] `docs-links` job is included in the `ci-success` aggregator's `needs` list
- [ ] All existing CI jobs continue to pass (no regressions)

### Post-merge action items

- [ ] Update branch protection for `main` and `staging`: add `pr-title` as required check, switch required checks to `ci-success` only
- [ ] Verify docs-only PRs skip heavy jobs after branch protection update
- [ ] If release-please ADR recommends adoption, create a follow-up implementation issue

## Open Questions

- **Anchor validation in MDX:** The custom script currently strips `#section` fragments before resolution. Adding heading-aware anchor validation is a future enhancement — test feasibility and enable as a follow-up if reliable.
- **E2E filter consolidation output naming:** The current `check-e2e-paths` job outputs `should-run` which the `e2e` job checks. When consolidating into `detect-changes`, verify the output name and condition are preserved to avoid breaking the E2E trigger logic.
