---
title: "PostHog Analytics + Feature Flags"
parent_spec: "artifacts/specs/371-observability-stack.mdx"
parent_issue: 371
---

## Scope

Phase 3a â€” PostHog integration with consent-gated init, core events, feature flags, user identification. Breadboard IDs: U3, U4, U5, U6, U7, U9, U10.

## Success Criteria

- [ ] `PostHogProvider` dynamically imports `posthog-js` only when `useConsentGate('analytics')` returns true
- [ ] PostHog chunk not fetched when consent denied (verified via Network tab)
- [ ] PostHog not initialized when `VITE_POSTHOG_KEY` is absent
- [ ] `posthog.identify(userId, { email, orgId })` called on login success
- [ ] `posthog.reset()` called on logout
- [ ] Core events tracked: `$pageview`, `user_signed_up`, `user_logged_in`, `org_created`
- [ ] `usePostHog()` hook returns PostHog client or null
- [ ] `useFeatureFlag(key, defaultValue)` returns default when PostHog not loaded; cached value when API unreachable
- [ ] On consent revocation: `posthog.reset()`, client set to null
- [ ] SSR pages render default state; flags hydrate client-side
- [ ] CSP `connectSrc` updated with PostHog host
- [ ] `VITE_POSTHOG_KEY` and `VITE_POSTHOG_HOST` added to `.env.example`

## Reference

Full spec: [artifacts/specs/371-observability-stack.mdx](../specs/371-observability-stack.mdx)
