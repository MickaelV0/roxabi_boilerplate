---
title: "Fix CI OOM — Move Analyses/Specs Out of Docs, Restrict Shiki Languages"
description: Reduce CI build memory usage by moving internal planning documents out of the Fumadocs pipeline and limiting Shiki language grammars to those actually used.
---

## Context

**GitHub Issue:** [#234](https://github.com/MickaelV0/roxabi_boilerplate/issues/234)

CI builds periodically OOM during the Fumadocs/Vite build step. The `source.config.ts` already uses `async: true` to lazy-load MDX bodies, but this is insufficient as the doc collection grows.

Two root causes have been identified:

1. **96 of 127 MDX files (75.6%)** are analyses and specs — internal project planning documents that don't need to be served through the documentation site. They are processed through the full Fumadocs pipeline (MDX compilation, Shiki highlighting, SSR bundling) unnecessarily.
2. **Shiki loads all 200+ bundled language grammars** by default, but only ~15 are actually used in code blocks across the codebase.

## Goal

Reduce CI build memory consumption to eliminate OOM failures by:
- Moving artifacts/analyses/specs out of `docs/` to root-level directories (`artifacts/analyses/`, `artifacts/specs/`) so they are never touched by Fumadocs
- Restricting Shiki to only the languages used in the codebase

## Users & Use Cases

- **CI pipeline**: Must build the web app without OOM on standard GitHub Actions runners (7 GB RAM)
- **Developers**: Continue reading artifacts/analyses/specs as plain files in the repo (IDE, GitHub UI) — no Fumadocs serving needed
- **Claude/AI agents**: Continue referencing artifacts/analyses/specs by file path — paths change from `docs/artifacts/analyses/` → `artifacts/analyses/` and `docs/artifacts/specs/` → `artifacts/specs/`

## Expected Behavior

### Happy path

1. `bun run build` completes without OOM on a standard 7 GB runner
2. The docs site (`/docs/`) serves architecture, standards, processes, guides, getting-started, configuration, contributing, vision, hooks, and changelog — but NOT analyses or specs
3. Code blocks in the docs site render with syntax highlighting for the supported language set
4. Analyses live at `artifacts/analyses/` and specs live at `artifacts/specs/` at the repo root

### Edge cases

- **Code block with unlisted language** (e.g., `lua`, `mermaid`): Fumadocs/Shiki falls back to plain text rendering (no highlighting). Acceptable — each appears only once and only in artifacts/analyses/specs (which are outside `docs/` anyway).
- **`txt` code fences**: Shiki does not need a grammar for plain text. The 25 `txt` fences in the codebase are all in artifacts/analyses/specs (outside Fumadocs) so this is a non-issue for served docs.
- **Future new language needed**: Add it to the `langs` array in `source.config.ts`. Documented inline in the file.

## Constraints

- Must not break the existing docs site navigation for remaining pages
- Must preserve all analysis/spec content — move, don't delete
- The `apps/web/docs` symlink points to `../../docs` — moving files out of `docs/` means they are no longer reachable by Fumadocs (which is the goal)

## Non-goals

- Changing the format of artifacts/analyses/specs (they stay as `.mdx`)
- Reducing the number of artifacts/analyses/specs files
- Adding a separate documentation site for artifacts/analyses/specs
- Optimizing other aspects of the build pipeline (Vite chunking, TurboRepo caching, etc.)

## Technical Decisions

### 1. Move to root-level directories

Move `docs/artifacts/analyses/` → `artifacts/analyses/` and `docs/artifacts/specs/` → `artifacts/specs/` at the repo root. This is the cleanest solution — files are completely outside the Fumadocs pipeline with no exclusion patterns needed.

```bash
git mv docs/analyses analyses
git mv docs/specs specs
```

**Rationale**: Simpler than glob exclusion patterns. Analyses and specs are project planning artifacts (like `CLAUDE.md` and `AGENTS.md`), not user-facing documentation. Root-level placement reflects their nature.

### 2. Remove from `docs/meta.json` navigation

Remove `"analyses"` and `"specs"` entries from the root `docs/meta.json` `pages` array.

### 3. Restrict Shiki languages via `rehypeCodeOptions.langs`

Configure `defineConfig()` in `source.config.ts` to specify only used languages:

```typescript
export default defineConfig({
  mdxOptions: {
    rehypeCodeOptions: {
      langs: [
        'typescript', 'ts', 'tsx',
        'javascript', 'js',
        'bash',
        'json', 'jsonc',
        'yaml',
        'sql',
        'python',
        'markdown', 'mdx',
        'toml',
      ],
    },
  },
})
```

**Languages included** (15 entries, ~10 distinct grammars): All languages with code fences in the Fumadocs-served docs. Both `ts` and `typescript` are listed explicitly — relying on alias resolution is fragile.

**Excluded**: `txt` (no grammar needed), `lua` (1 occurrence, in analyses only), `mermaid` (1 occurrence, rendered by Mermaid plugin not Shiki).

### 4. Update all path references

Every reference to `docs/artifacts/analyses/` and `docs/artifacts/specs/` across the codebase must be updated to `artifacts/analyses/` and `artifacts/specs/`.

#### Core configuration files

| File | What changes |
|------|-------------|
| `CLAUDE.md` | Bootstrap exception clause, product-lead scope, reference table links |
| `AGENTS.md` | product-lead permissions scope |

#### Skill files

| File | What changes |
|------|-------------|
| `.claude/skills/bootstrap/SKILL.md` | Output paths, glob patterns, git add commands. Remove meta.json and index.mdx maintenance steps from Completion. |
| `.claude/skills/interview/SKILL.md` | Output paths for all three doc types. Remove meta.json auto-update step from Step 4. |
| `.claude/skills/scaffold/SKILL.md` | Spec lookup paths |
| `.claude/skills/review/SKILL.md` | Spec lookup path |

#### Agent definitions

| File | What changes |
|------|-------------|
| `.claude/agents/product-lead.md` | Ownership scope, output paths, reference materials paths |
| `.claude/agents/doc-writer.md` | File format pattern references |

#### Fumadocs-served documentation

| File | What changes |
|------|-------------|
| `docs/meta.json` | Remove `"analyses"` and `"specs"` from `pages` array |
| `docs/guides/rbac.mdx` | Fix 2 dead links to `../analyses/24-rbac` |
| `docs/guides/multi-tenant.mdx` | Fix 2 dead links to `../analyses/21-multi-tenant-rls` |
| `docs/processes/dev-process.mdx` | Update path patterns in document type table |
| `docs/contributing.mdx` | Update folder structure diagram |
| `docs/architecture/index.mdx` | Update folder structure reference |

#### Internal cross-references (within artifacts/analyses/specs)

~45 cross-references between analyses and specs (e.g., "Promoted from: ../analyses/...") must be updated. Since both `artifacts/analyses/` and `artifacts/specs/` are now siblings at root level, relative links change from `../analyses/X` to `../analyses/X` (stays the same) and from `../specs/X` to `../specs/X` (stays the same when referenced from the other directory). Links from specs to analyses using `../analyses/` remain valid since both directories are at root level.

However, any links using paths relative to `docs/` (e.g., `./artifacts/analyses/X` from a file that was in `docs/`) need updating to reflect the new location.

#### Source code

| File | What changes |
|------|-------------|
| `packages/ui/src/lib/theme.ts` | JSDoc `@see` reference to design-system spec |
| `tools/license-checker.ts` | JSDoc `@see` reference to license-checker spec |

### 5. Delete Fumadocs navigation artifacts

The `meta.json` and `index.mdx` files in artifacts/analyses/specs were Fumadocs navigation artifacts. After the move:

- **Delete `artifacts/analyses/meta.json`** and **`artifacts/specs/meta.json`** — Fumadocs-specific, no other consumers
- **Delete `artifacts/analyses/index.mdx`** and **`artifacts/specs/index.mdx`** — not worth maintaining outside Fumadocs

## Implementation Plan

| Step | Action | Files |
|------|--------|-------|
| 1 | Move directories | `git mv docs/analyses analyses && git mv docs/specs specs` |
| 2 | Configure Shiki | `apps/web/source.config.ts` — add `rehypeCodeOptions.langs` |
| 3 | Update Fumadocs nav | `docs/meta.json` — remove `"analyses"` and `"specs"` |
| 4 | Update core config | `CLAUDE.md`, `AGENTS.md` |
| 5 | Update skills | `bootstrap/SKILL.md`, `interview/SKILL.md`, `scaffold/SKILL.md`, `review/SKILL.md` |
| 6 | Update agents | `product-lead.md`, `doc-writer.md` |
| 7 | Fix served docs | `docs/guides/rbac.mdx`, `docs/guides/multi-tenant.mdx`, `docs/processes/dev-process.mdx`, `docs/contributing.mdx`, `docs/architecture/index.mdx` |
| 8 | Fix internal cross-refs | All `../analyses/` and `../specs/` links within moved files |
| 9 | Fix source code refs | `packages/ui/src/lib/theme.ts`, `tools/license-checker.ts` |
| 10 | Delete nav artifacts | Delete `artifacts/analyses/meta.json`, `artifacts/analyses/index.mdx`, `artifacts/specs/meta.json`, `artifacts/specs/index.mdx` |

## Verification

1. **Local build test**: Run `bun run build` locally and confirm it completes successfully
2. **Docs navigation**: Verify the docs site sidebar no longer shows "Analyses" or "Specifications" sections
3. **Code highlighting**: Spot-check a few docs pages with code blocks to confirm syntax highlighting works
4. **Dead links**: Confirm no links to `/docs/artifacts/analyses/` or `/docs/artifacts/specs/` remain in served pages
5. **File accessibility**: Confirm `artifacts/analyses/` and `artifacts/specs/` are browsable at repo root on GitHub

## Success Criteria

- [ ] `bun run build` completes without OOM on GitHub Actions `ubuntu-latest` (7 GB)
- [ ] Docs site serves all remaining pages correctly with no broken navigation
- [ ] Code blocks render with syntax highlighting for the supported languages
- [ ] `artifacts/analyses/` and `artifacts/specs/` exist at repo root with all content preserved
- [ ] All path references updated across CLAUDE.md, AGENTS.md, skills, agents, and served docs
- [ ] All internal cross-references within artifacts/analyses/specs are valid
- [ ] Bootstrap and interview skills use new paths and no longer maintain meta.json or index.mdx
- [ ] No dead links in Fumadocs-served documentation
- [ ] `artifacts/analyses/meta.json`, `artifacts/analyses/index.mdx`, `artifacts/specs/meta.json`, `artifacts/specs/index.mdx` are deleted
