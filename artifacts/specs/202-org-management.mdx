---
title: "Organization Management (Edit & Delete)"
description: Enhanced organization settings with soft-deletion, confirmation UX, and reactivation — builds on shared patterns from #201
---

## Context

Organization settings (`/org/settings`) and member management (`/org/members`) pages **already exist**. This spec enhances them with:
- Soft-delete for organizations (30-day grace period, matching the user deletion pattern)
- Destructive action confirmation UX (type org name to confirm)
- Organization reactivation during the grace period

The **soft-delete pattern, GDPR anonymization, and purge cron** are defined in [#201 User Account Management](./201-user-account-management). This spec references and extends those shared patterns for the organization domain.

**Promoted from:** [User Account &amp; Organization Management Analysis](../analyses/201-202-account-org-management)

**Dependencies:**
- [#201 User Account Management](./201-user-account-management) — shared soft-delete pattern, purge cron endpoint, `whereActive()` helper
- Existing org settings page ([Spec: #68 Auth UI/UX](./68-auth-ui-ux))
- Existing RBAC system ([Spec: #24 RBAC](./24-rbac))

## Goal

Allow organization owners to delete their organization with a safe, reversible 30-day grace period. Enhance the existing org settings page with the deletion flow and reactivation capability.

## Users &amp; Use Cases

**Primary user:** Organization owner managing their organization.

| Use Case | Workflow |
|----------|----------|
| Delete organization | Owner navigates to `/org/settings`, clicks delete, confirms by typing org name |
| Reactivate organization | Owner navigates to soft-deleted org during grace period, clicks reactivate |
| View deletion status | Members of a soft-deleted org see "scheduled for deletion" message |

## Expected Behavior

### Happy path — Organization deletion

1. Owner navigates to `/org/settings`
2. "Danger Zone" section at bottom shows "Delete organization" button
3. Owner clicks "Delete organization"
4. **Impact summary modal:** Shows count of members, pending invitations, custom roles that will be affected
5. **Confirmation dialog:** `AlertDialog` with warning, impact summary, and text input
6. Owner types the organization name (case-insensitive match) &rarr; "Delete" button enables
7. System executes:
   - Set `deletedAt` + `deleteScheduledFor` (now + 30 days) on the organization
   - Clear `activeOrganizationId` on all sessions referencing this org
   - Invalidate pending invitations (set `status = 'expired'` to preserve audit trail)
8. Redirect to dashboard with toast: "Organization '{name}' scheduled for deletion on {date}."

### Happy path — Organization reactivation

1. Owner (with active account) navigates to the org (e.g., from dashboard or direct URL)
2. Org settings page detects `deletedAt IS NOT NULL`
3. Instead of normal settings, shows a **reactivation banner**:
   - "This organization is scheduled for deletion on {date}."
   - "Reactivate" button (only shown to users who were owners before deletion)
4. Owner clicks "Reactivate" (ownership determined by querying `members` table — role = 'owner' — since member rows are preserved during soft-delete)
5. System clears `deletedAt` and `deleteScheduledFor` on the organization
6. Frontend forces session refresh (re-fetches org data from Better Auth to clear cached deleted state)
7. Org is restored — members regain access, settings page shows normally

### Happy path — Member view of soft-deleted org

1. Non-owner member attempts to access a soft-deleted org
2. System shows read-only message: "This organization has been scheduled for deletion by an owner. It will be permanently removed on {date}."
3. No actions available — member cannot edit settings or manage members
4. If the org is reactivated, member regains normal access

### Edge cases

| Scenario | Behavior |
|----------|----------|
| Non-owner clicks delete | Button not visible (permission-gated: only `organizations:delete` permission) |
| All owners delete their accounts during grace period | Org cannot be reactivated — purged after 30 days |
| New org created with same slug during grace period | Blocked during grace period — soft-deleted org's slug still holds the unique constraint. Users must choose a different slug until the org is purged or reactivated. |
| Slug collision during purge | Purge job uses UUID in the replacement slug — collision is statistically impossible |
| Pending invitations during soft-delete | Immediately invalidated. Recipients clicking the link see "Organization no longer available." |
| Owner reactivates org, then immediately deletes again | Normal flow — new `deletedAt` and `deleteScheduledFor` are set |
| Org deleted as part of user account deletion (#201) | Same soft-delete pattern applies. Org owner can still reactivate independently if their account is reactivated first. |

## Constraints

- **Shared pattern dependency:** Soft-delete columns, purge cron, and `whereActive()` helper are implemented as part of #201. This spec assumes they exist.
- **Permission-gated:** Only users with `organizations:delete` permission (typically owners) can initiate or reactivate.
- **No notification system:** Member notification on org deletion is a follow-up task. For now, members see the status when navigating to the org.
- **Better Auth org operations:** Org CRUD goes through `api/auth/*`. The soft-delete may need to be implemented as a custom endpoint since Better Auth's `deleteOrganization` does a hard delete.

## Non-goals

- Member notification system (email or in-app) for org deletion events
- Organization data export before deletion
- Organization transfer to another owner (only individual ownership transfer per #201 deletion flow)
- Archival (read-only org state) — soft-delete is full deactivation
- Sub-organization handling (not yet implemented)

## Technical Decisions

### Schema Migration

Add to `organizations` table (if not already added by #201 migration):

```sql
ALTER TABLE organizations
  ADD COLUMN deleted_at TIMESTAMPTZ,
  ADD COLUMN delete_scheduled_for TIMESTAMPTZ;

CREATE INDEX organizations_deleted_at_idx ON organizations (deleted_at) WHERE deleted_at IS NOT NULL;
CREATE INDEX organizations_delete_scheduled_for_idx ON organizations (delete_scheduled_for) WHERE delete_scheduled_for IS NOT NULL;
```

### API Endpoints

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `api/organizations/:id` | Bearer + org member | Get org details (includes `deletedAt`, `deleteScheduledFor` for reactivation page) |
| DELETE | `api/organizations/:id` | Bearer + `organizations:delete` | Initiate org soft-deletion |
| POST | `api/organizations/:id/reactivate` | Bearer + `organizations:delete` | Reactivate soft-deleted org |
| GET | `api/organizations/:id/deletion-impact` | Bearer + `organizations:delete` | Impact summary: `{ memberCount, invitationCount, customRoleCount }` |

**Note:** These are NestJS endpoints, not Better Auth routes. Better Auth's built-in `deleteOrganization` does a hard delete — we need custom endpoints for soft-delete. The `GET` endpoint enforces `id == session.activeOrganizationId` to prevent cross-org access.

### GDPR Anonymization (Organization)

Executed by the shared purge cron (defined in #201):

| Table | Action |
|-------|--------|
| `organizations` | UPDATE: `name` &rarr; `'Deleted Organization'`, `slug` &rarr; `'deleted-{uuid}'`, `logo` &rarr; null, `metadata` &rarr; null |
| `members` | DELETE all membership records for this org |
| `invitations` | DELETE all invitations for this org |
| `roles` | DELETE tenant-scoped custom roles (cascade handles `role_permissions`) |

### Session Cleanup on Org Deletion

When an org is soft-deleted:
1. Query all sessions where `activeOrganizationId = orgId`
2. Set `activeOrganizationId = NULL` on those sessions
3. Users with those sessions will be redirected to org selection on next request

### Org Access Guard

Extend `TenantInterceptor.resolveParentOrg()` to also return `deletedAt` (avoids a second DB query):
1. After resolving the active organization from the session
2. Check `organizations.deletedAt` for the active org
3. If `deletedAt IS NOT NULL`:
   - Allow: `POST api/organizations/:id/reactivate`, `GET api/organizations/:id` (for reactivation page)
   - Deny all other org-scoped operations with `{ errorCode: 'ORG_SCHEDULED_FOR_DELETION', deleteScheduledFor }`
4. Frontend renders the reactivation banner when receiving this error code

### Frontend Changes

**`/org/settings` page enhancements:**

1. **Danger Zone section** (bottom of page):
   - "Delete organization" button (only visible with `organizations:delete` permission)
   - Styled with red border, warning icon

2. **Deletion modal** (multi-step):
   - Step 1: Impact summary (member count, invitation count, custom roles count)
   - Step 2: Confirmation input (type org name)
   - "Delete" button disabled until name matches

3. **Reactivation state** (when `deletedAt` is set):
   - Replace normal settings content with reactivation banner
   - Show deletion date, reactivation button (owners only)
   - Non-owners see read-only "scheduled for deletion" message

### Confirmation Component

Reusable `DestructiveConfirmDialog` component (shared with #201):

```tsx
interface DestructiveConfirmDialogProps {
  title: string;
  description: string;
  impactSummary?: React.ReactNode;
  confirmText: string; // text user must type
  confirmLabel?: string; // e.g., "Type the organization name to confirm"
  onConfirm: () => void;
  onCancel: () => void;
  isLoading?: boolean;
}
```

- `AlertDialog` from `@repo/ui`
- Red destructive button variant
- Case-insensitive comparison for `confirmText`
- Disabled state until input matches

## Success Criteria

- [ ] Org owner can initiate soft-deletion from `/org/settings`
- [ ] Impact summary shows member count, invitations, roles before confirmation
- [ ] Confirmation requires typing the org name (case-insensitive)
- [ ] Soft-deleted org sets `deletedAt` and `deleteScheduledFor` (30 days)
- [ ] `activeOrganizationId` cleared on all sessions referencing the org
- [ ] Soft-deleted org is inaccessible for normal operations
- [ ] Owner sees reactivation banner during grace period
- [ ] Non-owner members see "scheduled for deletion" read-only message
- [ ] Reactivation clears `deletedAt` and restores full access
- [ ] Purge cron anonymizes org data after grace period (shared with #201)
- [ ] Pending invitations are invalidated on org soft-delete
- [ ] `DestructiveConfirmDialog` component is reusable (shared with #201 account deletion)

## Open Questions

- **Member notification:** Should members receive an email when their org is deleted? Deferred to follow-up task — requires notification infrastructure.
- **Org listing for soft-deleted orgs:** Soft-deleted orgs are hidden from the org switcher but accessible via direct URL during the grace period. Owners see the reactivation banner; non-owners see the read-only deletion notice.
- **Better Auth `deleteOrganization` bypass:** Need to verify that calling our custom soft-delete endpoint doesn't conflict with Better Auth's internal org state. May need to disable Better Auth's built-in delete route.
