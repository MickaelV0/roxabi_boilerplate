---
title: "Enhance review + 1b1 with root cause analysis, recommendations & confidence-based auto-apply"
description: Enrich review findings with root cause analysis, confidence scoring, and auto-apply for high-confidence fixes
---

## Context

The `/review` skill produces Conventional Comment findings but each is a surface-level observation — reviewers say *what* is wrong without explaining *why* or *how* to fix it. The `/1b1` walkthrough presents thin findings, forcing users to investigate root causes themselves. Meanwhile, many findings are straightforward fixes that don't need human judgment but still go through manual 1b1.

**Promoted from:** [Analysis: Enhance review + 1b1](../analyses/305-review-1b1-enhancements.mdx)

**Issue:** #305 (sub-issue of #251)
**Tier:** F-lite

## Goal

Enrich every review finding with root cause analysis, concrete recommendations, and a confidence score. Use confidence to gate automation: high-confidence findings are auto-applied by fixer agents, low-confidence findings go through an enriched 1b1 walkthrough with multiple solution options.

## Users &amp; Use Cases

**Primary user:** Developer running `/review` on a branch or PR.

**Use case 1 — Routine PR review:** Developer runs `/review`. 8 findings are produced. 5 have confidence &ge;80% (typo, missing null check, naming convention, unused import, simple error handling). These are auto-applied. The developer sees a summary of what was fixed. The remaining 3 findings (architectural concern, unclear performance impact, design trade-off) go through enriched 1b1 with root cause, solutions, and recommendation.

**Use case 2 — Complex PR review:** Developer runs `/review` on a large feature PR. Most findings have confidence &lt;80% because the code involves new patterns. All findings go through enriched 1b1. The developer benefits from root cause analysis and solution options even though nothing is auto-applied.

**Use case 3 — Auto-apply failure:** A high-confidence finding fails to auto-apply (fixer breaks a test). The finding is demoted to 1b1 with a note explaining the failure. The developer decides manually.

## Expected Behavior

### Happy path

1. Developer runs `/review` (or `/review #42`)
2. Phase 2 spawns domain review agents with enriched prompt — each finding now includes: Conventional Comment + root cause + 2-3 solutions + recommended solution + confidence score (see [Enriched Finding Format](#enriched-finding-format) below)
3. Phase 3 merges findings, deduplicates, groups by category (unchanged), and sorts by confidence within groups
4. Phase 3.5 posts all findings to PR as a comment (existing behavior, unchanged — all findings included regardless of confidence)
5. **Phase 3.6 (new):** Findings with confidence &ge;80% **and** category in [`issue`, `suggestion`, `todo`] are batched and passed to fixer agent(s). Fixer applies fixes serially (one finding at a time, halt on failure). Results are shown in a post-apply summary (see [Post-Apply Summary Format](#post-apply-summary-format) below)
6. Phase 4 presents remaining findings (confidence &lt;80% + non-actionable + failed auto-applies) via enriched 1b1. Each item shows: point, root cause, 2-3 solutions, recommended solution with rationale (see [Enriched 1b1 Brief Format](#enriched-1b1-brief-format) below)
7. User decides per item: Fix now, Reject, Skip, Defer. On "Fix now", a follow-up `AskUserQuestion` asks which solution to apply (recommended is pre-selected)
8. Accepted findings go to fixer agents with the chosen solution specified (existing Phase 4 flow)

### Enriched finding format

The canonical output format that review agents must produce for each finding:

```
<label>: <description>
  <file_path>:<line_number>
  -- <reviewer_agent>
  Root cause: <why this issue exists -- not just what it is>
  Solutions:
    1. <primary recommendation> (recommended)
    2. <alternative approach>
    3. <alternative approach> [optional]
  Confidence: <0-100>%
```

Confidence reflects both **diagnostic certainty** (is the finding correct?) and **fix certainty** (is the recommended fix correct?). Both must be high for a high score.

Example:

```
issue(blocking): This sql.raw() call with user input is a SQL injection vector.
  apps/api/src/users/users.service.ts:42
  -- security-auditor
  Root cause: The raw SQL call was introduced during the Knex-to-Drizzle migration
    without converting to parameterized queries.
  Solutions:
    1. Replace sql.raw(input) with sql.param(input) using Drizzle's parameterized API (recommended)
    2. Use prepared statements with explicit parameter binding
    3. Add input validation + escaping as a defense-in-depth layer
  Confidence: 92%
```

If any enrichment field (root cause, solutions, confidence) is missing from an agent's output, default confidence to 0% and route to 1b1.

### Post-apply summary format

Displayed after Phase 3.6 auto-apply completes, before 1b1 begins:

```
-- Auto-Applied Fixes (confidence >= 80%) --

Applied N finding(s) automatically:
  1. [applied] issue(blocking): SQL injection in users.service.ts:42 (92%)
  2. [applied] suggestion(blocking): Missing null check in auth.guard.ts:18 (88%)
  3. [failed -> 1b1] nitpick: Unused import in dashboard.tsx:3 (85%) -- test failure after fix

Remaining M finding(s) (confidence <80% or non-actionable) will be presented one-by-one.
```

### Enriched 1b1 brief format

For findings with confidence &lt;80% (or demoted from auto-apply), the 1b1 walkthrough presents:

```
-- Item {N}/{total}: {title or summary} --

<label> -- estimated confidence: <X>% -- <reviewer>
  <file_path>:<line_number>

Root cause: <why this issue exists>

Solutions:
  1. <primary recommendation> (recommended)
  2. <alternative approach>
  3. <alternative approach>

Recommended: Solution 1 -- <rationale for why this is the best option>
```

On "Fix now", a secondary `AskUserQuestion` asks which solution to apply:
- **Solution 1 (recommended):** &lt;brief description&gt;
- **Solution 2:** &lt;brief description&gt;
- **Solution 3:** &lt;brief description&gt; (if present)

The chosen solution is passed to the fixer agent as the specific fix instruction.

### Edge cases

| Scenario | Behavior |
|----------|----------|
| Zero findings (clean PR) | Phase 3.6 is skipped. 1b1 is skipped. Clean review verdict posted to PR. Existing behavior preserved. |
| All findings have confidence &ge;80% | All auto-applied. Post-apply summary shown. 1b1 is skipped (no items). |
| All findings have confidence &lt;80% | Phase 3.6 is skipped (no auto-apply). All go through enriched 1b1. |
| Auto-apply breaks tests | Fixer reverts via `git checkout -- &lt;files&gt;` for the specific finding's changes. Finding demoted to 1b1 queue with note: "Auto-apply attempted but failed: {reason}." |
| Auto-apply causes lint error | Same as test failure — fixer reverts specific changes, demote to 1b1. |
| Fixer agent times out or crashes | Finding demoted to 1b1 with note: "Auto-apply failed: fixer agent did not respond." No partial changes left — fixer must revert before erroring. |
| Fixer reports "cannot auto-fix" | Finding demoted to 1b1 with the fixer's explanation. Same flow as failed auto-apply. |
| Praise finding | Exempt from auto-apply (not actionable). Reported in summary as today. No confidence-based routing. |
| `thought:` or `question:` finding | Exempt from auto-apply. Always goes to 1b1 regardless of confidence. |
| Confidence exactly 80% | Treated as &ge;80% (inclusive threshold). |
| Review agent outputs confidence without root cause | Invalid format — default confidence to 0% (force to 1b1). |
| Fixer agent ignores recommendation | Fixer prompt uses recommendation as primary guidance. If unsuitable, reports "cannot auto-fix" — demoted to 1b1. |
| Phase 3.6 auto-apply modifies files that 1b1 findings also target | Phase 4 fixer re-reads files before applying (existing fixer behavior per Fix Workflow step 1). Stale findings are reported, not silently applied. |
| PR comment for auto-applied findings | All findings appear in the Phase 3.5 PR comment regardless of confidence. Auto-applied findings are marked with `[auto-applied]` in the PR comment. |

## Breadboard

### Code Affordances

Since this feature modifies skill prompts (not application UI or data stores), the breadboard maps skill files to their enrichment responsibilities.

| ID | Handler | Wiring | Logic |
|----|---------|--------|-------|
| N1 | Review agent prompt (Phase 2) | `.claude/skills/review/SKILL.md` &rarr; domain agents | Each agent outputs enriched findings: Conventional Comment + root cause + solutions + confidence |
| N2 | Confidence gate (Phase 3.6) | N1 &rarr; `.claude/skills/review/SKILL.md` | Split findings: &ge;80% actionable &rarr; fixer batch, &lt;80% + non-actionable &rarr; 1b1 queue |
| N3 | Post-apply summary | N2 &rarr; `.claude/skills/review/SKILL.md` | Display grouped summary of auto-applied fixes before 1b1 starts |
| N4 | Enriched 1b1 brief | N2 &rarr; `.claude/skills/1b1/SKILL.md` | Present each low-confidence finding with: point, root cause, solutions, recommendation. Follow-up question for solution choice. |
| N5 | Fixer format awareness | N2 &rarr; `.claude/agents/fixer.md` | Accept enriched finding with chosen solution, use it as primary fix guidance |
| N6 | Fixer result signal | N5 &rarr; N2 | On failure: revert changes + return demotion signal with reason. Finding re-queued for 1b1. |

### Data Flow

```
Domain agents (N1) produce enriched findings
  -> Phase 3 merge (existing) groups + deduplicates
  -> Phase 3.5 post to PR (existing, all findings, auto-applied marked)
  -> Phase 3.6 confidence gate (N2) splits into:
     |-- High confidence (>=80%, actionable) -> fixer agents (N5, serial)
     |     |-- Success -> post-apply summary (N3)
     |     |-- Failure (N6) -> revert + demote to 1b1 queue
     |-- Low confidence (<80%) + non-actionable -> enriched 1b1 (N4)
           -> user picks solution -> fixer (N5, existing Phase 4 flow)
```

## Slices

| Slice | Description | Affordances | Demo |
|-------|-------------|-------------|------|
| V1 | **Review enrichment** — Modify Phase 2 agent prompt to output enriched findings (root cause, solutions, confidence). Update Phase 3 merge to handle new format. Phase 3.5 PR comment includes all fields. | N1 | Run `/review` on a test branch. Findings now show root cause + solutions + confidence in the report and PR comment. No auto-apply yet — all go to 1b1 (existing format). |
| V2 | **Auto-apply gate** — Add Phase 3.6 confidence gate. High-confidence actionable findings go to fixer (serial). Post-apply summary displayed. Safety Rule 3 updated. Fixer prompt updated for recommendation-guided fixes. | N2, N3, N5, N6 | Run `/review`. High-confidence findings are auto-applied. Summary shown. Low-confidence findings still go to 1b1 (existing format). |
| V3 | **Enriched 1b1** — Update 1b1 brief template to show root cause, solutions list, and recommended solution. Add solution-choice follow-up question. Fixer receives chosen solution. | N4 | Run `/review` end-to-end. High-confidence auto-applied, low-confidence presented with full enriched context + solution picker in 1b1. |

## Constraints

- **Prompt-only changes:** All modifications are to `.claude/skills/` and `.claude/agents/` markdown files. No application code changes.
- **3 files:** `.claude/skills/review/SKILL.md`, `.claude/skills/1b1/SKILL.md`, `.claude/agents/fixer.md`.
- **Backward compatible:** The enriched finding format is a superset of the current Conventional Comment format. The 1b1 brief template is modified to accommodate new fields, but the decision loop (Fix/Reject/Skip/Defer) is preserved.
- **Threshold is hardcoded:** 80% confidence threshold is not configurable. Can be changed in a future iteration.
- **Serial auto-apply:** High-confidence findings are applied one at a time (not batched). If one fails, remaining high-confidence findings are demoted to 1b1 rather than risking cascading failures.

## Non-goals

- **Confidence calibration/tracking:** No mechanism to track predicted vs actual confidence over time. Deferred to future work.
- **Configurable threshold per project:** The 80% threshold is hardcoded. Per-project configuration via CLAUDE.md is out of scope.
- **Enriched PR comment format:** PR comments keep the current compact Conventional Comment format with an `[auto-applied]` marker. Full root cause and solutions are only shown in the local 1b1 flow.
- **Fixer agent core workflow changes:** The fixer agent's fix-validate-report cycle is unchanged. Only the input format is updated to include the recommendation/chosen solution field.
- **Auto-apply disable flag:** No per-project toggle to disable auto-apply entirely. If needed, the threshold can be set to 101% manually in the skill file as a workaround.

## Technical Decisions

1. **Shape A selected:** Enrich at review agent level. Review agents already have full context (diff, files, spec) to generate root causes and recommendations. No new pipeline stages or agents needed. See [analysis](../analyses/305-review-1b1-enhancements.mdx) for shape comparison.

2. **80% threshold rationale:** Sits at the lower bound of the "high confidence" band (70-89%), requiring both high diagnostic certainty and high fix certainty. Conservative starting point — auto-apply only triggers when the agent is genuinely confident in both the diagnosis and the fix.

3. **Confidence orthogonal to severity:** A blocking finding can have low confidence (goes to 1b1). A nitpick can have high confidence (auto-applied). Severity determines merge-blocking; confidence determines automation routing.

4. **Safety Rule 3 update (authoritative text):** The current "human decides on every finding" invariant is relaxed for high-confidence findings. Updated rule: "Human decides on every finding with estimated confidence &lt;80%. Findings with confidence &ge;80% and actionable categories (`issue`, `suggestion`, `todo`) are auto-applied by fixer agents, with results shown in a post-apply summary. The human can review auto-applied changes via git diff at any time."

5. **Auto-apply failure recovery:** If a fixer agent fails to apply a high-confidence fix (test failure, lint error, timeout), the finding is demoted to the 1b1 queue with a failure note. The fixer reverts its changes via `git checkout -- &lt;affected files&gt;`. No silent regressions.

6. **Phase numbering:** The new confidence gate is Phase 3.6 (after existing Phase 3.5 which posts PR comments). This preserves all existing phase numbers.

7. **Serial auto-apply:** High-confidence findings are applied one at a time to avoid cascading failures. If one fix fails, remaining unapplied findings are demoted to 1b1.

8. **Solution choice handoff:** When a user picks "Fix now" in 1b1, a secondary `AskUserQuestion` presents the 2-3 solutions. The chosen solution text is passed to the fixer agent as the specific fix instruction, replacing the generic "fix this finding" prompt.

## Success Criteria

- [ ] Review agents output enriched findings matching the [canonical format](#enriched-finding-format): root cause + 2-3 solutions + confidence (0-100%) for every finding
- [ ] Findings with confidence &ge;80% **and** category in [`issue`, `suggestion`, `todo`] are auto-applied by fixer agents without user interaction
- [ ] User sees a post-apply summary (matching [summary format](#post-apply-summary-format)) before 1b1 begins
- [ ] Findings with confidence &lt;80% enter 1b1 flow with enriched context matching the [enriched brief format](#enriched-1b1-brief-format)
- [ ] 1b1 items show: point, root cause, 2-3 solutions, recommended solution with rationale
- [ ] 1b1 "Fix now" triggers a solution-choice follow-up question; chosen solution is passed to fixer
- [ ] Failed auto-applies (test failure, lint error, timeout) are demoted to 1b1 with failure explanation
- [ ] Fixer reverts its changes on failure before demotion
- [ ] Praise, thought, and question findings are exempt from auto-apply
- [ ] Safety Rule 3 in `review/SKILL.md` is updated to the [authoritative text](#technical-decisions) (Decision 4)
- [ ] Phase 3.5 PR comment includes all findings; auto-applied findings marked with `[auto-applied]`
- [ ] Blocker findings with confidence &lt;80% still surface to human in 1b1
- [ ] All existing 1b1 decision options preserved: Fix now, Reject, Skip, Defer
- [ ] PR comment grouped format and verdict logic unchanged
- [ ] Fresh agent requirement preserved (review agents are new instances)
- [ ] Fixer agent uses recommendation/chosen solution field to guide fixes

## Open Questions

- **User anchoring on confidence numbers:** Users may treat agent confidence as ground truth. The 1b1 brief uses "estimated confidence" framing (see brief format above). Monitor user feedback after launch.
- **Confidence inflation over time:** If agents systematically over-report confidence, the 80% threshold may become too permissive. Deferred to calibration iteration — manual threshold adjustment available as workaround.
