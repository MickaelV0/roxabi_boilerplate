---
title: "Review sign-up/sign-in flow end-to-end"
description: Production-readiness fixes for the auth flow — branded email templates, redirect-back-after-login, verification resend UX, and route guards.
---

## Context

Issues #19 (Auth + Users) and #68 (Auth UI/UX) delivered a comprehensive authentication system. Both are **implemented**. Issue #200 is the end-to-end review that closes 5 remaining gaps before the auth flow is production-ready.

**Promoted from:** [#200 Auth Flow Review Analysis](../analyses/200-auth-flow-review)

**Related:**
- [Spec: #19 Auth + Users](./19-auth-users) — backend implementation
- [Spec: #68 Auth UI/UX](./68-auth-ui-ux) — frontend implementation

## Goal

Close the remaining production-readiness gaps in the auth flow:
1. Replace bare inline HTML email templates with branded, responsive, i18n-ready emails
2. Preserve the user's intended destination across login redirects
3. Allow verification email resend without an active session
4. Surface the invisible auto-resend on "email not verified" login failures
5. Add missing route guards on reset-password pages

## Users &amp; Use Cases

| User | Scenario | Gap Addressed |
|------|----------|---------------|
| New user | Receives a branded verification email in their preferred locale after registration | Gap 1 |
| French-speaking user | Receives emails in French instead of hardcoded English | Gap 1 |
| User clicking a deep link | Clicks `/org/settings` while logged out, logs in, and lands on `/org/settings` (not `/dashboard`) | Gap 2 |
| User with expired verification link | Visits `/verify-email` with expired token, can resend without logging in first | Gap 3 |
| User with unverified email | Tries to log in, sees a clear message that a verification email was sent + resend button | Gap 4 |
| Authenticated user visiting reset-password | Gets redirected to `/dashboard` instead of seeing a confusing reset form | Gap 5 |

## Expected Behavior

### Happy path

#### Email templates (Gap 1)

1. User registers → frontend passes browser locale (from `navigator.language`) as part of signup request
2. Backend stores locale on `users.locale` column (via post-signup update in `databaseHooks.user.create.after`)
3. Backend calls `sendVerificationEmail` callback in `auth.instance.ts`
4. Callback reads `user.locale` from the user object (default `'en'`)
5. Callback imports `renderVerificationEmail(url, locale)` from `@repo/email`
6. React Email renders branded HTML (logo, CTA button, expiry notice) + plain text
7. `emailProvider.send({ to, subject, html, text })` delivers via Resend
8. User receives a responsive, branded email in their language
9. Same flow for password reset emails (which also receive the `user` object)
10. **Magic link emails:** The `sendMagicLink` callback receives `{ email, url }` (no `user` object). Implementation performs a DB lookup by email to retrieve `user.locale` before rendering the template.

#### Redirect-back-after-login (Gap 2)

1. Unauthenticated user navigates to `/org/settings`
2. `requireAuth` guard captures the path: redirects to `/login?redirect=/org/settings`
3. Login page reads `redirect` from search params via `validateSearch`
4. User logs in successfully
5. Login page validates the redirect value (`startsWith('/') && !startsWith('//')`) and navigates to `/org/settings`
6. If no `redirect` param, navigates to `/dashboard` (existing behavior)

#### Redirect-back with OAuth (Gap 2)

**Primary approach (sessionStorage):**
1. User arrives at `/login?redirect=/org/settings`
2. User clicks "Sign in with Google"
3. Login page stores `redirect` value in `sessionStorage.setItem('auth_redirect', '/org/settings')`
4. `authClient.signIn.social({ provider: 'google' })` — OAuth round-trip happens
5. After OAuth callback, login page reads `sessionStorage.getItem('auth_redirect')`, validates, navigates to `/org/settings`, then clears the storage key

**Enhancement (best-effort):** Also pass `redirect` in `callbackURL` query param as a secondary mechanism. If `sessionStorage` is unavailable (e.g., incognito mode restrictions), the `callbackURL` param serves as fallback.

#### Resend verification without session (Gap 3)

1. User clicks an expired verification link → `/verify-email?token=expired`
2. Token verification fails → error state shown
3. User has no active session → email input form appears (instead of session-based resend button)
4. User enters their email and clicks "Resend verification"
5. Frontend calls `authClient.sendVerificationEmail({ email, callbackURL })`
6. Success message: "If an account with this email exists and is not yet verified, a verification email has been sent"
7. 60-second cooldown starts on the resend button

#### Login 403 resend banner (Gap 4)

1. User enters email/password on login page
2. Better Auth returns 403 (email not verified) — also auto-sends a verification email (`sendOnSignIn: true`)
3. Login page sets `emailNotVerified` state to `true` and stores the email
4. Login page shows a `div`-based warning banner:
   - "Your email is not verified. A new verification email has been sent. Check your inbox."
   - "Resend verification email" button with 60-second cooldown
5. User clicks "Resend" after cooldown → calls `authClient.sendVerificationEmail`
6. Toast: "Verification email sent"
7. If user edits their email/password and retries login → `emailNotVerified` state is cleared on new submission

#### requireGuest guards (Gap 5)

1. Authenticated user navigates to `/reset-password`
2. `requireGuest` guard detects active session → redirects to `/dashboard`
3. Same behavior for `/reset-password/confirm`

### Edge cases

| Scenario | Behavior |
|----------|----------|
| `redirect` param is an absolute URL (e.g., `https://evil.com`) | Rejected — falls back to `/dashboard` |
| `redirect` param is `//evil.com` (protocol-relative) | Rejected — `!startsWith('//')` check blocks it |
| `redirect` param is empty string | Falls back to `/dashboard` |
| User locale not in supported set (`en`, `fr`) | Falls back to `'en'` for email rendering |
| Frontend `navigator.language` not available (SSR, older browser) | Locale defaults to `'en'` |
| OAuth signup (no registration form) | Locale defaults to `'en'` — user can change in settings later |
| Sessionless resend on verify-email for non-existent email | Silent success — same neutral message shown (no account existence leak) |
| Sessionless resend for already-verified email | Silent success — Better Auth does not re-send |
| Multiple rapid resend clicks (verify-email or login) | 60-second frontend cooldown prevents spam; Better Auth server-side throttle (5 req/60s) as backstop |
| Authenticated user with stale cookie visits `/reset-password` | Redirected to `/dashboard` by `requireGuest`. "Change password" in settings is the correct path (tracked as follow-up) |
| Authenticated user clicks password reset email link | Redirected away from `/reset-password/confirm` by `requireGuest`, losing the reset token. Acceptable: the user is already authenticated and should use settings to change password. Edge case is rare (requires requesting reset while logged out, then the session being restored before clicking the link). |
| OAuth callback loses `redirect` param | Falls back to `sessionStorage` value, then `/dashboard` — degraded but safe |
| `sessionStorage` unavailable (incognito restrictions) | Falls back to `callbackURL` query param, then `/dashboard` |
| `redirect` param contains URL-encoded path traversal (e.g., `/%2F/evil.com`) | Caught by `new URL()` hostname validation in `safeRedirect` — falls back to `/dashboard` |
| User retries login after seeing 403 banner | `emailNotVerified` state cleared on new form submission — fresh error handling |
| `sendMagicLink` called for non-existent email | DB lookup returns null → locale falls back to `'en'` |
| Cooldown timer reset on page refresh | Accepted: frontend cooldown is UX guidance only. Better Auth server-side throttle (5 req/60s) is the hard limit. |
| User navigates from `/login?redirect=/org/settings` to "Create account" | Register page preserves `redirect` param in "Already have an account?" link back to login |
| SSR renders protected route server-side | `requireAuth` SSR short-circuit returns early (no-op) — redirect handled client-side on hydration |
| Email rendering fails (React Email error) | Catch and fall back to the existing bare inline HTML; log error. Email delivery must not fail silently. |
| Resend verification from login when already verified | `sendVerificationEmail` silently no-ops; no user-visible error |

## Constraints

- **Better Auth client SDK**: All auth operations go through `authClient` from `better-auth/react`. No direct API calls.
- **Paraglide JS**: All frontend user-facing strings use `m.*` messages. Email templates use their own translation objects (Paraglide is build-time frontend-only).
- **@repo/ui patterns**: Any new shared components follow shadcn/ui conventions (CVA, `cn()`, `data-slot`).
- **TanStack Start**: Routes use `createFileRoute`. SSR-compatible (no `window` access at module level).
- **Monorepo build order**: `packages/email` must have `tsup` build config and be declared as a TurboRepo dependency of `apps/api`.
- **Database migration**: The `locale` column addition requires `bun run db:generate && bun run db:migrate`.
- **Single PR**: All 5 gaps ship together in one PR from a worktree branch. Rationale: the email template work (Gap 1) includes the locale column migration which all other email-sending paths benefit from; the frontend gaps (2-5) are small and cohesive; splitting into multiple PRs would add review overhead for ~21 files that all touch the auth flow.

## Non-goals

- Two-factor authentication (2FA/TOTP)
- Captcha/bot protection
- Passkeys (WebAuthn)
- SSO (SAML/OIDC enterprise)
- Rate limiting on auth endpoints (deferred to #53)
- "Change password" settings page (follow-up issue)
- `useCooldown` shared hook extraction (acknowledged duplication, defer to follow-up)
- Email deliverability configuration (SPF, DKIM, Resend domain verification — infrastructure concern, not code)
- Confirm-password field on register page
- React Email dev server in TurboRepo `dev` pipeline (opt-in only via `cd packages/email && bun run dev:email`)

## Technical Decisions

### 1. React Email for email templates

**Decision:** New `packages/email` package with `@react-email/components`.

**Package structure:**
```
packages/email/
  package.json          # @repo/email, tsup build, ^build dependency
  tsup.config.ts        # Build configuration
  src/
    index.ts            # Public API: renderVerificationEmail, renderResetEmail, renderMagicLinkEmail
    translations/
      en.ts             # English translations for all templates
      fr.ts             # French translations for all templates
      index.ts          # Locale resolver
    templates/
      verification.tsx  # Email verification template
      reset-password.tsx # Password reset template
      magic-link.tsx    # Magic link sign-in template
    components/
      layout.tsx        # Shared branded layout (logo, footer, colors)
  tests/
    verification.test.ts   # Snapshot tests (HTML + plain text, both locales)
    reset-password.test.ts
    magic-link.test.ts
```

**Dependencies (in `packages/email/package.json`):**
- `@react-email/components` — dependency
- `react`, `react-dom` — direct dependencies (not peer — the API server does not provide React)
- `react-email` — devDependency (preview server only)

**Build config (`tsup.config.ts`):** Follow `packages/ui` pattern but:
- Do **NOT** include `banner: { js: '"use client";' }` — this package runs server-side
- Mark `react` and `react-dom` as `external` to avoid duplicate bundling
- Add `vitest.config.ts` using `@repo/vitest-config` node preset and `"test": "vitest run"` script

**Render API:**
```typescript
// packages/email/src/index.ts
export function renderVerificationEmail(url: string, locale: string): { html: string; text: string; subject: string }
export function renderResetEmail(url: string, locale: string): { html: string; text: string; subject: string }
export function renderMagicLinkEmail(url: string, locale: string): { html: string; text: string; subject: string }
```

Each function returns `{ html, text, subject }` — the subject is also localized. The caller in `auth.instance.ts` destructures and passes to `emailProvider.send()`.

**Fallback:** If React Email rendering throws, catch the error, log it, and fall back to the existing bare inline HTML. Email delivery must not break due to template errors.

### 2. User locale column

**Decision:** Add `locale` column to the `users` table.

**Drizzle definition in `auth.schema.ts`:**
```typescript
locale: text('locale').notNull().default('en')
```

**Population:** The `databaseHooks.user.create.after` callback receives only the `user` object — it does **not** have access to request headers. Therefore, `Accept-Language` detection cannot happen in the hook.

**Chosen approach:** Pass the locale from the frontend registration form:
1. The frontend reads `navigator.language` (e.g., `'fr-FR'`) and extracts the base language code (`'fr'`)
2. The frontend sends `locale` as an additional field in the signup request (Better Auth's `signUp.email()` accepts additional fields if declared in the schema)
3. The `databaseHooks.user.create.after` hook already performs `db.update(users)` for avatar defaults — it will also set `locale` from the user record (which Better Auth persists from the signup payload)
4. For OAuth signups (no form control), default to `'en'` — the user can change locale in settings later (follow-up feature)

**Usage:** Email callbacks (`sendVerificationEmail`, `sendResetPassword`) receive the `user` object and read `user.locale`. The `sendMagicLink` callback receives `{ email, url }` without a `user` object — it must perform a `db.select().from(users).where(eq(users.email, email))` lookup to retrieve the locale. Falls back to `'en'` if the lookup returns null.

**Direct Drizzle update:** The `locale` column is written via `db.update(users)` (same pattern as avatar defaults), not through a Better Auth user-update API. This avoids any issues with Better Auth stripping unknown columns.

### 3. Redirect-back via `?redirect=` query param

**Decision:** Standard query parameter pattern with open-redirect protection.

**Validation function (hardened against URL-encoded path traversal):**
```typescript
function safeRedirect(value: string | undefined): string {
  if (!value) return '/dashboard'
  if (!value.startsWith('/') || value.startsWith('//')) return '/dashboard'
  try {
    const url = new URL(value, 'http://localhost')
    if (url.hostname !== 'localhost') return '/dashboard'
  } catch {
    return '/dashboard'
  }
  return value
}
```
The `new URL()` parsing catches encoded variants like `/%2F/evil.com` that would bypass simple string checks.

**OAuth propagation:** Use `sessionStorage` as the primary mechanism:
1. Before initiating OAuth, store `sessionStorage.setItem('auth_redirect', redirectValue)`
2. After OAuth callback, read and clear the storage key
3. Also pass `redirect` in `callbackURL` query param as a best-effort secondary mechanism
4. If both are unavailable, fall back to `/dashboard`

### 4. Warning banner for login 403

**Decision:** `div`-based warning banner with embedded resend button.

Not using `FormMessage` (which renders as `&lt;p>`) because placing a `&lt;Button>` inside `&lt;p>` is invalid HTML. Instead, a `&lt;div>` with `role="alert"` and warning styling.

### 5. Cooldown pattern

**Decision:** Duplicate the existing 60-second cooldown pattern from `reset-password.tsx`. The pattern is now used in 3+ places. Extracting a `useCooldown` hook is deferred to a follow-up issue to keep this PR focused.

## Implementation Phases

### Phase 1: Email templates (`packages/email` + backend integration)

| Task | Files | Details |
|------|-------|---------|
| Create `packages/email` scaffold | `package.json`, `tsup.config.ts`, `vitest.config.ts`, `src/index.ts` | Set up new monorepo package with TurboRepo build dependency. No `"use client"` banner. React as external in tsup. |
| Create shared layout component | `src/components/layout.tsx` | Roxabi logo, brand colors, responsive container, footer |
| Create translation files | `src/translations/en.ts`, `fr.ts`, `index.ts` | Subject lines + body text for all 3 email types, both locales |
| Create verification email template | `src/templates/verification.tsx` | Branded CTA button, expiry notice, i18n |
| Create password reset email template | `src/templates/reset-password.tsx` | Branded CTA button, expiry notice, i18n |
| Create magic link email template | `src/templates/magic-link.tsx` | Branded CTA button, i18n |
| Add snapshot tests | `tests/*.test.ts` | HTML + plain text output for both locales, all 3 templates |
| Add `locale` column | `apps/api/src/database/schema/auth.schema.ts` | `locale: text('locale').notNull().default('en')` |
| Generate + apply migration | `apps/api/drizzle/` | `bun run db:generate && bun run db:migrate` |
| Declare `locale` in Better Auth schema | `apps/api/src/auth/auth.instance.ts` | Add `locale` as additional user field so `signUp.email()` accepts it from frontend |
| Integrate email templates | `apps/api/src/auth/auth.instance.ts` | Replace inline HTML with `@repo/email` render calls, pass `user.locale`, add fallback |
| Add magic link locale lookup | `apps/api/src/auth/auth.instance.ts` | DB lookup by email in `sendMagicLink` callback to retrieve `user.locale` |
| Add `@repo/email` dep to API | `apps/api/package.json` | `"@repo/email": "workspace:*"` |
| Verify migration is backwards-compatible | — | Confirm `DEFAULT 'en'` covers all existing rows |

### Phase 2: Redirect-back-after-login

| Task | Files | Details |
|------|-------|---------|
| Update `requireAuth` guard | `apps/web/src/lib/route-guards.ts` | Capture `pathname + searchStr` as `redirect` search param |
| Add `redirect` to login search schema | `apps/web/src/routes/login.tsx` | `validateSearch` with `redirect?: string` |
| Use `redirect` after login | `apps/web/src/routes/login.tsx` | `safeRedirect()` validation, navigate to redirect or `/dashboard` |
| Store redirect before OAuth | `apps/web/src/routes/login.tsx` | `sessionStorage.setItem('auth_redirect', redirect)` before `signIn.social()`, also pass in `callbackURL` as secondary |
| Read redirect after OAuth | `apps/web/src/routes/login.tsx` | Read `sessionStorage` on mount, clear after use |
| Pass locale on register | `apps/web/src/routes/register.tsx` | Send `navigator.language` base code as `locale` field in `signUp.email()` |
| Propagate in register link | `apps/web/src/routes/register.tsx` | Forward `redirect` to `/login` link via `search` prop |
| Propagate in magic-link-sent | `apps/web/src/routes/magic-link-sent.tsx` | Forward `redirect` to "Back to login" link |
| Add i18n keys | `messages/en.json`, `messages/fr.json` | No new keys needed (existing messages suffice) |

### Phase 3: Resend verification without session

| Task | Files | Details |
|------|-------|---------|
| Add email input fallback | `apps/web/src/routes/verify-email.tsx` | Show email form when `sessionEmail` is null |
| Add 60s cooldown | `apps/web/src/routes/verify-email.tsx` | Same pattern as `reset-password.tsx` |
| Security-neutral message | `apps/web/src/routes/verify-email.tsx` | "If an account exists and is not yet verified..." |
| Add i18n keys | `messages/en.json`, `messages/fr.json` | `auth_verify_email_resend_neutral`, `auth_verify_email_enter_email` |

### Phase 4: Login 403 resend banner

| Task | Files | Details |
|------|-------|---------|
| Add `emailNotVerified` state | `apps/web/src/routes/login.tsx` | Track 403 response, store email for resend |
| Add warning banner | `apps/web/src/routes/login.tsx` | `div`-based `role="alert"` with resend button |
| Add 60s cooldown | `apps/web/src/routes/login.tsx` | Same pattern as other cooldowns |
| Add i18n keys | `messages/en.json`, `messages/fr.json` | `auth_login_email_not_verified_sent`, `auth_resend_in` |

### Phase 5: requireGuest guards

| Task | Files | Details |
|------|-------|---------|
| Add guard to reset-password | `apps/web/src/routes/reset-password.tsx` | `beforeLoad: requireGuest` |
| Add guard to reset-password/confirm | `apps/web/src/routes/reset-password/confirm.tsx` | `beforeLoad: requireGuest` |

### Phase 6: Tests and validation

| Task | Files | Details |
|------|-------|---------|
| Unit test `safeRedirect` | `apps/web/src/lib/route-guards.test.ts` | Absolute URLs, `//`, encoded paths, empty string, valid relative paths |
| Update login page tests | `apps/web/src/routes/login.test.ts` | 403 banner rendering, resend button, `emailNotVerified` state clearing |
| Update verify-email tests | `apps/web/src/routes/verify-email.test.ts` | Sessionless resend form, cooldown, neutral message |
| Run `bun run i18n:validate` | — | Confirm EN and FR message files are in sync after new key additions |
| Run full quality check | — | `bun run lint && bun run typecheck && bun run test` |

**Note:** Phases 2-5 have no mutual dependencies and can be developed in parallel by multiple agents once Phase 1 is committed. Phase 6 runs after all phases are complete.

## Success Criteria

- [ ] All three email templates (verification, reset, magic link) render branded responsive HTML with CTA button, logo, footer
- [ ] Each email template renders correctly in both EN and FR locales
- [ ] Each email template includes a plain text version
- [ ] `locale` column exists on `users` table with default `'en'`
- [ ] User's locale is detected from `Accept-Language` at signup and persisted
- [ ] Email templates have snapshot tests for HTML and plain text output (both locales)
- [ ] If React Email rendering throws, the system falls back to inline HTML and logs the error
- [ ] Navigating to a protected route while logged out redirects to `/login?redirect=/original-path`
- [ ] After login, user is redirected to the original path (not always `/dashboard`)
- [ ] `redirect` param is validated: only relative paths allowed, `//` prefix rejected
- [ ] OAuth login preserves and uses the `redirect` param (or gracefully falls back to `/dashboard`)
- [ ] `/verify-email` error state shows email input + resend button when no session is active
- [ ] Resend on `/verify-email` has 60-second cooldown and shows security-neutral success message
- [ ] Login page shows a warning banner with resend button when login fails with 403 (email not verified)
- [ ] Login 403 resend has 60-second cooldown
- [ ] `/reset-password` redirects authenticated users to `/dashboard`
- [ ] `/reset-password/confirm` redirects authenticated users to `/dashboard`
- [ ] Email rendered in `'en'` when user locale is not in `['en', 'fr']`
- [ ] Magic link emails retrieve locale via DB lookup by email
- [ ] `safeRedirect` rejects encoded path traversal (`/%2F/evil.com`)
- [ ] `emailNotVerified` banner clears on new login attempt
- [ ] `bun run lint && bun run typecheck && bun run test` passes
- [ ] `bun run i18n:validate` shows zero missing keys
- [ ] Existing auth E2E tests (`bun run test:e2e`) pass without modification

## Open Questions

1. **Email template visual testing:** Should we add Litmus/Email on Acid testing for Gmail, Apple Mail, and Outlook rendering? Currently out of scope — snapshot tests verify HTML output, but visual rendering across clients is not tested. Can be added as a follow-up.

2. **`@repo/types` User type update:** If the `locale` field needs to be exposed to the frontend (e.g., for a locale settings page), `packages/types` may need updating. For this issue, `locale` is server-side only (email rendering). Defer `@repo/types` update to the settings page follow-up.

3. **Email template preview workflow:** The React Email dev server (`email dev`) runs independently. Consider whether a TurboRepo script alias (`bun run email:dev`) is worth adding for DX.

## Resolved Questions (from analysis)

- **~~OAuth callbackURL param preservation~~** → Resolved: Use `sessionStorage` as primary mechanism, `callbackURL` as best-effort secondary. See Technical Decision §3.
- **~~Accept-Language availability in Better Auth hooks~~** → Resolved: Hooks do NOT receive request context. Locale is passed from the frontend registration form via `signUp.email()` additional fields. See Technical Decision §2.
