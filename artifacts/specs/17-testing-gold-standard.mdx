---
title: "Upgrade Testing Infrastructure to Gold Standard"
description: Extract dedicated config packages, add multi-browser E2E with sharding, and enable coverage auto-ratchet
---

## Context

The testing infrastructure was established in issue #9 using Option C (Balanced Approach). It delivers per-package Vitest configs extending `@repo/config/vitest`, a root Playwright config with Chromium-only, TurboRepo caching for test tasks, and coverage PR comments.

Issue #17 upgrades to Option B (Gold Standard) proactively. The project is maturing and this upgrade positions the infrastructure for multi-developer collaboration, growing E2E coverage, and cross-browser validation.

**Promoted from:** [Issue #17: Upgrade Testing Infrastructure to Gold Standard](../analyses/17-testing-gold-standard.mdx)

**Depends on:** #9 (completed)

## Goal

Upgrade the testing infrastructure from Option C (Balanced) to Option B (Gold Standard) by extracting dedicated config packages, adding multi-browser E2E testing with CI sharding, and enabling coverage auto-ratchet — all in a single PR.

## Users & Use Cases

**Developers** writing and running tests locally:
- Import shared Vitest presets from `@repo/vitest-config` instead of `@repo/config/vitest`
- Run E2E tests locally with `--project=chromium` for fast feedback, or run the full browser matrix
- See coverage thresholds ratchet up automatically as coverage improves

**CI pipeline** validating PRs and merges:
- PRs run Chromium-only E2E (fast feedback, unchanged from today)
- staging/main pushes run full 4-browser E2E matrix with 2-shard parallelism
- Coverage auto-update prevents regression while the 80% floor prevents over-ratcheting

## Expected Behavior

### Happy path

1. **Create `packages/vitest-config/`** with `package.json`, `tsconfig.json`, `base.ts`, `react.ts`, `node.ts`
   - `base.ts`: shared settings (`passWithNoTests: false`, `watch: false`, reporters, testTimeout). Coverage config stays in root `vitest.config.ts` only — shared presets export test environment settings, not coverage.
   - `react.ts`: extends base with `environment: 'jsdom'`, CSS disabled, include patterns for `.test.{ts,tsx}`
   - `node.ts`: extends base with `environment: 'node'`, include patterns for `.test.ts`
   - `package.json`: `"name": "@repo/vitest-config"`, `"private": true`, exports map for each preset
   - `tsconfig.json`: extends `@repo/config/tsconfig.base`
   - Add empty `typecheck` and `lint` scripts (or `"typecheck": "tsc --noEmit"`) so TurboRepo pipeline does not warn about missing tasks

2. **Create `packages/playwright-config/`** with `package.json`, `tsconfig.json`, `base.ts`
   - `base.ts`: shared settings (fullyParallel, retries, reporter selection, 4 browser projects, webServer, trace/screenshot config)
   - `package.json`: `"name": "@repo/playwright-config"`, `"private": true`, exports map
   - `tsconfig.json`: extends `@repo/config/tsconfig.base`
   - Add empty `typecheck` and `lint` scripts so TurboRepo pipeline does not warn

3. **Migrate import paths** (all-at-once, single PR — 4 consumers):
   - `apps/web/vitest.config.ts`: `@repo/config/vitest` → `@repo/vitest-config`
   - `apps/api/vitest.config.ts`: `@repo/config/vitest` → `@repo/vitest-config`
   - `packages/ui/vitest.config.ts`: `@repo/config/vitest` → `@repo/vitest-config`
   - `tools/vitest.config.ts`: relative import `../packages/config/src/vitest` → `@repo/vitest-config` (also add `@repo/vitest-config` to `tools/package.json` devDependencies if `tools/` has its own `package.json`, otherwise resolve via root workspace)
   - Add `"@repo/vitest-config": "workspace:*"` to devDependencies in each consumer
   - Add `"@repo/playwright-config": "workspace:*"` to root or `apps/web` devDependencies
   - Remove `./vitest` export from `packages/config/package.json`
   - Delete `packages/config/src/vitest.ts`
   - `@repo/config` stays (still exports `./tsconfig` and `./tsconfig.base`)
   - Verify: grep the entire monorepo for `@repo/config/vitest` and `packages/config/src/vitest` — zero results before merging

4. **Update root `playwright.config.ts`** to extend `@repo/playwright-config`:
   - Add Firefox, Safari (webkit), and Mobile Chrome (Pixel 5) browser projects
   - Configure reporter: blob in CI for sharded runs, html locally
   - Add comment documenting `--project=chromium` for fast local runs

5. **Update root `vitest.config.ts`** coverage thresholds:
   - Set initial thresholds to 80% floor with `autoUpdate: true`
   - First non-cached test run will ratchet thresholds to actual coverage values

6. **Update CI workflow** (`.github/workflows/ci.yml`):
   - Keep existing `e2e` job for PRs (Chromium-only, unchanged behavior)
   - Add `e2e-matrix` job for staging/main: `needs: [build]` only (NOT `check-e2e-paths` which only runs on PRs). Gate with `if:` on `github.ref == 'refs/heads/main' || 'refs/heads/staging'`. Use 2-shard matrix strategy with full 4-browser config. Set `timeout-minutes: 60`.
   - Add `merge-reports` job: depends on `e2e-matrix` with `if: always()`, merges blob reports. Requires `permissions: actions: read` to download artifacts from other jobs.
   - Update browser install step to include `chromium firefox webkit` in BOTH the cache-miss step (`playwright install --with-deps`) AND the cache-hit step (`playwright install-deps chromium firefox webkit`)
   - Update cache key: `playwright-${{ runner.os }}-${{ hashFiles('bun.lock') }}`
   - Blob artifacts: per-shard unique names using `${{ matrix.shard }}` (e.g., `blob-report-${{ matrix.shard }}`). 1-day retention. Upload always.
   - `merge-reports` job: use `actions/download-artifact` with `pattern: blob-report-*` and `merge-multiple: true`. Merged HTML report: 7-day retention.
   - Update `check-e2e-paths` filter to include `packages/playwright-config/**` and `packages/vitest-config/**` (note: this filter only affects PR jobs; `e2e-matrix` on push always runs regardless)

7. **Update `turbo.jsonc`**:
   - The `test:e2e` task does not currently exist in `turbo.jsonc`. E2E tests run via root `package.json` script (`"test:e2e": "playwright test"`) outside the Turbo task graph. Keep it this way — no Turbo task for E2E since sharding is incompatible with Turbo caching. No `passThroughEnv` needed since E2E bypasses Turbo entirely.

8. **Update documentation**:
   - `docs/standards/testing.mdx`: update import path examples from `@repo/config/vitest` to `@repo/vitest-config`

### Edge cases

- **WebKit system deps fail on runner update**: Pin Playwright version in `package.json`. If webkit becomes persistently flaky, set `continue-on-error: true` on the webkit browser job.
- **Auto-threshold blocks a refactoring PR**: Developer manually lowers the threshold in that PR with a comment explaining why. `autoUpdate` re-ratchets on the next coverage improvement.
- **Mobile Chrome viewport false failures**: Existing E2E tests should be audited for viewport assumptions (hardcoded widths, desktop-only selectors) before enabling the Pixel 5 project. Fix any viewport-dependent tests.
- **TurboRepo caching + autoUpdate interaction**: `autoUpdate` only fires on non-cached runs. Thresholds update less frequently than every commit. This is acceptable — the ratchet is a backstop, not a real-time tracker.
- **Shard artifact naming collisions**: Each shard must use a unique artifact name using `${{ matrix.shard }}` (e.g., `blob-report-1-2`). The `merge-reports` job downloads all artifacts matching the `blob-report-*` pattern with `merge-multiple: true`.
- **One shard fails, others pass**: The `merge-reports` job uses `if: always()` to merge partial reports even on shard failure.

## Constraints

- **Single PR**: All changes (packages, migrations, CI) ship together. No gradual dual-path migration.
- **No new test framework dependencies**: Uses existing Vitest and Playwright versions already in the monorepo.
- **`@repo/config` must remain**: It still provides tsconfig exports used by all apps. Only the `./vitest` export is removed.
- **Workspace glob handles registration**: Root `package.json` uses `"workspaces": ["apps/*", "packages/*"]` — new packages under `packages/` are auto-discovered. No manual registration.
- **Vercel unaffected**: Test configs are dev-only. No impact on build or deployment.
- **Rollback plan**: If CI breaks persistently after merge, the PR can be fully reverted with no residual state. All changes are self-contained in the PR.

## Non-goals

- **Playwright component testing**: Experimental API, not stable enough. Separate issue when mature.
- **Mutation testing (Stryker)**: Listed as "advanced" in testing standards. Orthogonal to infrastructure upgrade.
- **Cross-app E2E directory** (`tests/e2e/`): Option B's original analysis mentions this, but it adds architectural complexity without immediate value. Defer to when cross-app flows exist.
- **Contract testing (Pact)**: No separate frontend/backend deployment boundary exists yet.
- **Bumping to 4 shards**: Start at 2. Bump when E2E test count exceeds ~20.

## Technical Decisions

1. **Dedicated packages over embedded config**: `@repo/vitest-config` and `@repo/playwright-config` follow TurboRepo best practices. Each package has its own `package.json` with exports map, making dependencies explicit and enabling independent versioning if needed.

2. **All-at-once migration**: With only 4 vitest config consumers (`apps/web`, `apps/api`, `packages/ui`, `tools/`), a clean cut is simpler and safer than a gradual deprecation with re-exports.

3. **Tiered browser matrix**: PRs stay fast (Chromium-only). staging/main get full coverage. This is the right tradeoff for a project with a small but growing E2E suite.

4. **2 shards starting point**: Matches current E2E volume. Infrastructure supports bumping to 4 with a one-line matrix change.

5. **Coverage auto-ratchet with floor**: Prevents regression without becoming a refactoring blocker. Floor values (80% for lines/functions/statements, 76% for branches matching current value) are below actual coverage, acting as a safety net. `autoUpdate` ratchets upward from there.

6. **Two separate E2E jobs (not conditional matrix)**: Simpler to read, debug, and maintain than a single job with conditional matrix expressions.

## Success Criteria

### Packages
- [ ] `packages/vitest-config/` exists with `base.ts`, `react.ts`, `node.ts`, `tsconfig.json`, and correct `package.json` exports
- [ ] `packages/playwright-config/` exists with `base.ts`, `tsconfig.json`, and correct `package.json` exports
- [ ] Both new packages have `typecheck` scripts so TurboRepo pipeline succeeds without warnings
- [ ] `bun install` resolves both new packages without errors (workspace auto-discovery)

### Migration
- [ ] All vitest configs (including `tools/vitest.config.ts`) import from `@repo/vitest-config`
- [ ] Zero references to `@repo/config/vitest` or `../packages/config/src/vitest` remain in the monorepo (verified by grep)
- [ ] `packages/config/src/vitest.ts` is deleted and `./vitest` export removed from `packages/config/package.json`
- [ ] `@repo/config` still builds and exports `./tsconfig` and `./tsconfig.base` correctly

### Playwright
- [ ] `playwright.config.ts` configures 4 browser projects (Chromium, Firefox, WebKit, Pixel 5)
- [ ] Local `bun run test:e2e --project=chromium` works for fast local E2E runs

### Coverage
- [ ] `vitest.config.ts` uses `autoUpdate: true` with 80% floor thresholds
- [ ] After a fresh (non-cached) `bun run test:coverage`, thresholds in `vitest.config.ts` reflect actual coverage values (at or above 80%)

### CI
- [ ] PRs run Chromium-only E2E (existing behavior preserved)
- [ ] staging/main pushes run 2-shard, 4-browser E2E matrix with blob reporter
- [ ] `merge-reports` job produces a downloadable merged HTML report artifact
- [ ] `check-e2e-paths` filter includes `packages/playwright-config/**` and `packages/vitest-config/**`
- [ ] `e2e-matrix` job has `timeout-minutes: 60`

### Tests
- [ ] All existing unit tests pass with the new vitest config packages
- [ ] All existing E2E tests pass on Chromium, Firefox, and WebKit
- [ ] Mobile Chrome (Pixel 5): tests pass, or viewport-dependent failures are deferred with `test.fixme()` and a linked follow-up issue (max 2 deferred tests — if more, extract viewport fixes to a separate issue)

### Documentation
- [ ] `docs/standards/testing.mdx` updated with new import paths (zero references to `@repo/config/vitest` in `docs/`)
- [ ] No references to old import paths remain in analysis or spec documents in `artifacts/analyses/` and `artifacts/specs/`

## Resolved Questions

- **Vitest `autoUpdate` + TurboRepo caching**: The `test` task in `turbo.jsonc` caches `coverage/**` outputs. When Turbo serves a cache hit, `vitest run --coverage` does not execute, so `autoUpdate` never fires. **Decision**: Accept infrequent threshold updates. The 80% floor is a backstop; the ratchet fires whenever Turbo cache misses (code changes). No need to exclude `vitest.config.ts` from Turbo outputs — the current behavior is acceptable and simpler.

- **`branches: 76%` is below the 80% floor**: The current `branches` threshold is 76%, which is below the proposed 80% floor. **Decision**: Set the initial `branches` floor to 76% (matching current value) and the other three to 80%. `autoUpdate` will ratchet all four upward from these starting points.

## Open Questions

- **WebKit flakiness threshold**: At what point should webkit be downgraded to `continue-on-error: true`? Suggested SLA: if webkit fails on >3 unrelated PRs in a single week, downgrade to advisory and open a tracking issue.
