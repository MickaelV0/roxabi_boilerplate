---
title: "Sentry Backend Error Tracking + CI + Alerting"
parent_spec: "artifacts/specs/371-observability-stack.mdx"
parent_issue: 371
---

## Scope

Phase 2 backend — Sentry NestJS integration, PII sanitization, source map uploads, alert config. Breadboard IDs: N4, N5, N6, N7, N8, N14, N15, N16, S1.

## Success Criteria

- [ ] `instrument.ts` file created with `Sentry.init()`, loaded via `--import` flag before all other modules
- [ ] `SentryGlobalFilter` registered as APP_FILTER after `AllExceptionsFilter` in providers array (outermost)
- [ ] `SentryModule` registered in AppModule for shutdown flush
- [ ] Unhandled exceptions appear in Sentry with `correlationId` tag, stack trace, and matching release tag
- [ ] `beforeSend` strips Authorization headers, cookies, and request bodies
- [ ] Sentry `release` set to `VERCEL_GIT_COMMIT_SHA`; `environment` from `VERCEL_ENV`
- [ ] Source map upload gated to push events (main/staging) — skipped on PRs
- [ ] Two separate upload invocations: `SENTRY_PROJECT_API` and `SENTRY_PROJECT_WEB`
- [ ] Source maps deleted after upload
- [ ] `await Sentry.flush(2000)` called before serverless function exit
- [ ] Sentry disabled gracefully when `SENTRY_DSN` not set
- [ ] Sentry Alert rules configured (screenshot in PR)
- [ ] Env vars: `SENTRY_DSN` in `.env.example`; CI secrets documented
- [ ] `turbo.jsonc`: `SENTRY_AUTH_TOKEN` in `globalPassThroughEnv`; Sentry vars in `build.env`
- [ ] CSP `connectSrc` updated with `*.ingest.sentry.io`
- [ ] `SENTRY_AUTH_TOKEN` added to `build` job env in `ci.yml`

## Reference

Full spec: [artifacts/specs/371-observability-stack.mdx](../specs/371-observability-stack.mdx)
