---
title: "Harden Vercel Env Var Handling Across CI/CD Pipeline"
description: Analysis of 8 improvements to environment variable security, reliability, and developer experience across the Roxabi CI/CD pipeline
status: draft
---

## Context

A comprehensive audit of the CI/CD environment variable handling (2026-02-13) revealed 8 improvements spanning security, reliability, and developer experience. These are tracked as children of [epic #158](https://github.com/MickaelV0/roxabi_boilerplate/issues/158).

**Current state:**

- **API env validation** (`apps/api/src/config/env.validation.ts`): Zod schema validates all API env vars at startup, with a guard that rejects insecure `BETTER_AUTH_SECRET` defaults — but only when `NODE_ENV === 'production'`, missing preview/staging environments. The rate limiting guard (lines 69-74) has the same gap.
- **Web env handling**: No validation at all. `process.env.API_URL` falls back silently to `http://localhost:3001` if missing (`apps/web/src/lib/api-client.server.ts:34`). Client-side `import.meta.env.VITE_*` vars are unchecked.
- **Turbo `passThroughEnv`** (`apps/api/turbo.json`): Contains 15+ Postgres connection string variants cargo-culted from Vercel's Neon integration template. Only `DATABASE_URL` is actually used in application code (`DATABASE_URL_UNPOOLED` is also absent from the Zod schema — see Workstream 5).
- **Env file resolution**: Web (Vite) reads only from monorepo root (`envDir: '../..'`). API (NestJS) searches 4 paths: `../../.env.local`, `../../.env`, `.env.local`, `.env`. Inconsistent behavior confuses developers.
- **Neon branch lifecycle**: The `deploy-preview.yml` workflow creates Neon branches for preview deploys but has only a manual cleanup target — no automatic cleanup on PR close/merge.
- **No env sync check**: Developers can add env vars to Zod schemas but forget to update `.env.example`, causing silent breakage for other developers and preview deploys.
- **`VERCEL_ENV` not in schema**: Vercel sets `VERCEL_ENV` automatically (`production`/`preview`/`development`) but it's not in the Zod schema, so it's unavailable via `ConfigService`.
- **No consolidated reference**: Developers must grep across 5+ files to understand which env vars exist, which app uses them, and their defaults.

## Questions Explored

1. How should we tighten the `BETTER_AUTH_SECRET` guard to cover all non-development environments?
2. What should the web env validation schema look like, and how do we validate client-side vars at build time?
3. How should Neon branch cleanup be triggered — on PR close, on a schedule, or both?
4. What's the right implementation order given cross-dependencies?
5. Should env file resolution standardize on monorepo root or support app-level overrides?
6. How comprehensive should the env sync check be?

## Analysis

### Workstream 1: Security — BETTER_AUTH_SECRET Guard (#151)

**Problem:** The guard uses `NODE_ENV === 'production'`, but Vercel preview deploys do not set `NODE_ENV=production` — they typically inherit `NODE_ENV=development` or leave it unset (which defaults to `development` via the Zod schema). A preview could run with the insecure default secret, enabling session forgery.

**Solution:** Invert the check to `NODE_ENV !== 'development'`. This ensures the default secret is only accepted in local development — never in preview, staging, or production.

```typescript
// Before
if (validatedConfig.NODE_ENV === 'production' && INSECURE_SECRETS.includes(...))

// After
if (validatedConfig.NODE_ENV !== 'development' && INSECURE_SECRETS.includes(...))
```

Additionally, add `VERCEL_ENV` to the schema (#157) and use it as a secondary signal: reject the default secret whenever `VERCEL_ENV` is set (regardless of `NODE_ENV`).

**Note on rate limiting guard:** The guard at lines 69-74 of `env.validation.ts` has the same `NODE_ENV === 'production'` pattern. However, `deploy-preview.yml` explicitly sets `RATE_LIMIT_ENABLED=false` for preview deploys, so this gap is mitigated. Evaluate for consistency during implementation but no change required.

**Test suite impact:** This change **will break existing tests**. Specifically:
- `apps/api/src/config/env.validation.test.ts` line 123 asserts that `validate({ NODE_ENV: 'test' })` accepts the insecure default — this test must be updated to either provide a test-specific secret or assert the new rejection behavior.
- Integration tests bootstrapping the full NestJS app with `NODE_ENV=test` must also provide a safe `BETTER_AUTH_SECRET`.
- Fix: add `BETTER_AUTH_SECRET=test-secret-for-ci-only-32chars` to `.env.test` or test setup files.

**Risk:** Low, but test changes are required (not a one-liner — multiple test files affected).

**Rollback strategy:** If preview deploys crash because `BETTER_AUTH_SECRET` is not set in Vercel preview env vars, the fix is to add the env var in the Vercel dashboard for the preview environment. As a stop-gap, revert the single guard condition.

**Scope:** `apps/api/src/config/env.validation.ts`, `env.validation.test.ts`, test setup/config.

**Done when:**
- API startup throws in preview/staging/test with default secret
- API startup succeeds in development with default secret
- All existing tests pass with explicit test secret
- Vercel preview deploys have `BETTER_AUTH_SECRET` configured

---

### Workstream 2: Security & Reliability — Web Env Validation (#150)

**Problem:** The web app has zero env validation. Missing `API_URL` silently falls back to localhost, causing broken production deploys with no error signal.

**Solution:** Mirror the API's Zod validation pattern:

1. **`apps/web/src/lib/env.server.ts`** — Server-side vars (validated at startup):
   - `API_URL` (required, URL)
   - `APP_URL` (required, URL)
   - `NODE_ENV` (enum, default `development`)
   - `VERCEL_ENV` (optional enum, for parity with API — see #157)

2. **`apps/web/src/lib/env.client.ts`** — Client-side `VITE_*` vars (validated at build time):
   - `VITE_ENABLE_DEMO` (boolean string, optional, default `true`)
   - `VITE_GITHUB_REPO_URL` (URL, optional)

3. **Validation entry point:** Import and call the server validation at the top of `apps/web/src/server.ts` (before the handler export). This fails the server at startup if env vars are invalid. No Nitro plugin plumbing needed — the existing server entry is the simplest and most reliable hook. Client vars should be validated during Vite build via a custom plugin that fails the build if validation fails.

**Why not Nitro plugins:** The project has no existing Nitro plugin infrastructure (`apps/web/src/server/plugins/` does not exist). The Nitro config is passed inline via the `nitro()` Vite plugin, not a separate `nitro.config.ts`. Using a top-of-file import in `server.ts` is simpler and known to work.

**Alternative considered:** Using `@t3-oss/env-core` — dismissed because it adds a dependency for something we can do with plain Zod (consistent with the API pattern).

**Risk:** Low-medium. Server-side validation is straightforward. Client-side build-time validation via Vite plugin needs implementation but is well-documented in Vite's plugin API.

**Scope:** New files in `apps/web/src/lib/`, `apps/web/src/server.ts` update, Vite config update.

**Done when:**
- Server crashes at startup with clear error if `API_URL` is missing
- Build fails if `VITE_*` vars are invalid
- Type-safe `env` object exported and used across the web app
- All existing web routes still work

---

### Workstream 3: Reliability — Neon Branch Cleanup (#153)

**Problem:** `deploy-preview.yml` creates Neon database branches for preview deploys. The only cleanup mechanism is a manual `cleanup` target that must be triggered explicitly. Orphaned branches accumulate and may incur billing costs.

**Solution:** PR-close trigger:

1. **`pull_request: types: [closed]` workflow** (`neon-cleanup.yml`):
   - Use `github.head_ref` (not `GITHUB_REF_NAME`) to get the source branch name — in a `pull_request` event, `GITHUB_REF_NAME` resolves to `<pr_number>/merge`, not the branch name.
   - Construct `preview/${github.head_ref}` to match the naming convention in `deploy-preview.yml` line 124.
   - Call Neon API to find and delete the branch. Handle "not found" gracefully (idempotent).

2. **Existing manual `cleanup` target** in `deploy-preview.yml` remains as a fallback.

**Why no weekly schedule:** The existing `deploy-preview.yml` already self-cleans — it deletes any existing Neon branch with the same name before creating a new one (lines 129-137). So the next manual preview deploy for the same branch automatically replaces the old one. Orphan buildup is naturally limited.

**Risk:** Low. Both cleanup paths are idempotent and only target `preview/*` branches.

**Scope:** New `.github/workflows/neon-cleanup.yml`.

**Done when:**
- Neon branches auto-deleted when PR is closed/merged
- Handles "branch doesn't exist" gracefully (no error)

---

### Workstream 4: Reliability — Env Var Sync Check (#152)

**Problem:** Developers can add env vars to Zod schemas but forget `.env.example`, or vice versa. No CI gate catches this drift.

**Solution:** A Bun script (`scripts/check-env-sync.ts`) that:

1. Parses keys from `.env.example` (skip comments and blank lines)
2. Imports and reads `Object.keys(envSchema.shape)` from the API Zod schema
3. Imports and reads keys from the web env schemas (`apps/web/src/lib/env.server.ts`, `apps/web/src/lib/env.client.ts`) — depends on #150
4. Reports: keys in schemas but missing from `.env.example` (error), keys in `.env.example` but not in any schema (warning)

**Why import instead of regex:** Zod exposes `.shape` as a plain object whose keys are the schema field names. Using `Object.keys(envSchema.shape)` is zero-regex, perfectly reliable, and won't break on multiline defaults, comments, or nested objects. The schemas only depend on Zod which is already installed.

**Policy for local-only vars:** Some vars in `.env.example` are consumed by tooling scripts rather than Zod schemas (e.g., `POSTGRES_USER`, `POSTGRES_PASSWORD` for Docker, `CLAUDE_CODE_*` for dev tooling). The script should maintain an explicit allowlist of "tooling-only" vars that are expected in `.env.example` but not in any schema. These produce neither errors nor warnings.

Add as a step in the `lint` job of `.github/workflows/ci.yml` (alongside Biome lint, i18n validation, and license check) — it is fast static analysis with zero runtime dependencies. No separate CI job needed.

**Decision:** Build the sync check covering both API and web schemas together. This means #152 depends on #150.

**Risk:** Low. The script is a development tool — if it breaks, CI fails safely.

**Scope:** New `scripts/check-env-sync.ts`, `ci.yml` lint job update, root `package.json` script entry.

**Done when:**
- CI fails if `.env.example` is missing keys declared in Zod schemas
- CI warns if `.env.example` has keys not in any schema (excluding the tooling allowlist)
- Script is runnable locally (`bun run env:check`)

---

### Workstream 5: DX — Trim `passThroughEnv` (#154)

**Problem:** `apps/api/turbo.json` lists 15+ Postgres variants (`PGHOST`, `PGPASSWORD`, `POSTGRES_URL`, etc.) that are never referenced in application code. These were cargo-culted from Vercel's Neon integration template.

**Verified safe to remove** (confirmed by grepping the entire codebase):
- `PGDATABASE`, `PGHOST`, `PGHOST_UNPOOLED`, `PGPASSWORD`, `PGUSER` — only in `turbo.json`
- `POSTGRES_DATABASE`, `POSTGRES_HOST`, `POSTGRES_PRISMA_URL`, `POSTGRES_URL`, `POSTGRES_URL_NON_POOLING`, `POSTGRES_URL_NO_SSL` — only in `turbo.json`
- `POSTGRES_USER`, `POSTGRES_PASSWORD` — used in `apps/api/scripts/db-branch.ts` for local Docker operations only (not during Turbo builds)
- `NEON_PROJECT_ID` — used only as a GitHub Actions secret in CI workflows, never in application code
- `DATABASE_URL_UNPOOLED` — not in the Zod schema and not referenced in any application source file; only in `turbo.json` itself

**Solution:** Trim to only vars consumed by application code:

```json
"passThroughEnv": [
  "BETTER_AUTH_SECRET",
  "BETTER_AUTH_URL",
  "CORS_ORIGIN",
  "DATABASE_URL",
  "EMAIL_FROM",
  "KV_REST_API_URL",
  "KV_REST_API_TOKEN",
  "RATE_LIMIT_ENABLED",
  "SWAGGER_ENABLED",
  "RATE_LIMIT_GLOBAL_TTL",
  "RATE_LIMIT_GLOBAL_LIMIT",
  "RATE_LIMIT_AUTH_TTL",
  "RATE_LIMIT_AUTH_LIMIT",
  "RATE_LIMIT_AUTH_BLOCK_DURATION",
  "RATE_LIMIT_API_TTL",
  "RATE_LIMIT_API_LIMIT"
]
```

Add a comment above the array explaining why the Neon/Postgres vars were removed and what to restore if Vercel's native Neon integration is later enabled.

**Risk:** Very low. `passThroughEnv` only affects what's available during Turbo builds — removing unused entries has zero runtime effect. Note: `POSTGRES_USER`/`POSTGRES_PASSWORD` are used by local Docker scripts but those are never invoked via Turbo tasks.

**Scope:** `apps/api/turbo.json` only.

**Done when:**
- All unused Postgres variants and `DATABASE_URL_UNPOOLED` removed
- Comment added explaining removal rationale
- `turbo run build` succeeds (Vercel deploys unaffected)

---

### Workstream 6: DX — Standardize Env File Resolution (#156)

**Problem:** Web reads `.env` from monorepo root only. API searches 4 paths (root `.env.local`, root `.env`, local `.env.local`, local `.env`). A developer creating `.env.local` at root gets API overrides but not web overrides.

**Decision:** Standardize both to monorepo root only.

**Solution:**
1. **API** (`apps/api/src/app.module.ts`): Simplify `envFilePath` to `['../../.env.local', '../../.env']` — remove the app-local paths (`.env.local`, `.env`) that nobody uses.
2. **Web** (`apps/web/vite.config.ts`): Already correct (`envDir: '../..'`). No change needed — Vite natively supports `.env.local` in the `envDir`.
3. **Document** in configuration docs: `.env` and `.env.local` always live at monorepo root.

**Verified:** Zero `.env*` files exist in `apps/web/` or `apps/api/` directories.

**Vercel note:** On Vercel, the CWD is the repo root (TurboRepo build). The relative paths `../../.env.local` and `../../.env` would resolve above the repo. Since Vercel injects env vars via the dashboard (not files), `envFilePath` is operationally irrelevant on Vercel — this change only affects local development behavior.

**Risk:** Very low. Nobody has app-level `.env` files today.

**Scope:** `apps/api/src/app.module.ts`, docs update.

**Done when:**
- API resolves env files from monorepo root only
- Documented in configuration docs
- Local dev workflow unchanged

---

### Workstream 7: DX — Add `VERCEL_ENV` to Env Validation (#157)

**Problem:** Vercel sets `VERCEL_ENV` automatically but it's not in the Zod schema, so it's unavailable via `ConfigService` and can't be used for preview-specific behavior.

**Note:** Despite being labeled P3, this is a dependency of #151 (P1). Should be treated as P1 priority.

**Solution:** Add to the API Zod schema:

```typescript
VERCEL_ENV: z.enum(['production', 'preview', 'development']).optional(),
```

Also add to the web server env schema (#150) for parity.

This enables future preview-specific features (e.g., preview banner, relaxed rate limits) and strengthens the `BETTER_AUTH_SECRET` guard (#151).

**Risk:** Very low. Optional field, no breaking change.

**Scope:** `apps/api/src/config/env.validation.ts`, `apps/web/src/lib/env.server.ts`.

**Done when:**
- `VERCEL_ENV` available via `ConfigService.get('VERCEL_ENV')`
- Added to both API and web schemas
- Existing tests unaffected (field is optional)

---

### Workstream 8: Docs — Consolidated Env Var Reference (#155)

**Problem:** No single reference for all env vars. Developers grep across 5+ files.

**Decision:** Extend `docs/configuration.mdx` with a comprehensive reference table.

**Solution:** Add a new "Complete Environment Variable Reference" section to `docs/configuration.mdx` with columns: Variable, App (web/api/both), Required, Default, Scope (client/server/build), Description.

Group by domain: Core, Database, Authentication, Rate Limiting, Public (Client), Deployment. This section should be maintained as the source of truth — the sync check (#152) can eventually validate against it.

**Risk:** None. Documentation only.

**Scope:** `docs/configuration.mdx`.

**Done when:**
- Single reference table listing all env vars with all columns populated
- Grouped by domain
- Matches actual Zod schemas (after all other workstreams complete)

## Dependency Graph

```
#157 (VERCEL_ENV)  ───▶ #151 (BETTER_AUTH_SECRET guard)

#150 (Web env)     ───▶ #152 (Env sync check)
                   ───▶ #155 (Env var reference docs)

#153 (Neon cleanup)           — independent
#154 (Trim passThroughEnv)    — independent
#156 (Standardize env resolution) — independent
```

### Recommended Implementation Order

| Phase | Issues | Rationale |
|-------|--------|-----------|
| **1 — Independent quick wins** | #154, #156, #157 | Zero dependencies, XS/S size, unblock later work |
| **2 — Security core** | #151 | Depends on #157 for `VERCEL_ENV` signal |
| **3 — Web validation** | #150 | Medium size, enables #152 |
| **4 — CI tooling** | #152, #153 | #152 depends on #150; #153 is independent but groups well with CI work |
| **5 — Documentation** | #155 | Best done last when all schemas are finalized |

Phase 1's three items can be done in parallel. Phases 2-3 are sequential. Phase 4's two items can be done in parallel. Phase 5 is the final pass.

### PR Strategy

All reviewers recommend splitting into multiple PRs rather than one monolithic PR:

| PR | Phases | Contents | Rationale |
|----|--------|----------|-----------|
| **PR 1 — Security** | 1 + 2 | #154, #156, #157, #151 | Quick wins unblock the P1 security fix; all are tightly coupled |
| **PR 2 — Validation + Tooling** | 3 + 4 | #150, #152, #153 | Web validation enables the sync check; Neon cleanup groups with CI work |
| **PR 3 — Documentation** | 5 | #155 | Final pass after all schemas are stable |

This allows incremental review and safe rollback per concern.

## Conclusions

1. **All 8 items are well-scoped** with clear acceptance criteria. No new discovery or design is needed — this is execution work.
2. **The dependency chain is shallow** — only #151 depends on #157, and #152 depends on #150. Most items are independent.
3. **The `BETTER_AUTH_SECRET` gap in preview environments is a real security risk** that the current pipeline does not mitigate. This should not be deferred.
4. **The env sync check (#152) is the highest DX-value item** — it prevents a class of "silent breakage" bugs permanently.
5. **Splitting into 3 PRs** (security, validation+tooling, docs) balances review quality with implementation momentum.

## Next Steps

- Create spec with per-workstream implementation details, file-level change lists, and test plans
- Split into 3 PRs aligned with the PR strategy above
- Update #157 priority from P3 to P1 (dependency of P1 #151)
- Verify `BETTER_AUTH_SECRET` is configured in Vercel preview environment before merging #151
- Verify Neon cleanup workflow uses `github.head_ref` (not `GITHUB_REF_NAME`) for branch name resolution
