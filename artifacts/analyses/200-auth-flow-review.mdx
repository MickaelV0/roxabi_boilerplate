---
title: "#200 Review sign-up/sign-in flow end-to-end"
description: End-to-end audit of the authentication flow, identifying gaps in email templates, redirect-back-after-login, verification resend UX, and route guards.
---

## Context

Issues #19 (Auth + Users) and #68 (Auth UI/UX) delivered a comprehensive authentication system: Better Auth backend with email/password, OAuth (Google, GitHub), magic link, organization management, and polished frontend pages with AuthLayout, PasswordInput, OAuthButton, Sonner toasts, i18n, and accessibility. Both issues are marked as **implemented**.

Issue #200 requests an end-to-end review of the sign-up/sign-in flow to catch remaining gaps before the auth system can be considered production-ready.

**Related documents:**
- [Analysis: #19 Auth + Users](./19-auth-users) — backend research
- [Spec: #19 Auth + Users](../specs/19-auth-users) — backend implementation spec
- [Analysis: #68 Auth UI/UX](./68-auth-ui-ux) — frontend UI/UX research
- [Spec: #68 Auth UI/UX](../specs/68-auth-ui-ux) — frontend implementation spec

## Questions Explored

1. What is the current state of each auth page and flow?
2. What gaps exist between the implemented system and production readiness?
3. How should email templates be upgraded (approach, i18n, package structure)?
4. How should redirect-back-after-login work (storage, security, OAuth propagation)?
5. How should the "email not verified" and "expired verification" cases be improved?
6. Which auth routes need additional route guards?

## Analysis

### Current State — Full Audit

Every auth page defined in spec #68 is implemented (source: `apps/web/src/routes/login.tsx`, `register.tsx`, `reset-password.tsx`, `reset-password/confirm.tsx`, `verify-email.tsx`, `magic-link-sent.tsx`, `account-reactivation.tsx`):

| Page | Route | Form Validation | Loading States | Error Handling | AuthLayout | i18n |
|------|-------|----------------|----------------|----------------|------------|------|
| Login | `/login` | HTML5 + credential error classification | Per-button | 403 vs generic, toast | Yes | Yes |
| Register | `/register` | Email regex on blur+submit, password strength, terms checkbox | Per-button | `USER_ALREADY_EXISTS` vs generic | Yes | Yes |
| Reset Password | `/reset-password` | HTML5 `required` + `type="email"` | Yes + 60s cooldown | Toast | Yes | Yes |
| Reset Confirm | `/reset-password/confirm` | Token presence, password strength | Yes | Error message + fallback | Yes | Yes |
| Verify Email | `/verify-email` | N/A (no input) | 3-state machine | Resend button (session-dependent) | Yes | Yes |
| Magic Link Sent | `/magic-link-sent` | N/A | Yes + 60s cooldown + provider deep-link | Toast | Yes | Yes |
| Account Reactivation | `/account-reactivation` | N/A | Yes | Destructive confirm dialog | Card | Yes |

**Components:** AuthLayout, OrDivider, OrgSwitcher, OAuthButton, PasswordInput, Sonner/Toaster, FormMessage — all implemented with tests.

**Backend:** Better Auth with email/password, OAuth, magic link, organization, admin plugins. Email via Resend (with console fallback in dev). JWE cookie cache. Five auth decorators.

### Gap 1: Email Templates Are Bare Inline HTML (High)

**Current state:** All three email types (verification, password reset, magic link) use single-line inline HTML in `auth.instance.ts`:

```html
&lt;p>Click &lt;a href="...">here&lt;/a> to reset your password.&lt;/p>
```

**Problem:** These emails are not production-ready:
- No visual branding (logo, colors, footer)
- No responsive layout (many email clients break plain HTML)
- No plain text fallback (spam filters penalize HTML-only)
- No i18n (English hardcoded in subject lines and body)
- Subject lines are generic ("Verify your email", "Reset your password", "Sign in to Roxabi")

**Proposed solution:** Introduce **React Email** for template authoring and rendering:

- **New package:** `packages/email` — shared email templates using `@react-email/components`
- **Three templates:** `VerificationEmail`, `PasswordResetEmail`, `MagicLinkEmail`
- **Features per template:**
  - Roxabi logo and brand colors
  - Responsive layout via `@react-email/components` (`Html`, `Head`, `Body`, `Container`, `Section`, `Text`, `Button`, `Img`)
  - Clear CTA button (not just a text link)
  - Plain text version auto-generated via `render({ plainText: true })`
  - i18n: Accept a `locale` parameter (`'en' | 'fr'`), use simple key-value translations (no Paraglide — Paraglide compiles messages at build time for the frontend bundle; email rendering happens at runtime on the API server where Paraglide's compiled output is not available)
  - Expiration notice where applicable ("This link expires in X hours")
- **Integration:** `auth.instance.ts` imports render functions from `@repo/email` and passes rendered HTML + text to `emailProvider.send()`. Locale resolution happens in the email callbacks where `user.locale` is read.
- **EmailProvider interface change:** Already supports `text?` optional param — no change needed
- **Dev preview:** React Email includes a dev server (`email dev`) for previewing templates in the browser. Run ad hoc via `cd packages/email && bun run dev:email` — not added to the TurboRepo `dev` pipeline (opt-in only).
- **Testing:** Snapshot tests for each template using React Email's `render()` function — verify HTML output and plain text output for both locales.

**Package setup (`packages/email`):**
- `package.json` with `@repo/email` name, `build` script via `tsup`, TurboRepo `^build` dependency chain (same pattern as `@repo/ui`)
- `tsup.config.ts` for building the package
- `@react-email/components` — UI primitives (dependency)
- `react` + `react-dom` — direct dependencies (not peer deps — the API server does not provide React, the rendering happens inside this package)
- `react-email` — **devDependency only** (dev preview server; `render` is re-exported from `@react-email/components`)

**i18n approach:** A simple `translations` object per template:

```typescript
const t = {
  en: {
    subject: 'Verify your email',
    heading: 'Verify your email address',
    body: 'Click the button below to verify your email.',
    cta: 'Verify email',
    expiry: 'This link expires in 24 hours.',
  },
  fr: {
    subject: 'Vérifiez votre email',
    heading: 'Vérifiez votre adresse email',
    body: 'Cliquez sur le bouton ci-dessous pour vérifier votre email.',
    cta: 'Vérifier l\'email',
    expiry: 'Ce lien expire dans 24 heures.',
  },
}
```

**User locale detection:** The user's preferred locale should be stored on the `users` table:

- **Drizzle column:** `locale: text('locale').notNull().default('en')` in `auth.schema.ts`
- **Migration required:** `bun run db:generate && bun run db:migrate`
- **Population strategy:** On signup, read `Accept-Language` from the registration request and persist to the `locale` column via `databaseHooks.user.create.after` (which already performs a `db.update()` for avatar defaults). Falls back to `'en'` if no header or unsupported locale.
- **Email callbacks:** Read `user.locale` (or fall back to `'en'`) and pass to the template render function.

**Note:** Email deliverability (SPF, DKIM, domain verification in Resend) is a prerequisite for production emails but is a Resend configuration concern, not a code change — out of scope for this issue.

### Gap 2: No Redirect-Back-After-Login (Medium)

**Current state:** The `requireAuth` guard in `route-guards.ts` redirects to `/login` without preserving the intended destination:

```typescript
if (!data) throw redirect({ to: '/login' })
```

After login, the user always goes to `/dashboard` (hardcoded in `login.tsx` line 104):

```typescript
navigate({ to: '/dashboard' })
```

**Problem:** Users who click a deep link to a protected page (e.g., `/org/settings`) get bounced to `/login` and then land on `/dashboard` instead of their intended page.

**Proposed solution:** Standard `?redirect=` query parameter pattern:

1. **`requireAuth` guard** — append current path (not full URL) as `redirect` search param:
   ```typescript
   const returnPath = ctx.location.pathname + (ctx.location.searchStr ?? '')
   if (!data) throw redirect({ to: '/login', search: { redirect: returnPath } })
   ```
   **Note:** Use `pathname + searchStr`, not `location.href` (which includes the origin and would fail the relative-path safety check). The current SSR short-circuit (`if (typeof window === 'undefined') return`) means redirect preservation is a no-op during SSR — the client-side hydration handles it.

2. **Login page** — read `redirect` from search params:
   ```typescript
   const { redirect: redirectTo } = Route.useSearch()
   // After successful login:
   navigate({ to: redirectTo || '/dashboard' })
   ```

3. **Security validation** — only allow relative paths (prevent open redirect):
   ```typescript
   const safeRedirect = redirectTo?.startsWith('/') && !redirectTo.startsWith('//') ? redirectTo : '/dashboard'
   ```
   Blocks both absolute URLs and protocol-relative URLs (`//evil.com`).

4. **Propagate through OAuth** — When calling `authClient.signIn.social()`, set `callbackURL` to include the redirect param: `/login?redirect=/target`. Better Auth returns the user to this callback URL after the OAuth round-trip. The login page then reads the `redirect` param from the URL and navigates accordingly. **Open question:** Verify that Better Auth preserves the `callbackURL` query params through the OAuth redirect chain — needs testing during implementation.

5. **Route search schema** — add `redirect?: string` to `/login` route's `validateSearch`.

**Files affected:**
- `apps/web/src/lib/route-guards.ts` — pass `redirect` param
- `apps/web/src/routes/login.tsx` — read and use `redirect` param, propagate through OAuth `callbackURL`
- `apps/web/src/routes/register.tsx` — propagate `redirect` to login link via `search` prop:
  ```tsx
  &lt;Link to="/login" search={{ redirect: redirectTo }}>
  ```
- `apps/web/src/routes/magic-link-sent.tsx` — same redirect propagation for post-magic-link navigation

### Gap 3: Resend Verification Without Session (Medium)

**Current state:** The `/verify-email` error state shows a "Resend verification" button only when the user has an active session (`sessionEmail`):

```tsx
{sessionEmail && (
  &lt;Button variant="outline" onClick={handleResend}>...&lt;/Button>
)}
```

**Problem:** A user who registers, closes the browser, and later clicks an expired verification link sees the error but **no resend button** because they have no session. They must manually navigate to `/login`, which auto-triggers `sendOnSignIn: true` (Better Auth resends on sign-in attempt for unverified accounts). This is unintuitive.

**Proposed solution:** Add an email input fallback when no session is available:

```tsx
{sessionEmail ? (
  &lt;Button onClick={handleResend}>Resend verification&lt;/Button>
) : (
  &lt;form onSubmit={handleResendWithEmail}>
    &lt;Input type="email" placeholder="Enter your email" />
    &lt;Button type="submit">Resend verification&lt;/Button>
  &lt;/form>
)}
```

**Security consideration:** The `sendVerificationEmail` API should not leak whether an account exists. Better Auth already handles this — if the email doesn't exist or is already verified, it silently succeeds without sending. The frontend should always show "If an account with this email exists and is not yet verified, a verification email has been sent" (same pattern as password reset).

**Cooldown:** The email-input form must include a 60-second cooldown (same pattern as `reset-password.tsx` and `magic-link-sent.tsx`) to prevent abuse of the unauthenticated resend path.

**Files affected:**
- `apps/web/src/routes/verify-email.tsx` — add email input fallback + security-neutral message + 60s cooldown

### Gap 4: Login 403 "Email Not Verified" Resend (Medium)

**Current state:** When login fails with 403 (email not verified), the error message from `m.auth_login_email_not_verified()` is displayed via `FormMessage`. Better Auth's `sendOnSignIn: true` automatically resends a verification email on failed sign-in for unverified accounts. However, the user has no visible indication that a new email was sent, and no explicit resend button.

**Problem:** The UX relies on an invisible automatic resend. Users may not realize a new email was sent and may try to log in repeatedly, triggering multiple emails.

**Proposed solution:** Replace the plain error message with an inline banner that:

1. Clearly states the account is not verified and a new verification email has been sent automatically
2. Provides an explicit "Resend verification email" button with a cooldown (60s, same pattern as reset-password)
3. Uses a `warning` variant banner (not `FormMessage` which renders as `&lt;p>` — a `&lt;Button>` inside `&lt;p>` is invalid HTML). Use a `&lt;div>`-based warning banner instead:

```tsx
{emailNotVerified && (
  &lt;div role="alert" className="rounded-md border border-warning bg-warning/10 p-3 space-y-2">
    &lt;p className="text-sm text-warning-foreground">{m.auth_login_email_not_verified_sent()}&lt;/p>
    &lt;Button variant="link" size="sm" onClick={handleResendVerification} disabled={cooldown > 0}>
      {cooldown > 0 ? m.auth_resend_in({ seconds }) : m.auth_resend_verification()}
    &lt;/Button>
  &lt;/div>
)}
```

**Note:** The 60-second cooldown timer logic is now used in 3+ places (reset-password, magic-link-sent, and now login + verify-email). Consider extracting a `useCooldown(seconds)` hook in a follow-up, but for this issue, duplicate the existing pattern to keep the PR focused.

**i18n keys needed:**
- `auth_login_email_not_verified_sent` — "Your email is not verified. A new verification email has been sent. Check your inbox."
- `auth_resend_in` — "Resend in {seconds}s"

**Files affected:**
- `apps/web/src/routes/login.tsx` — add `emailNotVerified` state, resend handler, cooldown timer

### Gap 5: Reset-Password Pages Lack `requireGuest` Guard (Low)

**Current state:** `/reset-password` and `/reset-password/confirm` have no `beforeLoad` guard. Authenticated users can access them.

**Problem:** Minor UX issue — an authenticated user visiting `/reset-password` can request a reset for their own email, which is confusing (they should use a "Change password" feature in settings instead). Not a security issue since Better Auth validates the token regardless.

**Edge case:** A user who forgot their password but has a stale cookie (still authenticated) would be blocked from the reset-password page by `requireGuest`. They would be redirected to `/dashboard`. The correct path for authenticated users is a "Change password" feature in settings. This dependency should be tracked as a follow-up but is not a blocker — stale cookies expire within 7 days (session TTL).

**Proposed solution:** Add `requireGuest` guard to both routes:

```typescript
// reset-password.tsx
export const Route = createFileRoute('/reset-password')({
  beforeLoad: requireGuest,
  // ...
})

// reset-password/confirm.tsx
export const Route = createFileRoute('/reset-password/confirm')({
  beforeLoad: requireGuest,
  // ...
})
```

**Files affected:**
- `apps/web/src/routes/reset-password.tsx` — add `beforeLoad: requireGuest`
- `apps/web/src/routes/reset-password/confirm.tsx` — add `beforeLoad: requireGuest`

### Items Explicitly Out of Scope

| Item | Reason |
|------|--------|
| Confirm-password field on register | Low severity, server validates on submission |
| Password `minLength` on login input | Login intentionally doesn't show strength — server validates |
| Auth controller wildcard route depth | Current NestJS/Fastify wildcard works, covered by tests |
| 2FA / TOTP / Passkeys | Separate features, not part of flow review |
| Rate limiting on auth endpoints | Deferred to #53 |

### Estimated Scope

| Area | New Files | Modified Files | Details |
|------|-----------|----------------|---------|
| `packages/email/` | ~10 | 0 | Package setup (package.json, tsup.config) + 3 templates + translations + shared layout + snapshot tests |
| `apps/api/src/auth/` | 0 | 1 | `auth.instance.ts` — import + call React Email render, read `user.locale` |
| `apps/api/src/database/schema/` | 0 | 1 | `auth.schema.ts` — add `locale` column |
| `apps/api/` | 1 | 0 | Drizzle migration file (generated) |
| `apps/web/src/routes/` | 0 | 5 | login, reset-password, reset-password/confirm, verify-email, magic-link-sent |
| `apps/web/src/lib/` | 0 | 1 | route-guards.ts — add redirect param |
| i18n messages | 0 | 2 | EN + FR message files — new keys |
| **Total** | **~11** | **~10** | **~21 files** |

**Tier: F-lite** — Clear scope, documented requirements, primarily frontend + 1 new package. The `packages/email` addition involves monorepo tooling (new TurboRepo package, tsup config) which adds configuration surface, but no architectural uncertainty. All technical decisions are established patterns from existing packages.

## Conclusions

1. **The auth system is 90% complete.** The remaining gaps are UX polish and email presentation — no structural or security issues.

2. **Email templates are the largest work item** (~8 new files for a new `packages/email` package). React Email provides production-grade responsive emails with minimal complexity. i18n via simple translation objects (EN + FR) aligns with the Paraglide approach on the frontend without adding a build dependency.

3. **Redirect-back-after-login is a standard pattern** — `?redirect=` query param with open-redirect protection. Minimal code change across 3 files.

4. **Verification resend improvements** (gaps 3 + 4) are small, focused changes to the existing verify-email and login pages. The security model is already correct (Better Auth never leaks account existence).

5. **The `requireGuest` guard addition** is a 2-line change across 2 files.

## Next Steps

1. **Create spec** for #200 with detailed implementation plan and file-level changes
2. **Create worktree** `../roxabi-200` for implementation
3. **Install React Email** in new `packages/email` package
4. **Implement in order:** email templates → redirect-back → verify-email resend → login 403 banner → requireGuest guards
