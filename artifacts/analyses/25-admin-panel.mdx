---
title: "Admin Panel — User, Org, and System Management"
description: Administrative interface for managing users, organizations, and system settings with role-based access for org admins and super admins.
---

## Context

Issue [#25](https://github.com/roxabi/roxabi_boilerplate/issues/25) calls for an administrative interface — one of the Phase 1 MVP targets from the [vision doc](/docs/vision.mdx) ("B2B: Internal tools, dashboards, admin panels"). Dependencies #19 (RBAC), #21 (Org Management), and #24 (Soft Delete) are all completed, providing the foundation this feature builds on.

**Current state:**

- **Org members page** (`/org/members`) and **org settings page** (`/org/settings`) already exist but are basic — no pagination, no custom RBAC role support, and limited to the active organization.
- **Two-tier role system** is in place: global user roles (`user | admin | superadmin`) and org-scoped RBAC roles (`owner | admin | member | viewer` + custom roles). The `@Roles()` decorator and `@Permissions()` guard are implemented but `@Roles('superadmin')` is unused.
- **Better Auth admin plugin** is loaded, providing `/api/auth/admin/*` endpoints (ban/unban, role management), but these bypass NestJS guards entirely — a security concern that must be resolved before shipping (see [Open Questions](#open-questions)).
- **No `/admin` routes exist** on the frontend. No admin-scoped API endpoints exist in NestJS.
- **Soft delete** is implemented for both users and organizations.

## Questions Explored

1. What is the MVP scope — all sections or phased?
2. How should the admin panel route architecture handle two admin types (org admin vs super admin)?
3. How do existing org pages relate to the new admin panel?
4. How should impersonation, audit logs, feature flags, org hierarchy, and deletion work?
5. What are the technical gaps in the current codebase?

## Analysis

### Scope

**Full MVP scope** — all four sections ship together:

| Section | Audience | Key capabilities |
|---------|----------|-----------------|
| **User Management** | Org Admin + Super Admin | List/search/CRUD users, assign roles, impersonate (super admin), activity overview |
| **Organization Management** | Org Admin + Super Admin | List/search/CRUD orgs, parent/child hierarchy, settings |
| **System Settings** | Super Admin only | Global configuration, feature flag toggles, system health dashboard |
| **Super Admin Features** | Super Admin only | Cross-tenant access, system-wide analytics, audit log viewer |

### Non-goals

The following are explicitly **out of scope** for this feature:

- **Audit log CSV export** — deferred to a follow-up issue.
- **Feature flag targeting rules** (per-org, per-user, percentage rollouts) — MVP is global boolean toggles only.
- **Permanent (hard) deletion** of users or organizations — soft delete with restore only.
- **Custom admin dashboard/analytics** — system health dashboard shows operational metrics, not business analytics.
- **Mobile-optimized admin experience** — the admin panel is desktop-first. It will be responsive (collapsible sidebar, stacked layout on small screens) but not optimized for mobile workflows. This is standard for B2B admin panels.

### Route Architecture

**Single `/admin/*` with sidebar nav groups.** Three approaches were evaluated:

| Approach | Description | Verdict |
|----------|-------------|---------|
| **A. Single `/admin/*` + conditional UI** | One panel, all pages adapt per role via inline conditionals | More conditional rendering, risk of leaking super-admin UI |
| **B. Split `/admin/*` + `/super/*`** | Separate route trees for org admin vs super admin | Code duplication, split navigation, super admins juggle two sections |
| **C. Single `/admin/*` + nav groups** | One panel, sidebar groups for Organization and System | **Selected** — best UX, single entry point, minimal duplication |

**Selected approach (C):**

- One admin panel at `/admin/*` with a dedicated admin layout (sidebar + content area).
- **Sidebar nav groups:**
  - **Organization** (visible to org admins + super admins): Users, Members, Organization Settings
  - **System** (visible to super admins only): Organizations (cross-tenant), System Settings, Feature Flags, Health Dashboard, Audit Logs
- Super admins see all groups; org admins see only the Organization group.
- The existing `/org/members` and `/org/settings` pages **migrate into** the admin panel. The old routes serve **client-side redirects** (not 301/permanent — these are internal app routes, not indexed by search engines).

**Why this approach:** Single entry point avoids navigation split. Nav groups provide clean visual separation. Minimal code duplication vs. split routes. RBAC-based group visibility is straightforward with the existing permission system.

### RBAC Model

Two roles with clear boundaries:

| Role | Scope | Access |
|------|-------|--------|
| **Admin** (org-scoped) | Active organization only | User/member management, org settings, role assignment within their org |
| **Super Admin** (global) | All organizations | Everything above + cross-tenant access, system settings, feature flags, health dashboard, audit logs, impersonation |

The existing two-tier system maps cleanly: org admin = org-scoped RBAC role (`admin` or `owner`), super admin = global `superadmin` user role.

**Frontend route guards:**

- `requireAdmin`: Checks if the user has `admin`/`owner` RBAC role in the active org **OR** has `superadmin` global role. Super admins bypass the active-org requirement entirely (they may have no active org when accessing cross-tenant views).
- `requireSuperAdmin`: Checks for `superadmin` global role only. No org context required.

**Backend guard strategy:** The `AdminModule` will contain two types of controllers:
- **Org-scoped controllers** (members, org settings): Use `@Permissions('members:write')` etc. — these work within the existing tenant context.
- **Cross-tenant controllers** (all users, all orgs, system settings): Use `@Roles('superadmin')`. These endpoints must bypass `TenantService` scoping — they query without a `tenantId` filter. This is achieved by not calling `TenantService.queryAs()` in these services and instead using direct Drizzle queries with explicit filters.

### Existing Page Migration

The current `/org/members` and `/org/settings` pages move into the admin panel:

- `/org/members` → `/admin/members` (enhanced with pagination, custom RBAC role support, bulk actions)
- `/org/settings` → `/admin/settings` (enhanced with more configuration options)
- Old routes serve client-side redirects to the new locations.
- The main navbar "Organization" item updates to point to `/admin` instead of `/org`.

**Enhancements during migration:**

- Member list: add server-side pagination, support custom RBAC roles (not just `admin | member`), add search/filter
- Org settings: add reactivation flow improvements, integrate with parent/child org hierarchy
- Fix the current gap where `members.role` (legacy) and `members.roleId` (RBAC) coexist — admin panel should use the RBAC system exclusively
- Fix `invitations.role` (same legacy string problem as `members.role`) — invitations should reference RBAC role IDs

### User Management

**For org admins:**

- List members of their organization with search, filter by role, and pagination
- Invite new members (all RBAC roles available, not just `admin | member`)
- Change member roles (using RBAC `roleId`, not legacy `role` field)
- Remove members (soft remove from org)
- View member activity summary (last login, actions count)

**For super admins (cross-tenant):**

- List all users across all organizations
- Search/filter by name, email, organization, role, status (active/banned/deleted)
- Edit user details (name, email, global role)
- Ban/unban users (with reason and optional expiration)
- Soft-delete users (with restore capability)
- View user's organization memberships

### User Impersonation

**Session-based with persistent banner:**

1. Super admin clicks "Impersonate" on a user row.
2. Backend creates a new session as that user via Better Auth's admin impersonation API, storing the real admin's ID in an `impersonatorId` column on the `sessions` table (schema change required).
3. Frontend shows a persistent top banner: "You are viewing as [User Name] — [Stop Impersonating]"
4. All actions taken during impersonation are **audit logged** with both the real admin ID and the impersonated user ID.
5. Clicking "Stop Impersonating" destroys the impersonation session and returns to the admin's original session.

**Constraints:**

- Cannot impersonate another super admin — enforced at both backend (guard rejects the request) and frontend (button hidden).
- Impersonation sessions have a 1-hour TTL.
- The impersonation banner is visible on every page, not just admin pages.

### Organization Management

**For org admins:** manage their own organization's settings, members, and hierarchy.

**For super admins:**

- List all organizations with search/filter by name, slug, status (active/deleted), member count
- Create new organizations
- Edit organization details
- Soft-delete organizations (with impact preview, reusing existing `/api/organizations/:id/deletion-impact`)
- Restore soft-deleted organizations

**Parent/child hierarchy:**

- Organizations can have a parent organization (tree structure: Company → Division → Team).
- Schema change: add `parentId` column to `organizations` table (self-referencing FK, nullable).
- Admin UI: tree view or indented list showing hierarchy. Ability to set/change parent org.
- Constraint: maximum depth of 3 levels — enforced at both application layer (validation in `OrganizationService`) and DB level (check constraint or trigger). Rationale: prevents recursive query complexity and keeps the UI manageable.
- **Scope boundary:** Parent orgs do **not** automatically inherit access to child orgs. Parent/child is an organizational grouping for display purposes. Cross-org access remains a super admin privilege only.
- Existing single-org deployments get `parentId = null` — no migration risk.

### System Settings

**Global configuration** (super admin only):

- New `system_settings` table:

```
system_settings
  id (PK), key (unique), value (jsonb), type ('string' | 'number' | 'boolean' | 'select'),
  name, description, category,
  createdAt, updatedAt
```

- The `type` column determines how the UI renders the input (text field, number input, toggle, dropdown).
- The `value` column stores the typed value as JSONB. Validation is done at the application layer based on `type`.
- UI: grouped settings cards by `category` with appropriate input types.

**Feature flags** (simple boolean toggles):

- New `feature_flags` table: `id, key (unique), name, description, enabled (boolean), createdAt, updatedAt`.
- Admin UI: list of flags with toggle switches. Create/edit/delete flags.
- Runtime: `FeatureFlagService.isEnabled(key)` uses an **in-memory cache with a 60-second TTL** to avoid per-request DB hits. Cache is invalidated on flag changes via the admin API.
- No targeting rules in MVP — global on/off only.

### System Health Dashboard

**Service status + key metrics** (super admin only):

| Metric | Source | MVP status |
|--------|--------|-----------|
| API status | Health check endpoint | Available |
| Database status | Drizzle connection check | Available |
| Active users (24h) | Count from sessions table | Available |
| Total users / orgs | Counts from users/organizations tables | Available |
| API request rate | Application metrics | **Deferred** — shows "Not configured" |
| Error rate | Application metrics | **Deferred** — shows "Not configured" |
| DB connection pool | Drizzle/pg pool stats | Available |

Metrics marked "Deferred" display a "Not configured" state with a tooltip explaining that application metrics integration is required. They are not hidden — the UI acknowledges the gap.

Auto-refresh interval: 30 seconds. Color-coded status indicators (green/yellow/red).

### Audit Log System

**Detailed table with expandable diff view:**

**Schema:** new `audit_logs` table:

```
audit_logs
  id (PK), timestamp,
  actorId → users.id,          -- who performed the action
  actorType ('user' | 'system' | 'impersonation'),
  impersonatorId → users.id,   -- if action was via impersonation
  organizationId → organizations.id (nullable),
  action (text),               -- e.g., 'user.updated', 'member.role_changed'
  resource (text),             -- e.g., 'user', 'organization', 'member'
  resourceId (text),           -- ID of the affected resource
  before (jsonb),              -- snapshot before change
  after (jsonb),               -- snapshot after change
  metadata (jsonb),            -- additional context (IP, user agent, etc.)
  createdAt
```

**UI features:**

- Filterable table: date range, actor, action type, resource type, organization
- Text search across action descriptions
- Click to expand: shows before/after diff for data changes (role changed from X to Y, name updated, etc.)
- Cursor-based pagination (large dataset expected)

**Integration:** Audit logging is implemented via explicit `AuditService.log()` calls in each admin controller action. The service requires callers to pass the `before` state (read before mutation) and the `after` state (result of mutation). This is **not** an automatic interceptor — controllers are responsible for capturing the before-state to avoid N+1 reads on bulk operations.

**Audit log action vocabulary** must be defined in the spec (standardized strings like `user.created`, `user.updated`, `member.role_changed`, `org.deleted`, `flag.toggled`, etc.).

### Deletion Strategy

**Soft delete with restore capability:**

- Users and organizations are soft-deleted (existing `deletedAt` + `deleteScheduledFor` pattern).
- Admin panel shows soft-deleted items in a separate "Archived" tab or filter.
- Super admins can restore soft-deleted users and organizations.
- Permanent deletion is a separate, explicitly confirmed action (future consideration — not in MVP).
- Audit logs are retained indefinitely regardless of user/org deletion status.

### Super Admin Provisioning

On fresh deployments, the first super admin is provisioned via:

1. **Database seed** (`bun run db:seed`): creates a default super admin account with credentials from environment variables (`SUPERADMIN_EMAIL`, `SUPERADMIN_PASSWORD`).
2. **Subsequent super admins**: an existing super admin can promote users to `superadmin` via the admin panel's user management.
3. **Emergency access**: direct DB update as a last resort (documented in deployment guide).

### Technical Gaps and Required Changes

**Backend (NestJS):**

1. **New `AdminModule`** with two controller types: org-scoped (using `@Permissions()`) and cross-tenant (using `@Roles('superadmin')`). Cross-tenant controllers bypass `TenantService` with direct Drizzle queries.
2. **Disable or restrict Better Auth admin plugin** endpoints (`/api/auth/admin/*`) to prevent unguarded access. Admin actions should go through NestJS controllers with proper audit logging.
3. **New DB tables:** `system_settings`, `feature_flags`, `audit_logs`. Add `parentId` to `organizations`. Add `impersonatorId` to `sessions`.
4. **`AuditService`** with explicit `log()` calls (not interceptor-based) for before/after snapshots.
5. **`ImpersonationService`** for managing impersonation sessions via Better Auth.
6. **`FeatureFlagService`** with in-memory cache (60s TTL) for runtime checks.
7. **`HealthService`** for aggregating system health metrics.
8. **Legacy field reconciliation:** `members.role` and `invitations.role` must be updated to use RBAC `roleId` exclusively, or kept in sync.

**Frontend (TanStack Start):**

1. **New route tree:** `/admin/*` with admin layout (sidebar + content).
2. **New route guards:** `requireAdmin` (org role OR superadmin), `requireSuperAdmin` (superadmin only). Super admins bypass active-org requirement.
3. **Admin layout component:** sidebar with nav groups, desktop-first responsive design.
4. **Page components:** users list, user detail/edit, orgs list, org detail/edit, org hierarchy view, system settings, feature flags, health dashboard, audit logs.
5. **Impersonation banner:** global component in root layout, shown when session has `impersonatorId`.
6. **Migration:** existing `/org/members` and `/org/settings` pages refactored and moved.

**Shared (`packages/types`):**

1. New types for admin API DTOs, audit log entries, feature flags, system settings.
2. New permission strings if needed (e.g., `admin:read`, `admin:write`, `system:manage`).

**Pagination strategy:** Cross-tenant lists (all users, all orgs, audit logs) use **cursor-based pagination** for performance with large datasets. Org-scoped lists (members within an org) use offset-based pagination (smaller datasets).

## Conclusions

1. **Route architecture:** Single `/admin/*` with sidebar nav groups is the cleanest approach. Org-scoped group for admin roles, system group for super admins.
2. **Existing page migration:** `/org/members` and `/org/settings` move into the admin panel with enhancements (pagination, full RBAC role support).
3. **Impersonation:** Session-based with persistent banner and full audit logging. 1-hour TTL. Cannot impersonate other super admins (enforced backend + frontend).
4. **Audit logs:** Explicit `AuditService.log()` calls with before/after snapshots. Cursor-based pagination. Action vocabulary to be defined in spec.
5. **Feature flags:** Simple boolean toggles with in-memory cache (60s TTL). No targeting rules in MVP.
6. **Org hierarchy:** Parent/child tree with max 3 levels (enforced). Display-only grouping — no cross-org access inheritance.
7. **Deletion:** Soft delete with restore. Audit logs retained regardless.
8. **Better Auth admin plugin:** Must be disabled or restricted before shipping — bypasses NestJS guards and audit logging.
9. **Biggest risk:** The dual role system (`members.role` / `invitations.role` vs `roleId`) must be reconciled. The admin panel should use the RBAC system exclusively.

## Open Questions

- **Better Auth admin plugin:** Disable entirely, or wrap endpoints with NestJS middleware? Disabling is simpler but may break existing functionality if any code depends on those endpoints.
- **Impersonation via Better Auth:** Does the current Better Auth version support the `impersonate-user` admin API? If not, the impersonation session must be created via direct DB session manipulation.
- **Audit log retention policy:** How long are audit logs retained? Indefinite for MVP, but a configurable retention policy may be needed at scale.
- **`members.role` migration:** Drop the legacy field entirely (breaking change to Better Auth) or add a sync mechanism? Needs investigation.

## Next Steps

- Create a spec from this analysis with detailed API contracts, component breakdown, and phased implementation plan.
- Resolve the `members.role` / `invitations.role` vs `roleId` dual system — investigate Better Auth compatibility.
- Define the audit log action vocabulary (standardized action strings).
- Investigate Better Auth admin plugin impersonation API availability.
