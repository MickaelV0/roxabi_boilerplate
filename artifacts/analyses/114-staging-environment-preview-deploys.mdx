---
title: "Staging Environment with On-Demand Preview Deploys"
description: Analysis of introducing a staging branch with manual preview deploys via GitHub Actions
---

## Context

Currently, all changes merged to `main` trigger an automatic Vercel production deploy. This means WIP or non-production-ready code can reach production prematurely. The project needs a staging gate between feature work and production.

This builds on the branching strategy established in [Issue #13 analysis](./13-workflow-branching) (now deprecated), which recommended GitHub Flow. Issue #114 evolves this by adding a `staging` integration branch while keeping `main` as the production-only branch.

## Questions Explored

1. How should the staging branch integrate with the existing Vercel auto-deploy pipeline?
2. Should preview deploys be automatic or on-demand?
3. How should CI (including E2E tests) behave across staging and main?
4. What changes are needed to docs, workflows, and developer tooling?

## Analysis

### Current State

- **Branching**: GitHub Flow — feature branches merge directly to `main`
- **CI**: GitHub Actions runs lint, typecheck, test, build, and E2E on PRs to `main` and pushes to `main`
- **Deploy**: Vercel auto-deploys both web and API on push to `main`; `ignoreCommand` in `vercel.json` blocks Vercel deploys on all other branches
- **Preview**: Manual only via `vercel` CLI from local machine

### Proposed Flow

```
Feature branch → PR to staging → CI (full) → merge
                                                ↓
                        Manual: GitHub Actions "Deploy Preview" → preview URL
                                                ↓
                staging → PR to main → CI (full) → merge → auto-deploy to production
```

**Hotfix path**: `hotfix/*` → PR directly to `main` → auto-deploy.

### Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Preview deploy trigger | Manual only (`workflow_dispatch`) | Keeps staging quiet — avoids unnecessary deploys on every merge |
| Vercel `ignoreCommand` | Unchanged (main only) | GitHub Actions handles previews via CLI; Vercel only auto-deploys production |
| E2E on staging PRs | Yes | Catch regressions before they reach staging; same gates as main |
| CI triggers | PRs to both `staging` and `main` | Full CI coverage at both integration points |

### Preview Deploy Workflow Design

The new `deploy-preview.yml` uses `workflow_dispatch` with an input to select `web`, `api`, or `both`. Each app deploys in parallel using `vercel pull` → `vercel build` → `vercel deploy --prebuilt`. Preview URLs are written to the GitHub Actions step summary.

**Required GitHub secrets** (configured manually post-merge):
- `VERCEL_TOKEN`
- `VERCEL_ORG_ID`
- `VERCEL_PROJECT_ID_WEB`
- `VERCEL_PROJECT_ID_API`

**Concurrency**: One deploy per branch at a time to avoid conflicts.

### Impact on Existing Files

| File | Change Type | Description |
|------|------------|-------------|
| `.github/workflows/ci.yml` | Modify | Add `staging` to PR trigger branches; update E2E condition for staging |
| `.github/workflows/deploy-preview.yml` | **New** | On-demand preview deploy workflow |
| `docs/guides/deployment.mdx` | Modify | Document staging flow, preview deploys, required secrets |
| `docs/processes/dev-process.mdx` | Modify | Update branch bases from `main` to `staging` for worktrees/branches |
| `docs/contributing.mdx` | Modify | Replace GitHub Flow with staging-based flow |
| `CLAUDE.md` | Modify | Update worktree commands to use `staging` base |

### Risks &amp; Mitigations

| Risk | Mitigation |
|------|-----------|
| Developers forget to target staging | Set `staging` as default branch in GitHub settings (post-merge manual step) |
| Staging diverges from main | Regular promotion PRs; staging is always a superset of main |
| Preview deploys fail silently | Preview URLs in step summary; workflow reports errors clearly |
| Hotfix bypasses staging | Documented and intentional — hotfixes need fast path to production |

## Conclusions

The staging branch approach is a pragmatic middle ground between trunk-based development and full environment pipelines. It adds a safety gate without introducing environment complexity (no staging servers, no additional Vercel projects). The on-demand preview deploys via GitHub Actions are sufficient for the current team size and avoid Vercel rate-limiting.

**Tier**: M (6 files, local CI/CD architecture change, no application code changes)

## Next Steps

- Create spec for implementation details → `artifacts/specs/114-staging-environment-preview-deploys.mdx`
- Implement changes (worktree required per Tier M process)
- Post-merge manual steps: push staging branch, set default branch, configure branch protection, add GitHub secrets
