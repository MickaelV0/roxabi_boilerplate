---
title: "Self-Role-Change with Confirmation + Sole-Owner Guard"
description: Analysis of allowing admin self-role-change with confirmation dialog and safety guards to prevent orphaned systems.
---

## Source

From code review finding Q1 on PR #308 (`feat/269-admin-phase2`):

> Currently `SelfActionException` blocks ALL self-actions including self-role-change. The spec says self-role-change should be "allowed with confirmation."

Issue [#311](https://github.com/roxabi/roxabi_boilerplate/issues/311) — parent: #269 (Admin Phase 2).

## Problem

The current `SelfActionException` guard in `AdminUsersService.validateUpdatePermissions` is too broad — it blocks all self-role-changes at the global level. A superadmin should be able to voluntarily step down, but with guardrails to prevent orphaning the system (no remaining superadmins) or leaving organizations without owners.

## Outcome

A superadmin can change their own global role with explicit confirmation, unless doing so would leave zero active superadmins on the platform. The system prevents orphaned platform administration.

## Appetite

1 day — full treatment including edge cases, tests, and UX polish.

## Context

### Current Architecture

**Global roles** (`users.role`): `user` | `superadmin` — managed in `/admin/users/:id`.
**Org roles** (`members.role` + `members.roleId`): `owner` | `admin` | `member` | `viewer` — managed in `/admin/members`.

These are **independent** — changing global role does not cascade to org memberships.

### Existing Guards

| Guard | Location | Behavior |
|-------|----------|----------|
| `SelfActionException` | `adminUsers.service.ts:345` | Blocks ALL self-role-changes (too broad) |
| `SelfActionException` | `adminUsers.lifecycle.ts:38,89` | Blocks self-ban and self-delete (correct) |
| `SelfRoleChangeException` | `AdminMembersService` | Blocks org-level self-role-change (separate concern) |
| `SuperadminProtectionException` | `adminUsers.service.ts:348` | Blocks demoting another superadmin |
| `LastOwnerConstraintException` | `AdminMembersService:291` | Blocks removing last org owner |

### Frontend State

- `EditUserForm` on `/admin/users/:userId` renders a role dropdown (`user` / `superadmin`)
- No confirmation dialog before role change submission
- `ConfirmDialog` component exists in `@repo/ui` (reusable, supports `variant: 'danger' | 'warning' | 'info'`)

## Questions Explored

1. What does "sole-owner guard" mean at the global level?
2. Should the backend block for org ownership or only for last superadmin?
3. What happens to the user's session after self-demotion?
4. How should the confirmation dialog adapt to different scenarios?
5. Should active-only superadmins be counted, or all?

## Analysis

### Guard 1: Last Active Superadmin (Backend)

**Scope:** Global. Prevents the last non-banned, non-deleted superadmin from demoting themselves.

**Count logic:** `SELECT COUNT(*) FROM users WHERE role = 'superadmin' AND banned = false AND deletedAt IS NULL AND id != :actorId`. If count = 0, block with new `LastSuperadminException`.

**Why active-only?** A banned or deleted superadmin can't manage the platform. Counting them as "available" would create a false sense of safety — the system could end up with only inaccessible superadmins.

**New exception:** `LastSuperadminException` with `ErrorCode.LAST_SUPERADMIN`, message: "Cannot demote yourself — you are the last active superadmin."

### Guard 2: Org Owner Warning (Frontend Only)

**Scope:** Org-level. The backend does NOT block self-demotion based on org ownership because:
- Global role and org membership are independent
- Demoting global role does not remove org owner membership
- The user retains org ownership — they just lose admin panel access

**Frontend enrichment:** Before showing the confirmation dialog, the FE fetches the user's org ownerships (from the existing user detail endpoint, which includes org memberships). If the user is an owner in any org, the dialog includes additional context.

### Session Invalidation

After successful self-demotion, **all sessions** for the user are invalidated — not just the current one. This prevents stale admin sessions on other devices.

**Implementation:** Better Auth provides session management. After the role update, call session revocation for the user ID. The user is redirected to login.

### Confirmation Dialog UX

Dynamic `ConfirmDialog` with `variant: 'warning'`:

**Base scenario** (superadmin &rarr; user, no org ownership):
> **Title:** "Change Your Role"
> **Description:** "You are about to change your role from Superadmin to User. You will lose access to the admin panel and will be logged out on all devices. Another superadmin will need to restore your access."

**Org owner scenario** (superadmin &rarr; user, owns orgs):
> **Title:** "Change Your Role"
> **Description:** "You are about to change your role from Superadmin to User. You will lose access to the admin panel and will be logged out on all devices. Another superadmin will need to restore your access.
>
> Note: You are still an owner in {orgNames}. Your organization ownership is not affected, but you won't be able to manage these organizations from the admin panel."

**Blocked scenario** (last superadmin):
> The dialog is NOT shown. Instead, the `superadmin` option in the role dropdown is visually locked — the dropdown remains interactive (user can see available roles) but the current role option shows a lock icon with a tooltip: "You are the last active superadmin and cannot change your role." The save button is not affected — the guard prevents selection, not submission.

### Changes Summary

| Layer | Change | File(s) |
|-------|--------|---------|
| **Backend** | Remove `SelfActionException` for role changes | `adminUsers.service.ts` |
| **Backend** | Add `LastSuperadminException` + counting query | New exception + `adminUsers.service.ts` |
| **Backend** | Invalidate all sessions after self-demotion | `adminUsers.service.ts` |
| **Backend** | Enrich `GET /api/admin/users/:id` response with `isLastActiveSuperadmin: boolean` flag | `adminUsers.service.ts`, `adminUsers.controller.ts` |
| **Frontend** | Add `ConfirmDialog` for self-role-change | `routes/admin/users.$userId.tsx` |
| **Frontend** | Dynamic dialog content based on org ownership | `routes/admin/users.$userId.tsx` |
| **Frontend** | Disable role change if last superadmin | `routes/admin/users.$userId.tsx` |
| **Tests** | Backend: last superadmin guard, session invalidation | `adminUsers.service.test.ts` |
| **Tests** | Backend: self-role-change now allowed | `adminUsers.service.test.ts` |
| **Frontend tests** | Dialog rendering, blocked state | New or existing test file |

### Edge Cases

| Case | Expected Behavior |
|------|-------------------|
| Superadmin demotes self, is last active superadmin | Backend blocks with `LastSuperadminException` |
| Superadmin demotes self, other superadmins exist but are all banned | Backend blocks (counts active only) |
| Superadmin demotes self, other superadmins exist and are active | Allowed with confirmation |
| Superadmin demotes self while being org owner | Allowed — org ownership unaffected. Dialog warns about admin panel access loss. |
| Superadmin changes name/email (not role) on own account | Allowed without confirmation (no guard needed for non-role changes) |
| Superadmin bans/deletes self | Still blocked by `SelfActionException` in lifecycle service (unchanged) |
| Non-superadmin user tries to access admin panel | Route guards (`requireSuperAdmin()`) block access (unchanged) |
| Race condition: two superadmins demote themselves simultaneously | Wrap count query + role update in a serializable transaction (`SET TRANSACTION ISOLATION LEVEL SERIALIZABLE`). The second transaction will fail with a serialization error and should be retried or rejected. |
| Cross-operation race: superadmin A demotes self while superadmin B is being banned | Same serializable transaction protection. Both `updateUser` (demotion) and `banUser` operations must check active superadmin count within the transaction. The ban path in lifecycle service needs the same guard. |
| Superadmin promotes another user to superadmin, then demotes self | Allowed — new superadmin exists |

## Conclusions

1. **Split the guard**: `SelfActionException` stays for ban/delete. Role changes get a new, more nuanced guard (`LastSuperadminException`) that counts only active superadmins.
2. **Frontend drives UX**: Confirmation dialog with dynamic content. Org ownership is a frontend warning only — the backend doesn't block for it.
3. **Session safety**: All sessions invalidated after self-demotion to prevent stale admin access.
4. **Minimal surface area**: ~5-8 files touched, all within the existing admin module. No new abstractions needed.

## Next Steps

- Promote to spec: `artifacts/specs/311-self-role-change-sole-owner-guard.mdx`
- Implementation via `/scaffold --spec 311`
