---
title: "Plan: fix: code and skill gaps found during documentation audit"
issue: 389
spec: artifacts/specs/389-code-skill-gaps-audit.mdx
complexity: 4/10
tier: F-full
generated: "2026-02-27T00:00:00Z"
---

## Summary

Fix three code/skill gaps identified during the documentation audit (#388): the ADR skill's silent `meta.json` data corruption, the `feature-flags.tsx` TanStack Query standards violations, and a misleading TODO comment in the tenant interceptor. Independent slices V1, V2, V4 can run in parallel; V3 depends on V2.

## Bootstrap Context

No analysis artifact (analyze phase skipped). Source: `artifacts/frames/code-skill-gaps-audit.mdx` (F-full, 3 domains).

Reference patterns used:
- `apps/web/src/lib/apiKeys.ts` — established fetch-with-signal pattern
- `apps/web/src/routes/admin/feature-flags.test.tsx` — existing test structure to preserve
- `docs/standards/frontend-patterns.mdx §1.7` — queryOptions + useMutation canonical patterns

## Agents

| Agent | Task count | Files |
|-------|-----------|-------|
| doc-writer | 2 | `.claude/skills/adr/SKILL.md` |
| tester | 4 | `apps/web/src/lib/featureFlags/queryKeys.test.ts`, `apps/web/src/lib/featureFlags/queries.test.ts`, `apps/web/src/routes/admin/feature-flags.test.tsx` |
| frontend-dev | 6 | `apps/web/src/lib/featureFlags/queryKeys.ts`, `apps/web/src/lib/featureFlags/queries.ts`, `apps/web/src/routes/admin/feature-flags.tsx` |
| backend-dev | 1 | `apps/api/src/tenant/tenant.interceptor.ts` |

## Consistency Report

- Criteria covered: 9/9
- Uncovered criteria: none
- Tasks without spec backing: none
- Gold plating exemptions applied: 0

## Micro-Tasks

### Slice V1: ADR skill meta.json fix

#### Task 1: Update "Update meta.json" step to use Fumadocs { title, pages } format → doc-writer
- **File:** `.claude/skills/adr/SKILL.md`
- **Snippet:**
  ```markdown
  #### 5. Update meta.json

  Read `docs/architecture/adr/meta.json` if it exists. If it does not exist, create it with:
  ```json
  { "title": "ADRs", "pages": [] }
  ```

  The file uses the Fumadocs navigation format — a plain object with a `pages` array of slugs:
  ```json
  { "title": "ADRs", "pages": ["001-fastify-over-express", "002-bun-as-runtime"] }
  ```

  Append the new ADR slug (filename without `.mdx`) to the `pages` array and write the updated object back, preserving `title` and all existing entries.
  ```
- **Verify:** `grep -q '"pages"' .claude/skills/adr/SKILL.md` (ready)
- **Expected:** exit 0
- **Time:** 3 min
- **Difficulty:** 2
- **Traces:** SC-1, SC-2, SC-3
- **Phase:** GREEN

#### Task 2: Update "List Mode" section to parse Fumadocs { title, pages } format → doc-writer
- **File:** `.claude/skills/adr/SKILL.md`
- **Snippet:** In the List Mode section, update the `meta.json` schema documentation to show `{ "title": "ADRs", "pages": ["001-slug", ...] }` instead of the array-of-objects format. Note that List Mode falls back to reading frontmatter from each `.mdx` file if `meta.json` is missing or uses the old format.
- **Verify:** `grep -c '"pages"' .claude/skills/adr/SKILL.md` (ready)
- **Expected:** ≥2 (both Create and List Mode sections reference the pages format)
- **Time:** 2 min
- **Difficulty:** 1
- **Traces:** SC-3
- **Phase:** GREEN

#### RED-GATE: V1 complete → verify SKILL.md updated
- **Verify:** `grep -q '"pages"' .claude/skills/adr/SKILL.md && grep -qv '"number":' .claude/skills/adr/SKILL.md || echo "FAIL"`
- **Expected:** no output (old number field removed from schema docs)
- **Phase:** RED-GATE

---

### Slice V2: Feature flags query infrastructure

#### Task 3: Write test skeleton for featureFlagKeys factory [P] → tester
- **File:** `apps/web/src/lib/featureFlags/queryKeys.test.ts` *(create)*
- **Snippet:**
  ```ts
  import { describe, expect, it } from 'vitest'
  import { featureFlagKeys } from './queryKeys'

  describe('featureFlagKeys', () => {
    it('all key is the root', () => {
      expect(featureFlagKeys.all).toEqual(['feature-flags'])
    })
    it('list() starts from all', () => {
      expect(featureFlagKeys.list()).toEqual([...featureFlagKeys.all, 'list'])
    })
  })
  ```
- **Verify:** `bun run test apps/web/src/lib/featureFlags/queryKeys.test.ts 2>&1 | grep -q "Cannot find module"` (ready)
- **Expected:** exit 0 — import fails before impl (expected RED)
- **Time:** 3 min
- **Difficulty:** 1
- **Traces:** SC-4, SC-7
- **Phase:** RED

#### Task 4: Write test skeleton for featureFlagQueries.list() factory [P] → tester
- **File:** `apps/web/src/lib/featureFlags/queries.test.ts` *(create)*
- **Snippet:**
  ```ts
  import { describe, expect, it } from 'vitest'
  import { featureFlagKeys } from './queryKeys'
  import { featureFlagQueries } from './queries'

  describe('featureFlagQueries', () => {
    it('list() returns queryOptions with correct queryKey', () => {
      const opts = featureFlagQueries.list()
      expect(opts.queryKey).toEqual(featureFlagKeys.list())
    })
    it('list() queryFn passes signal to fetch', async () => {
      const fetchSpy = vi.fn().mockResolvedValue({ ok: true, json: () => Promise.resolve([]) })
      globalThis.fetch = fetchSpy
      const controller = new AbortController()
      await featureFlagQueries.list().queryFn({ signal: controller.signal } as never)
      expect(fetchSpy).toHaveBeenCalledWith(
        '/api/admin/feature-flags',
        expect.objectContaining({ signal: controller.signal })
      )
    })
  })
  ```
- **Verify:** `bun run test apps/web/src/lib/featureFlags/queries.test.ts 2>&1 | grep -q "Cannot find module"` (ready)
- **Expected:** exit 0 — import fails before impl (expected RED)
- **Time:** 4 min
- **Difficulty:** 2
- **Traces:** SC-4, SC-5
- **Phase:** RED

#### Task 5: Create featureFlagKeys factory → frontend-dev
- **File:** `apps/web/src/lib/featureFlags/queryKeys.ts` *(create)*
- **Snippet:**
  ```ts
  export const featureFlagKeys = {
    all: ['feature-flags'] as const,
    list: () => [...featureFlagKeys.all, 'list'] as const,
  } as const
  ```
- **Verify:** `bun run test apps/web/src/lib/featureFlags/queryKeys.test.ts 2>&1 | grep -q "PASS"` (ready)
- **Expected:** PASS
- **Time:** 3 min
- **Difficulty:** 1
- **Traces:** SC-4, SC-7
- **Phase:** GREEN

#### Task 6: Create featureFlagQueries.list() factory with signal → frontend-dev
- **File:** `apps/web/src/lib/featureFlags/queries.ts` *(create)*
- **Snippet:**
  ```ts
  import { queryOptions } from '@tanstack/react-query'
  import type { FeatureFlag } from '@repo/types'
  import { featureFlagKeys } from './queryKeys'

  export const featureFlagQueries = {
    list: () =>
      queryOptions({
        queryKey: featureFlagKeys.list(),
        queryFn: async ({ signal }): Promise<FeatureFlag[]> => {
          const res = await fetch('/api/admin/feature-flags', {
            credentials: 'include',
            signal,
          })
          if (!res.ok) throw new Error('Failed to fetch feature flags')
          return res.json()
        },
      }),
  }
  ```
- **Verify:** `bun run test apps/web/src/lib/featureFlags/queries.test.ts 2>&1 | grep -q "PASS"` (ready)
- **Expected:** PASS
- **Time:** 4 min
- **Difficulty:** 2
- **Traces:** SC-4, SC-5
- **Phase:** GREEN

#### RED-GATE: V2 RED complete → tester
- **Verify:** `bun run test apps/web/src/lib/featureFlags/ 2>&1 | grep -q "PASS"`
- **Phase:** RED-GATE

---

### Slice V3: Feature flags component migration (depends on V2)

#### Task 7: Replace inline useQuery with featureFlagQueries.list() → frontend-dev
- **File:** `apps/web/src/routes/admin/feature-flags.tsx`
- **Snippet:**
  ```ts
  // Remove:
  // const FEATURE_FLAGS_QUERY_KEY = ['admin', 'feature-flags'] as const

  // Add import:
  import { featureFlagQueries } from '@/lib/featureFlags/queries'

  // In FeatureFlagsPage:
  const { data, isLoading, isError } = useQuery(featureFlagQueries.list())
  ```
- **Verify:** `grep -qv 'FEATURE_FLAGS_QUERY_KEY' apps/web/src/routes/admin/feature-flags.tsx` (ready)
- **Expected:** exit 0
- **Time:** 3 min
- **Difficulty:** 2
- **Traces:** SC-4, SC-7
- **Phase:** GREEN

#### Task 8: Add useToggleFeatureFlag useMutation hook → frontend-dev
- **File:** `apps/web/src/routes/admin/feature-flags.tsx`
- **Snippet:**
  ```ts
  import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'
  import { featureFlagKeys } from '@/lib/featureFlags/queryKeys'

  function useToggleFeatureFlag() {
    const queryClient = useQueryClient()
    return useMutation({
      mutationFn: async ({ id, enabled }: { id: string; enabled: boolean }) => {
        const res = await fetch(`/api/admin/feature-flags/${id}`, {
          method: 'PATCH',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled }),
        })
        if (!res.ok) {
          const body: unknown = await res.json().catch(() => null)
          throw new Error(isErrorWithMessage(body) ? body.message : 'Failed to update feature flag')
        }
        return res.json()
      },
      onSuccess: () => queryClient.invalidateQueries({ queryKey: featureFlagKeys.list() }),
      onError: (err: Error) => toast.error(err.message),
    })
  }
  ```
- **Verify:** `grep -q 'useToggleFeatureFlag' apps/web/src/routes/admin/feature-flags.tsx` (ready)
- **Expected:** exit 0
- **Time:** 5 min
- **Difficulty:** 3
- **Traces:** SC-6, SC-7
- **Phase:** GREEN

#### Task 9: Add useDeleteFeatureFlag useMutation hook → frontend-dev
- **File:** `apps/web/src/routes/admin/feature-flags.tsx`
- **Snippet:**
  ```ts
  function useDeleteFeatureFlag() {
    const queryClient = useQueryClient()
    return useMutation({
      mutationFn: async (id: string) => {
        const res = await fetch(`/api/admin/feature-flags/${id}`, {
          method: 'DELETE',
          credentials: 'include',
        })
        if (!res.ok) {
          const body: unknown = await res.json().catch(() => null)
          throw new Error(isErrorWithMessage(body) ? body.message : 'Failed to delete feature flag')
        }
      },
      onSuccess: () => {
        toast.success('Feature flag deleted')
        queryClient.invalidateQueries({ queryKey: featureFlagKeys.list() })
      },
      onError: (err: Error) => toast.error(err.message),
    })
  }
  ```
- **Verify:** `grep -q 'useDeleteFeatureFlag' apps/web/src/routes/admin/feature-flags.tsx` (ready)
- **Expected:** exit 0
- **Time:** 4 min
- **Difficulty:** 3
- **Traces:** SC-6, SC-7
- **Phase:** GREEN

#### Task 10: Remove useFeatureFlagActions, wire mutation hooks in FeatureFlagsPage → frontend-dev
- **File:** `apps/web/src/routes/admin/feature-flags.tsx`
- **Snippet:**
  ```ts
  // Remove entire useFeatureFlagActions function

  // In FeatureFlagsPage, replace:
  // const { handleToggle, handleDelete, handleCreated } = useFeatureFlagActions()
  // With:
  const toggleMutation = useToggleFeatureFlag()
  const deleteMutation = useDeleteFeatureFlag()

  // FlagListItem:
  onToggle={(id, enabled) => toggleMutation.mutate({ id, enabled })}
  onDelete={(id) => deleteMutation.mutate(id)}

  // CreateFlagDialog.onCreated — inline invalidation via queryClient:
  const queryClient = useQueryClient()
  // onCreated={() => queryClient.invalidateQueries({ queryKey: featureFlagKeys.list() })}
  ```
- **Verify:** `grep -qv 'useFeatureFlagActions' apps/web/src/routes/admin/feature-flags.tsx` (ready)
- **Expected:** exit 0
- **Time:** 5 min
- **Difficulty:** 2
- **Traces:** SC-6, SC-7
- **Phase:** GREEN

#### Task 11: Update beforeLoad to async function with guard-then-ensureQueryData → frontend-dev
- **File:** `apps/web/src/routes/admin/feature-flags.tsx`
- **Snippet:**
  ```ts
  export const Route = createFileRoute('/admin/feature-flags')({
    staticData: { permission: 'role:superadmin' },
    beforeLoad: async (ctx) => {
      await enforceRoutePermission(ctx)
      await ctx.context.queryClient.ensureQueryData(featureFlagQueries.list())
    },
    component: FeatureFlagsPage,
    head: () => ({ meta: [{ title: 'Feature Flags | Admin | Roxabi' }] }),
  })
  ```
- **Verify:** `grep -q 'ensureQueryData' apps/web/src/routes/admin/feature-flags.tsx` (ready)
- **Expected:** exit 0
- **Time:** 3 min
- **Difficulty:** 2
- **Traces:** SC-8
- **Phase:** GREEN

#### Task 12: Verify existing tests pass and add beforeLoad coverage → tester
- **File:** `apps/web/src/routes/admin/feature-flags.test.tsx`
- **Snippet:** Run existing tests; if passing, add one test that verifies `beforeLoad` calls `enforceRoutePermission` and `ensureQueryData`:
  ```ts
  it('beforeLoad calls enforceRoutePermission then ensureQueryData', async () => {
    const mockEnsureQueryData = vi.fn().mockResolvedValue([])
    const ctx = {
      context: { queryClient: { ensureQueryData: mockEnsureQueryData } },
    }
    const { enforceRoutePermission } = await import('@/lib/routePermissions')
    await Route.options.beforeLoad(ctx as never)
    expect(enforceRoutePermission).toHaveBeenCalledWith(ctx)
    expect(mockEnsureQueryData).toHaveBeenCalled()
  })
  ```
- **Verify:** `bun run test apps/web/src/routes/admin/feature-flags.test.tsx 2>&1 | grep -q "PASS"` (ready)
- **Expected:** PASS — all existing tests still green + new beforeLoad test passes
- **Time:** 8 min
- **Difficulty:** 3
- **Traces:** SC-8
- **Phase:** GREEN

#### RED-GATE: V3 complete → tester
- **Verify:** `bun run test apps/web/src/routes/admin/feature-flags.test.tsx apps/web/src/lib/featureFlags/ 2>&1 | grep -q "PASS"`
- **Phase:** RED-GATE

---

### Slice V4: Tenant interceptor deferral comment

#### Task 13: Update resolveParentOrg() TODO with Phase 3 + #389 reference → backend-dev
- **File:** `apps/api/src/tenant/tenant.interceptor.ts`
- **Snippet:**
  ```ts
  // TODO(Phase 3, #389): Parent tenant resolution is formally deferred.
  // parentOrganizationId is present in the schema but the resolution
  // strategy (which context should inherit which tenant) is not yet designed.
  // Track: https://github.com/MickaelV0/roxabi_boilerplate/issues/389
  ```
- **Verify:** `grep -q '#389' apps/api/src/tenant/tenant.interceptor.ts` (ready)
- **Expected:** exit 0
- **Time:** 2 min
- **Difficulty:** 1
- **Traces:** SC-9
- **Phase:** GREEN

#### RED-GATE: V4 complete → verify
- **Verify:** `grep -q 'Phase 3' apps/api/src/tenant/tenant.interceptor.ts && grep -q '#389' apps/api/src/tenant/tenant.interceptor.ts`
- **Phase:** RED-GATE
