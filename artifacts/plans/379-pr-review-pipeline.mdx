---
title: "Plan: Automated PR Review & Auto-fix Pipeline"
issue: 379
spec: artifacts/specs/379-pr-review-pipeline.mdx
complexity: 3/10
tier: F-lite
generated: 2026-02-26T00:00:00Z
revised: 2026-02-26T00:00:00Z
---

## Summary

Create a single GitHub Actions workflow that uses `anthropics/claude-code-action@v1` with `CLAUDE_CODE_OAUTH_TOKEN`
to automatically review PRs, commit auto-fixes, and post a structured comment — no custom tooling required.

## Bootstrap Context

Key patterns from codebase:
- `.github/workflows/ci.yml` — `actions/checkout@v4`, `oven-sh/setup-bun@v2`, `bun install --frozen-lockfile`, `timeout-minutes`
- `.github/workflows/auto-merge.yml` — `gh pr comment`, `GH_TOKEN` env var, concurrency group pattern
- `bun run lint:fix` + `bun run format` — Biome-based, safe to run in CI

## Agents

| Agent | Tasks | Files |
|-------|-------|-------|
| devops | 4 | `.github/workflows/pr-review.yml` |
| tester | 1 | `tools/pr-review.test.ts` |

## Consistency Report

- Covered: 9/9 success criteria, 8/8 breadboard nodes
- Uncovered: none

---

## Micro-Tasks

### Slice V1: Workflow skeleton

#### Task V1.1: Create `.github/workflows/pr-review.yml` — triggers, concurrency, fork guard, permissions → devops
- **File:** `.github/workflows/pr-review.yml`
- **Snippet:**
  ```yaml
  name: PR Review & Auto-fix
  on:
    pull_request:
      types: [opened, synchronize]
      branches: [main, staging]

  permissions:
    contents: write
    pull-requests: write
    issues: read
    id-token: write

  concurrency:
    group: pr-review-${{ github.event.pull_request.number }}
    cancel-in-progress: true

  jobs:
    review:
      name: Review & Auto-fix
      runs-on: ubuntu-latest
      timeout-minutes: 15
      if: github.event.pull_request.head.repo.full_name == github.repository
  ```
- **Verify:** `test -f .github/workflows/pr-review.yml && grep -q 'cancel-in-progress: true' .github/workflows/pr-review.yml`
- **Expected:** file exists with correct concurrency, fork guard, and `contents: write` permission
- **Time:** 5 min | **Difficulty:** 2
- **Traces:** N1, N2, N3 → SC-5, SC-6

#### Task V1.2: Add preflight size check (> 2000 diff lines → warning + skip) + checkout → devops
- **File:** `.github/workflows/pr-review.yml`
- **Snippet:**
  ```yaml
      steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Preflight — check PR size
          id: preflight
          run: |
            LINES=$(gh pr diff "$PR_NUMBER" | wc -l)
            if [ "$LINES" -gt 2000 ]; then
              gh pr comment "$PR_NUMBER" \
                --body "<!-- reviewed-by-claude -->⚠️ PR too large for automated review (${LINES} diff lines > 2000). Run \`/review\` manually."
              echo "skip=true" >> "$GITHUB_OUTPUT"
            fi
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            PR_NUMBER: ${{ github.event.pull_request.number }}
  ```
- **Verify:** `grep -q 'skip=true' .github/workflows/pr-review.yml`
- **Expected:** preflight step outputs `skip=true` for large PRs
- **Time:** 3 min | **Difficulty:** 1
- **Traces:** N4 → large PR edge case

#### RED-GATE V1: File exists, fork guard and concurrency verified

---

### Slice V2: Claude action + auth + fallback

#### Task V2.1: Add `claude-code-action@v1` step with OAuth token, sticky comment, commit signing → devops
- **File:** `.github/workflows/pr-review.yml`
- **Snippet:**
  ```yaml
        - name: Review & Auto-fix
          if: steps.preflight.outputs.skip != 'true'
          uses: anthropics/claude-code-action@v1
          with:
            claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
            use_sticky_comment: true
            use_commit_signing: true
            prompt: |
              # PR Review & Auto-fix for PR #${{ github.event.pull_request.number }}

              **Step 1 — Review**
              Review the PR diff thoroughly. Identify bugs, security issues, style violations,
              type errors, and anything that deviates from the project coding standards
              (single quotes, no semicolons, trailing commas es5, 2-space indent, 100-char width).

              **Step 2 — Auto-fix**
              Fix issues you can address safely without changing logic or behaviour:
              - Run `bun run lint:fix && bun run format` to fix Biome violations
              - Fix simple type annotations and obvious safe corrections
              If you made any changes, commit them with:
              `fix(review): automated fixes [skip ci]`
              If nothing to fix, skip the commit.

              **Step 3 — Post comment**
              Post a PR comment in exactly this format:

              ```
              <!-- reviewed-by-claude -->
              ## Automated Review

              ### ✅ Auto-fixed
              - `path/to/file.ts` — description
              _(or "Nothing to auto-fix")_

              ### ⚠️ Manual action needed
              - `path/to/file.ts:42` — description
              _(or "No manual action needed")_

              _Reviewed commit: ${{ github.sha }}_
              ```
  ```
- **Verify:** `grep -q 'claude_code_oauth_token' .github/workflows/pr-review.yml && grep -q 'use_sticky_comment: true' .github/workflows/pr-review.yml && grep -q 'skip ci' .github/workflows/pr-review.yml`
- **Expected:** action step with OAuth auth, sticky comment, commit signing, and `[skip ci]` in prompt
- **Time:** 10 min | **Difficulty:** 3
- **Traces:** N5, N6, N7 → SC-1, SC-2, SC-3, SC-4, SC-9

#### Task V2.2: Add fallback step when action fails → devops
- **File:** `.github/workflows/pr-review.yml`
- **Snippet:**
  ```yaml
        - name: Post fallback comment on failure
          if: failure()
          run: |
            gh pr comment "$PR_NUMBER" \
              --body "<!-- reviewed-by-claude -->⚠️ Automated review could not complete. Please run \`/review\` manually."
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            PR_NUMBER: ${{ github.event.pull_request.number }}
  ```
- **Verify:** `grep -q "if: failure()" .github/workflows/pr-review.yml`
- **Expected:** fallback step runs on job failure only, posts error comment
- **Time:** 3 min | **Difficulty:** 1
- **Traces:** N8 → SC-8

#### RED-GATE V2: Full workflow complete — open a test PR to confirm action runs

---

### Slice V3: Tests

#### Task V3.1: Write tests for workflow YAML correctness → tester
- **File:** `tools/pr-review.test.ts`
- **Snippet:**
  ```ts
  import { describe, it, expect } from 'vitest'
  import { readFileSync } from 'node:fs'
  import { parse } from 'yaml'

  describe('pr-review.yml', () => {
    const wf = parse(readFileSync('.github/workflows/pr-review.yml', 'utf-8'))
    const job = wf.jobs.review

    it('has fork guard', () => {
      expect(job.if).toContain('head.repo.full_name == github.repository')
    })
    it('has cancel-in-progress concurrency', () => {
      expect(wf.concurrency['cancel-in-progress']).toBe(true)
    })
    it('has contents:write permission for auto-fix commits', () => {
      expect(wf.permissions.contents).toBe('write')
    })
    it('has id-token:write for OIDC commit signing', () => {
      expect(wf.permissions['id-token']).toBe('write')
    })
    it('uses OAuth token auth', () => {
      const step = job.steps.find((s: { uses?: string }) => s.uses?.startsWith('anthropics/claude-code-action'))
      expect(step.with.claude_code_oauth_token).toContain('CLAUDE_CODE_OAUTH_TOKEN')
    })
    it('has [skip ci] in prompt to prevent re-trigger loop', () => {
      const step = job.steps.find((s: { uses?: string }) => s.uses?.startsWith('anthropics/claude-code-action'))
      expect(step.with.prompt).toContain('[skip ci]')
    })
  })
  ```
- **Verify:** `bun run test tools/pr-review.test.ts`
- **Expected:** all 6 assertions pass
- **Time:** 5 min | **Difficulty:** 1
- **Traces:** N1, N2, N3, N5, N6 → SC-3, SC-4, SC-5, SC-6

#### RED-GATE V3: Tests green

---

## Setup Prerequisite (manual — not a code task)

A repo admin must run `claude setup-token` locally and add the output as a GitHub repository secret named `CLAUDE_CODE_OAUTH_TOKEN`.
Document this requirement in the PR description.
