---
title: "Plan: Feature Flags Admin Page + Backend with Cache"
issue: 359
spec: artifacts/specs/359-feature-flags-admin-page.mdx
complexity: 5
tier: F-lite
generated: "2026-02-26T00:00:00Z"
---

## Summary

Add admin CRUD controller for feature flags wrapping the existing `FeatureFlagService` (which already has write-through cache), plus a frontend page with toggle switches, create dialog, delete confirmation, and sidebar nav activation. Three custom exceptions integrate into the existing `AdminExceptionFilter`.

## Agents

| Agent | Task count | Files |
|-------|-----------|-------|
| backend-dev | 6 | `apps/api/src/common/errorCodes.ts`, `packages/types/src/admin.ts`, `apps/api/src/admin/exceptions/flagNotFound.exception.ts`, `apps/api/src/admin/exceptions/flagKeyConflict.exception.ts`, `apps/api/src/admin/exceptions/flagKeyInvalid.exception.ts`, `apps/api/src/admin/filters/adminException.filter.ts`, `apps/api/src/admin/adminFeatureFlags.controller.ts`, `apps/api/src/admin/admin.module.ts` |
| frontend-dev | 4 | `apps/web/src/routes/admin/feature-flags.tsx`, `apps/web/src/components/admin/flag-list-item.tsx`, `apps/web/src/components/admin/create-flag-dialog.tsx`, `apps/web/src/routes/admin.tsx` |
| tester | 3 | `apps/api/src/admin/adminFeatureFlags.controller.test.ts`, `apps/web/src/routes/admin/feature-flags.test.tsx`, `apps/web/src/components/admin/create-flag-dialog.test.tsx` |

## Consistency Report

- Criteria covered: 10/10
- Uncovered criteria: none
- Tasks without spec backing: none
- Gold plating exemptions applied: 0

## Reference Patterns

- Controller: `apps/api/src/admin/adminSettings.controller.ts` (decorators, audit logging)
- Exception: `apps/api/src/admin/exceptions/settingNotFound.exception.ts` (Error subclass + errorCode)
- Filter: `apps/api/src/admin/filters/adminException.filter.ts` (union type + @Catch + status mapping)
- Service: `apps/api/src/feature-flags/featureFlags.service.ts` (already has CRUD + cache)
- Frontend page: `apps/web/src/routes/admin/system-settings.tsx` (query, empty state, skeleton)
- Sidebar: `apps/web/src/routes/admin.tsx:72-76` (disabled flag link)
- Types: `packages/types/src/admin.ts:149-165` (FeatureFlag, CreateFeatureFlagPayload)

## Micro-Tasks

### Criteria SC-9: All endpoints use @Roles('superadmin') with @SkipOrg() + SC-10: All mutations produce audit log entries

#### Task 1: Add feature flag error codes and UpdateFeatureFlagPayload type [P] -> backend-dev
- **File:** `apps/api/src/common/errorCodes.ts`, `packages/types/src/admin.ts`
- **Snippet:** `FEATURE_FLAG_NOT_FOUND: 'FEATURE_FLAG_NOT_FOUND', FEATURE_FLAG_KEY_CONFLICT: 'FEATURE_FLAG_KEY_CONFLICT', FEATURE_FLAG_KEY_INVALID: 'FEATURE_FLAG_KEY_INVALID'` + `export type UpdateFeatureFlagPayload = { name?: string; description?: string; enabled?: boolean }`
- **Verify:** `grep -q 'FEATURE_FLAG_NOT_FOUND' apps/api/src/common/errorCodes.ts && grep -q 'UpdateFeatureFlagPayload' packages/types/src/admin.ts` (ready)
- **Expected:** Error codes and type exist
- **Time:** 3 min | **Difficulty:** 1
- **Traces:** SC-9, SC-10
- **Phase:** GREEN

#### Task 2: Create FlagNotFoundException [P] -> backend-dev
- **File:** `apps/api/src/admin/exceptions/flagNotFound.exception.ts`
- **Snippet:** `export class FlagNotFoundException extends Error { static readonly errorCode = ErrorCode.FEATURE_FLAG_NOT_FOUND; readonly errorCode = FlagNotFoundException.errorCode; constructor(id: string) { super(\`Feature flag "${id}" not found\`); this.name = 'FlagNotFoundException' } }`
- **Verify:** `grep -q 'FlagNotFoundException' apps/api/src/admin/exceptions/flagNotFound.exception.ts` (ready)
- **Expected:** Exception class exists with errorCode
- **Time:** 2 min | **Difficulty:** 1
- **Traces:** SC-3, SC-4
- **Phase:** GREEN

#### Task 3: Create FlagKeyConflictException and FlagKeyInvalidException [P] -> backend-dev
- **File:** `apps/api/src/admin/exceptions/flagKeyConflict.exception.ts`, `apps/api/src/admin/exceptions/flagKeyInvalid.exception.ts`
- **Snippet:** `export class FlagKeyConflictException extends Error { ... }` + `export class FlagKeyInvalidException extends Error { ... }`
- **Verify:** `grep -q 'FlagKeyConflictException' apps/api/src/admin/exceptions/flagKeyConflict.exception.ts && grep -q 'FlagKeyInvalidException' apps/api/src/admin/exceptions/flagKeyInvalid.exception.ts` (ready)
- **Expected:** Both exception classes exist
- **Time:** 3 min | **Difficulty:** 1
- **Traces:** SC-2
- **Phase:** GREEN

#### Task 4: Register exceptions in AdminExceptionFilter -> backend-dev
- **File:** `apps/api/src/admin/filters/adminException.filter.ts`
- **Snippet:** Add imports + union type entries + @Catch entries + status mappings: FlagNotFoundException -> NOT_FOUND, FlagKeyConflictException -> CONFLICT, FlagKeyInvalidException -> BAD_REQUEST
- **Verify:** `grep -q 'FlagNotFoundException' apps/api/src/admin/filters/adminException.filter.ts` (ready)
- **Expected:** All three exceptions registered in filter
- **Time:** 3 min | **Difficulty:** 2
- **Traces:** SC-2, SC-3, SC-4
- **Phase:** GREEN

#### Task 5: Create AdminFeatureFlagsController (full CRUD + Zod validation + audit logging) -> backend-dev
- **File:** `apps/api/src/admin/adminFeatureFlags.controller.ts`
- **Snippet:** `@ApiTags('Admin Feature Flags') @ApiBearerAuth() @UseFilters(AdminExceptionFilter) @Throttle({ global: { ttl: 60_000, limit: 30 } }) @Roles('superadmin') @SkipOrg() @Controller('api/admin/feature-flags') export class AdminFeatureFlagsController { constructor(private readonly featureFlagService: FeatureFlagService, private readonly auditService: AuditService) {} @Get() getAll() { ... } @Post() create(@Session() session, @Body() body) { ... key validation, duplicate check, auditService.log(flag.created) } @Patch(':id') update(@Session() session, @Param('id') id, @Body() body) { ... auditService.log(flag.toggled or flag.updated) } @Delete(':id') delete(@Session() session, @Param('id') id) { ... auditService.log(flag.deleted) } }`
- **Verify:** `bun run typecheck --filter=@repo/api` (deferred)
- **Expected:** Controller compiles, all CRUD endpoints wired
- **Time:** 8 min | **Difficulty:** 3
- **Traces:** SC-1, SC-2, SC-3, SC-4, SC-6, SC-9, SC-10
- **Phase:** GREEN

#### Task 6: Register controller and FeatureFlagsModule in AdminModule -> backend-dev
- **File:** `apps/api/src/admin/admin.module.ts`
- **Snippet:** Add `FeatureFlagsModule` to imports, `AdminFeatureFlagsController` to controllers
- **Verify:** `grep -q 'AdminFeatureFlagsController' apps/api/src/admin/admin.module.ts && grep -q 'FeatureFlagsModule' apps/api/src/admin/admin.module.ts` (ready)
- **Expected:** Module imports and controller registration present
- **Time:** 2 min | **Difficulty:** 1
- **Traces:** SC-1, SC-9
- **Phase:** GREEN

### Criteria SC-5: Empty state when no flags exist + SC-7: Delete confirmation dialog + SC-8: Sidebar nav

#### Task 7: Create feature-flags.tsx route page (list + empty state + loading skeleton) -> frontend-dev
- **File:** `apps/web/src/routes/admin/feature-flags.tsx`
- **Snippet:** `createFileRoute('/admin/feature-flags')({ staticData: { permission: 'role:superadmin' }, beforeLoad: enforceRoutePermission, component: FeatureFlagsPage }) function FeatureFlagsPage() { useQuery({ queryKey: ['admin', 'feature-flags'], queryFn: ... }) ... EmptyState + Skeleton + FlagListItem map }`
- **Verify:** `grep -q "createFileRoute('/admin/feature-flags')" apps/web/src/routes/admin/feature-flags.tsx` (ready)
- **Expected:** Route file with query, empty state, and loading skeleton
- **Time:** 8 min | **Difficulty:** 3
- **Traces:** SC-1, SC-5
- **Phase:** GREEN

#### Task 8: Create flag-list-item.tsx component (toggle switch + delete action) -> frontend-dev
- **File:** `apps/web/src/components/admin/flag-list-item.tsx`
- **Snippet:** `export function FlagListItem({ flag, onToggle, onDelete }: { flag: FeatureFlag; onToggle: (id: string, enabled: boolean) => Promise<void>; onDelete: (id: string) => Promise<void> }) { ... Switch component for toggle, Button for delete with AlertDialog confirmation showing safe-default warning }`
- **Verify:** `grep -q 'FlagListItem' apps/web/src/components/admin/flag-list-item.tsx` (ready)
- **Expected:** Component with toggle switch and delete confirmation dialog
- **Time:** 6 min | **Difficulty:** 3
- **Traces:** SC-6, SC-7
- **Phase:** GREEN

#### Task 9: Create create-flag-dialog.tsx component (key validation + form) -> frontend-dev
- **File:** `apps/web/src/components/admin/create-flag-dialog.tsx`
- **Snippet:** `export function CreateFlagDialog({ onCreated }: { onCreated: () => void }) { ... Dialog with form: key (regex validation /^[a-z0-9][a-z0-9_-]*$/, max 100), name (required), description (optional). POST to /api/admin/feature-flags, invalidate queries on success }`
- **Verify:** `grep -q 'CreateFlagDialog' apps/web/src/components/admin/create-flag-dialog.tsx` (ready)
- **Expected:** Dialog component with key validation
- **Time:** 6 min | **Difficulty:** 3
- **Traces:** SC-2
- **Phase:** GREEN

#### Task 10: Enable "Feature Flags" sidebar nav item -> frontend-dev
- **File:** `apps/web/src/routes/admin.tsx`
- **Snippet:** Remove `disabled: true` from feature-flags entry in SYSTEM_LINKS (line 76)
- **Verify:** `grep -A2 'feature-flags' apps/web/src/routes/admin.tsx | grep -v 'disabled'` (ready)
- **Expected:** Feature flags nav item is enabled (no disabled property)
- **Time:** 2 min | **Difficulty:** 1
- **Traces:** SC-8
- **Phase:** GREEN

### Tests

#### Task 11: Write AdminFeatureFlagsController unit tests -> tester
- **File:** `apps/api/src/admin/adminFeatureFlags.controller.test.ts`
- **Snippet:** `describe('AdminFeatureFlagsController', () => { it('GET returns all flags ordered by createdAt DESC') it('POST creates flag with valid key') it('POST rejects duplicate key with 400') it('POST rejects invalid key format with 400') it('PATCH updates name/description/enabled, rejects key in body') it('DELETE removes flag and logs audit') it('all endpoints require superadmin role') })`
- **Verify:** `grep -q 'AdminFeatureFlagsController' apps/api/src/admin/adminFeatureFlags.controller.test.ts` (ready)
- **Expected:** Test file with describe/it blocks covering all CRUD + validation + audit
- **Time:** 8 min | **Difficulty:** 3
- **Traces:** SC-1, SC-2, SC-3, SC-4, SC-6, SC-9, SC-10
- **Phase:** RED

#### Task 12: Write feature-flags page component tests -> tester
- **File:** `apps/web/src/routes/admin/feature-flags.test.tsx`
- **Snippet:** `describe('FeatureFlagsPage', () => { it('shows empty state when no flags') it('renders flag list with toggle switches') it('toggle switch calls PATCH endpoint') it('delete shows confirmation dialog with safe-default warning') })`
- **Verify:** `grep -q 'FeatureFlagsPage' apps/web/src/routes/admin/feature-flags.test.tsx` (ready)
- **Expected:** Test file with describe/it blocks
- **Time:** 5 min | **Difficulty:** 2
- **Traces:** SC-5, SC-6, SC-7
- **Phase:** RED

#### Task 13: Write create-flag-dialog component tests -> tester
- **File:** `apps/web/src/components/admin/create-flag-dialog.test.tsx`
- **Snippet:** `describe('CreateFlagDialog', () => { it('validates key format') it('rejects keys over 100 chars') it('submits valid form to POST endpoint') it('shows API error on duplicate key') })`
- **Verify:** `grep -q 'CreateFlagDialog' apps/web/src/components/admin/create-flag-dialog.test.tsx` (ready)
- **Expected:** Test file with describe/it blocks
- **Time:** 5 min | **Difficulty:** 2
- **Traces:** SC-2
- **Phase:** RED
