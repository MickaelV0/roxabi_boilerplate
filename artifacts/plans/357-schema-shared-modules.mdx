---
title: "Plan: Schema + Shared Modules for System Settings & Feature Flags"
issue: 357
spec: artifacts/specs/357-schema-shared-modules-settings-flags.mdx
complexity: 5/10
tier: F-lite
generated: 2026-02-25T00:00:00Z
---

## Summary

Implement V1 (foundation slice) for admin Phase 3: two global DB tables (`system_settings`, `feature_flags`), shared NestJS modules with services, shared types, seed migration, and seed fixture.

## Bootstrap Context

From [Admin Phase 3 Analysis](../../artifacts/analyses/270-admin-phase3-system-settings-feature-flags.mdx): global key-value settings + boolean feature flags for super admins, with shared services consumable by any module.

## Agents

| Agent | Tasks | Files |
|-------|-------|-------|
| backend-dev | 8 | schema (2), barrel, types, services (2), modules (2), AppModule, seed migration, seed fixture |
| tester | 3 | service tests (2), RED-GATE sentinel |

## Consistency Report

- Covered: 6/6 (all V1 success criteria)
- Uncovered: none
- Untraced: none
- Exemptions: 2 (seed migration infra, seed fixture infra)

## Micro-Tasks

### Slice V1: Schema + Shared Modules

#### Task 1: Create shared types [P] → backend-dev

- **File:** `packages/types/src/admin.ts`
- **Snippet:** Add `SystemSetting`, `FeatureFlag`, `SettingsUpdatePayload`, `SettingsByCategory`, `CreateFeatureFlagPayload` types
- **Verify:** `bun run typecheck --filter=@repo/types` (deferred)
- **Expected:** Types compile and export from barrel
- **Time:** 3 min | **Difficulty:** 1
- **Traces:** SC-6 (shared types exported) | **Phase:** GREEN

#### Task 2: Create system_settings schema [P] → backend-dev

- **File:** `apps/api/src/database/schema/systemSettings.schema.ts`
- **Snippet:** `pgTable('system_settings', { id, key (unique), value (jsonb), type, name, description, category, metadata (jsonb), ...timestamps })` + indexes (key unique, category)
- **Verify:** `grep -q 'system_settings' apps/api/src/database/schema/systemSettings.schema.ts` (ready)
- **Expected:** Table definition with correct columns and indexes
- **Time:** 5 min | **Difficulty:** 2
- **Traces:** S1, SC-2 (Global, no RLS) | **Phase:** GREEN

#### Task 3: Create feature_flags schema [P] → backend-dev

- **File:** `apps/api/src/database/schema/featureFlags.schema.ts`
- **Snippet:** `pgTable('feature_flags', { id, key (unique), name, description, enabled (boolean, default false), ...timestamps })` + indexes (key unique)
- **Verify:** `grep -q 'feature_flags' apps/api/src/database/schema/featureFlags.schema.ts` (ready)
- **Expected:** Table definition with correct columns and indexes
- **Time:** 4 min | **Difficulty:** 2
- **Traces:** S2, SC-2 (Global, no RLS) | **Phase:** GREEN

#### Task 4: Update schema barrel export → backend-dev

- **File:** `apps/api/src/database/schema/index.ts`
- **Snippet:** Add `export * from './systemSettings.schema.js'` and `export * from './featureFlags.schema.js'`
- **Verify:** `grep -q 'systemSettings' apps/api/src/database/schema/index.ts` (ready)
- **Expected:** Both schema files re-exported
- **Time:** 2 min | **Difficulty:** 1
- **Traces:** S1, S2 | **Phase:** GREEN

#### Task 5: Write SystemSettingsService failing tests → tester

- **File:** `apps/api/src/system-settings/system-settings.service.test.ts`
- **Snippet:** Tests for: `getValue<string>('app.name')` returns seeded default, `getValue('nonexistent')` returns null, `getAll()` returns all settings, `getByCategory('General')` filters correctly
- **Verify:** `bun run test apps/api/src/system-settings/system-settings.service.test.ts` (deferred — expected to fail)
- **Expected:** Tests compile but fail (RED)
- **Time:** 8 min | **Difficulty:** 3
- **Traces:** SC-5 (getValue returns Roxabi), SC-5 (nonexistent returns null) | **Phase:** RED

#### Task 6: Write FeatureFlagService failing tests → tester

- **File:** `apps/api/src/feature-flags/feature-flags.service.test.ts`
- **Snippet:** Tests for: `isEnabled('existing')` returns correct value, `isEnabled('nonexistent')` returns false, cache hit (no DB on 2nd call within 60s), cache invalidation on write, CRUD operations
- **Verify:** `bun run test apps/api/src/feature-flags/feature-flags.service.test.ts` (deferred — expected to fail)
- **Expected:** Tests compile but fail (RED)
- **Time:** 10 min | **Difficulty:** 4
- **Traces:** SC-3, SC-4 (cache behavior), N7 | **Phase:** RED

#### RED-GATE: RED complete V1 → tester

#### Task 7: Implement SystemSettingsModule + Service → backend-dev

- **Files:** `apps/api/src/system-settings/system-settings.module.ts`, `apps/api/src/system-settings/system-settings.service.ts`
- **Snippet:** Module exports service. Service: `getValue<T>(key)` → query by key, return typed value or null. `getAll()` → all settings. `getByCategory(cat)` → filter.
- **Verify:** `bun run test apps/api/src/system-settings/system-settings.service.test.ts` (ready)
- **Expected:** All RED tests pass (GREEN)
- **Time:** 8 min | **Difficulty:** 3
- **Traces:** N8, SC-5 | **Phase:** GREEN

#### Task 8: Implement FeatureFlagsModule + Service → backend-dev

- **Files:** `apps/api/src/feature-flags/feature-flags.module.ts`, `apps/api/src/feature-flags/feature-flags.service.ts`
- **Snippet:** Module exports service. Service: `isEnabled(key)` with Map cache (60s TTL), `getAll()`, `create()`, `update()`, `delete()` with write-through cache invalidation.
- **Verify:** `bun run test apps/api/src/feature-flags/feature-flags.service.test.ts` (ready)
- **Expected:** All RED tests pass (GREEN)
- **Time:** 10 min | **Difficulty:** 4
- **Traces:** S4, N7, SC-3, SC-4 | **Phase:** GREEN

#### Task 9: AppModule registration + seed migration + seed fixture → backend-dev

- **Files:** `apps/api/src/app.module.ts`, seed migration SQL, `apps/api/scripts/fixtures/systemSettings.fixture.ts`, `apps/api/scripts/fixtures/index.ts`
- **Snippet:** Import SystemSettingsModule + FeatureFlagsModule as top-level in AppModule. Hand-write seed SQL with 12 settings (INSERT ON CONFLICT DO NOTHING). Add fixture for db:seed.
- **Verify:** `bun run typecheck --filter=@repo/api` (ready)
- **Expected:** Modules registered, seed migration ready
- **Time:** 8 min | **Difficulty:** 3
- **Traces:** SC-1, SC-2 | **Phase:** GREEN

#### Task 10: Generate DDL migration → orchestrator

- **Command:** `cd apps/api && bun run db:generate`
- **Verify:** `ls apps/api/drizzle/migrations/0014_*.sql` (ready)
- **Expected:** New migration file with CREATE TABLE statements
- **Time:** 2 min | **Difficulty:** 1
- **Traces:** SC-1 | **Phase:** GREEN
