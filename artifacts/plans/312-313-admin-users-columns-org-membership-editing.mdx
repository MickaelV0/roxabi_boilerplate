---
title: "Plan: Admin Panel Enhancements — Users List Columns & Org Membership Editing"
issue: 312-313
spec: artifacts/specs/312-313-admin-users-columns-org-membership-editing.mdx
complexity: 5/10
tier: F-lite
generated: 2026-02-24T00:00:00.000Z
---

## Summary

Add organizations count and last active columns to admin users list (#312) and superadmin inline-edit org memberships via context menu (#313). No schema migrations needed.

## Bootstrap Context

From artifacts/analyses/312-313-admin-users-columns-org-membership-editing: Both features extend existing Phase 2 admin panel. All data stores and service patterns already exist. ContextMenu added to @repo/ui following DropdownMenu pattern.

## Agents

| Agent | Tasks | Files |
|-------|-------|-------|
| tester | 2 (RED gates) | `__tests__/*.spec.ts`, `__tests__/*.test.tsx` |
| backend-dev | 4 | `admin-users.service.ts`, `admin-organizations.controller.ts`, `admin-organizations.service.ts`, `admin-members.service.ts`, `admin.ts` |
| frontend-dev | 4 | `users.tsx`, `organizations.$orgId.tsx`, `member-context-menu.tsx`, `ContextMenu.tsx`, `format-relative-time.ts` |

## Consistency Report

- Covered: 14/14
- Uncovered: none
- Untraced: none
- Exemptions: 0

## Micro-Tasks

### Slice V1: Users list columns (#312)

#### Task 1: RED — Write failing tests for listUsers columns → tester
- **File:** `apps/api/src/admin/__tests__/admin-users-list-columns.spec.ts`
- **Snippet:** Implement test bodies: mock DB, call listUsers, assert organizationCount + lastActive fields
- **Verify:** `bun run test apps/api/src/admin/__tests__/admin-users-list-columns.spec.ts` (deferred — tests should fail pre-impl)
- **Expected:** 3 failing tests
- **Time:** 5 min | **Difficulty:** 2
- **Traces:** U1→N1→S1, U2→N1→S3 | **Phase:** RED

#### RED-GATE: RED complete V1 → tester

#### Task 2: Implement fetchLastActiveByUserIds batch query [P] → backend-dev
- **File:** `apps/api/src/admin/admin-users.service.ts`
- **Snippet:** Remove TODO from fetchLastActiveByUserIds, verify MAX(timestamp) query
- **Verify:** `bun run typecheck --filter=@repo/api` (ready)
- **Expected:** Clean typecheck
- **Time:** 3 min | **Difficulty:** 2
- **Traces:** N1→S3, U2 | **Phase:** GREEN

#### Task 3: Add Orgs + Last Active columns to users table [P] → frontend-dev
- **File:** `apps/web/src/routes/admin/users.tsx`, `apps/web/src/lib/format-relative-time.ts`
- **Snippet:** Remove TODOs, verify Badge for org count, formatRelativeTime for last active
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Clean typecheck
- **Time:** 3 min | **Difficulty:** 1
- **Traces:** U1, U2, N1 | **Phase:** GREEN

### Slice V2: Org membership context menu (#313)

#### Task 4: RED — Write failing tests for org roles + role change + context menu → tester
- **File:** `apps/api/src/admin/__tests__/admin-org-roles.spec.ts`, `apps/web/src/components/admin/__tests__/member-context-menu.test.tsx`
- **Snippet:** Implement test bodies: mock services, assert role listing, self-change guard, last-owner guard, menu rendering
- **Verify:** `bun run test apps/api/src/admin/__tests__/admin-org-roles.spec.ts` (deferred)
- **Expected:** 5 failing BE tests + 5 failing FE tests
- **Time:** 8 min | **Difficulty:** 3
- **Traces:** U3-U10, N2, N3 | **Phase:** RED

#### RED-GATE: RED complete V2 → tester

#### Task 5: Implement listOrgRoles endpoint [P] → backend-dev
- **File:** `apps/api/src/admin/admin-organizations.service.ts`, `apps/api/src/admin/admin-organizations.controller.ts`
- **Snippet:** Remove TODOs from listOrgRoles and controller route
- **Verify:** `bun run typecheck --filter=@repo/api` (ready)
- **Expected:** Clean typecheck
- **Time:** 3 min | **Difficulty:** 1
- **Traces:** N2→S4 | **Phase:** GREEN

#### Task 6: Implement last-owner guard in changeMemberRole [P] → backend-dev
- **File:** `apps/api/src/admin/admin-members.service.ts`
- **Snippet:** Remove TODO from ensureNotLastOwnerOnRoleChange — already scaffolded with dual-field check
- **Verify:** `bun run typecheck --filter=@repo/api` (ready)
- **Expected:** Clean typecheck
- **Time:** 2 min | **Difficulty:** 2
- **Traces:** N3→S2, S4 | **Phase:** GREEN

#### Task 7: Extend getOrganizationDetail members with userId + roleId → backend-dev
- **File:** `apps/api/src/admin/admin-organizations.service.ts`
- **Snippet:** Already done in stubs — verify fetchOrgMembers returns userId + roleId
- **Verify:** `bun run typecheck --filter=@repo/api` (ready)
- **Expected:** Clean typecheck
- **Time:** 2 min | **Difficulty:** 1
- **Traces:** N3 | **Phase:** GREEN

#### Task 8: Implement MemberContextMenu component → frontend-dev
- **File:** `apps/web/src/components/admin/member-context-menu.tsx`
- **Snippet:** Dual-trigger (ContextMenu + DropdownMenu), shared MemberMenuContent, role submenu fetch, edit dialog, view user link
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Clean typecheck
- **Time:** 8 min | **Difficulty:** 4
- **Traces:** U3-U10, N2, N3, N4 | **Phase:** GREEN

#### Task 9: Integrate MemberContextMenu into org detail page → frontend-dev
- **File:** `apps/web/src/routes/admin/organizations.$orgId.tsx`
- **Snippet:** Wire currentUserId from session, wrap TableRow in MemberContextMenu, connect MemberKebabButton
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Clean typecheck
- **Time:** 5 min | **Difficulty:** 3
- **Traces:** U3, U4 | **Phase:** GREEN

#### Task 10: Quality gate — lint + typecheck + tests → tester
- **File:** All modified files
- **Snippet:** `bun lint && bun typecheck && bun run test`
- **Verify:** `bun lint && bun typecheck && bun run test` (ready)
- **Expected:** All pass
- **Time:** 3 min | **Difficulty:** 1
- **Traces:** All SC | **Phase:** REFACTOR
