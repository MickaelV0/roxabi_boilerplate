---
title: "Plan: System Settings Admin Page + Backend"
issue: 358
spec: artifacts/specs/358-system-settings-admin-page.mdx
tier: F-lite
---

## Tasks

### T1 — RED: Failing tests (tester)

**Controller test** `apps/api/src/admin/adminSettings.controller.test.ts`:
- Decorator verification: `@Roles('superadmin')`, `@SkipOrg()`
- `GET /api/admin/settings` → delegates to service, returns grouped settings
- `PATCH /api/admin/settings` → validates payload, delegates batch update, returns updated
- `PATCH` with invalid type → throws `SettingValidationException`
- `PATCH` with non-existent key → throws `SettingNotFoundException`

**Service test** extend `apps/api/src/system-settings/systemSettings.service.test.ts`:
- `batchUpdate()` validates types, updates within transaction, returns updated settings
- `batchUpdate()` with invalid type rejects entire batch
- `batchUpdate()` with non-existent key throws

**Ref pattern:** `adminUsers.controller.test.ts` for controller test structure

### T2 — BE: Exceptions + error codes (backend-dev)

- `apps/api/src/admin/exceptions/settingNotFound.exception.ts`
- `apps/api/src/admin/exceptions/settingValidation.exception.ts`
- Add `SETTING_NOT_FOUND`, `SETTING_VALIDATION` to `apps/api/src/common/errorCodes.ts`
- Update `apps/api/src/admin/filters/adminException.filter.ts`: add to `@Catch()`, type union, status mapping (404 for NotFound, 400 for Validation)

### T3 — BE: Extend SystemSettingsService (backend-dev)

- Add `batchUpdate(updates, db?)` method with:
  - Read before-state for all keys
  - Validate types (string/number/boolean/select)
  - Transaction: update all or reject all
  - Return updated settings with before-state for audit
- Ref: `systemSettings.schema.ts`, existing `getAll()`

### T4 — BE: AdminSettingsController + module wiring (backend-dev)

- `apps/api/src/admin/adminSettings.controller.ts`:
  - Standard decorator stack: `@ApiTags`, `@ApiBearerAuth`, `@UseFilters`, `@Throttle`, `@Roles('superadmin')`, `@SkipOrg()`
  - `GET /api/admin/settings` → `service.getAll()` grouped by category
  - `PATCH /api/admin/settings` → Zod validation of `SettingsUpdatePayload`, batch update, audit log per changed setting
  - Inject `SystemSettingsService` + `AuditService`
- Update `apps/api/src/admin/admin.module.ts`: import `SystemSettingsModule`, add controller

### T5 — FE: System settings page + sidebar enablement (frontend-dev)

- `apps/web/src/routes/admin/system-settings.tsx`:
  - Route: `createFileRoute('/admin/system-settings')`, `permission: 'role:superadmin'`, `beforeLoad: enforceRoutePermission`
  - Fetch `GET /api/admin/settings` via `useQuery`
  - Group by category, render `SettingsCard` per category
- `apps/web/src/components/admin/SettingsCard.tsx`:
  - Props: `category`, `settings[]`, `onSave`
  - Type-appropriate inputs: text, number, boolean toggle, select dropdown
  - Per-card save button, dirty tracking, success toast
- `apps/web/src/routes/admin.tsx`: remove `disabled: true` from system-settings link

### T6 — Verify: Coverage + quality gate (tester)

- Run all tests, verify coverage
- Edge cases: empty updates array, concurrent saves
- Quality gate: `bun lint && bun typecheck && bun run test`
