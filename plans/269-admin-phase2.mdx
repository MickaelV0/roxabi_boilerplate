---
title: "Plan: Admin Panel Phase 2 — Cross-Tenant User & Organization Management"
issue: 269
spec: specs/269-admin-phase2.mdx
complexity: 8/10
tier: F-full
generated: 2026-02-23T00:00:00.000Z
---

## Summary

Implement cross-tenant user CRUD, organization CRUD with hierarchy (max 3 levels), and audit log viewer — all cursor-paginated and restricted to super admins. Extends the Phase 1 admin module with 3 new controller/service pairs, shared cursor pagination utilities, and 5 new frontend route pages.

## Bootstrap Context

From analyses/269-admin-phase2.mdx: Phase 2 builds on Phase 1's admin layout, route guards, and AuditService. Cursor-based pagination chosen over offset for cross-tenant lists (performance at scale). Org hierarchy is display-only grouping (max 3 levels, no cross-access inheritance). TenantInterceptor must be guarded to prevent parent resolution from breaking existing tenant isolation.

## Agents

| Agent | Task count | Files |
|-------|-----------|-------|
| backend-dev | 16 | cursor-pagination.util.ts, skip-org.decorator.ts, DB migration, admin-users.*, admin-organizations.*, admin-audit-logs.*, exceptions, error-codes, admin.module, exception filter |
| frontend-dev | 9 | use-cursor-pagination.ts, load-more-button.tsx, filter-bar.tsx, tree-view.tsx, diff-viewer.tsx, user-actions.tsx, org-actions.tsx, routes (users, users.$userId, organizations, organizations.$orgId, audit-logs), admin sidebar |
| tester | 4 | RED phase test writing for V1-V4 |

## Consistency Report

- Criteria covered: 19/19
- Uncovered criteria: none
- Tasks without spec backing: 2 (DB migration infrastructure, sidebar nav enablement — exempt: infrastructure/quality)
- Gold plating exemptions applied: 2

## Micro-Tasks

### Slice V1: Foundation

#### Task 1: Implement cursor pagination utility [P] → backend-dev
- **File:** `apps/api/src/admin/utils/cursor-pagination.util.ts`
- **Snippet:** `encodeCursor()`, `decodeCursor()`, `buildCursorCondition()`, `buildCursorResponse()` — Base64 encoding of `(timestamp, id)` tuple, Drizzle SQL condition builder, N+1 row trimming
- **Verify:** `bun run test apps/api/src/admin/utils/cursor-pagination.util.test.ts` (deferred)
- **Expected:** All cursor pagination unit tests pass
- **Time:** 5 min
- **Difficulty:** 3
- **Traces:** SC-19 (cursor pagination consistent), N16
- **Phase:** GREEN

#### Task 2: Write cursor pagination tests → tester
- **File:** `apps/api/src/admin/utils/cursor-pagination.util.test.ts`
- **Snippet:** Tests for encode/decode roundtrip, invalid cursor, buildCursorCondition SQL, buildCursorResponse trimming + hasMore logic
- **Verify:** `grep -q 'should roundtrip encode/decode correctly' apps/api/src/admin/utils/cursor-pagination.util.test.ts`
- **Expected:** Test file contains describe blocks for all 4 utility functions
- **Time:** 5 min
- **Difficulty:** 2
- **Traces:** SC-19
- **Phase:** RED

#### Task 3: DB migration — parentOrganizationId + cursor indexes [P] → backend-dev
- **File:** `apps/api/src/database/schema/auth.schema.ts` + new migration file
- **Snippet:** Add `parentOrganizationId TEXT` (nullable, self-ref FK) to `organizations`. Add composite indexes: `idx_users_cursor (createdAt DESC, id DESC)`, `idx_orgs_cursor (createdAt DESC, id DESC)`, `idx_audit_cursor (timestamp DESC, id DESC)`
- **Verify:** `cd apps/api && bun run db:generate --check` (ready)
- **Expected:** Migration applies cleanly, schema matches
- **Time:** 8 min
- **Difficulty:** 3
- **Traces:** SC-17 (parentOrganizationId), SC-19 (indexes)
- **Phase:** GREEN

#### Task 4: Implement useCursorPagination hook [P] → frontend-dev
- **File:** `apps/web/src/hooks/use-cursor-pagination.ts`
- **Snippet:** Wrap `useInfiniteQuery` with `getNextPageParam` from `cursor.next`. Flatten pages, expose `loadMore`, `hasMore`, `isLoading`, `isLoadingMore`
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Typecheck passes
- **Time:** 5 min
- **Difficulty:** 3
- **Traces:** SC-19, N16 (frontend counterpart)
- **Phase:** GREEN

#### Task 5: Implement LoadMoreButton component [P] → frontend-dev
- **File:** `apps/web/src/components/admin/load-more-button.tsx`
- **Snippet:** Button with loading spinner, conditional render on `hasMore`, disabled when loading
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Typecheck passes
- **Time:** 2 min
- **Difficulty:** 1
- **Traces:** U3, U24
- **Phase:** GREEN

#### RED-GATE: RED complete V1 → tester
- **Verify:** Task 2 marked complete
- **Phase:** RED-GATE

### Slice V2: Users (U1-U10, N1-N7)

#### Task 6: Write AdminUsersService tests → tester
- **File:** `apps/api/src/admin/admin-users.service.test.ts`
- **Snippet:** Full test implementations for listUsers (filters, search, ILIKE escaping), getUserDetail (profile + memberships + audit), updateUser (audit snapshots, email conflict), banUser (reason validation), unbanUser, deleteUser, restoreUser
- **Verify:** `grep -q 'should return cursor-paginated users' apps/api/src/admin/admin-users.service.test.ts`
- **Expected:** Test file has describe/it blocks for all 7 service methods
- **Time:** 8 min
- **Difficulty:** 4
- **Traces:** SC-1 through SC-6, SC-15, SC-16, SC-18
- **Phase:** RED

#### Task 7: Implement AdminUsersService → backend-dev
- **File:** `apps/api/src/admin/admin-users.service.ts`
- **Snippet:** `listUsers()` with cursor pagination + filters (role/status/org/search), `getUserDetail()` with memberships join + last 10 audit entries, `updateUser()` with before/after audit, `banUser()`/`unbanUser()`, `deleteUser()`/`restoreUser()` with soft-delete
- **Verify:** `bun run test apps/api/src/admin/admin-users.service.test.ts` (deferred)
- **Expected:** All user service tests pass
- **Time:** 10 min
- **Difficulty:** 5
- **Traces:** SC-1 through SC-6, N1-N7 → S1,S2,S3,S4
- **Phase:** GREEN

#### Task 8: Implement AdminUsersController → backend-dev
- **File:** `apps/api/src/admin/admin-users.controller.ts`
- **Snippet:** Zod schemas for updateUser (name, email, role), banUser (reason 5-500 chars, optional expires). Route handlers delegating to service. `@Roles('superadmin')` + `@SkipOrg()`
- **Verify:** `bun run test apps/api/src/admin/admin-users.controller.test.ts` (deferred)
- **Expected:** All user controller tests pass
- **Time:** 5 min
- **Difficulty:** 3
- **Traces:** SC-1, SC-15, SC-16, U1-U10
- **Phase:** GREEN

#### Task 9: Implement FilterBar component → frontend-dev
- **File:** `apps/web/src/components/admin/filter-bar.tsx`
- **Snippet:** Configurable filter bar with Select dropdowns, searchable selects (Combobox), debounced text input (300ms), date range pickers, reset button. Props-driven via `FilterConfig[]`
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Typecheck passes
- **Time:** 8 min
- **Difficulty:** 4
- **Traces:** U2, U12, U22
- **Phase:** GREEN

#### Task 10: Implement Users list page → frontend-dev
- **File:** `apps/web/src/routes/admin/users.tsx`
- **Snippet:** `useCursorPagination` for user list, FilterBar (role, status, org, search), table with clickable rows, LoadMoreButton, status badges
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Typecheck passes
- **Time:** 8 min
- **Difficulty:** 4
- **Traces:** U1, U2, U3, U4, SC-1, SC-6
- **Phase:** GREEN

#### Task 11: Implement UserActions component → frontend-dev
- **File:** `apps/web/src/components/admin/user-actions.tsx`
- **Snippet:** Edit form (name, email, role dropdown), Ban dialog (reason textarea 5-500 chars, optional date picker), Unban/Delete/Restore confirmation dialogs. useMutation for each action
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Typecheck passes
- **Time:** 8 min
- **Difficulty:** 4
- **Traces:** U6, U7, U8, U9, U10
- **Phase:** GREEN

#### Task 12: Implement User detail page → frontend-dev
- **File:** `apps/web/src/routes/admin/users.$userId.tsx`
- **Snippet:** Profile section, org memberships table, activity summary with expandable DiffViewer, UserActions in header. useQuery for user detail
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Typecheck passes
- **Time:** 8 min
- **Difficulty:** 4
- **Traces:** U5, SC-2, SC-3
- **Phase:** GREEN

#### Task 13: Enable /admin/users in sidebar nav [P] → frontend-dev
- **File:** `apps/web/src/routes/admin.tsx`
- **Snippet:** Remove `disabled: true` from the users link in `SYSTEM_LINKS`
- **Verify:** `grep -q "disabled: true" apps/web/src/routes/admin.tsx` should still match other links but users link should not have disabled
- **Expected:** Users link is clickable in sidebar
- **Time:** 2 min
- **Difficulty:** 1
- **Traces:** U1
- **Phase:** GREEN

#### RED-GATE: RED complete V2 → tester
- **Verify:** Task 6 marked complete
- **Phase:** RED-GATE

### Slice V3: Organizations (U11-U20, N8-N14)

#### Task 14: Write AdminOrganizationsService tests → tester
- **File:** `apps/api/src/admin/admin-organizations.service.test.ts`
- **Snippet:** Full test implementations for listOrganizations, listOrganizationsForTree (>1000 limit), createOrganization (depth validation, slug conflict), updateOrganization (cycle detection, subtree depth), getDeletionImpact (recursive counts), deleteOrganization (orphan children), restoreOrganization, validateHierarchy (transaction)
- **Verify:** `grep -q 'should reject parent that would create depth > 3' apps/api/src/admin/admin-organizations.service.test.ts`
- **Expected:** Test file has describe/it blocks for all service methods
- **Time:** 8 min
- **Difficulty:** 5
- **Traces:** SC-7 through SC-12
- **Phase:** RED

#### Task 15: Implement AdminOrganizationsService → backend-dev
- **File:** `apps/api/src/admin/admin-organizations.service.ts`
- **Snippet:** `listOrganizations()` with cursor + member count subquery, `listOrganizationsForTree()` with 1000 org limit, `createOrganization()` with hierarchy validation, `updateOrganization()` with depth + cycle checks in transaction, `getDeletionImpact()` recursive, `deleteOrganization()` soft-delete (children orphaned), `restoreOrganization()`, `validateHierarchy()` inside `db.transaction()`
- **Verify:** `bun run test apps/api/src/admin/admin-organizations.service.test.ts` (deferred)
- **Expected:** All org service tests pass
- **Time:** 10 min
- **Difficulty:** 5
- **Traces:** SC-7 through SC-12, N8-N14 → S2,S3,S4
- **Phase:** GREEN

#### Task 16: Implement AdminOrganizationsController → backend-dev
- **File:** `apps/api/src/admin/admin-organizations.controller.ts`
- **Snippet:** Zod schemas for create (name, slug, parentOrganizationId) and update (name, slug, parentOrganizationId). Route handlers with view=tree branching
- **Verify:** `bun run test apps/api/src/admin/admin-organizations.controller.test.ts` (deferred)
- **Expected:** All org controller tests pass
- **Time:** 5 min
- **Difficulty:** 3
- **Traces:** SC-7, SC-8, SC-9, U11-U20
- **Phase:** GREEN

#### Task 17: Guard TenantInterceptor for parentOrganizationId → backend-dev
- **File:** `apps/api/src/tenant/tenant.interceptor.ts`
- **Snippet:** Guard the `parentOrganizationId` branch with a TODO comment. Prevent automatic parent resolution when the column is populated
- **Verify:** `grep -q 'TODO: re-enable in Phase 3' apps/api/src/tenant/tenant.interceptor.ts` (ready)
- **Expected:** Interceptor does not resolve to parent tenant
- **Time:** 3 min
- **Difficulty:** 2
- **Traces:** SC-17
- **Phase:** GREEN

#### Task 18: Implement TreeView component [P] → frontend-dev
- **File:** `apps/web/src/components/admin/tree-view.tsx`
- **Snippet:** `buildTree()` function to assemble flat list into hierarchy. Recursive `TreeNode` component with expand/collapse (chevron), indentation, member count badge, status badge, orphan indicator
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Typecheck passes
- **Time:** 8 min
- **Difficulty:** 4
- **Traces:** U14, SC-12
- **Phase:** GREEN

#### Task 19: Implement Organizations list page → frontend-dev
- **File:** `apps/web/src/routes/admin/organizations.tsx`
- **Snippet:** List/Tree toggle, FilterBar (status, search), flat list with cursor pagination, tree view with TreeView component, Create Organization dialog (name, slug, parent dropdown)
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Typecheck passes
- **Time:** 8 min
- **Difficulty:** 4
- **Traces:** U11, U12, U13, U14, U15, U16, SC-7, SC-12
- **Phase:** GREEN

#### Task 20: Implement OrgActions + Org detail page → frontend-dev
- **File:** `apps/web/src/routes/admin/organizations.$orgId.tsx`, `apps/web/src/components/admin/org-actions.tsx`
- **Snippet:** Org detail with info section, edit form (name, slug, parent dropdown), members table, children list. OrgActions: delete with impact preview fetch, restore confirmation
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Typecheck passes
- **Time:** 8 min
- **Difficulty:** 4
- **Traces:** U17, U18, U19, U20, SC-10, SC-11
- **Phase:** GREEN

#### Task 21: Enable /admin/organizations in sidebar nav [P] → frontend-dev
- **File:** `apps/web/src/routes/admin.tsx`
- **Snippet:** Remove `disabled: true` from the organizations link in `SYSTEM_LINKS`
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Organizations link is clickable in sidebar
- **Time:** 2 min
- **Difficulty:** 1
- **Traces:** U11
- **Phase:** GREEN

#### RED-GATE: RED complete V3 → tester
- **Verify:** Task 14 marked complete
- **Phase:** RED-GATE

### Slice V4: Audit Logs (U21-U24, N15)

#### Task 22: Write AdminAuditLogsService tests → tester
- **File:** `apps/api/src/admin/admin-audit-logs.service.test.ts`
- **Snippet:** Full test implementations for listAuditLogs (all filters, text search on action/resource/resourceId only, actor name join, [Deleted User] display), redactSensitiveFields (case-insensitive, nested, non-sensitive unchanged)
- **Verify:** `grep -q 'should replace sensitive field values' apps/api/src/admin/admin-audit-logs.service.test.ts`
- **Expected:** Test file has describe/it blocks for list + redact
- **Time:** 5 min
- **Difficulty:** 3
- **Traces:** SC-13, SC-14
- **Phase:** RED

#### Task 23: Implement AdminAuditLogsService + Controller → backend-dev
- **File:** `apps/api/src/admin/admin-audit-logs.service.ts`, `apps/api/src/admin/admin-audit-logs.controller.ts`
- **Snippet:** `listAuditLogs()` with cursor pagination, all filters (date range, actor, action, resource, org, search), actor name join (LEFT JOIN users for [Deleted User]), `redactSensitiveFields()` applied to before/after before response. Controller parses query params
- **Verify:** `bun run test apps/api/src/admin/admin-audit-logs.service.test.ts` (deferred)
- **Expected:** All audit log tests pass
- **Time:** 8 min
- **Difficulty:** 4
- **Traces:** SC-13, SC-14, N15 → S3
- **Phase:** GREEN

#### Task 24: Implement DiffViewer component [P] → frontend-dev
- **File:** `apps/web/src/components/admin/diff-viewer.tsx`
- **Snippet:** Side-by-side before/after display. Changed fields highlighted (green for added, red for removed, yellow for changed). Client-side `redactSensitiveFields()` as defense-in-depth. Null value handling
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Typecheck passes
- **Time:** 5 min
- **Difficulty:** 3
- **Traces:** U23, SC-14
- **Phase:** GREEN

#### Task 25: Implement Audit Logs list page → frontend-dev
- **File:** `apps/web/src/routes/admin/audit-logs.tsx`
- **Snippet:** FilterBar (date range, actor, action, resource, org, search), cursor-paginated table, expandable rows with DiffViewer, LoadMoreButton, human-readable action labels
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Typecheck passes
- **Time:** 8 min
- **Difficulty:** 4
- **Traces:** U21, U22, U23, U24, SC-13
- **Phase:** GREEN

#### Task 26: Enable /admin/audit-logs in sidebar nav [P] → frontend-dev
- **File:** `apps/web/src/routes/admin.tsx`
- **Snippet:** Remove `disabled: true` from the audit-logs link in `SYSTEM_LINKS`
- **Verify:** `bun run typecheck --filter=@repo/web` (ready)
- **Expected:** Audit logs link is clickable in sidebar
- **Time:** 2 min
- **Difficulty:** 1
- **Traces:** U21
- **Phase:** GREEN

#### RED-GATE: RED complete V4 → tester
- **Verify:** Task 22 marked complete
- **Phase:** RED-GATE
